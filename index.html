<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deltagar- & Coachschema</title>
<style>
:root{
  --card-bg:#fff;--border:#ddd;--shadow:0 3px 10px rgba(0,0,0,.05);
  --radius:16px;--print-scale:1;
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  margin:0 auto;max-width:1400px;padding:20px;background:#fafafa;
}
header{text-align:center;margin-bottom:10px;}
h1{margin:0;font-size:1.4rem;}
#version{font-size:.85rem;color:#666;margin-top:4px;}
select,button{
  font-size:1rem;padding:10px 14px;border-radius:10px;border:1px solid #ccc;
  background:#f8f8f8;cursor:pointer;
}
select{width:220px;}
button:hover{background:#eee;}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:15px;}

.cards{display:flex;flex-direction:column;gap:12px;}
.card{
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:12px 16px;background:var(--card-bg);
  position:relative;
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--band,#ccc);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card h3{margin:0;font-size:1.1rem;}
.row{font-size:.95rem;margin-top:4px;}

#blockContainer{display:none;margin-top:10px;}
.block-header{display:grid;grid-template-columns:80px repeat(5,1fr);font-weight:bold;}
.block-grid{display:grid;grid-template-columns:80px repeat(5,1fr);}
.block-time{background:#fafafa;font-size:.85rem;padding:3px 6px;}
.block-cell{position:relative;min-height:28px;border:none;}
.block{
  position:absolute;left:2px;right:2px;top:2px;
  border-radius:8px;padding:4px 6px;line-height:1.2;
  border:1pt solid #666;font-size:.8rem;
  word-break:break-word;overflow:hidden;
  -webkit-print-color-adjust:exact;print-color-adjust:exact;
}
@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar{display:none !important;}
  #blockContainer{display:block !important;transform:scale(var(--print-scale,1));transform-origin:top left;}
  @page{size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <h1>Deltagar- & Coachschema</h1>
  <div id="version">Version 4.3 (2025-10-09)</div>
</header>

<div class="toolbar">
  <button id="btnParticipant">Deltagarschema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
  <select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>
  <button id="btnCards">Dagens schema</button>
  <button id="btnBlocks">Veckoschema</button>
  <button id="btnHelp">üß© Schemahj√§lp</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>

<div id="blockContainer">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
</div>

<div id="helpPanel" style="display:none;text-align:center;margin-top:20px;">
  <button id="btnCompare">üë• J√§mf√∂r scheman</button>
</div>
<div id="comparePanel" style="display:none;background:#fff;border:1px solid #ccc;
border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,.1);padding:20px;max-width:700px;
margin:20px auto;">
  <h2>J√§mf√∂r scheman</h2>
  <div style="display:flex;gap:30px;justify-content:center;flex-wrap:wrap;">
    <div><h3>Delconst url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},"Padel":{color:"#82E0AA",emoji:"üèì"},
  "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
  "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Trummor":{color:"#F1948A",emoji:"ü•Å"},
  "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},"Medicin":{color:"#E59866",emoji:"üíä"},
  "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
  "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},"Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
  "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},"Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"},
  "Warhammer":{color:"#C39BD3",emoji:"üõ°Ô∏è"},"Uppstart Taket":{color:"#AED6F1",emoji:"üå§Ô∏è"},
  "G√•tr√§ning":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÇÔ∏è"},"Promenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},
  "Baka":{color:"#FAD7A0",emoji:"üßÅ"},"Utflykt":{color:"#A9CCE3",emoji:"üöå"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#F4F6F7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  fillLists();
  console.log("‚úÖ Data uppdaterad "+new Date().toLocaleString("sv-SE"));
}
loadData();

function fillLists(){
  const names=[...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort();
  const coaches=[...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort();
  const s=document.getElementById("nameSelect"), c=document.getElementById("coachSelect");
  s.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  c.innerHTML='<option value="">-- V√§lj coach --</option>';
  names.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);});
  coaches.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;c.appendChild(o);});
  const ld=document.getElementById("listDelt"),lc=document.getElementById("listCoach");
  ld.innerHTML=names.map(n=>`<label><input type="checkbox" class="chk-delt" value="${n}"> ${n}</label><br>`).join("");
  lc.innerHTML=coaches.map(n=>`<label><input type="checkbox" class="chk-coach" value="${n}"> ${n}</label><br>`).join("");
}

/* ===== Hj√§lpfunktioner ===== */
function applyLunchRule(rows,name,isCoach){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const isAll=(isCoach? r.Coach : r.Deltagare ||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&
        (x.Aktivitet||"").toLowerCase().includes("lunch")&&
        (isCoach? (x.Coach||"").toLowerCase().includes(name.toLowerCase())
                 : (x.Deltagare||"").toLowerCase().includes(name.toLowerCase())));
      if(specific) return false;
    }
    return true;
  });
}
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}

/* ===== Kortvy ===== */
function renderCards(name,isCoach){
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(
    DATA.filter(r=>{
      const str=(r[field]||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      return(str.split(/,|\/|;|\n/).map(x=>x.trim().toLowerCase()).some(x=>x===name.toLowerCase())||str==="alla")
      && dayKey(r.Datum)===today;
    }),name,isCoach).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(today));
  let html=`<h3>${label}</h3><div class="cards">`;
  if(!rows.length){html+="<p>Inga aktiviteter idag.</p>";}
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

/* ===== Veckoschema ===== */
function renderBlocks(name,isCoach){
  const slots=makeSlots(), days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    return str.split(/,|\/|;|\n/).map(x=>x.trim().toLowerCase()).some(x=>x===name.toLowerCase())||str==="alla";
  }),name,isCoach);
  const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("");
  grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class="block-time">${t}</div>`+days.map(()=>`<div class="block-cell"></div>`).join("");});
  const cells=[...grid.children], dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");block.className="block";block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    if(duration<=30){block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""} ‚Äì ${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;}
    else{block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}<br>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}`;}
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  const today=new Date();
  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name} (${today.toLocaleDateString("sv-SE")})`;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
}

/* ===== Knappar ===== */
btnParticipant.onclick=()=>{coachSelect.style.display="none";nameSelect.style.display="inline-block";viewTitle.textContent="Deltagarschema";};
btnCoach.onclick=()=>{nameSelect.style.display="none";coachSelect.style.display="inline-block";viewTitle.textContent="Coachschema";};
btnCards.onclick=()=>{const n=nameSelect.style.display!=="none"?nameSelect.value:coachSelect.value;if(n)renderCards(n,coachSelect.style.display!=="none");};
btnBlocks.onclick=()=>{const n=nameSelect.style.display!=="none"?nameSelect.value:coachSelect.value;if(n)renderBlocks(n,coachSelect.style.display!=="none");};
btnPrint.onclick=()=>{window.print();};
btnHelp.onclick=()=>{helpPanel.style.display=helpPanel.style.display==="none"?"block":"none";};
btnCompare.onclick=()=>{comparePanel.style.display="block";};
btnCloseCompare.onclick=()=>{comparePanel.style.display="none";};

/* ===== DEL 3 ‚Äì Visa flera scheman bredvid varandra ===== */
document.addEventListener("click",function(e){
 if(!(e.target&&e.target.id==="btnShowCompare"))return;
 const selected=[...document.querySelectorAll(".chk-delt:checked"),...document.querySelectorAll(".chk-coach:checked")]
   .map(cb=>({name:cb.value,isCoach:cb.classList.contains("chk-coach")}));
 if(!selected.length){alert("V√§lj minst en person f√∂rst.");return;}
 const cont=document.getElementById("blockContainer");
 schemaContainer.style.display="none";cont.style.display="block";viewTitle.textContent="J√§mf√∂r scheman";
 cont.innerHTML="";const wrap=document.createElement("div");
 wrap.style.display="flex";wrap.style.flexWrap="wrap";wrap.style.gap="25px";wrap.style.justifyContent="center";
 cont.appendChild(wrap);
 selected.forEach(sel=>{
  const box=document.createElement("div");
  box.style.flex="1 1 600px";box.style.background="#fff";box.style.border="1px solid #ddd";
  box.style.borderRadius="14px";box.style.padding="10px";box.style.boxShadow="0 3px 10px rgba(0,0,0,.05)";
  box.innerHTML=`<h3 style="text-align:center;margin:0 0 6px 0;">${sel.isCoach?"üßë‚Äçüè´ ":"üë• "}${sel.name}</h3>
    <div class='block-header'></div><div class='block-grid'></div>`;
  wrap.appendChild(box);
  renderSingleSchedule(sel.name,sel.isCoach,box.querySelector(".block-header"),box.querySelector(".block-grid"));
 });
});
function renderSingleSchedule(name,isCoach,head,grid){
 const slots=makeSlots(),days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
 const field=isCoach?"Coach":"Deltagare";
 const rows=applyLunchRule(DATA.filter(r=>{
  const str=(r[field]||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  return str.split(/,|\/|;|\n/).map(x=>x.trim().toLowerCase()).some(x=>x===name.toLowerCase())||str==="alla";
 }),name,isCoach);
 head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("");
 grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
 slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
 const cells=[...grid.children],dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
 const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
 rows.forEach(r=>{
  const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
  const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);if(sIdx<0||eIdx<=sIdx)return;
  const first=sIdx*(1+days.length)+col,cell=cells[first];
  const block=document.createElement("div");block.className="block";block.style.background=colorFor(r);
  const dur=toMin(r.Slut)-toMin(r.Start);
  block.innerHTML=dur<=30?`${emojiFor(r)} ${r.Aktivitet||""} ‚Äì ${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`
    :`${emojiFor(r)} ${r.Aktivitet||""}<br>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}`;
  requestAnimationFrame(()=>{const h=cell.clientHeight||28;block.style.height=(eIdx-sIdx)*h+"px";});
  cell.appendChild(block);
 });
}
</script>
</body>
</html>
tagare</h3><div id="listDelt"></div></div>
    <div><h3>Coacher</h3><div id="listCoach"></div></div>
  </div>
  <div style="text-align:center;margin-top:15px;">
    <button id="btnShowCompare">Visa scheman</button>
    <button id="btnCloseCompare">St√§ng</button>
  </div>
</div>

<script>
