
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Grunden DV ‚Äì Schema</title>
</head>
<body>
<header>
  <!-- Logga √∂verst -->
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga" style="height:65px;margin:10px auto;display:block;">
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnBlocks">Veckoblock</button>
  <button id="btnCards">Kortvy</button>
  <button id="btnSick">Sjukschema</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
  <button id="btnReload">üîÑ Uppdatera nu</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<!-- Blockschema -->
<div id="blockContainer" class="block-wrap" aria-hidden="true">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div id="printHint" style="font-size:.9rem;color:#444;margin-top:6px;display:none;text-align:center;">
    F√∂rhandsvisning ‚Äì anv√§nd webbl√§sarens <b>Skriv ut</b> (Ctrl/Cmd + P).
  </div>
</div>

<!-- Sjukpanel -->
<div id="sickPanel">
  <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
  <div id="sickList"></div>
  <div id="sickMsg" style="font-size:.85rem;color:#666;margin-top:6px;"></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button id="btnShowSick">Visa sjukschema</button>
    <button id="btnClearSick">Rensa</button>
  </div>
</div>
<style>
:root {
  --card-bg: #fff;
  --page-bg: #fafafa;
  --border: #ddd;
  --muted: #555;
  --heading: #2c3e50;
  --shadow: 0 6px 18px rgba(0,0,0,.05);
  --radius: 16px;
  --band: #9ecbff;
}

/* ===== Bas ===== */
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
  background: var(--page-bg);
}
header { text-align: center; margin-bottom: 15px; }
#clock { font-family: ui-monospace; font-size: .9rem; color: #333; }
#updated { font-size: .8rem; color: var(--muted); margin-top: 4px; }

.toolbar {
  display: flex; flex-wrap: wrap; justify-content: center;
  gap: 10px; margin: 18px 0;
}
button, select {
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: #f7f7f7;
  cursor: pointer;
  font-size: 15px;
}
button:hover { background: #ececec; }

/* ===== Dagavsnitt ===== */
.day-section {
  border-bottom: 1px solid #ddd;
  margin-bottom: 25px;
  padding-bottom: 10px;
}
.day-heading {
  background: #eef5ff;
  color: var(--heading);
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 700;
  margin: 20px 0 12px 0;
}

/* ===== Kortvy ===== */
.cards { display: flex; flex-direction: column; gap: 18px; margin-bottom: 25px; }
.card {
  position: relative;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}
.card::before {
  content: "";
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 8px; background: var(--band);
  border-top-left-radius: var(--radius);
  border-bottom-left-radius: var(--radius);
}
.card-title {
  font-weight: 800;
  font-size: 1.1rem;
  margin: 4px 0 8px;
  display: flex; align-items: center; gap: 8px;
}
.row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
  font-size: 1rem;
  padding: 2px 0;
}
.row label { color: #333; font-weight: 700; }

/* ===== Sjukpanel ===== */
#sickPanel {
  display: none;
  border: 1px solid var(--border);
  background: #fff;
  border-radius: 14px;
  padding: 12px;
  box-shadow: var(--shadow);
}
#sickList {
  display: flex; flex-wrap: wrap;
  gap: 8px 14px; max-height: 220px; overflow: auto;
}
#sickList label { display: flex; align-items: center; gap: 6px; white-space: nowrap; }

/* ===== Blockschema (ny stil) ===== */
.block-wrap { display: none; margin-top: 16px; }
.block-header {
  display: grid;
  grid-template-columns: 80px repeat(5, 1fr);
  gap: 0;
  font-weight: 700;
  text-transform: capitalize;
}
.block-header div { padding: 6px 8px; background: #f3f6ff; border: none; }
.block-grid { display: grid; grid-template-columns: 80px repeat(5, 1fr); }
.block-time { background: #fafafa; padding: 4px 6px; font-size: .9rem; border: none; }
.block-cell { position: relative; min-height: 28px; border: none; }

.block {
  position: absolute; left: 2px; right: 2px; top: 2px;
  border: 1pt solid #666;
  border-radius: 6px;
  padding: 3px 5px;
  font-size: .85rem;
  line-height: 1.2;
  box-sizing: border-box;<script>
/* ===== Datak√§lla ===== */
const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger = {
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},"Padel":{color:"#82E0AA",emoji:"üèì"},
  "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
  "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Trummor":{color:"#F1948A",emoji:"ü•Å"},
  "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},"Medicin":{color:"#E59866",emoji:"üíä"},
  "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
  "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},"Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
  "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},"Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"}
};

/* ===== Hj√§lpfunktioner ===== */
function getSEDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Stockholm"}));}
function fmtSE(dt,opts){return new Intl.DateTimeFormat("sv-SE",opts).format(dt);}
function dayKey(str){return String(str).slice(0,10);}
function parseCoaches(c){const ignore=["","-",".","ingen","ingen coach","eget arbete","sj√§lvst√§ndigt","utan coach"];return (c||"").split(/,|\/|&|\+|;|\||\n| och /i).map(x=>x.trim()).filter(x=>x&&!ignore.includes(x.toLowerCase())&&x.toLowerCase()!=="alla");}
function colorFor(r){return (aktivitetFarger[r.Aktivitet]||{color:"#fff"}).color;}
function emojiFor(r){return (aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function shrinkList(str,max=2){if(!str)return"-";const a=String(str).split(/,|\/|;|\||\n| och /i).map(s=>s.trim()).filter(Boolean);return a.length<=max?a.join(", "):a.slice(0,max).join(", ")+`, +${a.length-max} fler`;}

/* ===== Klocka ===== */
function updateClock(){
  const now=getSEDate();
  document.getElementById("clock").textContent =
    fmtSE(now,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateClock,1000);updateClock();

/* ===== Ladda data ===== */
let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  document.getElementById("updated").textContent="Senast uppdaterad: "+(json.updated||"‚Äì");
  setupCoachSelect(DATA);
  setupSickList(DATA);
  renderDaily(DATA);
}

/* ===== Kortvy ===== */
function cardHTML(r){
  const b=colorFor(r);
  const t=(r.Start&&r.Slut)?`${r.Start}‚Äì${r.Slut}`:r.Start||r.Slut||"-";
  return `<div class="card" style="--band:${b}">
    <div class="row"><label>üïí Tid:</label><div>${t}</div></div>
    <h4 class="card-title">${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h4>
    <div class="row"><label>üë• Deltagare:</label><div>${shrinkList(r.Deltagare,4)}</div></div>
    <div class="row"><label>üßë‚Äçüè´ Coach:</label><div>${shrinkList(r.Coach,3)}</div></div>
  </div>`;
}
function groupByDate(rows){const g={};rows.forEach(r=>{const k=dayKey(r.Datum);(g[k]=g[k]||[]).push(r);});return Object.keys(g).sort().reduce((a,k)=>(a[k]=g[k],a),{});}
function sectionHTML(k,rows){const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(k));return `<div class="day-section"><div class="day-heading">${label}</div><div class="cards">${rows.map(cardHTML).join("")}</div></div>`;}
function renderDaily(data){
  const today=dayKey(getSEDate().toISOString());
  const rows=data.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").innerHTML=rows.length?sectionHTML(today,rows):`<p>Inga aktiviteter idag.</p>`;
}

/* ===== Coachschema ===== */
function setupCoachSelect(data){
  const s=document.getElementById("coachSelect");
  s.innerHTML=`<option value="">-- V√§lj coach --</option>`;
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });
  s.onchange=()=>{const v=s.value;if(v)renderCoachWeek(DATA,v);};
}

/* ===== Lunch-regel + veckoschema ===== */
function renderCoachWeek(data,coach){
  const workDays=new Set(data.filter(r=>parseCoaches(r.Coach).includes(coach)).map(r=>dayKey(r.Datum)));
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach);
    const isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);

    // üí° Lunch-trumfar-Alla
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const isAllRow=isAll || (r.Deltagare||"").toLowerCase()==="alla";
    if(isLunch && isAllRow){
      const overlappingSpecific=data.some(x=>{
        const sameDay=dayKey(x.Datum)===dk;
        const sameTime=(x.Start===r.Start && x.Slut===r.Slut);
        const sameActivity=(x.Aktivitet||"").toLowerCase().includes("lunch");
        const notAll=(x.Coach||"").toLowerCase()!=="alla" && (x.Deltagare||"").toLowerCase()!=="alla";
        return sameDay&&sameTime&&sameActivity&&notAll;
      });
      if(overlappingSpecific)return false;
    }

    return cs.includes(coach)||(isAll&&workDays.has(dk));
  }).sort((a,b)=>{
    if(dayKey(a.Datum)===dayKey(b.Datum))return (a.Start||"").localeCompare(b.Start||"");
    return dayKey(a.Datum).localeCompare(dayKey(b.Datum));
  });
  const grouped=groupByDate(rows);
  document.getElementById("viewTitle").textContent="Coachschema ‚Äì "+coach;
  document.getElementById("schemaContainer").innerHTML=Object.keys(grouped).map(k=>sectionHTML(k,grouped[k])).join("")||`<p>Inga aktiviteter hittades.</p>`;
}

/* ===== Blockschema (kortare pass, tydliga ramar) ===== */
const SLOT_START="08:00",SLOT_END="16:30";
function makeSlots(){const out=[];let t=8*60;while(t<=16*60+30){out.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));t+=30;}return out;}
function weekdayIndex(d){const wd=new Date(d).getDay();return wd>=1&&wd<=5?wd:0;}
function timeToRowIndex(t,s){return s.indexOf(t)+1;}
function floorSlot(t){const[h,m]=t.split(":").map(Number);return`${String(h).padStart(2,"0")}:${m<30?"00":"30"}`;}
function renderCoachBlocks(data,coach){
  const slots=makeSlots();
  const workDays=new Set(data.filter(r=>parseCoaches(r.Coach).includes(coach)).map(r=>dayKey(r.Datum)));
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach);
    const isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);

    // üí° Lunch-trumfar-Alla
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const isAllRow=isAll||(r.Deltagare||"").toLowerCase()==="alla";
    if(isLunch && isAllRow){
      const overlappingSpecific=data.some(x=>{
        const sameDay=dayKey(x.Datum)===dk;
        const sameTime=(x.Start===r.Start && x.Slut===r.Slut);
        const sameActivity=(x.Aktivitet||"").toLowerCase().includes("lunch");
        const notAll=(x.Coach||"").toLowerCase()!=="alla" && (x.Deltagare||"").toLowerCase()!=="alla";
        return sameDay&&sameTime&&sameActivity&&notAll;
      });
      if(overlappingSpecific)return false;
    }

    return cs.includes(coach)||(isAll&&workDays.has(dk));
  });

  // Grid-layout
  const head=document.getElementById("blockHeader"),grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div><div>M√•ndag</div><div>Tisdag</div><div>Onsdag</div><div>Torsdag</div><div>Fredag</div>";
  grid.innerHTML="";
  slots.forEach(t=>{
    grid.innerHTML+=`<div class="block-time">${t}</div>`;
    for(let d=0;d<5;d++)grid.innerHTML+=`<div class="block-cell"></div>`;
  });
  const cells=[...grid.children];
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("viewTitle").textContent="Veckoblock ‚Äì "+coach+" (08:00‚Äì16:30)";

  rows.forEach(r=>{
    const wd=weekdayIndex(r.Datum);if(!wd)return;
    const start=floorSlot(r.Start||SLOT_START),end=floorSlot(r.Slut||SLOT_END);
    let sIdx=timeToRowIndex(start,slots),eIdx=timeToRowIndex(end,slots)-1;
    if(sIdx<1||eIdx<sIdx)return;
    const firstCellIndex=(sIdx-1)*(1+5)+wd,firstCell=cells[firstCellIndex];
    const slotsCovered=eIdx-sIdx+1;
    const durationMin=((+r.Slut?.split(":")[0])*60+(+r.Slut?.split(":")[1]||0))-((+r.Start?.split(":")[0])*60+(+r.Start?.split(":")[1]||0));
    const isShort=durationMin<=30;

    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);
    block.style.fontSize=isShort?".7rem":".85rem";
    const akt=r.Aktivitet||"Aktivitet";
    const deltagare=shrinkList(r.Deltagare,3);
    const coachDisplay=shrinkList(r.Coach,2);
    block.innerHTML=isShort?`<div><b>${akt}</b> ‚Äì ${deltagare}</div>`:`<div class="title">${akt}</div><div class="small">üë• ${deltagare}</div><div class="small">üßë‚Äçüè´ ${coachDisplay}</div>`;
    requestAnimationFrame(()=>{const h=firstCell.clientHeight||28;block.style.height=(slotsCovered*h-3)+"px";});
    firstCell.appendChild(block);
  });
}

/* ===== Sjukpanel, utskrift, knappar ===== */
function setupSickList(data){const c=document.getElementById("sickList");c.innerHTML="";[...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(co=>{const id="sick_"+co.replace(/\s+/g,"_");c.insertAdjacentHTML("beforeend",`<label><input type="checkbox" value="${co}" id="${id}"> ${co}</label>`);});}
function getSelectedSick(){return[...document.querySelectorAll("#sickList input:checked")].map(e=>e.value);}
document.getElementById("btnReload").onclick=loadData;
document.getElementById("btnDaily").onclick=()=>{document.getElementById("sickPanel").style.display="none";renderDaily(DATA);};
document.getElementById("btnCoach").onclick=()=>{document.getElementById("sickPanel").style.display="none";document.getElementById("coachSelect").style.display="inline-block";const v=document.getElementById("coachSelect").value;if(v)renderCoachWeek(DATA,v);};
document.getElementById("btnBlocks").onclick=()=>{const v=document.getElementById("coachSelect").value;if(v)renderCoachBlocks(DATA,v);};
document.getElementById("btnCards").onclick=()=>{const v=document.getElementById("coachSelect").value;if(v)renderCoachWeek(DATA,v);};
document.getElementById("btnSick").onclick=()=>{document.getElementById("sickPanel").style.display="block";};
document.getElementById("btnPrint").onclick=()=>{window.print();};

/* ===== Init ===== */
loadData();
setInterval(loadData,15*60*1000);
</script>

  background: #fff;
}
.block .title { font-weight: 700; margin-bottom: 2px; }
.block .small { font-size: .8rem; opacity: .95; }

/* ===== Utskrift ===== */
@media print {
  body { background: #fff; color: #000; font-size: 9pt; margin: 0; line-height: 1.2; }
  header, .toolbar, #sickPanel, #clock, #updated, #btnReload { display: none !important; }
  #viewTitle { text-align: center; font-size: 10pt; font-weight: bold; margin: 0 0 4px 0; }
  .cards, .card { display: none !important; }
  .block-wrap { display: block !important; }
  .block-header div { background: #eee !important; -webkit-print-color-adjust: exact; }
  .block { font-size: 8pt; line-height: 1.1; border: 1pt solid #000; }
  @page { size: A4 landscape; margin: 6mm; }
}
</style>
