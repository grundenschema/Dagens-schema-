<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grunden DV ‚Äì Schema</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #fafafa;
      position: relative;
    }
    header { position: relative; margin-bottom: 10px; }
    header h1 { margin: 0 0 6px 0; }
    header img {
      height: 60px;
      position: absolute;
      top: 0;
      right: 0;
    }
    #clock { font-family: monospace; font-size: 16px; margin: 6px 0 10px; }
    #updated { font-size: 0.9em; color: #555; margin-bottom: 10px; }

    nav { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
    button {
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    button.active { background: #1abc9c; }
    select {
      display: none;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
    }

    .table-container { overflow-x: auto; max-height: 70vh; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f2f2f2; }
    td.aktivitet { font-weight: bold; }
    .ended { opacity: 0.6; }

    .list-container { display: none; max-height: 70vh; overflow-y: auto; }
    .list-item {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      background: #fff;
    }
    .list-item strong { display: block; margin-bottom: 4px; }

    .day-section { margin-top: 22px; }
    .day-section h2 {
      margin: 0 0 6px 0;
      background: #f2f2f2;
      padding: 8px;
      border-radius: 8px;
    }

    @media (max-width: 600px) {
      .table-container { display: none; }
      .list-container { display: block; }
      header img { height: 40px; }
      h1 { font-size: 20px; }
      #clock { font-size: 14px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Grunden DV ‚Äì Schema</h1>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga"/>
  </header>

  <div id="clock"></div>
  <div id="updated"></div>

  <nav>
    <button id="btn-daily" class="active">üìÖ Dagens schema</button>
    <button id="btn-week">üóìÔ∏è Veckoschema</button>
    <select id="coach-filter">
      <option value="">V√§lj coach...</option>
    </select>
  </nav>

  <h2 id="view-title" style="margin:6px 0 10px;"></h2>

  <!-- Dagens vy -->
  <div id="daily-view">
    <div class="table-container">
      <table id="schema">
        <thead>
          <tr>
            <th>Start</th>
            <th>Slut</th>
            <th>Aktivitet</th>
            <th>Deltagare</th>
            <th>Coach</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="list-container" id="schema-list"></div>
  </div>

  <!-- Veckovy -->
  <div id="week-view" style="display:none;">
    <div id="week-content"></div>
  </div>

<script>
/* ===================== KONFIG ===================== */
const BASE_URL = "https://script.google.com/macros/s/AKfycbzGiAZqUnJsB27AB6Bs0XoNDA4_HOD7NH2OThtLJbjwG1NDTM9KKq5wEZGRspILfkp6/exec";

/* F√§rger (som i din gamla version). Vi f√§rgl√§gger efter aktivitetsNAMN,
   d√§rf√∂r strippar vi bort emoji n√§r vi sl√•r upp f√§rgen. */
const aktivitetFarger = {
  "M√•ndagsm√∂te":     {color:"#AED6F1", emoji:"üìÖ"},
  "Gruppm√∂te":       {color:"#7FB3D5", emoji:"üë•"},
  "Lunch":           {color:"#F9E79F", emoji:"üç≤"},
  "Frukost":         {color:"#FAD7A0", emoji:"ü•ê"},
  "Atelj√©":          {color:"#F5CBA7", emoji:"üé®"},
  "Musik":           {color:"#D2B4DE", emoji:"üé∂"},
  "Pod":             {color:"#A9CCE3", emoji:"üéôÔ∏è"},
  "Padel":           {color:"#82E0AA", emoji:"üèì"},
  "Lite av varje":   {color:"#FADBD8", emoji:"‚ú®"},
  "Yoga":            {color:"#D5F5E3", emoji:"üßò"},
  "Gym":             {color:"#A3E4D7", emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
  "Lunchpromenad":   {color:"#F7DC6F", emoji:"üö∂‚Äç‚ôÇÔ∏èüç≤"},
  "Kulturpromenad":  {color:"#F8C471", emoji:"üèõÔ∏èüö∂"},
  "Film":            {color:"#E6B0AA", emoji:"üé¨"},
  "Behandling":      {color:"#EDBB99", emoji:"üíÜ"},
  "Handla":          {color:"#ABEBC6", emoji:"üõçÔ∏è"},
  "G√•tr√§ning":       {color:"#76D7C4", emoji:"üö∂"},
  "Uppstart":        {color:"#F0B27A", emoji:"üöÄ"},
  "Poesigruppen":    {color:"#F1948A", emoji:"‚úçÔ∏è"},
  "Trummor":         {color:"#F1948A", emoji:"ü•Å"},
  "Rollspel":        {color:"#BB8FCE", emoji:"üêâ"},
  "√Öterkoppling":    {color:"#85C1E9", emoji:"üîÑ"},
  "Handling":        {color:"#73C6B6", emoji:"üõí"},
  "Medicin":         {color:"#E59866", emoji:"üíä"},
  "F√∂reningsgruppen":{color:"#D6DBDF", emoji:"ü§ù"},
  "√ñppen verkstad":  {color:"#F5B7B1", emoji:"üîß"},
  "Biljard":         {color:"#A9DFBF", emoji:"üé±"},
  "Spelgruppen":     {color:"#F8C471", emoji:"üé≤"},
  "S√∂mnad":          {color:"#F5EEF8", emoji:"üßµ"},
  "Filmkunskap":     {color:"#E6B0AA", emoji:"üé¨"},
  "Musikquizz":      {color:"#D2B4DE", emoji:"üé∂"},
  "Musikdokument√§r": {color:"#D2B4DE", emoji:"üé∂"}
};

/* ===================== HJ√ÑLP ===================== */
function getStockholmDate() {
  return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
}

/* Tar bort ledande emoji/ikoner s√• vi kan sl√• upp f√§rg p√• rena aktivitetsnamnet */
function normalizeActivity(label) {
  if (!label) return "";
  return String(label).replace(/^[^\w√Ö√Ñ√ñ√•√§√∂0-9]+/u, "").trim();
}

/* Dagens namn p√• svenska (index: 0=s√∂n ... 6=l√∂r) */
const svDays = ["S√∂ndag","M√•ndag","Tisdag","Onsdag","Torsdag","Fredag","L√∂rdag"];

/* Roterar en array s√• att index 'start' hamnar f√∂rst */
function rotate(arr, start) {
  return arr.slice(start).concat(arr.slice(0, start));
}

/* ===================== DAGENS SCHEMA ===================== */
async function showDaily() {
  setMode("daily");
  setTitle(""); // rubrik s√§tts av JSON
  setUpdated("");

  const tbody = document.querySelector("#schema tbody");
  const listContainer = document.getElementById("schema-list");
  tbody.innerHTML = "";
  listContainer.innerHTML = "";

  document.getElementById("view-title").textContent = "Laddar dagens schema...";

  try {
    const res = await fetch(`${BASE_URL}?mode=daily&t=${Date.now()}`);
    const json = await res.json();

    document.getElementById("view-title").textContent = json.date || "Dagens schema";
    if (json.updatedAt) setUpdated(`Senast uppdaterad: ${json.updatedAt}`);

    const now = getStockholmDate();
    const nowStr = now.toTimeString().slice(0,5);

    const aktiviteter = (json.data || []).map(row => {
      let status = "";
      if (row.slut <= nowStr) status = "‚ùå";
      else if (row.start <= nowStr && row.slut >= nowStr) status = "üü¢";
      return { ...row, status };
    });

    // sortera tidigt ‚Üí sent
    aktiviteter.sort((a,b) => (a.start || "").localeCompare(b.start || ""));

    // bygg tabell + mobilkort
    aktiviteter.forEach(act => {
      const rena = normalizeActivity(act.aktivitet);
      const farg = (aktivitetFarger[rena] || {}).color || "#fff";

      const tr = document.createElement("tr");
      if (act.status === "‚ùå") tr.classList.add("ended");
      tr.style.background = farg;
      tr.innerHTML = `
        <td>${act.start || ""}</td>
        <td>${act.slut || ""}</td>
        <td class="aktivitet">${act.status || ""} ${act.aktivitet || ""}</td>
        <td>${act.deltagare || ""}</td>
        <td>${act.coach || ""}</td>
      `;
      tbody.appendChild(tr);

      const div = document.createElement("div");
      div.className = "list-item" + (act.status === "‚ùå" ? " ended" : "");
      div.style.background = farg;
      div.innerHTML = `
        <strong>${act.start || ""}‚Äì${act.slut || ""} ${act.status || ""} ${act.aktivitet || ""}</strong>
        <div>üë• ${act.deltagare || ""}</div>
        <div>üéì ${act.coach || ""}</div>
      `;
      listContainer.appendChild(div);
    });
  } catch (err) {
    document.getElementById("view-title").textContent = "Fel: kunde inte h√§mta schemat";
    console.error(err);
  }
}

/* ===================== VECKOSCHEMA (per coach) ===================== */
async function showWeek(selectedCoach = "") {
  setMode("week");
  setTitle("Veckoschema");
  setUpdated("");

  const container = document.getElementById("week-content");
  container.innerHTML = "<p>Laddar veckoschema...</p>";

  try {
    const res = await fetch(`${BASE_URL}?mode=week&t=${Date.now()}`);
    const json = await res.json();

    if (json.updatedAt) setUpdated(`Senast uppdaterad: ${json.updatedAt}`);

    // Bygg coach-listan
    const allCoaches = new Set();
    (json.days || []).forEach(d => (d.data || []).forEach(r => {
      (String(r[4]||"").split(/,|&| och /i)).forEach(n => {
        const t = n.trim();
        if (t) allCoaches.add(t);
      });
    }));
    const coachFilter = document.getElementById("coach-filter");
    coachFilter.innerHTML = `<option value="">V√§lj coach...</option>`;
    [...allCoaches].sort((a,b)=>a.localeCompare(b,'sv')).forEach(c => {
      coachFilter.innerHTML += `<option value="${c}">${c}</option>`;
    });
    if (selectedCoach) coachFilter.value = selectedCoach;

    // Ordning p√• dagar: vardag ‚Üí dagens dag f√∂rst; helg ‚Üí b√∂rja p√• M√•ndag
    const today = getStockholmDate();
    const jsDay = today.getDay(); // 0=s√∂n ... 6=l√∂r
    const weekOrder = ["M√•ndag","Tisdag","Onsdag","Torsdag","Fredag"];
    const startIdx = (jsDay === 0 || jsDay === 6) ? 0 : (jsDay - 1); // helg ‚Üí 0, annars m√•ndag=0, tis=1...
    const displayOrder = rotate(weekOrder, startIdx);

    // render
    const daysByName = Object.fromEntries((json.days||[]).map(d => [d.date, d.data || []]));
    container.innerHTML = "";

    let showedAny = false;
    displayOrder.forEach(dayName => {
      const rows = (daysByName[dayName] || []).slice().sort((a,b) => (a[0]||"").localeCompare(b[0]||""));
      // filtrera per coach (visa alltid ‚ÄúAlla‚Äù)
      const filtered = rows.filter(r => {
        if (!selectedCoach) return true;
        const tokens = String(r[4]||"").toLowerCase().split(/,|&| och /i).map(s => s.trim());
        return tokens.includes(selectedCoach.toLowerCase()) || tokens.includes("alla");
      });
      if (filtered.length === 0) return;

      showedAny = true;
      const section = document.createElement("div");
      section.className = "day-section";
      section.innerHTML = `
        <h2>${dayName}${selectedCoach ? ` ‚Äì ${selectedCoach}` : ""}</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      `;
      const tbody = section.querySelector("tbody");

      filtered.forEach(r => {
        const aktivitet = r[2] || "";
        const rena = normalizeActivity(aktivitet);
        const farg = (aktivitetFarger[rena] || {}).color || "#fff";
        const tr = document.createElement("tr");
        tr.style.background = farg;
        tr.innerHTML = `
          <td>${r[0]||""}</td>
          <td>${r[1]||""}</td>
          <td class="aktivitet">${aktivitet}</td>
          <td>${r[3]||""}</td>
          <td>${r[4]||""}</td>
        `;
        tbody.appendChild(tr);
      });

      container.appendChild(section);
    });

    if (!showedAny) container.innerHTML = "<p>Inget schema hittades f√∂r vald coach.</p>";
  } catch (err) {
    container.innerHTML = "<p>Fel: kunde inte h√§mta veckoschemat.</p>";
    console.error(err);
  }
}

/* ===================== UI-styrning ===================== */
function setMode(mode) {
  const btnDaily = document.getElementById("btn-daily");
  const btnWeek  = document.getElementById("btn-week");
  const dailyView = document.getElementById("daily-view");
  const weekView  = document.getElementById("week-view");
  const coachFilter = document.getElementById("coach-filter");

  const isDaily = (mode === "daily");
  btnDaily.classList.toggle("active", isDaily);
  btnWeek.classList.toggle("active", !isDaily);
  dailyView.style.display = isDaily ? "block" : "none";
  weekView.style.display = isDaily ? "none" : "block";
  coachFilter.style.display = !isDaily ? "inline-block" : "none";
}

function setTitle(text) {
  document.getElementById("view-title").textContent = text || "";
}
function setUpdated(text) {
  document.getElementById("updated").textContent = text || "";
}

/* ===================== KLOCKA ===================== */
function updateClock() {
  const now = getStockholmDate();
  const options = {
    weekday:"long", year:"numeric", month:"long", day:"numeric",
    hour:"2-digit", minute:"2-digit", second:"2-digit", timeZone:"Europe/Stockholm"
  };
  document.getElementById("clock").textContent =
    new Intl.DateTimeFormat("sv-SE", options).format(now);
}
setInterval(updateClock, 1000);
updateClock();

/* ===================== H√ÑNDELSER ===================== */
document.getElementById("btn-daily").addEventListener("click", showDaily);
document.getElementById("btn-week").addEventListener("click", () => showWeek());
document.getElementById("coach-filter").addEventListener("change", e => showWeek(e.target.value));

/* Startvy + auto-uppdatering f√∂r dagens schema */
showDaily();
setInterval(showDaily, 30 * 60 * 1000); // var 30:e minut
</script>
</body>
</html>
