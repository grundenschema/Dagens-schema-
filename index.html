<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schema ‚Äì Deltagare & Coacher</title>

<style>
:root{
  --bg:#fafafa;
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 3px 10px rgba(0,0,0,.06);
  --radius:14px;
  --muted:#555;
  --band:#9ecbff;
  --header-bg:#f5f7fa;
  --chip-bg:#f8fafc;
  --chip-border:#cfd8e3;
  --chip-active:#3b82f6;
  --chip-text:#1f2937;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1800px;
  margin:0 auto;
  padding:16px;
}
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  margin-bottom:12px;
  cursor:pointer;
}
header img{height:60px;width:auto;}
#clock{font-weight:600;color:#333;font-size:1.1rem;letter-spacing:.5px}
.toolbar{
  display:flex;flex-direction:column;
  gap:10px;align-items:center;justify-content:center;
  margin:12px 0 16px;
}
.toolbar-row{
  display:flex;flex-wrap:wrap;
  gap:10px;justify-content:center;align-items:center;
}
button,select{
  font-size:1rem;padding:10px 16px;
  border-radius:12px;border:1px solid #cfd8e3;
  background:#fff;cursor:pointer;
  transition:.15s background,.15s transform;
}
button:hover{background:#eef2f7}
button:active{transform:translateY(1px)}
select{min-width:220px;background:#fff}
#viewTitle{text-align:center;margin:10px 0 8px;font-weight:700;}
.cards{
  display:flex;flex-direction:column;
  gap:10px;max-width:1100px;margin:0 auto;
}
.card{
  position:relative;background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px 14px;box-shadow:var(--shadow);
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;
  background:var(--band,#9ecbff);
  border-radius:var(--radius) 0 0 var(--radius);
}
.card h3{margin:0 0 6px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

/* Veckoschema (liggande) */
#blockContainer{display:none;margin-top:6px;}
.block-header{
  display:grid;grid-template-columns:80px repeat(5,1fr);
  font-weight:800;font-size:.92rem;
  background:var(--header-bg);
  border-radius:10px 10px 0 0;text-transform:capitalize;
}
.block-header div{text-align:center;padding:8px 0;}
.block-grid{
  display:grid;grid-template-columns:80px repeat(5,1fr);
  background:transparent;
}
.block-time{
  font-size:.86rem;padding:4px 6px;
  text-align:right;color:#2b2b2b;
}
.block-cell{position:relative;min-height:28px;background:transparent;}
.block{
  position:absolute;left:2px;right:2px;top:2px;
  border-radius:10px;padding:6px 8px;line-height:1.25;
  border:1px solid #bbb;font-size:.82rem;
  color:#111;box-shadow:var(--shadow);
  overflow:hidden;word-break:break-word;
}
.block .title{font-weight:700}

/* J√§mf√∂relsevy */
.schema-wrap{
  display:flex;flex-direction:column;
  gap:20px;align-items:center;
}
.schema{
  width:95%;max-width:1100px;
  background:#fff;border:1px solid #ccc;
  border-radius:14px;padding:10px;
  box-shadow:var(--shadow);
}
.schema h3{margin:6px 0 10px;text-align:center;font-size:1.05rem}

/* Utskrift */
@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,#nowContainer,.panel{display:none!important;}
  #schemaContainer,#blockContainer{display:none!important;}
  .print-visible{display:block!important;}
  .schema{page-break-inside:avoid;}
  @page{size:A4 landscape;margin:6mm;}
}

/* Responsiv */
@media (max-width:760px){
  body{padding:8px}
  .toolbar-row{gap:8px}
  button,select{width:95%;font-size:1.05rem}
  .schema{min-width:92vw}
}
</style>
</head>
<body>
<header onclick="showNowAndNext()">
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logo">
  <div id="clock"></div>
</header>

<!-- Knappar -->
<div class="toolbar">
  <div class="toolbar-row">
    <button id="btnParticipant">Deltagarschema</button>
    <button id="btnCoach">Coachschema</button>
    <div class="dropdown" id="scheduleDropdown">
      <button id="btnSchedule">üìÖ Schemal√§ggning ‚ñº</button>
      <div class="dropdown-content" style="display:none;">
        <button id="btnCompare">üîç J√§mf√∂r scheman</button>
        <button id="btnSick">ü©∫ Hitta ers√§ttare</button>
      </div>
    </div>
  </div>

  <div class="toolbar-row">
    <button id="btnCards">Dagens schema</button>
    <button id="btnBlocks">Veckoschema</button>
    <button id="btnNow">P√•g√•r nu</button>
  </div>

  <div class="toolbar-row">
    <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
    <select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>
  </div>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer" class="print-scope"></div>
<div id="blockContainer" class="print-scope">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div style="text-align:center;margin-top:10px;">
    <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
  </div>
</div>
<div id="nowContainer"></div>
<script>
/* ======= KONFIGURATION ======= */
const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";
let DATA = [];

/* ======= LADDA DATA ======= */
async function loadData() {
  try {
    const res = await fetch(url + "?t=" + Date.now());
    const json = await res.json();
    DATA = json.data || [];
    fillLists();
    showNowAndNext(); // visa direkt vid start
  } catch (e) {
    console.error("Fel vid laddning av data:", e);
  }
}
loadData();

/* ======= KLOCKA ======= */
function updateClock() {
  const el = document.getElementById("clock");
  if (!el) return;
  const now = new Date();
  el.textContent = now.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });
}
setInterval(updateClock, 1000);
updateClock();

/* ======= SKAPA LISTOR ======= */
function uniqueTokens(field) {
  return [...new Set(DATA.map(r => (r[field] || "").split(/,|\/|;|\n/).map(x => x.trim())).flat())]
    .filter(x => x && x.toLowerCase() !== "alla")
    .sort();
}

function fillLists() {
  const n = document.getElementById("nameSelect");
  const c = document.getElementById("coachSelect");
  n.innerHTML = '<option value="">-- V√§lj deltagare --</option>';
  c.innerHTML = '<option value="">-- V√§lj coach --</option>';
  uniqueTokens("Deltagare").forEach(v => n.innerHTML += `<option>${v}</option>`);
  uniqueTokens("Coach").forEach(v => c.innerHTML += `<option>${v}</option>`);
}

/* ======= HJ√ÑLPFUNKTIONER ======= */
function dayKey(s) { return String(s).slice(0, 10); }
function todayKey() { return new Date().toISOString().slice(0, 10); }
function hideAll() { ["schemaContainer", "blockContainer", "nowContainer"].forEach(id => document.getElementById(id).style.display = "none"); }

/* ======= P√ÖG√ÖR NU ======= */
function showNowAndNext() {
  hideAll();
  const cont = document.getElementById("nowContainer");
  const today = todayKey();
  const now = new Date();
  const mins = now.getHours() * 60 + now.getMinutes();
  const all = DATA.filter(r => dayKey(r.Datum) === today);
  const ongo = all.filter(r => {
    const [sH, sM] = (r.Start || "00:00").split(":").map(Number);
    const [eH, eM] = (r.Slut || "00:00").split(":").map(Number);
    const s = sH * 60 + sM, e = eH * 60 + eM;
    return mins >= s && mins <= e;
  });
  const next = all.filter(r => {
    const [sH, sM] = (r.Start || "00:00").split(":").map(Number);
    const s = sH * 60 + sM;
    return s > mins;
  });

  const label = new Intl.DateTimeFormat("sv-SE", { weekday: "long", day: "numeric", month: "long" }).format(now);
  const time = now.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });

  let html = `<h2 style="text-align:center;margin-bottom:8px">‚è±Ô∏è ${label} ‚Äì kl. ${time}</h2>`;
  html += `<h3 style="text-align:center;margin:8px 0 6px">P√•g√•r nu</h3>`;
  if (!ongo.length) html += "<p style='text-align:center'>Inga aktiviteter p√•g√•r just nu.</p>";
  else {
    html += `<div class="cards">` + ongo.map(r => `
      <div class="card" style="--band:#9ecbff">
        <h3>üìò ${r.Aktivitet || "Aktivitet"}</h3>
        <div class="row">üïí ${r.Start || ""}‚Äì${r.Slut || ""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach || "-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare || "-"}</div>
      </div>`).join("") + `</div>`;
  }

  html += `<h3 style="text-align:center;margin:12px 0 6px">Kommande idag</h3>`;
  if (!next.length) html += "<p style='text-align:center'>Inget mer planerat idag.</p>";
  else {
    html += `<div class="cards">` + next.map(r => `
      <div class="card" style="--band:#d3eaff">
        <h3>üìò ${r.Aktivitet || "Aktivitet"}</h3>
        <div class="row">üïí ${r.Start || ""}‚Äì${r.Slut || ""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach || "-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare || "-"}</div>
      </div>`).join("") + `</div>`;
  }

  cont.innerHTML = html;
  cont.style.display = "block";
}

/* ======= DROPDOWN SCHEMAL√ÑGGNING ======= */
document.getElementById("btnSchedule").addEventListener("click", () => {
  const d = document.querySelector("#scheduleDropdown .dropdown-content");
  d.style.display = (d.style.display === "none" || d.style.display === "") ? "block" : "none";
});
</script>
<script>
/* ========= FUNKTIONER F√ñR SCHEMARITNING ========= */
function makeSlots(){
  const s=[];
  for(let h=8;h<=16;h++) s.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);
  s.push("16:30");
  return s;
}

/* Visa veckoschema */
function renderBlocks(name,isCoach){
  hideAll();
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=(r[field]||"").toLowerCase();
    return list.includes(name.toLowerCase())||(r[field]||"").trim().toLowerCase()==="alla";
  }).sort((a,b)=>(a.Datum||"").localeCompare(b.Datum||"")||(a.Start||"").localeCompare(b.Start||""));

  const slots=makeSlots(), days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
  grid.innerHTML="";
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{
    grid.innerHTML+=`<div class="block-time">${t}</div>`+days.map(()=>`<div class="block-cell"></div>`).join("");
  });

  const cells=[...grid.children];
  rows.forEach(r=>{
    const wd=new Date(r.Datum).getDay();
    if(wd===0||wd===6)return;
    const col=(wd-1)+1;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,cell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";
    block.style.background="#dff0ff";

    // l√§ngd i minuter
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const dur=(eh*60+em)-(sh*60+sm);

    if(dur<=30){
      block.innerHTML=`${r.Aktivitet||""} ‚Äì ${isCoach?("üë• "+(r.Deltagare||"-")):("üßë‚Äçüè´ "+(r.Coach||"-"))}`;
    }else{
      block.innerHTML=`<div class="title">${r.Aktivitet||""}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?("üë• "+(r.Deltagare||"-")):("üßë‚Äçüè´ "+(r.Coach||"-"))}`;
    }
    requestAnimationFrame(()=>{
      const cellH=cell.clientHeight||28;
      block.style.height=(eIdx-sIdx)*cellH+"px";
    });
    cell.appendChild(block);
  });

  document.getElementById("blockContainer").style.display="block";
  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
}

/* Dagens korta schema */
function renderCards(name,isCoach){
  hideAll();
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=(r[field]||"").toLowerCase();
    return dayKey(r.Datum)===today&&(list.includes(name.toLowerCase())||(r[field]||"").trim().toLowerCase()==="alla");
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  let html="<div class='cards'>";
  if(!rows.length)html+="<p>Inga aktiviteter idag.</p>";
  else rows.forEach(r=>{
    html+=`<div class="card"><h3>${r.Aktivitet||"Aktivitet"}</h3>
    <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
    <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div></div>`;
  });
  html+="</div>";
  const sc=document.getElementById("schemaContainer");
  sc.innerHTML=html;sc.style.display="block";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

/* ======= J√ÑMF√ñRELSE ======= */
document.getElementById("btnCompare").onclick=()=>{
  hideAll();
  const cont=document.getElementById("schemaContainer");
  cont.innerHTML="<h2 style='text-align:center'>J√§mf√∂r scheman</h2>";
  const names=prompt("Skriv namn separerade med kommatecken:");
  if(!names)return;
  const arr=names.split(",").map(x=>x.trim()).filter(Boolean);
  let html="";
  arr.forEach(n=>{
    html+=`<div class="schema">`;
    html+=`<h3>${n}</h3>`;
    html+=`<div id="cmp_${n.replace(/\s/g,'_')}"></div>`;
    html+=`</div>`;
  });
  cont.innerHTML+=html;
  cont.style.display="block";
  arr.forEach(n=>{
    const div=document.getElementById(`cmp_${n.replace(/\s/g,'_')}`);
    const wrap=document.createElement("div");
    wrap.className="block-grid";
    const slots=makeSlots(),days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
    wrap.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
    slots.forEach(t=>{
      wrap.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");
    });
    const cells=[...wrap.children];
    const rows=DATA.filter(r=>{
      const list=(r.Deltagare||"").toLowerCase()+" "+(r.Coach||"").toLowerCase();
      return list.includes(n.toLowerCase());
    });
    rows.forEach(r=>{
      const wd=new Date(r.Datum).getDay();
      if(wd===0||wd===6)return;
      const col=(wd-1)+1;
      const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
      if(sIdx<0||eIdx<=sIdx)return;
      const i=sIdx*(1+days.length)+col,cell=cells[i];
      const b=document.createElement("div");
      b.className="block";
      b.style.background="#f4faff";
      b.innerHTML=`<div class='title'>${r.Aktivitet}</div>${r.Start}-${r.Slut}`;
      cell.appendChild(b);
    });
    div.appendChild(wrap);
  });
};

/* ======= UTSKRIFT ======= */
document.getElementById("btnPrint").onclick=()=>{
  document.querySelectorAll('.print-scope').forEach(e=>e.classList.remove('print-visible'));
  if(document.getElementById("blockContainer").style.display==="block"){
    document.getElementById("blockContainer").classList.add("print-visible");
  }else{
    document.getElementById("schemaContainer").classList.add("print-visible");
  }
  window.print();
};

/* ======= KNAPPAR ======= */
document.getElementById("btnParticipant").onclick=()=>{
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
};
document.getElementById("btnCoach").onclick=()=>{
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
};
document.getElementById("btnCards").onclick=()=>{
  const isCoach=document.getElementById("coachSelect").style.display!=="none";
  const n=isCoach?document.getElementById("coachSelect").value:document.getElementById("nameSelect").value;
  if(n)renderCards(n,isCoach);
};
document.getElementById("btnBlocks").onclick=()=>{
  const isCoach=document.getElementById("coachSelect").style.display!=="none";
  const n=isCoach?document.getElementById("coachSelect").value:document.getElementById("nameSelect").value;
  if(n)renderBlocks(n,isCoach);
};
document.getElementById("btnNow").onclick=()=>showNowAndNext();
</script>
</body>
</html>
