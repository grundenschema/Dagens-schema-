<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Schema ‚Äì Deltagare & Coacher</title>
<style>
/* =============================
   üåô M√ñRK DASHBOARD-STIL
   ============================= */
:root {
  --bg-main: #1e1f25;
  --bg-panel: #2a2c33;
  --bg-card: #32343b;
  --text-main: #e9e9eb;
  --text-muted: #9a9a9a;
  --accent: #3a7afe;
  --border: #3b3d45;
  --radius: 14px;
  --shadow: 0 4px 10px rgba(0,0,0,.25);
  --hover: #3a3c44;
}

/* ===== GLOBAL ===== */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg-main);
  color:var(--text-main);
  margin:0 auto;
  max-width:1800px;
  padding:16px;
}
h1,h2,h3,h4{font-weight:600}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
small{color:var(--text-muted)}

/* ===== HEADER ===== */
header{
  text-align:center;
  margin-bottom:16px;
}
h1{
  font-size:1.6rem;
  letter-spacing:.3px;
}

/* ===== TOOLBAR ===== */
.toolbar{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:10px;
  padding:16px;
  background:var(--bg-panel);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
button,select{
  font-size:1rem;
  padding:10px 16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  transition:all .18s ease;
  color:var(--text-main);
  background:var(--bg-card);
  box-shadow:inset 0 0 0 1px var(--border);
}
button:hover,select:hover{
  background:var(--hover);
  transform:translateY(-1px);
  box-shadow:0 3px 8px rgba(0,0,0,.4);
}
button:active{transform:translateY(0);box-shadow:inset 0 0 0 1px var(--border);}
select{min-width:220px}
button span.icon{margin-right:6px}

/* ===== VIEW TITLE ===== */
#viewTitle{
  text-align:center;
  margin:12px 0;
  color:var(--text-muted);
  font-weight:500;
}

/* ===== CARDS ===== */
.cards{
  display:flex;
  flex-direction:column;
  gap:12px;
  max-width:900px;
  margin:0 auto;
}
.card{
  position:relative;
  background:var(--bg-card);
  border-radius:var(--radius);
  padding:12px 16px;
  box-shadow:var(--shadow);
}
.card::before{
  content:"";
  position:absolute;
  left:0;top:0;bottom:0;
  width:6px;
  background:var(--accent);
  border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 4px;font-size:1.05rem}
.card .row{font-size:.9rem;color:var(--text-muted)}

/* ===== WEEK VIEW ===== */
.week-view{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:18px;
  margin:0 auto;
  padding:10px;
}
.day-col{
  flex:1 1 260px;
  min-width:240px;
  max-width:300px;
  background:var(--bg-panel);
  border-radius:var(--radius);
  padding:12px 14px;
  box-shadow:var(--shadow);
}
.day-col h4{
  text-align:center;
  margin-bottom:10px;
  font-size:1rem;
  color:var(--text-main);
  border-bottom:1px solid var(--border);
  padding-bottom:6px;
}

/* ===== ACTIVITY BLOCKS ===== */
.block{
  background:var(--bg-card);
  color:var(--text-main);
  border-radius:10px;
  padding:8px 10px;
  margin-bottom:10px;
  box-shadow:0 3px 8px rgba(0,0,0,.3);
  transition:background .2s ease,transform .15s ease;
}
.block:hover{
  background:var(--hover);
  transform:translateY(-1px);
}
.block .title{
  font-weight:600;
  color:#fff;
  font-size:.9rem;
}
.block .meta{
  font-size:.8rem;
  color:var(--text-muted);
  margin-top:3px;
}

/* ===== PANELS ===== */
.helper-panels{max-width:1000px;margin:0 auto}
.panel{
  display:none;
  background:var(--bg-panel);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
.panel h2{color:var(--text-main);margin-bottom:12px;}
.list-two-col{
  display:flex;
  gap:30px;
  justify-content:center;
  flex-wrap:wrap;
}
.list-two-col>div{min-width:240px}

/* ===== RESPONSIVE ===== */
@media(max-width:760px){
  body{padding:8px}
  .toolbar{flex-direction:column;align-items:stretch}
  button,select{width:100%;font-size:1.05rem}
  .week-view{flex-direction:column;align-items:center}
}

/* ===== PRINT ===== */
@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,.helper-panels,#schemaContainer{display:none!important;}
  .week-view{
    display:block!important;
    color:#000;
    background:#fff;
  }
  .day-col{
    background:#fff;
    box-shadow:none;
    border:1px solid #ccc;
    margin-bottom:8px;
  }
  .block{
    background:#f9f9f9;
    color:#000;
    box-shadow:none;
  }
  @page{size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <h1>Schema ‚Äì Deltagare & Coacher</h1>
  <small>Veckoschema med flervy, p√•g√•ende vy och ers√§ttarplanering</small>
</header>

<div class="toolbar">
  <button id="btnParticipant"><span class="icon">üßç‚Äç‚ôÇÔ∏è</span>Deltagarschema</button>
  <button id="btnCoach"><span class="icon">üßë‚Äçüè´</span>Coachschema</button>
  <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
  <select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>
  <button id="btnCards">üìÖ Dagens schema</button>
  <button id="btnBlocks">üìÜ Veckoschema</button>
  <button id="btnNow">‚è±Ô∏è P√•g√•r just nu</button>
  <button id="btnCompare">üîç J√§mf√∂r scheman</button>
  <button id="btnSick">ü©∫ Hitta ers√§ttare</button>
  <button id="btnPrint" style="display:none">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>
<div id="nowContainer"></div>

<div class="helper-panels">
  <div id="comparePanel" class="panel">
    <h2>J√§mf√∂r scheman</h2>
    <div class="list-two-col">
      <div><h3>Coacher</h3><div id="coachListCompare"></div></div>
      <div><h3>Deltagare</h3><div id="participantListCompare"></div></div>
    </div>
    <button id="btnShowCompare">Visa valda scheman</button>
  </div>

  <div id="sickPanel" class="panel">
    <h2>Hitta ers√§ttare f√∂r sjuk coach</h2>
    <select id="sickCoachSelect"><option value="">-- V√§lj sjuk coach --</option></select>
    <div id="sickResult" style="margin-top:14px;"></div>
  </div>
</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
  "M√•ndagsm√∂te":"#AED6F1","Gruppm√∂te":"#7FB3D5","Lunch":"#F9E79F","Frukost":"#FAD7A0",
  "Atelj√©":"#F5CBA7","Musik":"#D2B4DE","Pod":"#A9CCE3","Padel":"#82E0AA",
  "Lite av varje":"#FADBD8","Yoga":"#D5F5E3","Gym":"#A3E4D7","Film":"#E6B0AA",
  "F√∂reningsgruppen":"#D6DBDF","Trummor":"#F1948A","√Öterkoppling":"#85C1E9",
  "Medicin":"#E59866","Biljard":"#A9DFBF","Spelgruppen":"#F8C471","S√∂mnad":"#F5EEF8",
  "Filmgruppen":"#E6B0AA","Musikquizz":"#D2B4DE","Musikdokument√§r":"#D2B4DE",
  "Warhammer":"#C39BD3","Utflykt":"#A9CCE3","Uppstart Taket":"#AED6F1"
};
function colorFor(r){return aktivitetFarger[r.Aktivitet]||"#555";}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList();fillCoachList();fillCompareLists();
    document.getElementById("sickCoachSelect").innerHTML='<option value="">-- V√§lj sjuk coach --</option>'+
      [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
      .filter(x=>x&&x.toLowerCase()!=="alla").sort().map(c=>`<option>${c}</option>`).join("");
  }catch(e){console.error(e);}
}
loadData();

/* ---------- LISTOR ---------- */
function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
      const o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);
    });
}
function fillCoachList(){
  const s=document.getElementById("coachSelect");
  s.innerHTML='<option value="">-- V√§lj coach --</option>';
  [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
      const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
    });
}
function fillCompareLists(){
  const cList=document.getElementById("coachListCompare");
  const pList=document.getElementById("participantListCompare");
  cList.innerHTML="";pList.innerHTML="";
  [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
      cList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-coach" value="${c}"> ${c}</label><br>`);
    });
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
      pList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-delt" value="${n}"> ${n}</label><br>`);
    });
}

/* ---------- RESET-VIEW ---------- */
function resetView(){
  document.querySelectorAll("#schemaContainer,#nowContainer,#comparePanel,#sickPanel")
    .forEach(el=>{el.style.display="none";});
  document.getElementById("btnPrint").style.display="none";
}

/* ---------- HJ√ÑLPFUNKTIONER ---------- */
function applyLunchRule(rows,name,isCoach){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const field=isCoach?"Coach":"Deltagare";
    const isAll=(r[field]||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&(x.Aktivitet||"").toLowerCase().includes("lunch")&&(x[field]||"").toLowerCase().includes(name.toLowerCase()));
      if(specific)return false;
    }
    return true;
  });
}
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
const weekdayNames=["S√∂ndag","M√•ndag","Tisdag","Onsdag","Torsdag","Fredag","L√∂rdag"];

/* ---------- VISNINGAR ---------- */
function renderCards(name,isCoach){
  resetView();
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(
    DATA.filter(r=>{
      const str=(r[field]||"").toLowerCase();
      return str.includes(name.toLowerCase())||str==="alla";
    }),name,isCoach).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  let html=`<div class='cards'>`;
  if(!rows.length)html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--accent:${colorFor(r)}">
      <h3>${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}
function renderBlocks(name,isCoach){
  resetView();
  const days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach);
  let html=`<div class='week-view'>`;
  days.forEach(d=>{
    const dayRows=rows.filter(r=>dayKey(r.Datum)===d)
      .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
    const dayName=weekdayNames[new Date(d).getDay()];
    html+=`<div class="day-col"><h4>${dayName}</h4>`;
    if(!dayRows.length){html+=`<p style="color:var(--text-muted)">Inga aktiviteter</p>`;}
    dayRows.forEach(r=>{
      html+=`<div class="block" style="background:${colorFor(r)}">
        <div class="title">${r.Aktivitet||""}</div>
        <div class="meta">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="meta">${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}</div>
      </div>`;
    });
    html+=`</div>`;
  });
  html+=`</div>`;
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
}

/* ---------- P√ÖG√ÖR NU ---------- */
document.getElementById("btnNow").onclick=()=>{
  resetView();
  const now=new Date();
  const minsNow=now.getHours()*60+now.getMinutes();
  const today=todayKey();
  const active=DATA.filter(r=>{
    if(dayKey(r.Datum)!==today)return false;
    const[sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const[eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const s=sh*60+sm,e=eh*60+em;
    return minsNow>=s&&minsNow<=e;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const cont=document.getElementById("nowContainer");
  cont.innerHTML=`<h2 style="text-align:center">‚è±Ô∏è P√•g√•r just nu</h2>`;
  if(!active.length)cont.innerHTML+=`<p style="text-align:center">Inga aktiviteter p√•g√•r just nu.</p>`;
  else cont.innerHTML+=`<div class="cards">`+
    active.map(r=>`<div class="card" style="--accent:${colorFor(r)}"><h3>${r.Aktivitet}</h3><div class="row">üïí ${r.Start}‚Äì${r.Slut}</div><div class="row">üßë‚Äçüè´ ${r.Coach||"-"}</div><div class="row">üë• ${r.Deltagare||"-"}</div></div>`).join("")+
    `</div>`;
  cont.style.display="block";
  document.getElementById("viewTitle").textContent="P√•g√•r just nu";
};

/* ---------- HITTA ERS√ÑTTARE ---------- */
document.getElementById("btnSick").onclick=()=>{
  resetView();
  document.getElementById("sickPanel").style.display="block";
  document.getElementById("viewTitle").textContent="Hitta ers√§ttare";
};
function overlap(s1,e1,s2,e2){return !(e1<=s2||s1>=e2);}
document.getElementById("sickCoachSelect").onchange=()=>{
  const coach=document.getElementById("sickCoachSelect").value;
  if(!coach)return;
  const allDays=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const otherCoaches=[...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla"&&x!==coach);
  let html="";
  allDays.forEach(d=>{
    const dayRows=DATA.filter(r=>dayKey(r.Datum)===d&&(r.Coach||"").toLowerCase().includes(coach.toLowerCase()));
    if(!dayRows.length)return;
    const dayName=weekdayNames[new Date(d).getDay()];
    html+=`<h3 style="margin-top:16px">${dayName}</h3>`;
    dayRows.forEach(r=>{
      const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
      const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
      const s1=sh*60+sm,e1=eh*60+em;
      const free=otherCoaches.filter(c=>{
        return !DATA.some(o=>{
          if(dayKey(o.Datum)!==d)return false;
          if(!(o.Coach||"").toLowerCase().includes(c.toLowerCase()))return false;
          const[os,om]=(o.Start||"00:00").split(":").map(Number);
          const[oe,om2]=(o.Slut||"00:00").split(":").map(Number);
          const s2=os*60+om,e2=oe*60+om2;
          return overlap(s1,e1,s2,e2);
        });
      });
      html+=`<div class="block" style="background:${colorFor(r)}">
        <div class="title">${r.Aktivitet||""} (${r.Start}‚Äì${r.Slut})</div>
        <div class="meta">üë• ${r.Deltagare||"-"}</div>
        <div class="meta">üí° Lediga vikarier: ${free.length?free.join(", "):"‚Äì Inga lediga"}</div>
      </div>`;
    });
  });
  document.getElementById("sickResult").innerHTML=html||"<p>Inga pass hittades f√∂r den valda coachen.</p>";
};

/* ---------- J√ÑMF√ñR SCHEMAN ---------- */
document.getElementById("btnCompare").onclick=()=>{
  resetView();
  document.getElementById("comparePanel").style.display="block";
  document.getElementById("viewTitle").textContent="J√§mf√∂r scheman";
};
document.getElementById("btnShowCompare").onclick=()=>{
  const selectedNames=[...document.querySelectorAll(".chk-delt:checked"),...document.querySelectorAll(".chk-coach:checked")]
    .map(cb=>({name:cb.value,isCoach:cb.classList.contains("chk-coach")}));
  if(!selectedNames.length){alert("V√§lj minst en person f√∂rst.");return;}
  resetView();
  const wrap=document.createElement("div");wrap.className="week-view";
  selectedNames.forEach(sel=>{
    const div=document.createElement("div");div.className="day-col";
    div.innerHTML=`<h4>${sel.isCoach?"Coach: ":"Deltagare: "}${sel.name}</h4>`;
    const field=sel.isCoach?"Coach":"Deltagare";
    const days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
    days.forEach(d=>{
      const rows=applyLunchRule(DATA.filter(r=>{
        const str=(r[field]||"").toLowerCase();
        return (str.includes(sel.name.toLowerCase())||str==="alla")&&dayKey(r.Datum)===d;
      }),sel.name,sel.isCoach);
      if(!rows.length)return;
      const dayName=weekdayNames[new Date(d).getDay()];
      div.innerHTML+=`<h5 style="color:var(--text-muted);margin-top:6px;">${dayName}</h5>`;
      rows.forEach(r=>{
        div.innerHTML+=`<div class="block" style="background:${colorFor(r)}">
          <div class="title">${r.Aktivitet}</div>
          <div class="meta">${r.Start||""}‚Äì${r.Slut||""}</div>
          <div class="meta">${sel.isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}</div>
        </div>`;
      });
    });
    wrap.appendChild(div);
  });
  document.getElementById("schemaContainer").innerHTML="";
  document.getElementById("schemaContainer").appendChild(wrap);
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
  document.getElementById("viewTitle").textContent="J√§mf√∂r scheman";
};

/* ---------- KNAPPHANTERING ---------- */
document.getElementById("btnParticipant").onclick=()=>{
  resetView();
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
  resetView();
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
  const n=document.getElementById("nameSelect").style.display!=="none"?document.getElementById("nameSelect").value:document.getElementById("coachSelect").value;
  if(n)renderCards(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnBlocks").onclick=()=>{
  const n=document.getElementById("nameSelect").style.display!=="none"?document.getElementById("nameSelect").value:document.getElementById("coachSelect").value;
  if(n)renderBlocks(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnPrint").onclick=()=>{window.print();};
</script>
</body>
</html>
<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

/* üé® F√§rg + emoji per aktivitet */
const aktivitetFarger={
 "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},
 "Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
 "Lunch":{color:"#F9E79F",emoji:"üç≤"},
 "Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
 "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},
 "Musik":{color:"#D2B4DE",emoji:"üé∂"},
 "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},
 "Padel":{color:"#82E0AA",emoji:"üèì"},
 "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},
 "Yoga":{color:"#D5F5E3",emoji:"üßò"},
 "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
 "Film":{color:"#E6B0AA",emoji:"üé¨"},
 "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},
 "Trummor":{color:"#F1948A",emoji:"ü•Å"},
 "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},
 "Medicin":{color:"#E59866",emoji:"üíä"},
 "Biljard":{color:"#A9DFBF",emoji:"üé±"},
 "Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
 "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},
 "Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
 "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},
 "Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"},
 "Warhammer":{color:"#C39BD3",emoji:"üõ°Ô∏è"},
 "Utflykt":{color:"#A9CCE3",emoji:"üöå"},
 "Uppstart Taket":{color:"#AED6F1",emoji:"üå§Ô∏è"},
 "G√•tr√§ning":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÇÔ∏è"},
 "Promenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},
 "Baka":{color:"#FAD7A0",emoji:"üßÅ"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#f4f6f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];

/* üîÑ Ladda data fr√•n Google Script */
async function loadData(){
 try{
   const res=await fetch(url+"?t="+Date.now());
   const json=await res.json();
   DATA=json.data||[];
   fillNameList();
   fillCoachList();
   fillCompareLists();
   document.getElementById("sickCoachSelect").innerHTML='<option value="">-- V√§lj sjuk coach --</option>'+
   [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
     .filter(x=>x&&x.toLowerCase()!=="alla").sort().map(c=>`<option>${c}</option>`).join("");
 }catch(e){console.error(e);}
}
loadData();

/* üë§ Fyll listor */
function fillNameList(){
 const s=document.getElementById("nameSelect");
 s.innerHTML='<option value="">-- V√§lj deltagare --</option>';
 [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
   const o=document.createElement("option");
   o.value=n;o.textContent=n;s.appendChild(o);
 });
}
function fillCoachList(){
 const s=document.getElementById("coachSelect");
 s.innerHTML='<option value="">-- V√§lj coach --</option>';
 [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
   const o=document.createElement("option");
   o.value=c;o.textContent=c;s.appendChild(o);
 });
}
function fillCompareLists(){
 const cList=document.getElementById("coachListCompare");
 const pList=document.getElementById("participantListCompare");
 cList.innerHTML="";pList.innerHTML="";
 [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
   cList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-coach" value="${c}"> ${c}</label><br>`);
 });
 [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
   pList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-delt" value="${n}"> ${n}</label><br>`);
 });
}

/* üç¥ Lunchregel */
function applyLunchRule(rows,name,isCoach){
 return rows.filter(r=>{
   const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
   const field=isCoach?"Coach":"Deltagare";
   const isAll=(r[field]||"").trim().toLowerCase()==="alla";
   if(isLunch&&isAll){
     const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&(x.Aktivitet||"").toLowerCase().includes("lunch")&&(x[field]||"").toLowerCase().includes(name.toLowerCase()));
     if(specific) return false;
   }
   return true;
 });
}

/* üóìÔ∏è Dagens schema */
function renderCards(name,isCoach){
 const today=todayKey();
 const field=isCoach?"Coach":"Deltagare";
 const rows=applyLunchRule(
  DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
 let html=`<div class='cards'>`;
 if(!rows.length) html+="<p>Inga aktiviteter idag.</p>";
 rows.forEach(r=>{
   const e=emojiFor(r);
   html+=`<div class="card" style="--band:${colorFor(r)}">
     <h3>${e} ${r.Aktivitet||"Aktivitet"}</h3>
     <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
     <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
   </div>`;
 });
 html+="</div>";
 document.getElementById("schemaContainer").innerHTML=html;
 document.getElementById("schemaContainer").style.display="block";
 document.getElementById("blockContainer").style.display="none";
 document.getElementById("btnPrint").style.display="inline-block";
 document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

/* üß© Veckoschema utan linjer */
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
function renderBlocks(name,isCoach){
 const slots=makeSlots(), days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
 const field=isCoach?"Coach":"Deltagare";
 const rows=applyLunchRule(DATA.filter(r=>{
   const str=(r[field]||"").toLowerCase();
   return str.includes(name.toLowerCase())||str==="alla";
 }),name,isCoach);
 const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
 head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
 grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
 slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
 const cells=[...grid.children], dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
 const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
 rows.forEach(r=>{
   const dIndex=new Date(r.Datum).getDay()-1;
   if(dIndex<0||dIndex>4)return;
   const col=dIndex+1;
   const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);if(sIdx<0||eIdx<=sIdx)return;
   const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
   const block=document.createElement("div");
   block.className="block";block.style.background=colorFor(r);
   block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
   requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
   firstCell.appendChild(block);
 });
 document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
 document.getElementById("schemaContainer").style.display="none";
 document.getElementById("blockContainer").style.display="block";
 document.getElementById("btnPrint").style.display="inline-block";
}

/* üîò Knappar */
document.getElementById("btnParticipant").onclick=()=>{
 document.getElementById("coachSelect").style.display="none";
 document.getElementById("nameSelect").style.display="inline-block";
 document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
 document.getElementById("nameSelect").style.display="none";
 document.getElementById("coachSelect").style.display="inline-block";
 document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
 const n=document.getElementById("nameSelect").style.display!=="none"
  ?document.getElementById("nameSelect").value
  :document.getElementById("coachSelect").value;
 if(n)renderCards(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnBlocks").onclick=()=>{
 const n=document.getElementById("nameSelect").style.display!=="none"
  ?document.getElementById("nameSelect").value
  :document.getElementById("coachSelect").value;
 if(n)renderBlocks(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnPrint").onclick=()=>window.print();
</script>
<script>
/* ü©∫ Hitta ers√§ttare */
document.getElementById("btnSick").onclick = () => {
  document.getElementById("sickPanel").style.display = "block";
  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("btnPrint").style.display = "none";
  document.getElementById("viewTitle").textContent = "Hitta ers√§ttare (sjuk coach)";
};

document.getElementById("sickCoachSelect").onchange = () => {
  const coach = document.getElementById("sickCoachSelect").value;
  if (!coach) return;
  const today = todayKey();

  // hitta pass f√∂r sjuk coach
  const todaysPass = DATA.filter(r =>
    dayKey(r.Datum) === today &&
    (r.Coach || "").toLowerCase().includes(coach.toLowerCase())
  );

  // alla andra coacher
  const otherCoaches = [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla" && x!==coach);

  // kolla vilka som √§r lediga samma tider
  const freeCoaches = otherCoaches.filter(c=>{
    return !DATA.some(r=>{
      if(dayKey(r.Datum)!==today)return false;
      if(!(r.Coach||"").toLowerCase().includes(c.toLowerCase()))return false;
      const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
      const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
      const s=sh*60+sm,e=eh*60+em;
      return todaysPass.some(tp=>{
        const [th,tm]=(tp.Start||"00:00").split(":").map(Number);
        const [xh,xm]=(tp.Slut||"00:00").split(":").map(Number);
        const ts=th*60+tm,te=xh*60+xm;
        return !(e<=ts || s>=te);
      });
    });
  });

  let html = `<h3>${coach}s pass idag</h3>`;
  if (!todaysPass.length) html += `<p>Inga pass idag.</p>`;
  else html += `<ul>` + todaysPass.map(r=>`<li>${emojiFor(r)} ${r.Aktivitet} (${r.Start}‚Äì${r.Slut})</li>`).join("") + `</ul>`;
  html += `<h3>Tillg√§ngliga coacher</h3>`;
  if (!freeCoaches.length) html += `<p>Inga lediga coacher just nu.</p>`;
  else html += `<ul>` + freeCoaches.map(c=>`<li>${c}</li>`).join("") + `</ul>`;
  document.getElementById("sickResult").innerHTML = html;
};

/* üîç J√§mf√∂r scheman (flervy ‚Äì veckoblock) */
document.getElementById("btnCompare").onclick = () => {
  document.getElementById("comparePanel").style.display = "block";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("btnPrint").style.display = "none";
  document.getElementById("viewTitle").textContent = "J√§mf√∂r scheman";
};

document.getElementById("btnShowCompare").onclick = () => {
  const selectedNames = [
    ...document.querySelectorAll(".chk-delt:checked"),
    ...document.querySelectorAll(".chk-coach:checked")
  ].map(cb => ({
    name: cb.value,
    isCoach: cb.classList.contains("chk-coach")
  }));
  if (!selectedNames.length) {
    alert("V√§lj minst en person f√∂rst.");
    return;
  }

  // generera veckoscheman bredvid varandra
  const wrap = document.createElement("div");
  wrap.className = "schema-wrap";
  selectedNames.forEach(sel => {
    const div = document.createElement("div");
    div.className = "schema";
    div.appendChild(renderSingleWeek(sel.name, sel.isCoach));
    wrap.appendChild(div);
  });

  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").innerHTML = "";
  document.getElementById("schemaContainer").appendChild(wrap);
  document.getElementById("schemaContainer").style.display = "block";
  document.getElementById("btnPrint").style.display = "inline-block";
  document.getElementById("viewTitle").textContent = "J√§mf√∂relse av veckoscheman";
};

/* üß± Bygg veckoschema f√∂r varje person i j√§mf√∂relsen */
function renderSingleWeek(name,isCoach){
  const slots=["08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30"];
  const days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach);
  const container=document.createElement("div");
  container.innerHTML=`<h3 style="text-align:center;margin-bottom:6px">${isCoach?"Coach: ":"Deltagare: "}${name}</h3>
  <div class="block-header"><div>Tid</div>${days.map(d=>`<div>${d}</div>`).join("")}</div>
  <div class="block-grid"></div>`;
  const grid=container.querySelector(".block-grid");
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children],dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dIndex=new Date(r.Datum).getDay()-1;
    if(dIndex<0||dIndex>4)return;
    const col=dIndex+1;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";block.style.background=colorFor(r);
    block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  return container;
}

/* üïí P√•g√•r just nu */
document.getElementById("btnNow").onclick = () => {
  const now = new Date();
  const minsNow = now.getHours() * 60 + now.getMinutes();
  const today = todayKey();
  const active = DATA.filter(r => {
    if (dayKey(r.Datum) !== today) return false;
    const [sh, sm] = (r.Start || "00:00").split(":").map(Number);
    const [eh, em] = (r.Slut || "00:00").split(":").map(Number);
    const start = sh * 60 + sm, end = eh * 60 + em;
    return minsNow >= start && minsNow <= end;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const cont = document.getElementById("nowContainer");
  cont.innerHTML = `<h2 style="text-align:center">‚è±Ô∏è P√•g√•r just nu</h2>`;
  if (!active.length) {
    cont.innerHTML += `<p style="text-align:center">Inga aktiviteter p√•g√•r just nu.</p>`;
    return;
  }
  cont.innerHTML += `<div class="cards">` +
    active.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") +
    `</div>`;
  document.getElementById("viewTitle").textContent = "P√•g√•r just nu";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("btnPrint").style.display = "none";
};

/* St√§ng √∂vriga paneler n√§r man v√§xlar vy */
function hidePanels(){
 document.getElementById("comparePanel").style.display="none";
 document.getElementById("sickPanel").style.display="none";
}
</script>
</body>
</html>
