<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Schema & Hitta ersättare</title>
<style>
:root {
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 3px 10px rgba(0,0,0,.05);
  --radius:14px;
}
body {
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  margin:0 auto;
  max-width:1800px;
  padding:10px;
  background:#fafafa;
}
header {
  text-align:center;
  margin-bottom:12px;
}
h1 {
  margin:0;
  font-size:1.3rem;
}
.toolbar {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  margin-bottom:12px;
}
button, select {
  font-size:1rem;
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#f8f8f8;
  cursor:pointer;
}
button:hover {background:#eee;}
#checkboxContainer {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px 14px;
  max-width:1000px;
  margin:10px auto;
}
#schemanContainer {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  justify-content:center;
}
.schema {
  flex:1 1 300px;
  min-width:280px;
  max-width:480px;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:10px;
}
.block-header {
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  font-weight:bold;
  font-size:0.85rem;
  background:#eef3ff;
}
.block-grid {
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
}
.block-time {
  background:#fafafa;
  font-size:0.8rem;
  padding:2px 4px;
}
.block-cell {
  position:relative;
  min-height:26px;
}
.block {
  position:absolute;
  left:2px;
  right:2px;
  top:2px;
  border-radius:6px;
  padding:3px 4px;
  line-height:1.2;
  border:1pt solid #666;
  font-size:0.75rem;
  overflow:hidden;
  -webkit-print-color-adjust:exact;
  print-color-adjust:exact;
}
.block .title {font-weight:bold;}
@media (max-width:700px) {
  body {padding:6px;}
  .schema {min-width:100%;max-width:100%;}
  .toolbar {flex-direction:column;align-items:center;}
  button, select {width:90%;font-size:1.1rem;}
}
@media print {
  body {background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,#checkboxContainer{display:none!important;}
  .schema {page-break-inside:avoid;}
  @page {size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <h1>Schema & Hitta ersättare</h1>
  <div>Visa flera coacher och deltagare samtidigt</div>
</header>

<div class="toolbar">
  <button id="btnLoad">🔄 Ladda namn</button>
  <button id="btnShow">👀 Visa scheman</button>
  <button id="btnAvailable">🩺 Hitta ersättare</button>
  <button id="btnPrint">🖨️ Skriv ut</button>
</div>

<div id="checkboxContainer"></div>
<div id="schemanContainer"></div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
  "Måndagsmöte":"#AED6F1","Gruppmöte":"#7FB3D5","Lunch":"#F9E79F","Frukost":"#FAD7A0",
  "Ateljé":"#F5CBA7","Musik":"#D2B4DE","Pod":"#A9CCE3","Padel":"#82E0AA",
  "Lite av varje":"#FADBD8","Yoga":"#D5F5E3","Gym":"#A3E4D7","Film":"#E6B0AA",
  "Föreningsgruppen":"#D6DBDF","Trummor":"#F1948A","Återkoppling":"#85C1E9","Medicin":"#E59866",
  "Biljard":"#A9DFBF","Spelgruppen":"#F8C471","Sömnad":"#F5EEF8","Warhammer":"#C39BD3","Utflykt":"#A9CCE3"
};
const aktivitetEmoji={
  "Måndagsmöte":"📅","Gruppmöte":"👥","Lunch":"🍲","Frukost":"🥐",
  "Ateljé":"🎨","Musik":"🎶","Pod":"🎙️","Padel":"🏓","Lite av varje":"✨",
  "Yoga":"🧘","Gym":"🏋️‍♂️","Film":"🎬","Föreningsgruppen":"🤝","Trummor":"🥁",
  "Återkoppling":"🔄","Medicin":"💊","Biljard":"🎱","Spelgruppen":"🎲","Sömnad":"🧵","Warhammer":"🛡️","Utflykt":"🚌"
};

let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  fillCheckboxes();
}

function fillCheckboxes(){
  const cont=document.getElementById("checkboxContainer");
  cont.innerHTML="<h3>Välj scheman att visa</h3>";
  let list=new Set();
  DATA.forEach(r=>{
    parseList(r.Coach).forEach(n=>list.add(n));
    parseList(r.Deltagare).forEach(n=>list.add(n));
  });
  [...list].filter(x=>x&&x!=="alla").sort().forEach(n=>{
    const id="cb_"+n.replace(/\s+/g,"_");
    cont.insertAdjacentHTML("beforeend",
      `<label><input type="checkbox" value="${n}" id="${id}"> ${n}</label>`);
  });
}

function parseList(str){
  return (str||"").split(/,|\/|;|\n/).map(s=>s.trim().toLowerCase()).filter(Boolean);
}
function dayKey(str){return String(str).slice(0,10);}
function colorFor(r){return aktivitetFarger[r.Aktivitet]||"#eee";}
function emojiFor(r){return aktivitetEmoji[r.Aktivitet]||"";}
function makeSlots(){
  const out=[];let t=8*60;while(t<=16*60+30){
    out.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));
    t+=30;
  }return out;
}

function renderWeek(person){
  const slots=makeSlots();
  const days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const rows=DATA.filter(r=>{
    const isCoach=parseList(r.Coach).includes(person.toLowerCase());
    const isDelt=parseList(r.Deltagare).includes(person.toLowerCase());
    const allC=(r.Coach||"").toLowerCase()==="alla";
    const allD=(r.Deltagare||"").toLowerCase()==="alla";
    return isCoach||isDelt||allC||allD;
  });
  const div=document.createElement("div");
  div.className="schema";
  div.innerHTML=`<h3 style="text-align:center;margin:6px 0;">${person}</h3>
    <div class="block-header"><div>Tid</div>${days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("")}</div>
    <div class="block-grid"></div>`;
  const grid=div.querySelector(".block-grid");
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{
    grid.innerHTML+=`<div class="block-time">${t}</div>`+days.map(()=>`<div class="block-cell"></div>`).join("");
  });
  const cells=[...grid.children],dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    if(duration<=30){
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}`;
    } else {
      block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>
                       <div>${r.Start}–${r.Slut}</div>
                       <div>${r.Coach||""}</div>`;
    }
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||26;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  return div;
}

/* === 🩺 Hitta ersättare === */
function showAvailable(){
  const now=new Date();
  const currentDay=dayKey(now.toISOString());
  const currentMinutes=now.getHours()*60+now.getMinutes();

  const busyActivities=[];
  const busyPeople=new Set();

  DATA.forEach(r=>{
    if(dayKey(r.Datum)!==currentDay) return;
    const start=(r.Start||"").split(":").map(Number);
    const end=(r.Slut||"").split(":").map(Number);
    const s=start[0]*60+(start[1]||0);
    const e=end[0]*60+(end[1]||0);
    if(currentMinutes>=s && currentMinutes<e){
      busyActivities.push(r);
      parseList(r.Coach).forEach(n=>busyPeople.add(n));
      parseList(r.Deltagare).forEach(n=>busyPeople.add(n));
    }
  });

  const all=new Set();
  DATA.forEach(r=>{
    parseList(r.Coach).forEach(n=>all.add(n));
    parseList(r.Deltagare).forEach(n=>all.add(n));
  });
  const available=[...all].filter(n=>n && !busyPeople.has(n));

  const cont=document.getElementById("schemanContainer");
  let html=`<div style="text-align:center;"><h3>🩺 Pågående aktiviteter just nu (${busyActivities.length})</h3>`;
  if(!busyActivities.length) html+="<p>Inga aktiviteter pågår just nu.</p>";
  else html+="<div style='display:flex;flex-direction:column;align-items:center;gap:8px;'>"+
    busyActivities.map(r=>`
      <div style="background:${colorFor(r)};padding:6px 10px;border-radius:10px;width:95%;max-width:500px;box-shadow:0 2px 6px rgba(0,0,0,.1);text-align:left;">
      <b>${r.Aktivitet}</b> – ${r.Start}–${r.Slut}<br>
      Coach: ${r.Coach||"-"}<br>
      Deltagare: ${r.Deltagare||"-"}
      </div>`).join("")+"</div>";

  html+=`<h3 style="margin-top:16px;">✅ Tillgängliga personer (${available.length})</h3>
         <p>${available.length?available.join(", "):"Ingen tillgänglig just nu."}</p></div>`;
  cont.innerHTML=html;
}

/* === Knappar === */
document.getElementById("btnLoad").onclick=loadData;
document.getElementById("btnShow").onclick=()=>{
  const selected=[...document.querySelectorAll("#checkboxContainer input:checked")].map(e=>e.value);
  if(!selected.length){alert("Välj minst en person.");return;}
  const cont=document.getElementById("schemanContainer");
  cont.innerHTML="";
  selected.forEach(p=>cont.appendChild(renderWeek(p)));
};
document.getElementById("btnAvailable").onclick=showAvailable;
document.getElementById("btnPrint").onclick=()=>{window.print();};
</script>
</body>
</html>
