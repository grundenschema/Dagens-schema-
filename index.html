<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grunden DV ‚Äì Schema</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px 20px;
      position: relative;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    header img {
      height: 60px;
      margin-left: 20px;
    }

    h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    #clock {
      font-family: monospace;
      margin: 6px 0 10px;
      font-size: 0.9rem;
    }

    #updated {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 16px;
    }

    select, button {
      margin: 5px 5px 15px 0;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background-color: #f7f7f7;
      cursor: pointer;
    }

    button:hover { background-color: #e0e0e0; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }

    .ended { opacity: 0.6; }
    .aktivitet { font-weight: bold; }
    .hidden { display: none; }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .day-heading {
      background-color: #f0f6ff;
      color: #2c3e50;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 25px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 id="viewTitle">Dagens gemensamma schema</h1>
      <div id="clock"></div>
      <div id="updated">Senast uppdaterad: ‚Äì</div>
    </div>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <div class="toolbar">
    <button id="showDaily">Gemensamt schema</button>
    <button id="showWeekly">Coachschema</button>
    <select id="coachSelect" class="hidden"></select>
  </div>

  <div id="schemaContainer">Laddar schema...</div>

  <script>
    // üîó Din Google Apps Script-webbapp
    const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

    const aktivitetFarger = {
      "M√•ndagsm√∂te": {color:"#AED6F1", emoji:"üìÖ"},
      "Gruppm√∂te": {color:"#7FB3D5", emoji:"üë•"},
      "Lunch": {color:"#F9E79F", emoji:"üç≤"},
      "Frukost": {color:"#FAD7A0", emoji:"ü•ê"},
      "Atelj√©": {color:"#F5CBA7", emoji:"üé®"},
      "Musik": {color:"#D2B4DE", emoji:"üé∂"},
      "Pod": {color:"#A9CCE3", emoji:"üéôÔ∏è"},
      "Padel": {color:"#82E0AA", emoji:"üèì"},
      "Lite av varje": {color:"#FADBD8", emoji:"‚ú®"},
      "Yoga": {color:"#D5F5E3", emoji:"üßò"},
      "Gym": {color:"#A3E4D7", emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
      "Film": {color:"#E6B0AA", emoji:"üé¨"},
      "F√∂reningsgruppen": {color:"#D6DBDF", emoji:"ü§ù"},
      "Trummor": {color:"#F1948A", emoji:"ü•Å"},
      "√Öterkoppling": {color:"#85C1E9", emoji:"üîÑ"},
      "Medicin": {color:"#E59866", emoji:"üíä"},
      "Biljard": {color:"#A9DFBF", emoji:"üé±"},
      "Spelgruppen": {color:"#F8C471", emoji:"üé≤"},
      "S√∂mnad": {color:"#F5EEF8", emoji:"üßµ"},
      "Filmgruppen": {color:"#E6B0AA", emoji:"üé¨"},
      "Musikquizz": {color:"#D2B4DE", emoji:"üé∂"},
      "Musikdokument√§r": {color:"#D2B4DE", emoji:"üé∂"}
    };

    function getStockholmDate() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
    }

    function updateClock() {
      const now = getStockholmDate();
      const opts = { weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit", second:"2-digit" };
      document.getElementById("clock").textContent = new Intl.DateTimeFormat("sv-SE", opts).format(now);
    }
    setInterval(updateClock, 1000); updateClock();

    let GLOBAL_DATA = [];

    async function loadSchema() {
      try {
        const res = await fetch(url + "?t=" + Date.now());
        const json = await res.json();
        GLOBAL_DATA = json.data || [];
        document.getElementById("updated").textContent = "Senast uppdaterad: " + (json.updated || "‚Äì");
        renderDaily(GLOBAL_DATA);
        setupWeekly(GLOBAL_DATA);
      } catch {
        document.getElementById("schemaContainer").textContent = "Kunde inte h√§mta schema.";
      }
    }

    function renderDaily(data) {
      document.getElementById("viewTitle").textContent = "Dagens gemensamma schema";
      document.getElementById("coachSelect").classList.add("hidden");

      const today = getStockholmDate().toISOString().split("T")[0];
      const todays = data.filter(r => String(r.Datum).startsWith(today));
      const now = getStockholmDate().toTimeString().slice(0,5);
      let html = `<table><thead>
        <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
      </thead><tbody>`;

      todays.forEach(row => {
        const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
        const status = (row.Slut <= now) ? "‚ùå" : (row.Start <= now && row.Slut >= now) ? "üü¢" : "";
        html += `<tr style="background:${f.color}" class="${status==='‚ùå'?'ended':''}">
          <td>${row.Start}</td>
          <td>${row.Slut}</td>
          <td class="aktivitet">${status ? status + " " : ""}${f.emoji||""} ${row.Aktivitet}</td>
          <td>${row.Deltagare}</td>
          <td>${row.Coach}</td>
        </tr>`;
      });
      if (!todays.length) html += `<tr><td colspan="5">Inga aktiviteter idag.</td></tr>`;
      html += "</tbody></table>";
      document.getElementById("schemaContainer").innerHTML = html;
    }

    function setupWeekly(data) {
      const select = document.getElementById("coachSelect");
      const coaches = [...new Set(data.map(r => (r.Coach || "").split(",")).flat().map(c => c.trim()).filter(c => c && c!=="Alla"))].sort();
      select.innerHTML = "<option value=''>-- V√§lj coach --</option>" + coaches.map(c => `<option value="${c}">${c}</option>`).join("");
      select.onchange = () => renderWeekly(data, select.value);
    }

    function renderWeekly(data, coach) {
      document.getElementById("viewTitle").textContent = "Coachschema" + (coach ? ` ‚Äì ${coach}` : "");
      document.getElementById("coachSelect").classList.remove("hidden");

      let filtered = data;
      if (coach) {
        filtered = data.filter(r => {
          const coachList = (r.Coach || "").split(",").map(c => c.trim());
          return coachList.includes(coach) || (r.Coach || "").trim() === "Alla";
        });
      }

      filtered.sort((a,b)=>{
        const dA=String(a.Datum).slice(0,10), dB=String(b.Datum).slice(0,10);
        if(dA===dB) return (a.Start||"").localeCompare(b.Start||"");
        return dA.localeCompare(dB);
      });

      const grouped = {};
      filtered.forEach(r => {
        const d = String(r.Datum).slice(0,10);
        if(!grouped[d]) grouped[d]=[];
        grouped[d].push(r);
      });

      const fmt = new Intl.DateTimeFormat("sv-SE", {weekday:"long", day:"numeric", month:"long"});
      let html = "";

      Object.keys(grouped).forEach(dateKey=>{
        const dLabel = fmt.format(new Date(dateKey));
        html += `<div class="day-heading">${dLabel.charAt(0).toUpperCase()+dLabel.slice(1)}</div>`;
        html += `<table><thead>
          <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
        </thead><tbody>`;
        grouped[dateKey].forEach(r=>{
          const f=aktivitetFarger[r.Aktivitet]||{color:"#fff",emoji:""};
          html += `<tr style="background:${f.color}">
            <td>${r.Start}</td>
            <td>${r.Slut}</td>
            <td class="aktivitet">${f.emoji||""} ${r.Aktivitet}</td>
            <td>${r.Deltagare}</td>
            <td>${r.Coach}</td>
          </tr>`;
        });
        html += "</tbody></table>";
      });

      if (!filtered.length) html = `<p>Inga aktiviteter hittades${coach ? " f√∂r " + coach : ""}.</p>`;
      document.getElementById("schemaContainer").innerHTML = html;
    }

    function updateStatusColors(){
      const now=getStockholmDate().toTimeString().slice(0,5);
      document.querySelectorAll("tbody tr").forEach(tr=>{
        const s=tr.children[0]?.textContent?.trim();
        const e=tr.children[1]?.textContent?.trim();
        const cell=tr.querySelector(".aktivitet");
        if(!s||!e||!cell)return;
        let st="";
        if(e<=now)st="‚ùå"; else if(s<=now&&e>=now)st="üü¢";
        cell.textContent=cell.textContent.replace(/^(?:üü¢|‚ùå)\s*/,"");
        if(st)cell.textContent=`${st} ${cell.textContent}`;
        tr.classList.toggle("ended",e<=now);
      });
    }

    document.getElementById("showDaily").onclick=()=>renderDaily(GLOBAL_DATA);
    document.getElementById("showWeekly").onclick=()=>renderWeekly(GLOBAL_DATA,document.getElementById("coachSelect").value||"");
    loadSchema();
    setInterval(updateStatusColors,60000);
    setInterval(loadSchema,900000);
  </script>
</body>
</html>
