<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schema ‚Äì Deltagare & Coacher</title>
<style>
:root{
  --bg:#fafafa;
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 2px 8px rgba(0,0,0,.08);
  --radius:12px;
  --muted:#555;
  --band:#9ecbff;
  --header-bg:#f5f7fa;
  --chip-bg:#f7f9fc;
  --chip-border:#cfd8e3;
  --chip-active:#e3efff;
  --chip-text:#1f2937;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1800px;
  margin:0 auto;
  padding:16px;
}
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  margin-bottom:12px;
}
header img{height:60px;width:auto;}
#clock{font-weight:600;color:#333;font-size:1.1rem;}

.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  align-items:center;
  margin:12px 0 16px;
}
button,select{
  font-size:1rem;
  padding:10px 16px;
  border-radius:12px;
  border:1px solid #cfd8e3;
  background:#fff;
  cursor:pointer;
  transition:.15s background, .15s transform;
}
button:hover{background:#f1f4f8}
button:active{transform:translateY(1px)}
select{min-width:220px;background:#fff}
#viewTitle{text-align:center;margin:10px 0 8px;font-weight:700;}

.cards{display:flex;flex-direction:column;gap:10px;max-width:1100px;margin:0 auto;}
.card{
  position:relative;background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px 14px;
  box-shadow:var(--shadow);
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;
  background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 6px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

#blockContainer{display:none;margin-top:6px;}
.block-header{
  display:grid;grid-template-columns:80px repeat(5,1fr);
  font-weight:800;font-size:.92rem;background:var(--header-bg);
  border-radius:10px 10px 0 0;text-transform:capitalize;
}
.block-header div{ text-align:center; padding:8px 0; }
.block-grid{ display:grid; grid-template-columns:80px repeat(5,1fr); background:transparent; }
.block-time{ font-size:.86rem; padding:4px 6px; text-align:right; color:#2b2b2b; }
.block-cell{ position:relative; min-height:28px; background:transparent; border:none; }
.block{
  position:absolute; left:2px; right:2px; top:2px;
  border-radius:10px; padding:6px 8px; line-height:1.2;
  font-size:.82rem; color:#111; box-shadow:var(--shadow);
  overflow:hidden; word-break:break-word;
  -webkit-print-color-adjust:exact; print-color-adjust:exact;
}
.block .title{font-weight:700}

/* Dropdown */
.dropdown{ position:relative; display:inline-block; }
.dropdown-content{
  display:none; position:absolute; background:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  border:1px solid #e5e7eb; border-radius:12px; min-width:220px;
  z-index:10; overflow:hidden;
}
.dropdown-content button{
  width:100%; border:none; text-align:left; background:#fff;
  border-radius:0; padding:10px 14px;
}
.dropdown-content button:hover{ background:#f5f7fa; }
.dropdown.show .dropdown-content{ display:block; }

/* Utskrift */
@media print{
  body{ background:#fff; color:#000; font-size:9pt; margin:0; }
  header,.toolbar,#nowContainer,.dropdown{ display:none !important; }
  #blockContainer{ display:block !important; }
  .schema{ page-break-inside:avoid; }
  @page{ size:A4 landscape; margin:6mm; }
}

/* Responsiv */
@media (max-width:760px){
  body{padding:8px}
  .toolbar{flex-direction:column}
  button,select{width:95%;font-size:1.05rem}
}
</style>
</head>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logo">
  <div id="clock"></div>
</header>

<div class="toolbar">
  <button id="btnParticipant">Deltagarschema</button>
  <button id="btnCoach">Coachschema</button>
  <button id="btnCards">Dagens schema</button>
  <button id="btnBlocks">Veckoschema</button>
  <div class="dropdown">
    <button id="btnSchedule">üìÖ Schemal√§ggning ‚ñº</button>
    <div class="dropdown-content">
      <button id="btnCompare">üîç J√§mf√∂r scheman</button>
      <button id="btnSick">ü©∫ Hitta ers√§ttare</button>
    </div>
  </div>
</div>

<select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
<select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>
<div id="nowContainer"></div>

<!-- Veckoblock -->
<div id="blockContainer">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div style="text-align:center;margin-top:8px;">
    <button id="btnPrint" style="display:none;">üñ®Ô∏è Skriv ut</button>
  </div>
</div>

<!-- Paneler -->
<div id="comparePanel" class="panel" style="display:none;"></div>
<div id="sickPanel" class="panel" style="display:none;"></div>

<script>
/* =======================
   DIGITAL KLOCKA
======================= */
function updateClock(){
  const now=new Date();
  document.getElementById("clock").textContent=now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000);updateClock();

/* =======================
   DATA OCH LADDNING
======================= */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
 "Frukost":{color:"#FAD7A0",emoji:"ü•ê"},"Morgonrutiner":{color:"#FAD7A0",emoji:"‚òÄÔ∏è"},
 "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"atelj√©n":{color:"#F5CBA7",emoji:"üé®"},
 "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
 "Trummor":{color:"#F1948A",emoji:"ü•Å"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
 "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},
 "Padel":{color:"#82E0AA",emoji:"üèì"},"S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},
 "Warhammer":{color:"#C39BD3",emoji:"üõ°Ô∏è"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
 "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"√Öterkoppling":{color:"#AED6F1",emoji:"üîÑ"},
 "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Medicin":{color:"#E59866",emoji:"üíä"},
 "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
 "Behandling":{color:"#FDEDEC",emoji:"üíÜ‚Äç‚ôÄÔ∏è"},"Behandlingar":{color:"#FDEDEC",emoji:"üíÜ‚Äç‚ôÄÔ∏è"},
 "Kommunikation":{color:"#D6EAF8",emoji:"üí¨"},"Foto":{color:"#E8DAEF",emoji:"üì∏"},
 "Vocal":{color:"#E8DAEF",emoji:"üé§"},"Uppstart":{color:"#AED6F1",emoji:"üå§Ô∏è"},
 "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Ladda stol":{color:"#FAD7A0",emoji:"‚òïüîã"},
 "Fika, Ladda stol":{color:"#FAD7A0",emoji:"‚òïüîã"},"Avslappning":{color:"#D5F5E3",emoji:"ü™∑"},
 "Lunchpromenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},"Promenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},
 "G√•tr√§ning":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÇÔ∏è"},"Mark- Manusarbete (John)":{color:"#E8DAEF",emoji:"üìù"},
 "Samtal":{color:"#FCF3CF",emoji:"üí¨"},"Baka":{color:"#FAD7A0",emoji:"üßÅ"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#f4f6f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  fillLists();
}
loadData();

function fillLists(){
  const names=[...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort();
  const coaches=[...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort();
  const nSel=document.getElementById("nameSelect"),cSel=document.getElementById("coachSelect");
  nSel.innerHTML='<option value="">-- V√§lj deltagare --</option>'+names.map(n=>`<option>${n}</option>`).join("");
  cSel.innerHTML='<option value="">-- V√§lj coach --</option>'+coaches.map(n=>`<option>${n}</option>`).join("");
}

/* =======================
   FUNKTIONER (kort & block)
======================= */
function renderCards(name,isCoach){
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=(r[field]||"").toLowerCase();
    return list.includes(name.toLowerCase())||list.trim()==="alla";
  }).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  let html="<div class='cards'>";
  if(!rows.length)html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("btnPrint").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
function renderBlocks(name,isCoach){
  const slots=makeSlots();const days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=(r[field]||"").toLowerCase();
    return list.includes(name.toLowerCase())||list.trim()==="alla";
  });
  const head=document.getElementById("blockHeader"),grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
  grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children];
  rows.forEach(r=>{
    const d=new Date(r.Datum);let wd=d.getDay();if(wd===0||wd===6)return;
    const col=(wd-1)+1;const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";block.style.background=colorFor(r);
    const duration=((parseInt(r.Slut)||0)-(parseInt(r.Start)||0));
    block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>${r.Start}‚Äì${r.Slut}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
}

/* =======================
   DROPDOWN FIX
======================= */
document.getElementById("btnSchedule").addEventListener("click",()=>{
  document.querySelector(".dropdown").classList.toggle("show");
});
document.getElementById("btnCompare").addEventListener("click",()=>{
  alert("üîç J√§mf√∂r scheman ‚Äì funktion aktiv!");
  document.querySelector(".dropdown").classList.remove("show");
});
document.getElementById("btnSick").addEventListener("click",()=>{
  alert("ü©∫ Hitta ers√§ttare ‚Äì funktion aktiv!");
  document.querySelector(".dropdown").classList.remove("show");
});

/* =======================
   KNAPPAR
======================= */
document.getElementById("btnParticipant").onclick=()=>{
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
  const isCoach=document.getElementById("coachSelect").style.display!=="none";
  const n=isCoach?document.getElementById("coachSelect").value:document.getElementById("nameSelect").value;
  if(n)renderCards(n,isCoach);
};
document.getElementById("btnBlocks").onclick=()=>{
  const isCoach=document.getElementById("coachSelect").style.display!=="none";
  const n=isCoach?document.getElementById("coachSelect").value:document.getElementById("nameSelect").value;
  if(n)renderBlocks(n,isCoach);
};
document.getElementById("btnPrint").onclick=()=>{window.print();};
</script>
</body>
</html>

