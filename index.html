<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grunden DV ‚Äì Schema</title>
<style>
:root{
  --card-bg:#fff;
  --page-bg:#fafafa;
  --border:#ddd;
  --muted:#555;
  --heading:#2c3e50;
  --shadow:0 6px 18px rgba(0,0,0,.05);
  --radius:16px;
  --pad:14px;
  --band:#9ecbff;
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:1000px;margin:0 auto;padding:16px;background:var(--page-bg);}
header{text-align:center;margin-bottom:15px;}
header img{height:65px;margin:10px auto;display:block;}
#clock{font-family:ui-monospace;font-size:.9rem;color:#333;}
#updated{font-size:.8rem;color:var(--muted);margin-top:4px;}
.toolbar{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:18px 0;}
button,select{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;font-size:15px;}
button:hover{background:#ececec;}
#coachSelect{display:none;}
#sickPanel{display:none;border:1px solid var(--border);background:var(--card-bg);border-radius:14px;padding:12px;box-shadow:var(--shadow);}
#sickList{display:flex;flex-wrap:wrap;gap:8px 14px;max-height:220px;overflow:auto;}
#sickList label{display:flex;align-items:center;gap:6px;white-space:nowrap;}
.day-section{border-bottom:1px solid #ddd;margin-bottom:22px;padding-bottom:10px;}
.day-heading{background:#eef5ff;color:var(--heading);padding:8px 12px;border-radius:12px;font-weight:700;margin:18px 0 10px 0;}
.cards{display:none;}
.card{position:relative;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow);margin:0 auto 12px auto;max-width:95%;}
.card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:8px;background:var(--band);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);}
.card-title{font-weight:800;font-size:1.05rem;margin:0 0 6px 0;display:flex;align-items:center;gap:8px;}
.row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;font-size:.95rem;padding:2px 0;}
.row label{color:#333;font-weight:700;}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem;background:#fff3cd;color:#8a5b00;border:1px solid #ffe39a;margin-left:8px;white-space:nowrap;}
.okpill{background:#e8f6ee;color:#1a7f37;border:1px solid #cdebd9;}
@media(max-width:700px){
  .toolbar button{flex:1 1 45%;}
  .toolbar select{flex:1 1 90%;}
  .cards{display:block;}
  table{display:none;}
}
</style>
</head>
<body>
<header>
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnSick">Sjukschema</button>
</div>

<div id="sickPanel">
  <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
  <div id="sickList"></div>
  <div id="sickMsg" style="font-size:.85rem;color:#666;margin-top:6px;"></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button id="btnShowSick">Visa sjukschema</button>
    <button id="btnClearSick" title="Rensa val">Rensa</button>
  </div>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";
const aktivitetFarger={
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},"Padel":{color:"#82E0AA",emoji:"üèì"},
  "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
  "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Trummor":{color:"#F1948A",emoji:"ü•Å"},
  "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},"Medicin":{color:"#E59866",emoji:"üíä"},
  "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
  "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},"Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
  "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},"Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"}
};

function getSEDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Stockholm"}));}
function fmtSE(dt,opts){return new Intl.DateTimeFormat("sv-SE",opts).format(dt);}
function updateClock(){
  const now=getSEDate();
  document.getElementById("clock").textContent=fmtSE(now,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateClock,1000);updateClock();

let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  document.getElementById("updated").textContent="Senast uppdaterad: "+(json.updated||"‚Äì");
  setupCoachSelect(DATA);
  setupSickList(DATA);
  renderDaily(DATA);
}

function dayKey(v){
  if(!v)return"";
  const d=new Date(v);
  return d.toISOString().slice(0,10);
}
function parseCoaches(coachStr){
  const ignore=["","-",".","ingen","ingen coach","eget arbete","sj√§lvst√§ndigt","utan coach"];
  return (coachStr||"").split(",").map(c=>c.trim()).filter(c=>c&&!ignore.includes(c.toLowerCase())&&c.toLowerCase()!=="alla");
}
function overlap(aStart,aEnd,bStart,bEnd){return !(aEnd<=bStart||aStart>=bEnd);}
function getThisWeekMonFri(){
  const today=getSEDate(),day=today.getDay(),mon=new Date(today);
  mon.setDate(today.getDate()-((day+6)%7));
  mon.setHours(0,0,0,0);
  const fri=new Date(mon);fri.setDate(mon.getDate()+4);
  return{mon,fri};
}
function groupByDate(rows){
  const g={};
  rows.forEach(r=>{
    const k=dayKey(r.Datum);
    if(!g[k])g[k]=[];
    g[k].push(r);
  });
  return Object.keys(g).sort().reduce((a,k)=>(a[k]=g[k],a),{});
}
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#fff"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function cardHTML(r,extra=""){
  const b=colorFor(r);
  const t=r.Start&&r.Slut?`${r.Start}‚Äì${r.Slut}`:r.Start||r.Slut||"";
  return `<div class="card" style="--band:${b}">
    <h4 class="card-title">${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h4>
    <div class="row"><label>üïí Tid</label><div>${t||"-"}</div></div>
    <div class="row"><label>üë• Deltagare</label><div>${r.Deltagare||"-"}</div></div>
    <div class="row"><label>üßë‚Äçüè´ Coach</label><div>${r.Coach||"-"} ${extra||""}</div></div>
  </div>`;
}
function sectionHTML(dateKey,rows,extraForRow=null,showWarn=false){
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(dateKey));
  let html=`<div class="day-section"><div class="day-heading">${label.charAt(0).toUpperCase()+label.slice(1)}</div>`;
  html+=`<div class="cards">`;
  rows.forEach(r=>{
    const extra=extraForRow?extraForRow(r):"";
    html+=cardHTML(r,extra);
  });
  html+=`</div><table><thead><tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coachinfo</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const warn=showWarn&&parseCoaches(r.Coach).length>2?` <span class="pill">‚ö†Ô∏è ${parseCoaches(r.Coach).length} coacher</span>`:"";
    const extra=extraForRow?extraForRow(r):"";
    html+=`<tr><td>${r.Start||""}</td><td>${r.Slut||""}</td><td>${emojiFor(r)} ${r.Aktivitet||""}${warn}</td><td>${r.Deltagare||""}</td><td>${r.Coach||""} ${extra}</td></tr>`;
  });
  html+=`</tbody></table></div>`;
  return html;
}

function renderDaily(data){
  const today=dayKey(getSEDate().toISOString());
  const todays=data.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").innerHTML=todays.length?sectionHTML(today,todays):`<p>Inga aktiviteter idag.</p>`;
}

function setupCoachSelect(data){
  const s=document.getElementById("coachSelect");
  s.innerHTML=`<option value="">-- V√§lj coach --</option>`;
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    o.textContent=c;
    s.appendChild(o);
  });
  s.onchange=()=>{const v=s.value;if(v)renderCoachWeek(DATA,v);};
}

/* üóìÔ∏è Coachschema (denna vecka) */
function renderCoachWeek(data, coach){
  document.getElementById("viewTitle").textContent="Coachschema ‚Äì "+coach;
  const {mon,fri}=getThisWeekMonFri();
  const startKey=dayKey(mon),endKey=dayKey(fri);
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach);
    const dateKey=dayKey(r.Datum);
    return (cs.includes(coach)||(r.Coach||"").trim().toLowerCase()==="alla")&&dateKey>=startKey&&dateKey<=endKey;
  }).sort((a,b)=>dayKey(a.Datum)===dayKey(b.Datum)?(a.Start||"").localeCompare(b.Start||""):dayKey(a.Datum).localeCompare(dayKey(b.Datum)));
  const grouped=groupByDate(rows);
  let html="";
  Object.keys(grouped).forEach(k=>html+=sectionHTML(k,grouped[k],null,false));
  document.getElementById("schemaContainer").innerHTML=rows.length?html:`<p>Inga aktiviteter hittades f√∂r ${coach} denna vecka.</p>`;
}

function setupSickList(data){
  const c=document.getElementById("sickList");
  c.innerHTML="";
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(co=>{
    const id="sick_"+co.replace(/\s+/g,"_");
    c.insertAdjacentHTML("beforeend",`<label><input type="checkbox" value="${co}" id="${id}"> ${co}</label>`);
  });
}

function getSelectedSick(){return[...document.querySelectorAll("#sickList input:checked")].map(e=>e.value);}
function renderSickSchedule(data,sickCoaches){
  document.getElementById("viewTitle").textContent="ü©∫ Sjukschema";
  const {mon,fri}=getThisWeekMonFri(),sK=dayKey(mon),eK=dayKey(fri);
  const weekRows=data.filter(r=>dayKey(r.Datum)>=sK&&dayKey(r.Datum)<=eK);
  const sickRows=weekRows.filter(r=>sickCoaches.some(s=>parseCoaches(r.Coach).includes(s))).sort((a,b)=>(dayKey(a.Datum)===dayKey(b.Datum)?(a.Start||"").localeCompare(b.Start||""):dayKey(a.Datum).localeCompare(dayKey(b.Datum))));
  const allCoaches=[...new Set(weekRows.map(r=>parseCoaches(r.Coach)).flat())];
  const extraForRow=(r)=>{
    const tS=r.Start||"00:00",tE=r.Slut||"23:59",dK=dayKey(r.Datum);
    const avail=allCoaches.filter(c=>!sickCoaches.includes(c)).filter(c=>{
      const cRows=weekRows.filter(x=>parseCoaches(x.Coach).includes(c)&&dayKey(x.Datum)===dK);
      return!cRows.some(x=>overlap(x.Start||"00:00",x.Slut||"23:59",tS,tE));
    });
    return avail.length?`<span class="okpill">Ers√§ttare: ${avail.join(", ")}</span>`:`<span class="pill">Inga ers√§ttare</span>`;
  };
  const grouped=groupByDate(sickRows);let html="";
  Object.keys(grouped).forEach(k=>{
    const rows=grouped[k].map(r=>{
      const cs=parseCoaches(r.Coach),sick=cs.filter(c=>sickCoaches.includes(c)),others=cs.filter(c=>!sickCoaches.includes(c));
      const coachText=[sick.length?`Sjuk: ${sick.join(", ")}`:"",others.length?`√ñvriga: ${others.join(", ")}`:""].filter(Boolean).join(" ‚Ä¢ ");
      return {...r,Coach:coachText};
    });
    html+=sectionHTML(k,rows,extraForRow,true);
  });
  document.getElementById("schemaContainer").innerHTML=sickRows.length?html:`<p>Inga pass f√∂r valda coacher under denna vecka.</p>`;
}

document.getElementById("btnDaily").onclick=()=>{document.getElementById("coachSelect").style.display="none";document.getElementById("sickPanel").style.display="none";renderDaily(DATA);};
document.getElementById("btnCoach").onclick=()=>{document.getElementById("sickPanel").style.display="none";document.getElementById("coachSelect").style.display="inline-block";};
document.getElementById("btnSick").onclick=()=>{document.getElementById("coachSelect").style.display="none";document.getElementById("sickPanel").style.display="block";document.getElementById("schemaContainer").innerHTML=`<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;};
document.getElementById("btnShowSick").onclick=()=>{const s=getSelectedSick();if(!s.length){document.getElementById("sickMsg").textContent="V√§lj minst en coach.";return;}document.getElementById("sickMsg").textContent="";renderSickSchedule(DATA,s);};
document.getElementById("btnClearSick").onclick=()=>{document.querySelectorAll("#sickList input").forEach(cb=>cb.checked=false);document.getElementById("sickMsg").textContent="";document.getElementById("schemaContainer").innerHTML=`<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;};

loadData();
setInterval(loadData,15*60*1000);
</script>
</body>
</html>

