<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schema â€“ Deltagare & Coacher</title>
<style>
:root{
  --bg:#e9eef3;              /* bakgrundsfÃ¤rg */
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 2px 5px rgba(0,0,0,.1);
  --radius:12px;
  --muted:#555;
  --band:#9ecbff;
  --header-bg:#f5f7fa;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1800px;
  margin:0 auto;
  padding:16px;
}
header{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  margin-bottom:16px;
}
header img{
  height:60px;
  width:auto;
}
header h1{
  font-size:1.8rem;
  font-weight:700;
}
small{color:var(--muted);display:block;text-align:center;margin-top:4px;}

.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  margin:12px 0 18px;
}
button,select{
  font-size:1rem;
  padding:10px 16px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#f8f8f8;
  cursor:pointer;
  transition:.15s background;
}
button:hover{background:#eee;}
select{min-width:220px;}
#viewTitle{text-align:center;margin:12px 0 8px;font-weight:600;}

.cards{
  display:flex;
  flex-direction:column;
  gap:10px;
  max-width:900px;
  margin:0 auto;
}
.card{
  position:relative;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:10px 14px;
  box-shadow:var(--shadow);
}
.card::before{
  content:"";
  position:absolute;
  left:0;top:0;bottom:0;width:6px;
  background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 4px;font-size:1.05rem;}
.card .row{font-size:.95rem;color:#222;}

#blockContainer{display:none;margin-top:6px;}

.schema-wrap{
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  justify-content:center;
  align-items:flex-start;
}
.schema{
  flex:1 1 360px;
  min-width:320px;
  max-width:520px;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:10px;
  box-shadow:var(--shadow);
}

/* ==== Veckoschema utan linjer ==== */
.block-header{
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  font-weight:700;
  font-size:.9rem;
  background:var(--header-bg);
  border-radius:10px 10px 0 0;
  text-transform:capitalize;
}
.block-header div{
  text-align:center;
  padding:6px 0;
}
.block-grid{
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  background:transparent;
}
.block-time{
  font-size:.85rem;
  padding:3px 4px;
  text-align:right;
  color:#333;
}
.block-cell{
  position:relative;
  min-height:28px;
  background:transparent;
  border:none; /* inga linjer */
}
.block{
  position:absolute;
  left:2px;right:2px;top:2px;
  border-radius:8px;
  padding:4px 6px;
  line-height:1.2;
  border:none;
  font-size:.8rem;
  color:#222;
  box-shadow:var(--shadow);
  word-break:break-word;
  overflow:hidden;
  -webkit-print-color-adjust:exact;
  print-color-adjust:exact;
}
.block .title{font-weight:600;}
.helper-panels{
  max-width:1000px;
  margin:0 auto;
}
.panel{
  display:none;
  background:#fff;
  border:1px solid #ccc;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,.1);
  padding:16px;
  margin:14px auto;
}
.panel h2{margin:6px 0 12px;}
.list-two-col{
  display:flex;
  gap:30px;
  justify-content:center;
  flex-wrap:wrap;
}
.list-two-col>div{min-width:240px;}

#nowContainer{max-width:900px;margin:10px auto;}

/* SchemalÃ¤ggning meny */
.dropdown {
  position:relative;
  display:inline-block;
}
.dropdown-content{
  display:none;
  position:absolute;
  background:#fff;
  box-shadow:0 3px 10px rgba(0,0,0,.1);
  border-radius:10px;
  min-width:200px;
  z-index:2;
}
.dropdown-content button{
  width:100%;
  border:none;
  text-align:left;
  border-radius:0;
  background:#fff;
}
.dropdown-content button:hover{background:#f3f3f3;}
.dropdown:hover .dropdown-content{display:block;}

@media (max-width:760px){
  body{padding:8px;}
  .toolbar{flex-direction:column;}
  button,select{width:95%;font-size:1.08rem;}
}

@media print{
  body{background:#e9eef3;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,.helper-panels{display:none!important;}
  #blockContainer{display:block!important;}
  #blockContainer .block-cell{border:none!important;}
  .schema{page-break-inside:avoid;}
  @page{size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logo">
  <h1>Schema</h1>
</header>
<small>Veckoschema med flervy, schemalÃ¤ggning och utskrift</small>

<div class="toolbar">
  <button id="btnParticipant">Deltagarschema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="nameSelect"><option value="">-- VÃ¤lj deltagare --</option></select>
  <select id="coachSelect" style="display:none"><option value="">-- VÃ¤lj coach --</option></select>

  <button id="btnCards">Dagens schema</button>
  <button id="btnBlocks">Veckoschema</button>
  <div class="dropdown">
    <button>ğŸ“… SchemalÃ¤ggning</button>
    <div class="dropdown-content">
      <button id="btnCompare">ğŸ” JÃ¤mfÃ¶r scheman</button>
      <button id="btnSick">ğŸ©º Hitta ersÃ¤ttare</button>
    </div>
  </div>
  <button id="btnPrint">ğŸ–¨ï¸ Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>
<div id="nowContainer"></div>

<div id="blockContainer">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
</div>

<!-- Panels fÃ¶r jÃ¤mfÃ¶relse och ersÃ¤ttare -->
<div class="helper-panels">
  <div id="comparePanel" class="panel">
    <h2>JÃ¤mfÃ¶r scheman</h2>
    <div class="list-two-col">
      <div><h3>Coacher</h3><div id="coachListCompare"></div></div>
      <div><h3>Deltagare</h3><div id="participantListCompare"></div></div>
    </div>
    <button id="btnShowCompare">Visa valda scheman</button>
  </div>

  <div id="sickPanel" class="panel">
    <h2>Hitta ersÃ¤ttare</h2>
    <select id="sickCoachSelect"><option value="">-- VÃ¤lj sjuk coach --</option></select>
    <div id="sickResult"></div>
  </div>
</div>
<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

/* ğŸ¨ FÃ¤rg + emoji per aktivitet */
const aktivitetFarger={
 "MÃ¥ndagsmÃ¶te":{color:"#AED6F1",emoji:"ğŸ“…"},
 "GruppmÃ¶te":{color:"#7FB3D5",emoji:"ğŸ‘¥"},
 "Lunch":{color:"#F9E79F",emoji:"ğŸ²"},
 "Frukost":{color:"#FAD7A0",emoji:"ğŸ¥"},
 "AteljÃ©":{color:"#F5CBA7",emoji:"ğŸ¨"},
 "Musik":{color:"#D2B4DE",emoji:"ğŸ¶"},
 "Pod":{color:"#A9CCE3",emoji:"ğŸ™ï¸"},
 "Padel":{color:"#82E0AA",emoji:"ğŸ“"},
 "Lite av varje":{color:"#FADBD8",emoji:"âœ¨"},
 "Yoga":{color:"#D5F5E3",emoji:"ğŸ§˜"},
 "Gym":{color:"#A3E4D7",emoji:"ğŸ‹ï¸â€â™‚ï¸"},
 "Film":{color:"#E6B0AA",emoji:"ğŸ¬"},
 "FÃ¶reningsgruppen":{color:"#D6DBDF",emoji:"ğŸ¤"},
 "Trummor":{color:"#F1948A",emoji:"ğŸ¥"},
 "Ã…terkoppling":{color:"#85C1E9",emoji:"ğŸ”„"},
 "Medicin":{color:"#E59866",emoji:"ğŸ’Š"},
 "Biljard":{color:"#A9DFBF",emoji:"ğŸ±"},
 "Spelgruppen":{color:"#F8C471",emoji:"ğŸ²"},
 "SÃ¶mnad":{color:"#F5EEF8",emoji:"ğŸ§µ"},
 "Filmgruppen":{color:"#E6B0AA",emoji:"ğŸ¬"},
 "Musikquizz":{color:"#D2B4DE",emoji:"ğŸ¶"},
 "MusikdokumentÃ¤r":{color:"#D2B4DE",emoji:"ğŸ¶"},
 "Warhammer":{color:"#C39BD3",emoji:"ğŸ›¡ï¸"},
 "Utflykt":{color:"#A9CCE3",emoji:"ğŸšŒ"},
 "Uppstart Taket":{color:"#AED6F1",emoji:"ğŸŒ¤ï¸"},
 "GÃ¥trÃ¤ning":{color:"#ABEBC6",emoji:"ğŸš¶â€â™‚ï¸"},
 "Promenad":{color:"#ABEBC6",emoji:"ğŸš¶â€â™€ï¸"},
 "Baka":{color:"#FAD7A0",emoji:"ğŸ§"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#f4f6f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];

/* ğŸ”„ Ladda data frÃ¥n Google Script */
async function loadData(){
 try{
   const res=await fetch(url+"?t="+Date.now());
   const json=await res.json();
   DATA=json.data||[];
   fillNameList();
   fillCoachList();
   fillCompareLists();
   document.getElementById("sickCoachSelect").innerHTML='<option value="">-- VÃ¤lj sjuk coach --</option>'+
   [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
     .filter(x=>x&&x.toLowerCase()!=="alla").sort().map(c=>`<option>${c}</option>`).join("");
 }catch(e){console.error(e);}
}
loadData();

/* ğŸ‘¤ Fyll listor */
function fillNameList(){
 const s=document.getElementById("nameSelect");
 s.innerHTML='<option value="">-- VÃ¤lj deltagare --</option>';
 [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
   const o=document.createElement("option");
   o.value=n;o.textContent=n;s.appendChild(o);
 });
}
function fillCoachList(){
 const s=document.getElementById("coachSelect");
 s.innerHTML='<option value="">-- VÃ¤lj coach --</option>';
 [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
   const o=document.createElement("option");
   o.value=c;o.textContent=c;s.appendChild(o);
 });
}
function fillCompareLists(){
 const cList=document.getElementById("coachListCompare");
 const pList=document.getElementById("participantListCompare");
 cList.innerHTML="";pList.innerHTML="";
 [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
   cList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-coach" value="${c}"> ${c}</label><br>`);
 });
 [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
   pList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-delt" value="${n}"> ${n}</label><br>`);
 });
}

/* ğŸ´ Lunchregel */
function applyLunchRule(rows,name,isCoach){
 return rows.filter(r=>{
   const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
   const field=isCoach?"Coach":"Deltagare";
   const isAll=(r[field]||"").trim().toLowerCase()==="alla";
   if(isLunch&&isAll){
     const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&(x.Aktivitet||"").toLowerCase().includes("lunch")&&(x[field]||"").toLowerCase().includes(name.toLowerCase()));
     if(specific) return false;
   }
   return true;
 });
}

/* ğŸ—“ï¸ Dagens schema */
function renderCards(name,isCoach){
 const today=todayKey();
 const field=isCoach?"Coach":"Deltagare";
 const rows=applyLunchRule(
  DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
 let html=`<div class='cards'>`;
 if(!rows.length) html+="<p>Inga aktiviteter idag.</p>";
 rows.forEach(r=>{
   const e=emojiFor(r);
   html+=`<div class="card" style="--band:${colorFor(r)}">
     <h3>${e} ${r.Aktivitet||"Aktivitet"}</h3>
     <div class="row">ğŸ•’ ${r.Start||""}â€“${r.Slut||""}</div>
     <div class="row">${isCoach?"ğŸ‘¥ Deltagare: "+(r.Deltagare||"-"):"ğŸ§‘â€ğŸ« Coach: "+(r.Coach||"-")}</div>
   </div>`;
 });
 html+="</div>";
 document.getElementById("schemaContainer").innerHTML=html;
 document.getElementById("schemaContainer").style.display="block";
 document.getElementById("blockContainer").style.display="none";
 document.getElementById("btnPrint").style.display="inline-block";
 document.getElementById("viewTitle").textContent=`Dagens schema â€“ ${name}`;
}

/* ğŸ§© Veckoschema utan linjer */
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
function renderBlocks(name,isCoach){
 const slots=makeSlots(), days=["mÃ¥ndag","tisdag","onsdag","torsdag","fredag"];
 const field=isCoach?"Coach":"Deltagare";
 const rows=applyLunchRule(DATA.filter(r=>{
   const str=(r[field]||"").toLowerCase();
   return str.includes(name.toLowerCase())||str==="alla";
 }),name,isCoach);
 const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
 head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
 grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
 slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
 const cells=[...grid.children], dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
 const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
 rows.forEach(r=>{
   const dIndex=new Date(r.Datum).getDay()-1;
   if(dIndex<0||dIndex>4)return;
   const col=dIndex+1;
   const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);if(sIdx<0||eIdx<=sIdx)return;
   const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
   const block=document.createElement("div");
   block.className="block";block.style.background=colorFor(r);
   block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>${r.Start||""}â€“${r.Slut||""}<br>${isCoach?"ğŸ‘¥ "+(r.Deltagare||"-"):"ğŸ§‘â€ğŸ« "+(r.Coach||"-")}`;
   requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
   firstCell.appendChild(block);
 });
 document.getElementById("viewTitle").textContent=`Veckoschema â€“ ${name}`;
 document.getElementById("schemaContainer").style.display="none";
 document.getElementById("blockContainer").style.display="block";
 document.getElementById("btnPrint").style.display="inline-block";
}

/* ğŸ”˜ Knappar */
document.getElementById("btnParticipant").onclick=()=>{
 document.getElementById("coachSelect").style.display="none";
 document.getElementById("nameSelect").style.display="inline-block";
 document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
 document.getElementById("nameSelect").style.display="none";
 document.getElementById("coachSelect").style.display="inline-block";
 document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
 const n=document.getElementById("nameSelect").style.display!=="none"
  ?document.getElementById("nameSelect").value
  :document.getElementById("coachSelect").value;
 if(n)renderCards(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnBlocks").onclick=()=>{
 const n=document.getElementById("nameSelect").style.display!=="none"
  ?document.getElementById("nameSelect").value
  :document.getElementById("coachSelect").value;
 if(n)renderBlocks(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnPrint").onclick=()=>window.print();
</script>
<script>
/* ğŸ©º Hitta ersÃ¤ttare */
document.getElementById("btnSick").onclick = () => {
  document.getElementById("sickPanel").style.display = "block";
  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("btnPrint").style.display = "none";
  document.getElementById("viewTitle").textContent = "Hitta ersÃ¤ttare (sjuk coach)";
};

document.getElementById("sickCoachSelect").onchange = () => {
  const coach = document.getElementById("sickCoachSelect").value;
  if (!coach) return;
  const today = todayKey();

  // hitta pass fÃ¶r sjuk coach
  const todaysPass = DATA.filter(r =>
    dayKey(r.Datum) === today &&
    (r.Coach || "").toLowerCase().includes(coach.toLowerCase())
  );

  // alla andra coacher
  const otherCoaches = [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla" && x!==coach);

  // kolla vilka som Ã¤r lediga samma tider
  const freeCoaches = otherCoaches.filter(c=>{
    return !DATA.some(r=>{
      if(dayKey(r.Datum)!==today)return false;
      if(!(r.Coach||"").toLowerCase().includes(c.toLowerCase()))return false;
      const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
      const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
      const s=sh*60+sm,e=eh*60+em;
      return todaysPass.some(tp=>{
        const [th,tm]=(tp.Start||"00:00").split(":").map(Number);
        const [xh,xm]=(tp.Slut||"00:00").split(":").map(Number);
        const ts=th*60+tm,te=xh*60+xm;
        return !(e<=ts || s>=te);
      });
    });
  });

  let html = `<h3>${coach}s pass idag</h3>`;
  if (!todaysPass.length) html += `<p>Inga pass idag.</p>`;
  else html += `<ul>` + todaysPass.map(r=>`<li>${emojiFor(r)} ${r.Aktivitet} (${r.Start}â€“${r.Slut})</li>`).join("") + `</ul>`;
  html += `<h3>TillgÃ¤ngliga coacher</h3>`;
  if (!freeCoaches.length) html += `<p>Inga lediga coacher just nu.</p>`;
  else html += `<ul>` + freeCoaches.map(c=>`<li>${c}</li>`).join("") + `</ul>`;
  document.getElementById("sickResult").innerHTML = html;
};

/* ğŸ” JÃ¤mfÃ¶r scheman (flervy â€“ veckoblock) */
document.getElementById("btnCompare").onclick = () => {
  document.getElementById("comparePanel").style.display = "block";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("btnPrint").style.display = "none";
  document.getElementById("viewTitle").textContent = "JÃ¤mfÃ¶r scheman";
};

document.getElementById("btnShowCompare").onclick = () => {
  const selectedNames = [
    ...document.querySelectorAll(".chk-delt:checked"),
    ...document.querySelectorAll(".chk-coach:checked")
  ].map(cb => ({
    name: cb.value,
    isCoach: cb.classList.contains("chk-coach")
  }));
  if (!selectedNames.length) {
    alert("VÃ¤lj minst en person fÃ¶rst.");
    return;
  }

  // generera veckoscheman bredvid varandra
  const wrap = document.createElement("div");
  wrap.className = "schema-wrap";
  selectedNames.forEach(sel => {
    const div = document.createElement("div");
    div.className = "schema";
    div.appendChild(renderSingleWeek(sel.name, sel.isCoach));
    wrap.appendChild(div);
  });

  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").innerHTML = "";
  document.getElementById("schemaContainer").appendChild(wrap);
  document.getElementById("schemaContainer").style.display = "block";
  document.getElementById("btnPrint").style.display = "inline-block";
  document.getElementById("viewTitle").textContent = "JÃ¤mfÃ¶relse av veckoscheman";
};

/* ğŸ§± Bygg veckoschema fÃ¶r varje person i jÃ¤mfÃ¶relsen */
function renderSingleWeek(name,isCoach){
  const slots=["08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30"];
  const days=["mÃ¥ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach);
  const container=document.createElement("div");
  container.innerHTML=`<h3 style="text-align:center;margin-bottom:6px">${isCoach?"Coach: ":"Deltagare: "}${name}</h3>
  <div class="block-header"><div>Tid</div>${days.map(d=>`<div>${d}</div>`).join("")}</div>
  <div class="block-grid"></div>`;
  const grid=container.querySelector(".block-grid");
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children],dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dIndex=new Date(r.Datum).getDay()-1;
    if(dIndex<0||dIndex>4)return;
    const col=dIndex+1;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";block.style.background=colorFor(r);
    block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>${r.Start||""}â€“${r.Slut||""}<br>${isCoach?"ğŸ‘¥ "+(r.Deltagare||"-"):"ğŸ§‘â€ğŸ« "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  return container;
}

/* ğŸ•’ PÃ¥gÃ¥r just nu */
document.getElementById("btnNow").onclick = () => {
  const now = new Date();
  const minsNow = now.getHours() * 60 + now.getMinutes();
  const today = todayKey();
  const active = DATA.filter(r => {
    if (dayKey(r.Datum) !== today) return false;
    const [sh, sm] = (r.Start || "00:00").split(":").map(Number);
    const [eh, em] = (r.Slut || "00:00").split(":").map(Number);
    const start = sh * 60 + sm, end = eh * 60 + em;
    return minsNow >= start && minsNow <= end;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const cont = document.getElementById("nowContainer");
  cont.innerHTML = `<h2 style="text-align:center">â±ï¸ PÃ¥gÃ¥r just nu</h2>`;
  if (!active.length) {
    cont.innerHTML += `<p style="text-align:center">Inga aktiviteter pÃ¥gÃ¥r just nu.</p>`;
    return;
  }
  cont.innerHTML += `<div class="cards">` +
    active.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">ğŸ•’ ${r.Start||""}â€“${r.Slut||""}</div>
        <div class="row">ğŸ§‘â€ğŸ« Coach: ${r.Coach||"-"}</div>
        <div class="row">ğŸ‘¥ Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") +
    `</div>`;
  document.getElementById("viewTitle").textContent = "PÃ¥gÃ¥r just nu";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("btnPrint").style.display = "none";
};

/* StÃ¤ng Ã¶vriga paneler nÃ¤r man vÃ¤xlar vy */
function hidePanels(){
 document.getElementById("comparePanel").style.display="none";
 document.getElementById("sickPanel").style.display="none";
}
</script>
</body>
</html>

