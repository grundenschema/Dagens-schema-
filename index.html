<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Schema ‚Äì Deltagare & Coacher</title>
<style>
:root {
  --bg:#fafafa;
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 3px 10px rgba(0,0,0,.06);
  --radius:14px;
  --muted:#555;
  --band:#9ecbff;
  --header-bg:#f5f7fa;
  --chip-bg:#f8fafc;
  --chip-border:#cfd8e3;
  --chip-active:#3b82f6;
  --chip-text:#1f2937;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1800px;
  margin:0 auto;
  padding:16px;
}

/* ===== header ===== */
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  margin-bottom:12px;
}
header img{height:60px;width:auto;cursor:pointer;}
#clock{font-weight:600;color:#333;font-size:1.1rem;letter-spacing:.5px}

/* ===== toolbar ===== */
.toolbar{
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
  justify-content:center;
  margin:12px 0 16px;
}
.toolbar-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  align-items:center;
}
button,select{
  font-size:1rem;
  padding:10px 16px;
  border-radius:12px;
  border:1px solid #cfd8e3;
  background:#fff;
  cursor:pointer;
  transition:.15s background,.15s transform;
}
button:hover{background:#eef2f7}
button:active{transform:translateY(1px)}
select{min-width:220px;background:#fff}
#viewTitle{text-align:center;margin:10px 0 8px;font-weight:700;}

/* ===== cards (dagens/nu) ===== */
.cards{
  display:flex;
  flex-direction:column;
  gap:10px;
  max-width:1100px;
  margin:0 auto;
}
.card{
  position:relative;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px 14px;
  box-shadow:var(--shadow);
}
.card::before{
  content:"";
  position:absolute;
  left:0;top:0;bottom:0;width:6px;
  background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 6px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

/* ===== block schema (veckoschema) ===== */
#blockContainer{display:none;margin-top:6px;}
.block-header{
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  font-weight:800;
  font-size:.92rem;
  background:var(--header-bg);
  border-radius:10px 10px 0 0;
  text-transform:capitalize;
}
.block-header div{text-align:center;padding:8px 0;}
.block-grid{
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  background:transparent;
}
.block-time{
  font-size:.86rem;
  padding:4px 6px;
  text-align:right;
  color:#2b2b2b;
}
.block-cell{
  position:relative;
  min-height:28px;
  background:transparent;
  border:none;
}
.block{
  position:absolute;
  left:2px; right:2px; top:2px;
  border-radius:10px;
  padding:6px 8px;
  line-height:1.25;
  font-size:.82rem;
  color:#111;
  box-shadow:var(--shadow);
  border:1px solid rgba(0,0,0,0.15); /* tunn ram runt block */
  word-break:break-word;
  overflow:hidden;
  -webkit-print-color-adjust:exact;
  print-color-adjust:exact;
}
.block .title{font-weight:700}

/* ===== j√§mf√∂relse ===== */
.schema-wrap{
  display:flex;
  flex-direction:column;  /* under varandra */
  gap:20px;
  align-items:center;
}
.schema{
  width:95%;
  max-width:1100px;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
  box-shadow:var(--shadow);
}
.schema h3{margin:6px 0 10px;text-align:center;font-size:1.05rem}

/* ===== paneler ===== */
.helper-panels{max-width:1200px;margin:0 auto}
.panel{
  display:none;
  background:#fff;
  border:1px solid #cfd8e3;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:16px;
  margin:14px auto;
}
.panel h2{margin:4px 0 10px;font-size:1.2rem}

/* ===== utskrift ===== */
.print-visible{display:block !important;}
@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,.helper-panels,#nowContainer{display:none !important;}
  #schemaContainer,#blockContainer{display:none !important;}
  .print-visible{display:block !important;}
  .schema{page-break-inside:avoid;}
  @page{size:A4 landscape;margin:6mm;}
}

/* ===== responsiv ===== */
@media (max-width:760px){
  body{padding:8px}
  .toolbar-row{gap:8px}
  button,select{width:95%;font-size:1.05rem}
  .schema{min-width:92vw}
}
</style>
</head>

<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logo">
  <div id="clock"></div>
</header>

<!-- ===== toolbar ===== -->
<div class="toolbar">
  <div class="toolbar-row">
    <button id="btnParticipant">Deltagarschema</button>
    <button id="btnCoach">Coachschema</button>
    <div class="dropdown" id="scheduleDropdown">
      <button id="btnSchedule">üìÖ Schemal√§ggning ‚ñº</button>
      <div class="dropdown-content">
        <button id="btnCompare">üîç J√§mf√∂r scheman</button>
        <button id="btnSick">ü©∫ Hitta ers√§ttare</button>
      </div>
    </div>
  </div>
  <div class="toolbar-row">
    <button id="btnCards">Dagens schema</button>
    <button id="btnBlocks">Veckoschema</button>
    <button id="btnNow">P√•g√•r nu</button> <!-- ny knapp -->
  </div>
  <div class="toolbar-row" style="gap:8px;margin-top:4px;">
    <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
    <select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>
  </div>
</div>

<h2 id="viewTitle"></h2>

<div id="schemaContainer" class="print-scope"></div>
<div id="nowContainer"></div>
<div id="blockContainer" class="print-scope">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div style="text-align:center;margin-top:10px;">
    <button id="btnPrint" style="display:none;">üñ®Ô∏è Skriv ut</button>
  </div>
</div>

<!-- paneler (j√§mf√∂r + ers√§ttare) -->
<div class="helper-panels">
  <div id="comparePanel" class="panel">
    <h2>üîç J√§mf√∂r scheman</h2>
    <div class="chip-title">Coacher</div>
    <div id="coachListCompare" class="chip-group"></div>
    <div class="chip-title">Deltagare</div>
    <div id="participantListCompare" class="chip-group"></div>
    <div style="text-align:center;margin-top:12px;">
      <button id="btnShowCompare">Visa valda scheman</button>
    </div>
  </div>

  <div id="sickPanel" class="panel">
    <h2>ü©∫ Hitta ers√§ttare</h2>
    <select id="sickCoachSelect"><option value="">-- V√§lj sjuk coach --</option></select>
    <div style="margin-top:8px;">
      <label><input type="checkbox" id="chkFullWeek" checked> Visa hela veckan</label>
    </div>
    <div id="sickResult" style="margin-top:10px;"></div>
  </div>
</div>
<script>
/* ==================== DATAK√ÑLLA ==================== */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

/* ==================== HJ√ÑLPFUNKTIONER ==================== */
function hideAllViews(){
  ["schemaContainer","blockContainer","nowContainer","comparePanel","sickPanel"].forEach(id=>{
    document.getElementById(id).style.display="none";
  });
}
function showNowAndNext(){
  hideAllViews();
  const cont=document.getElementById("nowContainer");
  const today=todayKey();
  const now=new Date();
  const minsNow=now.getHours()*60+now.getMinutes();
  const all=DATA.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const ongo=all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const s=sh*60+sm,e=eh*60+em;
    return minsNow>=s&&minsNow<=e;
  });
  const next=all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const s=sh*60+sm;
    return s>minsNow;
  });
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(now);
  const time=now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
  let html=`<h2 style="text-align:center;margin-bottom:8px">‚è±Ô∏è ${label} ‚Äì kl. ${time}</h2>`;
  html+=`<h3 style="text-align:center;margin:8px 0 6px">P√•g√•r nu</h3>`;
  if(!ongo.length) html+="<p style='text-align:center'>Inga aktiviteter p√•g√•r just nu.</p>";
  else html+=`<div class="cards">${ongo.map(r=>`
    <div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
      <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
    </div>`).join("")}</div>`;
  html+=`<h3 style="text-align:center;margin:12px 0 6px">Kommande idag</h3>`;
  if(!next.length) html+="<p style='text-align:center'>Inget mer planerat idag.</p>";
  else html+=`<div class="cards">${next.map(r=>`
    <div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
      <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
    </div>`).join("")}</div>`;
  cont.innerHTML=html;
  cont.style.display="block";
}

/* ==================== DATAHANTERING ==================== */
let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList();
    fillCoachList();
    fillCompareLists();
    fillSickList();
    showNowAndNext(); // visa direkt vid start
  }catch(e){console.error(e);}
}
loadData();

/* ==================== KLOCKA ==================== */
function updateClock(){
  const el=document.getElementById("clock");
  if(!el) return;
  const now=new Date();
  const time=now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
  el.textContent=time;
}
setInterval(updateClock,1000);
updateClock();

/* ==================== EVENTHANDLARE ==================== */
document.getElementById("btnNow").addEventListener("click",()=>showNowAndNext());
document.querySelector("header img").addEventListener("click",()=>{
  showNowAndNext();
  document.getElementById("viewTitle").textContent="";
});

/* ==================== UTSKRIFT ==================== */
document.getElementById("btnPrint").addEventListener("click",()=>{
  document.querySelectorAll('.print-scope').forEach(el=>el.classList.remove('print-visible'));
  let activeEl=null;
  if(document.getElementById("blockContainer").style.display==="block") activeEl=document.getElementById("blockContainer");
  else if(document.getElementById("schemaContainer").style.display==="block") activeEl=document.getElementById("schemaContainer");
  if(activeEl){
    activeEl.classList.add('print-visible');
    setTimeout(()=>{window.print();},200); // delay
    setTimeout(()=>activeEl.classList.remove('print-visible'),1000);
  }
});

/* ==================== ST√ñDFUNKTIONER ==================== */
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#edf2f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
/* ==================== RITA VECKOSCHEMA ==================== */
function makeSlots(){
  const a=[];
  for(let h=8;h<=16;h++){
    a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);
  }
  a.push("16:30");
  return a;
}

function renderBlocks(name,isCoach){
  hideAllViews();
  const slots=makeSlots();
  const days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=(r[field]||"").split(/,|\/|;|\n/).map(x=>x.trim().toLowerCase());
    return list.includes(name.toLowerCase())||(r[field]||"").trim().toLowerCase()==="alla";
  });

  const head=document.getElementById("blockHeader"),
        grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
  grid.innerHTML="";
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;

  slots.forEach(t=>{
    grid.innerHTML+=`<div class='block-time'>${t}</div>`+
      days.map(()=>"<div class='block-cell'></div>").join("");
  });

  const cells=[...grid.children];
  rows.forEach(r=>{
    const d=new Date(r.Datum);
    let wd=d.getDay();
    if(wd===0||wd===6) return;
    const col=(wd-1)+1;
    const sIdx=slots.indexOf(r.Start),
          eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx) return;

    const firstCellIndex=sIdx*(1+days.length)+col,
          firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);

    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const duration=(eh*60+em)-(sh*60+sm);

    if(duration>30){
      block.innerHTML=
        `<div class="title">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
         ${emojiFor(r)} ${r.Aktivitet||""}<br>
         ${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    }else{
      block.innerHTML=
        `${emojiFor(r)} ${r.Aktivitet||""} ‚Äì ${
          isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")
        }`;
    }

    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight||28;
      block.style.height=(eIdx-sIdx)*cellH+"px";
    });
    firstCell.appendChild(block);
  });

  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
}

/* ==================== DAGENS SCHEMA ==================== */
function renderCards(name,isCoach){
  hideAllViews();
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=(r[field]||"").split(/,|\/|;|\n/).map(x=>x.trim().toLowerCase());
    return list.includes(name.toLowerCase())||(r[field]||"").trim().toLowerCase()==="alla";
  }).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  let html="<div class='cards'>";
  if(!rows.length) html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  const c=document.getElementById("schemaContainer");
  c.innerHTML=html;
  c.style.display="block";
  document.getElementById("btnPrint").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

/* ==================== KNAPPAR ==================== */
document.getElementById("btnParticipant").onclick=()=>{
  hideAllViews();
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
  hideAllViews();
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
  const isCoach=document.getElementById("coachSelect").style.display!=="none";
  const n=isCoach?document.getElementById("coachSelect").value:document.getElementById("nameSelect").value;
  if(n) renderCards(n,isCoach);
};
document.getElementById("btnBlocks").onclick=()=>{
  const isCoach=document.getElementById("coachSelect").style.display!=="none";
  const n=isCoach?document.getElementById("coachSelect").value:document.getElementById("nameSelect").value;
  if(n) renderBlocks(n,isCoach);
};

/* ==================== F√ÑRGER & EMOJIS ==================== */
const aktivitetFarger={
 "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},
 "Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
 "Lunch":{color:"#F9E79F",emoji:"üç≤"},
 "Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
 "Morgonrutiner":{color:"#FAD7A0",emoji:"‚òÄÔ∏è"},
 "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},
 "Musik":{color:"#D2B4DE",emoji:"üé∂"},
 "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},
 "Padel":{color:"#82E0AA",emoji:"üèì"},
 "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},
 "Yoga":{color:"#D5F5E3",emoji:"üßò"},
 "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
 "Film":{color:"#E6B0AA",emoji:"üé¨"},
 "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},
 "Trummor":{color:"#F1948A",emoji:"ü•Å"},
 "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},
 "Medicin":{color:"#E59866",emoji:"üíä"},
 "Biljard":{color:"#A9DFBF",emoji:"üé±"},
 "Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
 "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},
 "Utflykt":{color:"#A9CCE3",emoji:"üöå"},
 "G√•tr√§ning":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÇÔ∏è"},
 "Promenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},
 "Baka":{color:"#FAD7A0",emoji:"üßÅ"},
 "Lokalv√•rd":{color:"#E5E7E8",emoji:"üßπ"},
 "√ñppen verkstad":{color:"#E5E7E8",emoji:"üß∞"},
 "Behandling":{color:"#FDEDEC",emoji:"üíÜ‚Äç‚ôÄÔ∏è"},
 "Relax Massagestol":{color:"#FDEDEC",emoji:"üí∫"},
 "Ladda stol":{color:"#FAD7A0",emoji:"‚òïüîã"},
 "Warhammer":{color:"#C39BD3",emoji:"üõ°Ô∏è"},
 "Autentiskt relaterande":{color:"#D6DBDF",emoji:"ü§ù"},
 "Handla":{color:"#E5E7E8",emoji:"üõí"},
 "Foto":{color:"#E8DAEF",emoji:"üì∏"},
 "Poesigrupp":{color:"#FDEBD0",emoji:"‚úçÔ∏è"},
 "Samtal":{color:"#FCF3CF",emoji:"üí¨"},
 "Gym Slottskogens Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
 "Avslappning":{color:"#D5F5E3",emoji:"ü™∑"},
 "Fika, Ladda stol":{color:"#FAD7A0",emoji:"‚òïüîã"}
};

</script>
</body>
</html>
