<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grunden DV ‚Äì Schema</title>
<style>
:root{
  --card-bg:#fff; --page-bg:#fafafa; --border:#ddd; --muted:#555; --heading:#2c3e50;
  --shadow:0 6px 18px rgba(0,0,0,.05); --radius:16px; --pad:14px; --band:#9ecbff;
  --grid-border:#bbb; --time-col:#fafafa;
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  max-width:1100px;margin:0 auto;padding:20px;background:var(--page-bg);
}
header{text-align:center;margin-bottom:15px;}
header img{height:65px;margin:10px auto;display:block;}
#clock{font-family:ui-monospace;font-size:.9rem;color:#333;}
#updated{font-size:.8rem;color:var(--muted);margin-top:4px;}
.toolbar{
  display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:18px 0;
}
button,select{
  padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;
  cursor:pointer;font-size:15px;
}
button:hover{background:#ececec;}
#coachSelect{display:none;}
#btnBlocks,#btnCards{display:none;}

#sickPanel{display:none;border:1px solid var(--border);background:var(--card-bg);
  border-radius:14px;padding:12px;box-shadow:var(--shadow);}
#sickList{display:flex;flex-wrap:wrap;gap:8px 14px;max-height:220px;overflow:auto;}
#sickList label{display:flex;align-items:center;gap:6px;white-space:nowrap;}

/* Kortvy */
.cards {display:flex;flex-direction:column;gap:18px;margin-bottom:25px;}
.card {position:relative;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);
  width:100%;max-width:800px;margin:0 auto;transition:transform .1s;}
.card:hover{transform:translateY(-3px);}
.card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:8px;
  background:var(--band);border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);}
.card-title{font-weight:800;font-size:1.1rem;margin:4px 0 8px;display:flex;align-items:center;gap:8px;}
.row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;font-size:1rem;padding:2px 0;}
.row label{color:#333;font-weight:700;}

/* Blockschema */
.block-wrap{display:none;}
.block-header{display:grid;grid-template-columns:80px repeat(5,1fr);gap:0;font-weight:700;text-transform:capitalize;margin:10px 0 6px;}
.block-header div{padding:6px 8px;border:1px solid var(--grid-border);background:#f3f6ff;}
.block-header div:first-child{background:var(--time-col);}
.block-grid{display:grid;grid-template-columns:80px repeat(5,1fr);border:1px solid var(--grid-border);border-top:none;}
.block-time{background:var(--time-col);border-top:1px solid var(--grid-border);border-right:1px solid var(--grid-border);padding:4px 6px;font-size:.9rem;}
.block-cell{position:relative;border-top:1px solid var(--grid-border);border-right:1px solid var(--grid-border);min-height:28px;}
.block{position:absolute;left:2px;right:2px;top:2px;border-radius:6px;border:1px solid rgba(0,0,0,.15);padding:4px 6px;font-size:.85rem;line-height:1.2;overflow:hidden;}
.block .title{font-weight:700;margin-bottom:2px;}
.block .small{font-size:.8rem;opacity:.95;}

/* Utskrift */
@media print {
  body {background:white;color:black;font-size:8pt;margin:0;line-height:1.2;}
  header, .toolbar, #sickPanel, #clock {display:none !important;}
  #viewTitle {text-align:center;font-size:10pt;font-weight:bold;margin:0 0 4px 0;}
  .cards, .card, table {display:none !important;}
  .block-wrap{display:block !important;}
  .block-header{grid-template-columns:70px repeat(5,1fr);}
  .block-header div{padding:3px 4px;background:#eee !important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  .block-grid{grid-template-columns:70px repeat(5,1fr);border:none;}
  .block-time{padding:2px 3px;font-size:8pt;border:none;}
  .block-cell{min-height:18px;border:none !important;position:relative;}
  .block{border-radius:4px;padding:2px 3px;font-size:8pt;-webkit-print-color-adjust:exact;print-color-adjust:exact;background-color:inherit !important;box-shadow:none;}
  @page {size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnBlocks">Veckoblock</button>
  <button id="btnCards">Kortvy</button>
  <button id="btnSick">Sjukschema</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<div id="blockContainer" class="block-wrap" aria-hidden="true">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div id="printHint" style="font-size:.9rem;color:#444;margin-top:6px;display:none;text-align:center;">
    F√∂rhandsvisning ‚Äì anv√§nd webbl√§sarens <b>Skriv ut</b> (Ctrl/Cmd + P).
  </div>
</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";
const aktivitetFarger={
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},"Padel":{color:"#82E0AA",emoji:"üèì"},
  "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
  "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Trummor":{color:"#F1948A",emoji:"ü•Å"},
  "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},"Medicin":{color:"#E59866",emoji:"üíä"},
  "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
  "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},"Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
  "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},"Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"}
};

function getSEDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Stockholm"}));}
function fmtSE(dt,opts){return new Intl.DateTimeFormat("sv-SE",opts).format(dt);}
function updateClock(){
  const now=getSEDate();
  document.getElementById("clock").textContent=
    fmtSE(now,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateClock,1000);updateClock();

let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  document.getElementById("updated").textContent="Senast uppdaterad: "+(json.updated||"‚Äì");
  setupCoachSelect(DATA);
  renderDaily(DATA);
}

function parseCoaches(coachStr){
  const ignore=["","-",".","ingen","ingen coach","eget arbete","sj√§lvst√§ndigt","utan coach"];
  return (coachStr||"").split(/,|\/|&|\+|;|\||\n| och /i).map(c=>c.trim()).filter(c=>c&&!ignore.includes(c.toLowerCase())&&c.toLowerCase()!=="alla");
}

function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#fff"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function shrinkList(str,max=2){
  if(!str) return "-";
  const arr=String(str).split(/,|\/|;|\||\n| och /i).map(s=>s.trim()).filter(Boolean);
  if(arr.length<=max) return arr.join(", ");
  return arr.slice(0,max).join(", ") + `, +${arr.length-max} fler`;
}

function renderDaily(data){
  const today=dayKey(getSEDate().toISOString());
  const todays=data.filter(r=>dayKey(r.Datum)===today);
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").innerHTML=`<p>${todays.length} aktiviteter idag</p>`;
}

function setupCoachSelect(data){
  const s=document.getElementById("coachSelect");
  s.innerHTML=`<option value="">-- V√§lj coach --</option>`;
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });
  s.onchange=()=>{const v=s.value;if(v)renderCoachBlocks(DATA,v);};
}

/* === BLOCKSCHEMA === */
const SLOT_START="08:00",SLOT_END="16:30";
function makeSlots(){const s=[];let t=8*60;while(t<=16*60+30){s.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));t+=30;}return s;}
function weekdayIndex(d){const wd=new Date(d).getDay();return wd>=1&&wd<=5?wd:0;}
function timeToRowIndex(t,slots){return slots.indexOf(t)+1;}
function floorSlot(t){const[h,m]=t.split(":").map(Number);return`${String(h).padStart(2,"0")}:${m<30?"00":"30"}`;}
function renderCoachBlocks(data,coach){
  const slots=makeSlots();const workDays=new Set(data.filter(r=>parseCoaches(r.Coach).includes(coach)).map(r=>dayKey(r.Datum)));
  const rows=data.filter(r=>{const cs=parseCoaches(r.Coach),isAll=(r.Coach||"").trim().toLowerCase()==="alla",dk=dayKey(r.Datum);return cs.includes(coach)||(isAll&&workDays.has(dk));});
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("viewTitle").textContent="Veckoblock ‚Äì "+coach;
  const head=document.getElementById("blockHeader"),grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div><div>M√•ndag</div><div>Tisdag</div><div>Onsdag</div><div>Torsdag</div><div>Fredag</div>";
  grid.innerHTML="";
  slots.forEach(t=>{
    grid.innerHTML+=`<div class="block-time">${t}</div>`;
    for(let d=0;d<5;d++)grid.innerHTML+=`<div class="block-cell"></div>`;
  });
  const cells=[...grid.children];
  rows.forEach(r=>{
    const wd=weekdayIndex(r.Datum);if(!wd)return;
    const start=floorSlot(r.Start||SLOT_START);
    const end=floorSlot(r.Slut||SLOT_END);
    let sIdx=timeToRowIndex(start,slots);
    let eIdx=timeToRowIndex(end,slots)-1; // fix √∂verlapp
    if(sIdx<1||eIdx<sIdx)return;
    const cellIndex=(sIdx-1)*(1+5)+wd;
    const firstCell=cells[cellIndex];
    const slotsCovered=eIdx-sIdx+1;
    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);
    block.innerHTML=`
      <div class="title">${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</div>
      <div class="small">üë• ${shrinkList(r.Deltagare,2)}</div>
      <div class="small">üßë‚Äçüè´ ${shrinkList(r.Coach,2)}</div>`;
    requestAnimationFrame(()=>{const h=firstCell.clientHeight||28;block.style.height=(slotsCovered*h-3)+"px";});
    firstCell.appendChild(block);
  });
}

/* === Knappar === */
document.getElementById("btnCoach").onclick=()=>{document.getElementById("coachSelect").style.display="inline-block";};
document.getElementById("btnBlocks").onclick=()=>{const v=document.getElementById("coachSelect").value;if(v)renderCoachBlocks(DATA,v);};
document.getElementById("btnPrint").onclick=()=>{document.getElementById("printHint").style.display="block";};
loadData();
</script>
</body>
</html>


