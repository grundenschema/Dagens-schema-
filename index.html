<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schema ‚Äì Deltagare & Coacher</title>
<style>
:root{
  --bg:#e9eef3;              /* sober gr√•bl√• bakgrund */
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 2px 8px rgba(0,0,0,.10);
  --radius:12px;
  --muted:#555;
  --band:#9ecbff;
  --header-bg:#f5f7fa;
  --chip-bg:#f7f9fc;
  --chip-border:#cfd8e3;
  --chip-active:#e3efff;
  --chip-text:#1f2937;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1800px;
  margin:0 auto;
  padding:16px;
}
header{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  margin-bottom:8px;
}
header img{height:60px;width:auto;}
small{color:var(--muted);display:block;text-align:center;margin-top:2px;margin-bottom:12px;}

.toolbar{
  display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
  margin:12px 0 16px;
}
button,select{
  font-size:1rem;padding:10px 16px;border-radius:12px;border:1px solid #cfd8e3;background:#f8fafc;cursor:pointer;transition:.15s background, .15s transform;
}
button:hover{background:#eef2f7}
button:active{transform:translateY(1px)}
select{min-width:220px;background:#fff}
#viewTitle{text-align:center;margin:10px 0 8px;font-weight:700;}

/* Kort (Dagens/Now/Kommande/Ers√§ttare) */
.cards{
  display:flex;flex-direction:column;gap:10px;max-width:1100px;margin:0 auto;
}
.card{
  position:relative;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow);
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 6px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

/* Veckoschema */
#blockContainer{display:none;margin-top:6px;}
.block-header{
  display:grid;grid-template-columns:80px repeat(5,1fr);font-weight:800;font-size:.92rem;background:var(--header-bg);
  border-radius:10px 10px 0 0;text-transform:capitalize;
}
.block-header div{ text-align:center; padding:8px 0; }
.block-grid{ display:grid; grid-template-columns:80px repeat(5,1fr); background:transparent; }
.block-time{ font-size:.86rem; padding:4px 6px; text-align:right; color:#2b2b2b; }
.block-cell{ position:relative; min-height:28px; background:transparent; border:none; } /* inga linjer */
.block{
  position:absolute; left:2px; right:2px; top:2px;
  border-radius:10px; padding:6px 8px; line-height:1.2; border:none;
  font-size:.82rem; color:#111; box-shadow:var(--shadow);
  word-break:break-word; overflow:hidden; -webkit-print-color-adjust:exact; print-color-adjust:exact;
}
.block .title{font-weight:700}

/* Flervy i j√§mf√∂relse */
.schema-wrap{ display:flex; flex-wrap:nowrap; gap:16px; align-items:flex-start; overflow-x:auto; padding-bottom:8px; }
.schema{
  min-width:420px; max-width:520px; flex:0 0 auto;
  background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:10px; box-shadow:var(--shadow);
}
.schema h3{margin:6px 0 10px; text-align:center; font-size:1.05rem}

/* Paneler */
.helper-panels{ max-width:1200px; margin:0 auto }
.panel{
  display:none;background:#fff;border:1px solid #cfd8e3;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:16px;margin:14px auto;
}
.panel h2{margin:4px 0 10px;font-size:1.2rem}

/* J√§mf√∂r ‚Äì chips horisontellt */
.chip-group{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.chip-title{ font-weight:700; margin:10px 0 6px; }
.chip{
  display:inline-flex; align-items:center; gap:8px;
  background:var(--chip-bg); border:1px solid var(--chip-border); color:var(--chip-text);
  border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none;
  transition: background .15s, border-color .15s;
  font-size:.95rem;
}
.chip input{appearance:none; width:16px; height:16px; border:1px solid #94a3b8; border-radius:4px; display:inline-block; position:relative;}
.chip input:checked{ background:var(--chip-active); border-color:#7aa7ff; }
.chip input:checked::after{ content:""; position:absolute; inset:3px; background:#3b82f6; border-radius:2px; }
.chip.active{ background:var(--chip-active); border-color:#9ecbff; }

/* Dropdown ‚ÄúSchemal√§ggning‚Äù */
.dropdown{ position:relative; display:inline-block; }
.dropdown-content{
  display:none; position:absolute; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.15);
  border:1px solid #e5e7eb; border-radius:12px; min-width:220px; z-index:10; overflow:hidden;
}
.dropdown-content button{
  width:100%; border:none; text-align:left; background:#fff; border-radius:0; padding:10px 14px;
}
.dropdown-content button:hover{ background:#f5f7fa; }
.dropdown:hover .dropdown-content{ display:block; }

/* P√•g√•r nu */
#nowContainer{ max-width:1100px; margin:10px auto; }

/* Skriv ut */
@media print{
  body{ background:#fff; color:#000; font-size:9pt; margin:0; }
  header, .toolbar, .helper-panels, #nowContainer{ display:none !important; }
  /* visa den del som √§r aktiv vid utskrift */
  #schemaContainer, #blockContainer{ display:block !important; }
  .schema{ page-break-inside:avoid; }
  @page{ size:A4 landscape; margin:6mm; }
}

/* Responsiv */
@media (max-width:760px){
  body{padding:8px}
  .toolbar{flex-direction:column}
  button,select{width:95%;font-size:1.08rem}
  .schema{min-width:92vw}
}
</style>
</head>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logo">
</header>
<small>Veckoschema med flervy, schemal√§ggning, ers√§ttare och realtidsvy</small>

<div class="toolbar">
  <button id="btnParticipant">Deltagarschema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
  <select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>

  <button id="btnCards">Dagens schema</button>
  <button id="btnBlocks">Veckoschema</button>
  <button id="btnNow">‚è±Ô∏è P√•g√•r nu</button>

  <div class="dropdown">
    <button>üìÖ Schemal√§ggning</button>
    <div class="dropdown-content">
      <button id="btnCompare">üîç J√§mf√∂r scheman</button>
      <button id="btnSick">ü©∫ Hitta ers√§ttare</button>
    </div>
  </div>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>

<div id="schemaContainer"></div>
<div id="nowContainer"></div>

<!-- Veckoblock (singel vy) -->
<div id="blockContainer">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
</div>

<!-- Paneler -->
<div class="helper-panels">

  <!-- J√§mf√∂r -->
  <div id="comparePanel" class="panel">
    <h2>üîç J√§mf√∂r scheman</h2>
    <div class="chip-title">Coacher</div>
    <div id="coachListCompare" class="chip-group"></div>

    <div class="chip-title">Deltagare</div>
    <div id="participantListCompare" class="chip-group"></div>

    <div style="text-align:center; margin-top:12px;">
      <button id="btnShowCompare">Visa valda scheman</button>
    </div>
  </div>

  <!-- Ers√§ttare -->
  <div id="sickPanel" class="panel">
    <h2>ü©∫ Hitta ers√§ttare</h2>
    <select id="sickCoachSelect"><option value="">-- V√§lj sjuk coach --</option></select>
    <div style="margin-top:8px;">
      <label><input type="checkbox" id="chkFullWeek" checked> Visa hela veckan</label>
    </div>
    <div id="sickResult" style="margin-top:10px;"></div>
  </div>

</div>

<script>
/* =========================
   DATA & KONFIG
========================= */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
 "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},
 "Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
 "Lunch":{color:"#F9E79F",emoji:"üç≤"},
 "Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
 "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},
 "Musik":{color:"#D2B4DE",emoji:"üé∂"},
 "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},
 "Padel":{color:"#82E0AA",emoji:"üèì"},
 "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},
 "Yoga":{color:"#D5F5E3",emoji:"üßò"},
 "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
 "Film":{color:"#E6B0AA",emoji:"üé¨"},
 "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},
 "Trummor":{color:"#F1948A",emoji:"ü•Å"},
 "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},
 "Medicin":{color:"#E59866",emoji:"üíä"},
 "Biljard":{color:"#A9DFBF",emoji:"üé±"},
 "Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
 "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},
 "Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
 "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},
 "Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"},
 "Warhammer":{color:"#C39BD3",emoji:"üõ°Ô∏è"},
 "Utflykt":{color:"#A9CCE3",emoji:"üöå"},
 "Uppstart Taket":{color:"#AED6F1",emoji:"üå§Ô∏è"},
 "G√•tr√§ning":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÇÔ∏è"},
 "Promenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},
 "Baka":{color:"#FAD7A0",emoji:"üßÅ"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#edf2f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}
function weekdayName(d){return ["s√∂ndag","m√•ndag","tisdag","onsdag","torsdag","fredag","l√∂rdag"][d];}
function svWeekday(d){return ["s√∂","m√•n","tis","ons","tors","fre","l√∂r"][d];}

let DATA=[];

/* =========================
   LADDA DATA
========================= */
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList(); fillCoachList(); fillCompareLists();
    fillSickList();
  }catch(e){ console.error(e); }
}
loadData();

/* =========================
   LISTOR (SELECTS + CHIPS)
========================= */
function uniqueTokens(field){
  return [...new Set(DATA.map(r=>(r[field]||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla")
    .sort();
}
function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  uniqueTokens("Deltagare").forEach(n=>{
    const o=document.createElement("option"); o.value=n; o.textContent=n; s.appendChild(o);
  });
}
function fillCoachList(){
  const s=document.getElementById("coachSelect");
  s.innerHTML='<option value="">-- V√§lj coach --</option>';
  uniqueTokens("Coach").forEach(c=>{
    const o=document.createElement("option"); o.value=c; o.textContent=c; s.appendChild(o);
  });
}
function fillCompareLists(){
  const cWrap=document.getElementById("coachListCompare");
  const pWrap=document.getElementById("participantListCompare");
  cWrap.innerHTML=""; pWrap.innerHTML="";
  uniqueTokens("Coach").forEach(c=>{
    const id="c_"+btoa(encodeURIComponent(c)).replace(/=/g,"");
    cWrap.insertAdjacentHTML("beforeend",`
      <label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-coach" value="${c}"><span>${c}</span></label>
    `);
  });
  uniqueTokens("Deltagare").forEach(n=>{
    const id="p_"+btoa(encodeURIComponent(n)).replace(/=/g,"");
    pWrap.insertAdjacentHTML("beforeend",`
      <label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-delt" value="${n}"><span>${n}</span></label>
    `);
  });
  // visuell feedback p√• chip
  document.querySelectorAll(".chip input").forEach(inp=>{
    inp.addEventListener("change",e=>{
      const lab=e.target.closest(".chip");
      if(e.target.checked) lab.classList.add("active"); else lab.classList.remove("active");
    });
  });
}
function fillSickList(){
  const s=document.getElementById("sickCoachSelect");
  s.innerHTML='<option value="">-- V√§lj sjuk coach --</option>'+
    uniqueTokens("Coach").map(c=>`<option>${c}</option>`).join("");
}

/* =========================
   GEMENSAM LOGIK
========================= */
function hidePanels(){
  document.getElementById("comparePanel").style.display="none";
  document.getElementById("sickPanel").style.display="none";
}
function sanitizeName(x){
  const bad=["alla","ingen coach","ingen","eget arbete",".","-","na","n/a","ok√§nt","unknown","(tom)",""];
  return x && !bad.includes(String(x).trim().toLowerCase());
}
function splitNames(str){
  return (str||"").split(/,|\/|;|\n/).map(s=>s.trim()).filter(sanitizeName);
}

/* =========================
   DAGENS SCHEMA (KORT)
========================= */
function renderCards(name,isCoach){
  hidePanels();
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(
    DATA.filter(r=>{
      const list=splitNames(r[field]||"");
      return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
    }),name,isCoach
  ).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  let html=`<div class='cards'>`;
  if(!rows.length) html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("nowContainer").innerHTML="";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

/* =========================
   VECKOSCHEMA (BLOCK, LIGGANDE)
========================= */
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
function renderBlocks(name,isCoach){
  hidePanels();
  const slots=makeSlots();
  const days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
  }),name,isCoach);

  const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
  grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children];
  const toMin=t=>{const [h,m]=t.split(":").map(Number);return h*60+m;};

  rows.forEach(r=>{
    const d=new Date(r.Datum);
    let wd=d.getDay(); // 0=Sun .. 6=Sat
    if(wd===0||wd===6) return; // endast vardagar
    const col=(wd-1)+1; // m√•ndag=1
    const sIdx=slots.indexOf(r.Start), eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx) return;
    const firstCellIndex=sIdx*(1+days.length)+col, firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block"; block.style.background=colorFor(r);
    const title=`${emojiFor(r)} ${r.Aktivitet||""}`;
    block.innerHTML=`<div class="title">${title}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });

  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("nowContainer").innerHTML="";
}

/* Anpassning: lunch ‚Äúalla‚Äù vs specifik */
function applyLunchRule(rows,name,isCoach){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const field=isCoach?"Coach":"Deltagare";
    const isAll=(r[field]||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>
        x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&
        (x.Aktivitet||"").toLowerCase().includes("lunch")&&
        (x[field]||"").toLowerCase().includes(name.toLowerCase())
      );
      if(specific) return false;
    }
    return true;
  });
}

/* =========================
   J√ÑMF√ñR SCHEMAN (FLERVY VECKA)
========================= */
document.getElementById("btnCompare").onclick = () => {
  document.getElementById("comparePanel").style.display = "block";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("viewTitle").textContent = "J√§mf√∂r scheman";
};

document.getElementById("btnShowCompare").onclick = () => {
  const selected = [
    ...document.querySelectorAll(".chk-delt:checked"),
    ...document.querySelectorAll(".chk-coach:checked")
  ].map(cb => ({ name: cb.value, isCoach: cb.classList.contains("chk-coach") }));

  if (!selected.length) { alert("V√§lj minst ett namn."); return; }

  const wrap = document.createElement("div");
  wrap.className = "schema-wrap";
  selected.forEach(sel => {
    const div = document.createElement("div");
    div.className = "schema";
    div.appendChild(renderSingleWeek(sel.name, sel.isCoach));
    wrap.appendChild(div);
  });

  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").innerHTML = "";
  document.getElementById("schemaContainer").appendChild(wrap);
  document.getElementById("schemaContainer").style.display = "block";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML="";
  document.getElementById("viewTitle").textContent = "J√§mf√∂relse av veckoscheman";
};

function renderSingleWeek(name,isCoach){
  const slots=makeSlots(), days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
  }),name,isCoach);

  const container=document.createElement("div");
  container.innerHTML=`<h3>${isCoach?"Coach: ":"Deltagare: "}${name}</h3>
  <div class="block-header"><div>Tid</div>${days.map(d=>`<div>${d}</div>`).join("")}</div>
  <div class="block-grid"></div>`;

  const grid=container.querySelector(".block-grid");
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children];

  rows.forEach(r=>{
    const wd=new Date(r.Datum).getDay();
    if(wd===0||wd===6) return;
    const col=(wd-1)+1;
    const sIdx=slots.indexOf(r.Start), eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx) return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block"; block.style.background=colorFor(r);
    block.innerHTML=`<div class="title">${emojiFor(r)} ${r.Aktivitet||""}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28; block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  return container;
}

/* =========================
   ERS√ÑTTARE ‚Äì HEL VECKA
========================= */
document.getElementById("btnSick").onclick = () => {
  document.getElementById("sickPanel").style.display = "block";
  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("viewTitle").textContent = "Hitta ers√§ttare";
};

document.getElementById("sickCoachSelect").onchange = renderSick;
document.getElementById("chkFullWeek").onchange = renderSick;

function renderSick(){
  const coach = document.getElementById("sickCoachSelect").value;
  const fullWeek = document.getElementById("chkFullWeek").checked;
  if(!coach){ document.getElementById("sickResult").innerHTML=""; return; }

  const today = new Date();
  const monday = new Date(today);
  const day = monday.getDay(); // 0..6
  const diffToMonday = (day === 0 ? -6 : 1) - day; // m√•ndag som start
  monday.setDate(today.getDate() + diffToMonday);
  const days = [...Array(5)].map((_,i)=>{ const d=new Date(monday); d.setDate(monday.getDate()+i); return d; });

  // H√§mta pass f√∂r vald coach (idag eller hela veckan)
  const passes = DATA.filter(r=>{
    const rDate = new Date(r.Datum);
    const isSameDay = dayKey(r.Datum)===todayKey();
    const inWeek = days.some(d => dayKey(r.Datum)===d.toISOString().slice(0,10));
    const coachHit = (r.Coach||"").toLowerCase().includes(coach.toLowerCase());
    return coachHit && (fullWeek ? inWeek : isSameDay);
  }).sort((a,b)=> (a.Datum||"").localeCompare(b.Datum||"") || (a.Start||"").localeCompare(b.Start||""));

  // Lista alla andra coacher
  const allCoaches = uniqueTokens("Coach");

  let html = "";
  if(!passes.length){
    html = `<p>Inga pass hittades f√∂r ${coach} ${fullWeek?"denna vecka":"idag"}.</p>`;
  } else {
    // gruppera per dag
    const byDay = {};
    passes.forEach(p=>{
      const k = dayKey(p.Datum);
      (byDay[k] ||= []).push(p);
    });

    html += `<div class="cards">`;
    Object.keys(byDay).sort().forEach(k=>{
      const dObj=new Date(k);
      html += `<div class="card" style="--band:#cfd8e3">
        <h3>üìÖ ${weekdayName(dObj.getDay())}</h3>
        <div class="row" style="color:#555">Coach: ${coach}</div>
      </div>`;

      byDay[k].forEach(p=>{
        // ber√§kna lediga ers√§ttare f√∂r p.Start‚Äìp.Slut
        const [psh,psm]=(p.Start||"00:00").split(":").map(Number);
        const [peh,pem]=(p.Slut||"00:00").split(":").map(Number);
        const ps=psh*60+psm, pe=peh*pem/ pem + peh*60 + pem; // fix below
      });
    });
    html += `</div>`;
  }

  // OBS: korrigera f√∂reg√•ende r√§knefel (pe-ber√§kning)
  // Vi skriver om blocket ovan med r√§tt kod:
  if(passes.length){
    const byDay = {};
    passes.forEach(p=>{
      const k = dayKey(p.Datum);
      (byDay[k] ||= []).push(p);
    });

    html = `<div class="cards">`;
    Object.keys(byDay).sort().forEach(k=>{
      const dObj=new Date(k);
      html += `<div class="card" style="--band:#cfd8e3">
        <h3>üìÖ ${weekdayName(dObj.getDay())}</h3>
        <div class="row" style="color:#555">Coach: ${coach}</div>
      </div>`;

      byDay[k].forEach(p=>{
        const [psh,psm]=(p.Start||"00:00").split(":").map(Number);
        const [peh,pem]=(p.Slut||"00:00").split(":").map(Number);
        const ps=psh*60+psm, pe=peh*60+pem;

        // coacher som INTE krockar
        const free = allCoaches.filter(c=>{
          if(!sanitizeName(c) || c===coach) return false;
          // har c n√•got pass som √∂verlappar p?
          const overlaps = DATA.some(r=>{
            if(dayKey(r.Datum)!==k) return false;
            if(!(r.Coach||"").toLowerCase().includes(c.toLowerCase())) return false;
            const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
            const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
            const s=sh*60+sm, e=eh*60+em;
            // √∂verlappar intervallen?
            return !(e<=ps || s>=pe);
          });
          return !overlaps;
        });

        const e=emojiFor(p), col=colorFor(p);
        html += `<div class="card" style="--band:${col}">
          <h3>${e} ${p.Aktivitet||""} (${p.Start}‚Äì${p.Slut})</h3>
          <div class="row">üßë‚Äçüè´ Sjuk coach: ${coach}</div>
          <div class="row">üë• Deltagare: ${p.Deltagare||"-"}</div>
          <div class="row">‚úÖ Lediga ers√§ttare: ${free.length? free.join(", ") : "Ingen tillg√§nglig"}</div>
        </div>`;
      });
    });
    html += `</div>`;
  }

  document.getElementById("sickResult").innerHTML = html;
}

/* =========================
   P√ÖG√ÖR NU + KOMMANDE (DAGSLINJE)
========================= */
let nowTimer=null;
document.getElementById("btnNow").onclick = () => {
  hidePanels();
  showNowAndNext();
  if(nowTimer) clearInterval(nowTimer);
  nowTimer=setInterval(showNowAndNext,60000); // uppdatera varje minut
  document.getElementById("viewTitle").textContent = "P√•g√•r nu & Kommande";
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="none";
};

function showNowAndNext(){
  const cont = document.getElementById("nowContainer");
  const today=todayKey();
  const now=new Date(); const minsNow=now.getHours()*60 + now.getMinutes();
  const all = DATA.filter(r=> dayKey(r.Datum)===today )
                  .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  const ongo = all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const s=sh*60+sm, e=eh*60+em;
    return minsNow>=s && minsNow<=e;
  });
  const next = all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const s=sh*60+sm;
    return s>minsNow;
  });

  const label = new Intl.DateTimeFormat("sv-SE",{ weekday:"long", day:"numeric", month:"long"}).format(now);
  const time = now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
  let html = `<h2 style="text-align:center;margin-bottom:8px">‚è±Ô∏è ${label} ‚Äì kl. ${time}</h2>`;

  html += `<h3 style="text-align:center;margin:8px 0 6px">P√•g√•r nu</h3>`;
  if(!ongo.length) html += `<p style="text-align:center">Inga aktiviteter p√•g√•r just nu.</p>`;
  else{
    html += `<div class="cards">` + ongo.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") + `</div>`;
  }

  html += `<h3 style="text-align:center;margin:12px 0 6px">Kommande idag</h3>`;
  if(!next.length) html += `<p style="text-align:center">Inget mer planerat idag.</p>`;
  else{
    html += `<div class="cards">` + next.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") + `</div>`;
  }

  cont.innerHTML = html;
}

/* =========================
   KNAPPAR / V√ÑXLING
========================= */
document.getElementById("btnParticipant").onclick=()=>{
  hidePanels();
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
  hidePanels();
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
  const isCoach = document.getElementById("coachSelect").style.display!=="none";
  const n = isCoach ? document.getElementById("coachSelect").value : document.getElementById("nameSelect").value;
  if(n) renderCards(n,isCoach);
};
document.getElementById("btnBlocks").onclick=()=>{
  const isCoach = document.getElementById("coachSelect").style.display!=="none";
  const n = isCoach ? document.getElementById("coachSelect").value : document.getElementById("nameSelect").value;
  if(n) renderBlocks(n,isCoach);
};
document.getElementById("btnPrint").onclick=()=>{ window.print(); };

/* Auto: n√§r man v√§ljer namn ‚Üí visa veckoschema direkt */
document.getElementById("nameSelect").addEventListener("change", e=>{
  if(e.target.value) renderBlocks(e.target.value,false);
});
document.getElementById("coachSelect").addEventListener("change", e=>{
  if(e.target.value) renderBlocks(e.target.value,true);
});
</script>
</body>
</html>
