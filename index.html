<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grunden DV ‚Äì Schema</title>
  <style>
    :root{
      --card-bg:#ffffff;
      --page-bg:#fafafa;
      --border:#e6e6e6;
      --muted:#666;
      --heading:#2c3e50;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --radius:16px;
      --pad:14px;
      --band:#9ecbff;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background:var(--page-bg); }
    header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    header img { height:60px; }
    #clock { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .9rem; margin-bottom: 4px; }
    #updated { font-size: .8rem; color:var(--muted); margin-bottom: 8px; }
    .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-bottom:12px; }
    button, select { padding:8px 12px; border-radius:10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; font-size:14px; }
    button:hover { background:#ececec; }
    #coachSelect { display:none; }

    /* Sjukschema-panel */
    #sickPanel { display:none; border:1px solid var(--border); background:var(--card-bg); border-radius:14px; padding:12px; box-shadow:var(--shadow); }
    #sickPanel h3 { margin:0 0 8px 0; font-size:1rem; }
    #sickList { display:flex; flex-wrap:wrap; gap:10px 16px; max-height:220px; overflow:auto; }
    #sickList label { display:flex; align-items:center; gap:6px; white-space:nowrap; }
    #sickMsg { font-size:.85rem; color:var(--muted); margin-top:6px; }

    /* Dag-rubrik */
    .day-heading {
      background:#eef5ff;
      color:var(--heading);
      padding:8px 12px;
      border-radius:12px;
      font-size:1.05rem;
      font-weight:700;
      margin:18px 0 10px 0;
    }

    /* Tabell (desktop) */
    table { border-collapse: collapse; width:100%; margin-top:6px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#f2f2f2; }
    .aktivitet { font-weight:700; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; background:#fff3cd; color:#8a5b00; border:1px solid #ffe39a; margin-left:8px; white-space:nowrap;}
    .okpill{ background:#e8f6ee; color:#1a7f37; border:1px solid #cdebd9; }

    /* Kortlayout (mobil) */
    .cards { display:none; }
    .card {
      position:relative;
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--pad);
      box-shadow:var(--shadow);
      margin:0 auto 12px auto;
      max-width: 95%;
    }
    .card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:8px;
      background:var(--band);
      border-top-left-radius:var(--radius);
      border-bottom-left-radius:var(--radius);
    }
    .card-title{ font-weight:800; font-size:1.05rem; margin:0 0 6px 0; display:flex; align-items:center; gap:8px; }
    .row { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; font-size:.95rem; padding:2px 0; }
    .row label{ color:#333; font-weight:700; }
    .row small{ color:var(--muted); }

    /* D√∂ljer tabell och visar kort p√• mobil */
    @media (max-width: 700px) {
      table { display:none; }
      .cards { display:block; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div id="clock"></div>
      <div id="updated">Senast uppdaterad: ‚Äì</div>
    </div>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <div class="toolbar">
    <button id="btnDaily">Gemensamt schema</button>
    <button id="btnCoach">Coachschema</button>
    <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
    <button id="btnSick">Sjukschema</button>
  </div>

  <div id="sickPanel">
    <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
    <div id="sickList"></div>
    <div id="sickMsg"></div>
    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnShowSick">Visa sjukschema</button>
      <button id="btnClearSick" title="Rensa val">Rensa</button>
    </div>
  </div>

  <div id="schemaContainer">Laddar schema...</div>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

    const aktivitetFarger = {
      "M√•ndagsm√∂te": {color:"#AED6F1", emoji:"üìÖ"},
      "Gruppm√∂te": {color:"#7FB3D5", emoji:"üë•"},
      "Lunch": {color:"#F9E79F", emoji:"üç≤"},
      "Frukost": {color:"#FAD7A0", emoji:"ü•ê"},
      "Atelj√©": {color:"#F5CBA7", emoji:"üé®"},
      "Musik": {color:"#D2B4DE", emoji:"üé∂"},
      "Pod": {color:"#A9CCE3", emoji:"üéôÔ∏è"},
      "Padel": {color:"#82E0AA", emoji:"üèì"},
      "Lite av varje": {color:"#FADBD8", emoji:"‚ú®"},
      "Yoga": {color:"#D5F5E3", emoji:"üßò"},
      "Gym": {color:"#A3E4D7", emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
      "Film": {color:"#E6B0AA", emoji:"üé¨"},
      "F√∂reningsgruppen": {color:"#D6DBDF", emoji:"ü§ù"},
      "Trummor": {color:"#F1948A", emoji:"ü•Å"},
      "√Öterkoppling": {color:"#85C1E9", emoji:"üîÑ"},
      "Medicin": {color:"#E59866", emoji:"üíä"},
      "Biljard": {color:"#A9DFBF", emoji:"üé±"},
      "Spelgruppen": {color:"#F8C471", emoji:"üé≤"},
      "S√∂mnad": {color:"#F5EEF8", emoji:"üßµ"},
      "Filmgruppen": {color:"#E6B0AA", emoji:"üé¨"},
      "Musikquizz": {color:"#D2B4DE", emoji:"üé∂"},
      "Musikdokument√§r": {color:"#D2B4DE", emoji:"üé∂"}
    };

    function getSEDate() { return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" })); }
    function fmtSE(dt, opts) { return new Intl.DateTimeFormat("sv-SE", opts).format(dt); }
    function updateClock() {
      const now = getSEDate();
      const opts = { weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit", second:"2-digit" };
      document.getElementById("clock").textContent = fmtSE(now, opts);
    }
    setInterval(updateClock, 1000); updateClock();

    let DATA = [];

    async function loadData() {
      const res = await fetch(url + "?t=" + Date.now());
      const json = await res.json();
      DATA = json.data || [];
      document.getElementById("updated").textContent = "Senast uppdaterad: " + (json.updated || "‚Äì");
      setupCoachSelect(DATA);
      setupSickList(DATA);
      renderDaily(DATA);
      document.getElementById("coachSelect").style.display = "none";
      document.getElementById("sickPanel").style.display = "none";
    }

    function dayKey(str) { return String(str).slice(0,10); }
    function parseCoaches(coachStr) {
      const ignore = ["", "-", ".", "ingen", "ingen coach", "eget arbete", "sj√§lvst√§ndigt", "utan coach"];
      return (coachStr || "")
        .split(",")
        .map(c => c.trim())
        .filter(c => c && !ignore.includes(c.toLowerCase()) && c.toLowerCase() !== "alla");
    }
    function countCoaches(coachStr) { return parseCoaches(coachStr).length; }
    function overlap(aStart, aEnd, bStart, bEnd) { return !(aEnd <= bStart || aStart >= bEnd); }
    function getThisWeekMonFri() {
      const today = getSEDate();
      const day = today.getDay();
      const mon = new Date(today);
      mon.setDate(today.getDate() - ((day + 6) % 7));
      mon.setHours(0,0,0,0);
      const fri = new Date(mon);
      fri.setDate(mon.getDate() + 4);
      return { mon, fri };
    }
    function groupByDate(rows) {
      const grouped = {};
      rows.forEach(r => {
        const k = dayKey(r.Datum);
        if (!grouped[k]) grouped[k] = [];
        grouped[k].push(r);
      });
      return Object.keys(grouped).sort().reduce((acc,k)=> (acc[k]=grouped[k], acc), {});
    }

    /* ====== RENDER HELPERS: b√•de tabell (desktop) + kort (mobil) ====== */

    function colorFor(row){ return (aktivitetFarger[row.Aktivitet] || {color:"#ffffff", emoji:""}).color; }
    function emojiFor(row){ return (aktivitetFarger[row.Aktivitet] || {color:"#ffffff", emoji:""}).emoji || ""; }

    function tableRowHTML(row) {
      const warn = countCoaches(row.Coach) > 2 ? ` <span class="pill">‚ö†Ô∏è ${countCoaches(row.Coach)} coacher</span>` : "";
      return `<tr>
        <td>${row.Start||""}</td>
        <td>${row.Slut||""}</td>
        <td class="aktivitet">${emojiFor(row)} ${row.Aktivitet||""}${warn}</td>
        <td>${row.Deltagare||""}</td>
        <td>${row.Coach||""}</td>
      </tr>`;
    }

    function cardHTML(row, extrasRightHTML="") {
      const band = colorFor(row);
      const warn = countCoaches(row.Coach) > 2 ? `<span class="pill">‚ö†Ô∏è ${countCoaches(row.Coach)} coacher</span>` : "";
      const time = (row.Start||"") && (row.Slut||"") ? `${row.Start}‚Äì${row.Slut}` : (row.Start||row.Slut||"");
      return `<div class="card" style="--band:${band}">
        <h4 class="card-title">${emojiFor(row)} ${row.Aktivitet||"Aktivitet"} ${warn}</h4>
        <div class="row"><label>üïí Tid</label><div>${time||"-"}</div></div>
        <div class="row"><label>üë• Deltagare</label><div>${row.Deltagare||"-"}</div></div>
        <div class="row"><label>üßë‚Äçüè´ Coach</label><div>${row.Coach||"-"} ${extrasRightHTML||""}</div></div>
      </div>`;
    }

    function sectionHTML(dateKey, rows, extraForRow=null){
      const label = new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(dateKey));
      let desktop = `<div class="day-heading">${label.charAt(0).toUpperCase()+label.slice(1)}</div>
      <table><thead><tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr></thead><tbody>`;
      rows.forEach((r,i)=> desktop += tableRowHTML(extraForRow ? extraForRow(r,i,"table") : r));
      desktop += `</tbody></table>`;

      let mobile = `<div class="day-heading">${label.charAt(0).toUpperCase()+label.slice(1)}</div><div class="cards">`;
      rows.forEach((r,i)=> {
        const extra = extraForRow ? extraForRow(r,i,"card") : "";
        mobile += cardHTML(r, extra);
      });
      mobile += `</div>`;

      return desktop + mobile;
    }

    /* ====== GEMENSAMT (idag) ====== */
    function renderDaily(data) {
      const today = dayKey(getSEDate().toISOString());
      const todays = data
        .filter(r => dayKey(r.Datum) === today)
        .sort((a,b)=> (a.Start||"").localeCompare(b.Start||""));

      let html = "";
      if (todays.length){
        html += sectionHTML(today, todays);
      } else {
        html = `<p>Inga aktiviteter idag.</p>`;
      }
      document.getElementById("schemaContainer").innerHTML = html;
    }

    /* ====== COACHSCHEMA ====== */
    function setupCoachSelect(data) {
      const select = document.getElementById("coachSelect");
      select.innerHTML = `<option value="">-- V√§lj coach --</option>`;
      const coaches = [...new Set(data.map(r => parseCoaches(r.Coach)).flat())].sort();
      coaches.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        select.appendChild(opt);
      });
      select.onchange = () => {
        const v = select.value;
        if (!v) return;
        renderCoachWeek(DATA, v);
      };
    }

    function renderCoachWeek(data, coach) {
      const rows = data.filter(r => {
        const cs = parseCoaches(r.Coach);
        return cs.includes(coach) || (r.Coach||"").trim().toLowerCase()==="alla";
      }).sort((a,b)=> (dayKey(a.Datum)===dayKey(b.Datum) ? (a.Start||"").localeCompare(b.Start||"") : dayKey(a.Datum).localeCompare(dayKey(b.Datum))));

      const grouped = groupByDate(rows);
      let html = "";
      Object.keys(grouped).forEach(dateKey=>{
        html += sectionHTML(dateKey, grouped[dateKey]);
      });
      if (!rows.length) html = `<p>Inga aktiviteter hittades f√∂r ${coach}.</p>`;
      document.getElementById("schemaContainer").innerHTML = html;
    }

    /* ====== SJUKSCHEMA (m√•n‚Äìfre denna vecka) ====== */
    function setupSickList(data) {
      const cont = document.getElementById("sickList");
      cont.innerHTML = "";
      const coaches = [...new Set(data.map(r => parseCoaches(r.Coach)).flat())].sort();
      coaches.forEach(c => {
        const id = "sick_" + c.replace(/\s+/g,"_");
        cont.insertAdjacentHTML("beforeend", `<label><input type="checkbox" value="${c}" id="${id}"> ${c}</label>`);
      });
    }
    function getSelectedSick() {
      return [...document.querySelectorAll("#sickList input[type=checkbox]:checked")].map(el => el.value);
    }

    function renderSickSchedule(data, sickCoaches) {
      const { mon, fri } = getThisWeekMonFri();
      const startKey = dayKey(mon.toISOString());
      const endKey = dayKey(fri.toISOString());

      const weekRows = data.filter(r => {
        const d = dayKey(r.Datum);
        return d >= startKey && d <= endKey;
      });

      const sickRows = weekRows.filter(r => {
        const cs = parseCoaches(r.Coach);
        return sickCoaches.some(s => cs.includes(s));
      }).sort((a,b)=> (dayKey(a.Datum)===dayKey(b.Datum) ? (a.Start||"").localeCompare(b.Start||"") : dayKey(a.Datum).localeCompare(dayKey(b.Datum))));

      const allCoaches = [...new Set(weekRows.map(r => parseCoaches(r.Coach)).flat())];

      const extraForRow = (r, i, mode) => {
        // Ber√§kna ers√§ttare
        const tStart = r.Start || "00:00", tEnd = r.Slut || "23:59";
        const dateK = dayKey(r.Datum);
        const available = allCoaches
          .filter(c => !getSelectedSick().includes(c))
          .filter(c => {
            const cRows = weekRows.filter(x => parseCoaches(x.Coach).includes(c) && dayKey(x.Datum) === dateK);
            return !cRows.some(x => overlap(x.Start||"00:00", x.Slut||"23:59", tStart, tEnd));
          });
        return available.length
          ? (mode==="card" ? ` <span class="okpill">Ers√§ttare: ${available.join(", ")}</span>` : ` <span class="okpill">Ers√§ttare: ${available.join(", ")}</span>`)
          : (mode==="card" ? ` <span class="pill">Inga ers√§ttare funna</span>` : ` <span class="pill">Inga ers√§ttare funna</span>`);
      };

      const grouped = groupByDate(sickRows);
      let html = "";
      Object.keys(grouped).forEach(dateKey=>{
        // F√∂r sjukkort: visa vilka som √§r sjuka vs √∂vriga coacher i coach-raden
        const rows = grouped[dateKey].map(r=>{
          const cs = parseCoaches(r.Coach);
          const sickHere = cs.filter(c => getSelectedSick().includes(c));
          const others = cs.filter(c => !getSelectedSick().includes(c));
          const coachText = [
            sickHere.length ? `Sjuk: ${sickHere.join(", ")}` : "",
            others.length ? `√ñvriga: ${others.join(", ")}` : ""
          ].filter(Boolean).join(" ‚Ä¢ ");
          return { ...r, Coach: coachText };
        });
        html += sectionHTML(dateKey, rows, (_r)=> extraForRow(_r));
      });

      if (!sickRows.length) html = `<p>Inga pass f√∂r valda coacher under m√•n‚Äìfre denna vecka.</p>`;
      document.getElementById("schemaContainer").innerHTML = html;
    }

    /* ====== HANDLERS ====== */
    document.getElementById("btnDaily").onclick = () => {
      document.getElementById("coachSelect").style.display = "none";
      document.getElementById("sickPanel").style.display = "none";
      renderDaily(DATA);
    };
    document.getElementById("btnCoach").onclick = () => {
      document.getElementById("sickPanel").style.display = "none";
      document.getElementById("coachSelect").style.display = "inline-block";
      const v = document.getElementById("coachSelect").value;
      if (v) renderCoachWeek(DATA, v);
      else document.getElementById("schemaContainer").innerHTML = `<p>V√§lj en coach i listan.</p>`;
    };
    document.getElementById("btnSick").onclick = () => {
      document.getElementById("coachSelect").style.display = "none";
      document.getElementById("sickPanel").style.display = "block";
      document.getElementById("schemaContainer").innerHTML = `<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;
    };
    document.getElementById("btnShowSick").onclick = () => {
      const sick = getSelectedSick();
      if (!sick.length) { document.getElementById("sickMsg").textContent = "V√§lj minst en coach."; return; }
      document.getElementById("sickMsg").textContent = "";
      renderSickSchedule(DATA, sick);
    };
    document.getElementById("btnClearSick").onclick = () => {
      document.querySelectorAll("#sickList input[type=checkbox]").forEach(cb => cb.checked = false);
      document.getElementById("sickMsg").textContent = "";
      document.getElementById("schemaContainer").innerHTML = `<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;
    };
    document.addEventListener("change", (e)=> {
      if (e.target && e.target.closest("#sickList") && e.target.type === "checkbox") {
        const sel = getSelectedSick();
        if (sel.length > 5) {
          e.target.checked = false;
          document.getElementById("sickMsg").textContent = "Du kan v√§lja h√∂gst 5 coacher.";
        } else {
          document.getElementById("sickMsg").textContent = "";
        }
      }
    });

    // Start + periodisk uppdatering (inget sparas mellan omladdningar)
    loadData();
    setInterval(loadData, 15*60*1000);
  </script>
</body>
</html>
