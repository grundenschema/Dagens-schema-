/* ===== KORTVY (digital visning) ===== */
function cardHTML(r, isOngoing=false, isShort=false){
  const b = colorFor(r);
  const t = (r.Start && r.Slut) ? `${r.Start}‚Äì${r.Slut}` : r.Start || r.Slut || "-";
  
  // Kort aktivitet (‚â§ 1h): endast aktivitet + deltagare, mindre text
  if(isShort){
    return `
      <div class="card" style="--band:${b}; font-size:0.9rem;">
        <div class="row"><label>üïí Tid:</label><div>${t}</div></div>
        <div class="card-title" style="font-weight:700;">${r.Aktivitet || "Aktivitet"}</div>
        <div class="row"><label>üë•:</label><div>${shrinkList(r.Deltagare,4)}</div></div>
      </div>`;
  }

  // L√§ngre aktivitet: full info (utan emoji)
  return `
    <div class="card" style="--band:${b}">
      <div class="row"><label>üïí Tid:</label><div>${t}</div></div>
      <h4 class="card-title">${r.Aktivitet || "Aktivitet"}</h4>
      <div class="row"><label>üë• Deltagare:</label><div>${shrinkList(r.Deltagare,4)}</div></div>
      <div class="row"><label>üßë‚Äçüè´ Coach:</label><div>${shrinkList(r.Coach,3)}</div></div>
    </div>`;
}

// Dela upp aktiviteter efter tidpunkt
function renderDaily(data){
  const now = getSEDate();
  const today = dayKey(now.toISOString());
  const rows = data
    .filter(r => dayKey(r.Datum) === today)
    .sort((a,b) => (a.Start||"").localeCompare(b.Start||""));

  const ongoing = [];
  const upcoming = [];
  const past = [];

  for(const r of rows){
    const start = r.Start ? r.Start : "00:00";
    const end   = r.Slut ? r.Slut : "23:59";
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    const durationMin = (eh*60+em) - (sh*60+sm);
    const isShort = durationMin <= 60;

    const nowMins = now.getHours()*60 + now.getMinutes();
    const startMins = sh*60 + sm;
    const endMins = eh*60 + em;

    if(nowMins >= startMins && nowMins < endMins){
      ongoing.push({...r, isShort});
    } else if(nowMins < startMins){
      upcoming.push({...r, isShort});
    } else {
      past.push({...r, isShort});
    }
  }

  const htmlSection = (title, arr, icon) => {
    if(!arr.length) return "";
    return `
      <div class="day-section">
        <div class="day-heading">${icon ? icon+" " : ""}${title}</div>
        <div class="cards">
          ${arr.map(r => cardHTML(r,false,r.isShort)).join("")}
        </div>
      </div>`;
  };

  const output = 
      htmlSection("P√•g√•ende aktiviteter", ongoing, "üü¢") +
      htmlSection("Kommande aktiviteter", upcoming, "‚è≥") +
      htmlSection("Tidigare aktiviteter", past, "üïì");

  document.getElementById("viewTitle").textContent = "Gemensamt schema";
  document.getElementById("schemaContainer").style.display = "block";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("schemaContainer").innerHTML = 
      output || "<p>Inga aktiviteter idag.</p>";
}
/* ===== Blockschema (f√∂r utskrift) ===== */
function renderCoachBlocks(data, coach){
  const slots = makeSlots();
  const workDays = new Set(
    data.filter(r => parseCoaches(r.Coach).includes(coach)).map(r => dayKey(r.Datum))
  );
  const rows = data.filter(r=>{
    const cs=parseCoaches(r.Coach),
          isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);
    return cs.includes(coach) || (isAll && workDays.has(dk));
  });

  // Visa blockschema, d√∂lj kort
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("blockContainer").setAttribute("aria-hidden","false");
  document.getElementById("printHint").style.display="block";
  document.getElementById("viewTitle").textContent="Veckoblock ‚Äì "+coach+" (08:00‚Äì16:30)";

  // Bygg rubriker & grid
  const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div><div>M√•n</div><div>Tis</div><div>Ons</div><div>Tors</div><div>Fre</div>";
  grid.innerHTML="";

  slots.forEach((t,i)=>{
    const zebra = i % 2 === 0 ? ' style="background:#f9f9f9;"' : '';
    grid.innerHTML+=`<div class="block-time"${zebra}>${t}</div>`;
    for(let d=0;d<5;d++) grid.innerHTML+=`<div class="block-cell"${zebra}></div>`;
  });

  const cells=[...grid.children];

  rows.forEach(r=>{
    const wd=weekdayIndex(r.Datum); if(!wd) return;
    const start=floorSlot(r.Start||SLOT_START);
    const end=floorSlot(r.Slut||SLOT_END);
    let sIdx=timeToRowIndex(start,slots);
    let eIdx=timeToRowIndex(end,slots)-1;
    if(sIdx<1 || eIdx<sIdx) return;

    const durationMin = (parseInt(end.split(":")[0])*60+parseInt(end.split(":")[1]))
                       - (parseInt(start.split(":")[0])*60+parseInt(start.split(":")[1]));
    const isShort = durationMin <= 60;

    const firstCellIndex=(sIdx-1)*(1+5)+wd;
    const firstCell=cells[firstCellIndex];
    const slotsCovered=eIdx-sIdx+1;

    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);
    block.style.border="0.5pt solid #aaa";
    block.style.marginBottom="1px";

    const akt=r.Aktivitet||"Aktivitet";
    const deltagare=shrinkList(r.Deltagare,3);
    const coachDisplay=shrinkList(r.Coach,2);

    // Mindre text f√∂r korta block
    const textSize = isShort ? "0.75rem" : "0.85rem";
    const smallCls = isShort ? "style='font-size:0.7rem; line-height:1.1;'" : "class='small'";

    block.innerHTML = `
      <div class="title" style="font-size:${textSize}; font-weight:700;">${akt}</div>
      <div ${smallCls}>üë• ${deltagare}</div>
      ${isShort ? "" : `<div class="small">üßë‚Äçüè´ ${coachDisplay}</div>`}
    `;

    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight||28;
      block.style.height=(slotsCovered*cellH - 3)+"px";
    });

    firstCell.appendChild(block);
  });
}
/* ===== Utskrift (Blockschema) ===== */
@media print {
  @page {
    size: A4 landscape;
    margin: 4mm; /* mindre marginaler f√∂r mer yta */
  }

  body {
    background: #fff;
    color: #000;
    font-size: 9pt;          /* lite st√∂rre text √§n tidigare */
    line-height: 1.25;
    margin: 0;
  }

  header,
  .toolbar,
  #sickPanel,
  #clock {
    display: none !important;
  }

  #viewTitle {
    text-align: center;
    font-size: 11pt;
    font-weight: bold;
    margin: 0 0 6px 0;
  }

  /* Visa endast blockschema vid utskrift */
  .cards,
  .card,
  table {
    display: none !important;
  }

  .block-wrap {
    display: block !important;
  }

  /* Zebra-bakgrund och tydligare grid */
  .block-header div {
    background: #e9eef8 !important;
    font-size: 9pt;
    padding: 3px 4px;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .block-time {
    background: #f9f9f9 !important;
    border: none;
    padding: 3px 5px;
    font-size: 8.5pt;
  }

  .block-cell {
    border: none;
    min-height: 22px;
    background: #fff;
  }

  .block {
    border: 0.5pt solid #888;
    padding: 2px 3px;
    border-radius: 4px;
    overflow: hidden;
    font-size: 8pt;
    line-height: 1.2;
    margin-bottom: 1px;
  }

  .block .title {
    font-weight: 700;
    margin-bottom: 1px;
  }

  .block .small {
    font-size: 7pt;
  }

  #printHint {
    display: none !important;
  }
}
