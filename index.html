<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grunden DV ‚Äì Schema</title>
<style>
:root{
  --card-bg:#fff; --page-bg:#fafafa; --border:#ddd; --muted:#555; --heading:#2c3e50;
  --shadow:0 6px 18px rgba(0,0,0,.05); --radius:16px; --pad:14px; --band:#9ecbff;
  --grid-border:#bbb; --time-col:#fafafa;
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  max-width:1100px;margin:0 auto;padding:20px;background:var(--page-bg);
}
header{text-align:center;margin-bottom:15px;}
header img{height:65px;margin:10px auto;display:block;}
#clock{font-family:ui-monospace;font-size:.9rem;color:#333;}
#updated{font-size:.8rem;color:var(--muted);margin-top:4px;}
.toolbar{
  display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:18px 0;
}
button,select{
  padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;
  cursor:pointer;font-size:15px;
}
button:hover{background:#ececec;}
#coachSelect{display:none;}
#btnBlocks,#btnCards{display:none;} /* visas i coachl√§get */

#sickPanel{
  display:none;border:1px solid var(--border);background:var(--card-bg);
  border-radius:14px;padding:12px;box-shadow:var(--shadow);
}
#sickList{
  display:flex;flex-wrap:wrap;gap:8px 14px;max-height:220px;overflow:auto;
}
#sickList label{display:flex;align-items:center;gap:6px;white-space:nowrap;}

.day-section{border-bottom:1px solid #ddd;margin-bottom:25px;padding-bottom:10px;}
.day-heading{
  background:#eef5ff;color:var(--heading);padding:10px 14px;border-radius:12px;
  font-weight:700;margin:20px 0 12px 0;
}

/* Kortvy (sk√§rm) */
.cards { display:flex; flex-direction:column; gap:18px; margin-bottom:25px; }
.card {
  position:relative; background:var(--card-bg); border:1px solid var(--border);
  border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
  width:100%; max-width:800px; margin:0 auto; transition:transform .1s;
}
.card:hover{ transform:translateY(-3px); }
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:8px;background:var(--band);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card-title{
  font-weight:800;font-size:1.1rem;margin:4px 0 8px;display:flex;align-items:center;gap:8px;
}
.row{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; font-size:1rem; padding:2px 0; }
.row label{ color:#333; font-weight:700; }
.pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; background:#fff3cd; color:#8a5b00; border:1px solid #ffe39a; margin-left:8px; white-space:nowrap; }
.okpill{ background:#e8f6ee; color:#1a7f37; border:1px solid #cdebd9; }

table{display:none;} /* tabellvyn ers√§tts av blockschema vid utskrift */

/* ======= BLOCKSCHEMA (sk√§rm + utskrift) ======= */
.block-wrap{ display:none; } /* visas n√§r man trycker "Veckoblock" */
.block-header{
  display:grid; grid-template-columns:80px repeat(5,1fr); gap:0;
  font-weight:700; text-transform:capitalize; margin:10px 0 6px;
}
.block-header div{
  padding:6px 8px; border:1px solid var(--grid-border);
  background:#f3f6ff;
}
.block-header div:first-child{ background:var(--time-col); }

.block-grid{
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  border:1px solid var(--grid-border);
  border-top:none;
}
.block-time{
  background:var(--time-col);
  border-top:1px solid var(--grid-border);
  border-right:1px solid var(--grid-border);
  padding:4px 6px; font-size:.9rem;
}
.block-cell{
  position:relative; border-top:1px solid var(--grid-border);
  border-right:1px solid var(--grid-border);
  min-height:28px; /* sk√§rm */
}
.block{
  position:absolute; left:2px; right:2px; top:2px; bottom:2px;
  border-radius:6px; border:1px solid rgba(0,0,0,.15);
  padding:4px 6px; font-size:.85rem; line-height:1.2; overflow:hidden;
}
.block .title{ font-weight:700; margin-bottom:2px; }
.block .small{ font-size:.8rem; opacity:.95; }

/* ======= UTSKRIFT ======= */
@media print {
  body { background:white; color:black; font-size:8pt; margin:0; line-height:1.2; }
  header, .toolbar, #sickPanel, #clock { display:none !important; }
  #viewTitle { text-align:center; font-size:10pt; font-weight:bold; margin:0 0 4px 0; }

  /* D√∂lj korten och eventuella tabeller ‚Äì visa blockschemat */
  .cards, .card, table { display:none !important; }
  .block-wrap{ display:block !important; }

  /* Kompakt blockn√§t f√∂r utskrift */
  .block-header{ grid-template-columns:70px repeat(5,1fr); }
  .block-header div{ padding:3px 4px; background:#eee !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  .block-grid{ grid-template-columns:70px repeat(5,1fr); }
  .block-time{ padding:2px 3px; font-size:8pt; }
  .block-cell{ min-height:18px; }
  .block{ border-radius:4px; padding:2px 3px; font-size:7.5pt; }

  @page { size:A4 landscape; margin:6mm; }
}
</style>
</head>
<body>
<header>
  <!-- Loggan √∂verst -->
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnBlocks">Veckoblock</button>
  <button id="btnCards">Kortvy</button>
  <button id="btnSick">Sjukschema</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<div id="sickPanel">
  <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
  <div id="sickList"></div>
  <div id="sickMsg" style="font-size:.85rem;color:#666;margin-top:6px;"></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button id="btnShowSick">Visa sjukschema</button>
    <button id="btnClearSick" title="Rensa val">Rensa</button>
  </div>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<!-- Blockschema-beh√•llare -->
<div id="blockContainer" class="block-wrap" aria-hidden="true">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div id="printHint" style="font-size:.9rem;color:#444;margin-top:6px;display:none;text-align:center;">
    F√∂rhandsvisning f√∂r utskrift ‚Äì anv√§nd webbl√§sarens Skriv ut (Ctrl/Cmd + P).
  </div>
</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";
const aktivitetFarger={
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},"Padel":{color:"#82E0AA",emoji:"üèì"},
  "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
  "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Trummor":{color:"#F1948A",emoji:"ü•Å"},
  "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},"Medicin":{color:"#E59866",emoji:"üíä"},
  "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
  "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},"Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
  "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},"Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"}
};

function getSEDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Stockholm"}));}
function fmtSE(dt,opts){return new Intl.DateTimeFormat("sv-SE",opts).format(dt);}
function updateClock(){
  const now=getSEDate();
  document.getElementById("clock").textContent=
    fmtSE(now,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateClock,1000);updateClock();

let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  document.getElementById("updated").textContent="Senast uppdaterad: "+(json.updated||"‚Äì");
  setupCoachSelect(DATA);
  setupSickList(DATA);
  renderDaily(DATA);
}
function dayKey(str){return String(str).slice(0,10);}
function parseCoaches(coachStr){
  const ignore=["","-",".","ingen","ingen coach","eget arbete","sj√§lvst√§ndigt","utan coach"];
  return (coachStr||"").split(/,|\/|&|\+|;|\||\n| och /i)
    .map(c=>c.trim())
    .filter(c=>c&&!ignore.includes(c.toLowerCase())&&c.toLowerCase()!=="alla");
}
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#fff"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}

function shrinkList(str,max=3){
  if(!str) return "-";
  const arr=String(str).split(/,|\/|;|\||\n| och /i).map(s=>s.trim()).filter(Boolean);
  if(arr.length<=max) return arr.join(", ");
  return arr.slice(0,max).join(", ") + `, +${arr.length-max} fler`;
}

/* ======= Kortvy (coach) ‚Äì ordning: Tid, Aktivitet, Deltagare, Coach ======= */
function cardHTML(r,extra=""){
  const b=colorFor(r);
  const t=r.Start&&r.Slut?`${r.Start}‚Äì${r.Slut}`:r.Start||r.Slut||"-";
  return `<div class="card" style="--band:${b}">
    <div class="row"><label>üïí Tid:</label><div>${t}</div></div>
    <h4 class="card-title">${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h4>
    <div class="row"><label>üë• Deltagare:</label><div>${shrinkList(r.Deltagare,4)}</div></div>
    <div class="row"><label>üßë‚Äçüè´ Coach:</label><div>${shrinkList(r.Coach,3)} ${extra||""}</div></div>
  </div>`;
}

function groupByDate(rows){
  const g={};rows.forEach(r=>{const k=dayKey(r.Datum);if(!g[k])g[k]=[];g[k].push(r);});
  return Object.keys(g).sort().reduce((a,k)=>(a[k]=g[k],a),{});
}

function sectionHTML(dateKey,rows,extraForRow=null){
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(dateKey));
  let html=`<div class="day-section"><div class="day-heading">${label.charAt(0).toUpperCase()+label.slice(1)}</div><div class="cards">`;
  rows.forEach(r=>{const extra=extraForRow?extraForRow(r):"";html+=cardHTML(r,extra);});
  html+=`</div></div>`;return html;
}

function renderDaily(data){
  const today=dayKey(getSEDate().toISOString());
  const todays=data.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("blockContainer").setAttribute("aria-hidden","true");
  document.getElementById("btnBlocks").style.display="none";
  document.getElementById("btnCards").style.display="none";
  document.getElementById("schemaContainer").innerHTML=todays.length?sectionHTML(today,todays):`<p>Inga aktiviteter idag.</p>`;
}

function setupCoachSelect(data){
  const s=document.getElementById("coachSelect");
  s.innerHTML=`<option value="">-- V√§lj coach --</option>`;
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });
  s.onchange=()=>{const v=s.value;if(v)renderCoachWeek(DATA,v);};
}

function renderCoachWeek(data,coach){
  document.getElementById("viewTitle").textContent="Coachschema ‚Äì "+coach;
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("btnBlocks").style.display="inline-block";
  document.getElementById("btnCards").style.display="inline-block";
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("blockContainer").setAttribute("aria-hidden","true");

  // Hitta dagar coachen faktiskt jobbar
  const workDays = new Set(
    data.filter(r => parseCoaches(r.Coach).includes(coach)).map(r => dayKey(r.Datum))
  );

  // Filtrera ‚Äì inkludera "alla" endast om coachen jobbar den dagen
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach);
    const isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);
    return cs.includes(coach) || (isAll && workDays.has(dk));
  }).sort((a,b)=>{
    if(dayKey(a.Datum)===dayKey(b.Datum)) return (a.Start||"").localeCompare(b.Start||"");
    return dayKey(a.Datum).localeCompare(dayKey(b.Datum));
  });

  const grouped=groupByDate(rows);let html="";
  Object.keys(grouped).forEach(k=>html+=sectionHTML(k,grouped[k],null));
  document.getElementById("schemaContainer").innerHTML=rows.length?html:`<p>Inga aktiviteter hittades f√∂r ${coach}.</p>`;
}

/* ======= BLOCKSCHEMA (per coach, M√•n‚ÄìFre, 08:00‚Äì16:30) ======= */
const SLOT_START="08:00", SLOT_END="16:30"; // inkl. sista slotten
function makeSlots(start="08:00", end="16:30"){
  const toMin=t=>{const [h,m]=t.split(":").map(Number);return h*60+m;};
  const fromMin=m=>String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0");
  const a=toMin(start), b=toMin(end);
  const out=[];
  for(let t=a; t<=b; t+=30){ out.push(fromMin(t)); }
  return out; // inkluderar end (t.ex. 16:30)
}

function weekdayIndex(dateStr){
  // Returnerar 1..5 f√∂r M√•n..Fre, annars 0 (ignoreras)
  const d=new Date(dateStr);
  const wd=d.getDay(); // 0=Sun,1=Mon,...6=Sat
  if(wd>=1 && wd<=5) return wd;
  return 0;
}

function timeToRowIndex(time, slots){
  // Returnerar index (1-baserat i grid-rader) f√∂r given tid i slots
  // Ex: slots[0]="08:00" => rad 1
  const i=slots.indexOf(time);
  return i>=0 ? i+1 : null;
}

function ceilToSlot(t){
  // ex. "09:10" -> "09:30"
  const [h,m]=t.split(":").map(Number);
  return m<=0 ? `${String(h).padStart(2,"0")}:00`
              : (m<=30? `${String(h).padStart(2,"0")}:30`
                       : `${String((h+1)).padStart(2,"0")}:00`);
}
function floorToSlot(t){
  // ex. "09:10" -> "09:00"
  const [h,m]=t.split(":").map(Number);
  return `${String(h).padStart(2,"0")}:${m<30?"00":"30"}`;
}

function renderCoachBlocks(data, coach){
  // F√∂rhandsvisa block innan utskrift
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("blockContainer").setAttribute("aria-hidden","false");
  document.getElementById("printHint").style.display="block";

  const slots=makeSlots(SLOT_START,SLOT_END); // 18 rader
  const headerEl=document.getElementById("blockHeader");
  const gridEl=document.getElementById("blockGrid");

  // Header (Tid | M√•n..Fre)
  headerEl.innerHTML="";
  const days=["Tid","M√•ndag","Tisdag","Onsdag","Torsdag","Fredag"];
  days.forEach(d=>{
    const div=document.createElement("div");
    div.textContent=d; headerEl.appendChild(div);
  });

  // Grid-ram: tid-kolumn + 5 dagkolumner √ó slots rader
  gridEl.innerHTML="";
  for(let r=0;r<slots.length;r++){
    // tidskolumn
    const tdiv=document.createElement("div");
    tdiv.className="block-time";
    tdiv.textContent=slots[r];
    gridEl.appendChild(tdiv);

    // 5 dagceller
    for(let c=0;c<5;c++){
      const cell=document.createElement("div");
      cell.className="block-cell";
      gridEl.appendChild(cell);
    }
  }

  // Dagar coachen jobbar (f√∂r att begr√§nsa "alla")
  const workDays = new Set(
    data.filter(r => parseCoaches(r.Coach).includes(coach)).map(r => dayKey(r.Datum))
  );

  // Filtrera rader f√∂r denna coach med "alla"-regeln
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach);
    const isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);
    return cs.includes(coach) || (isAll && workDays.has(dk));
  });

  // Skapa block
  rows.forEach(r=>{
    const wd=weekdayIndex(r.Datum);
    if(wd===0) return; // hoppa √∂ver helg
    // Anpassa tider till slotgr√§nser
    const start=floorToSlot(r.Start||SLOT_START);
    const end=floorToSlot(r.Slut||SLOT_END);
    // block ska t√§cka t.o.m slutslotten ‚Äì om slut = 10:00 s√• slutar blocket precis vid den raden (exklusiv nedre gr√§ns)
    // vi anv√§nder grid-placering absolut i cell, s√• vi bygger visuellt √∂ver flera celler via top/bottom proportioner ist√§llet: enklare = vi l√•ter blocket fylla hela cellen f√∂r varje slot det t√§cker.
    let sIdx=timeToRowIndex(start,slots);
    let eIdx=timeToRowIndex(end,slots);
    if(sIdx==null) return;
    if(eIdx==null) eIdx=slots.length;
    // Om slut ligger f√∂re start, hoppa
    if(eIdx < sIdx) return;

    // F√∂r varje slot fr√•n sIdx..eIdx: markera celler ‚Äì men vi vill ha ett sammanh√§ngande block i kolumnen.
    // H√§r g√∂r vi ett *sammanh√§ngande* block som t√§cker fr√•n f√∂rsta cellen till sista i samma kolumn (dag).
    // Cellindex i grid: varje rad har 1 tidscell + 5 dagceller.
    // F√∂r rad r och dag d (1..5): index = r*(1+5) + d  (0-baserat)
    const firstCellIndex = (sIdx-1)*(1+5) + wd; // wd √§r 1..5
    const lastCellIndex  = (eIdx-1)*(1+5) + wd;

    // H√§mta DOM-rect f√∂r f√∂rsta & sista cellen
    const cells=[...gridEl.children];
    const firstCell=cells[firstCellIndex];
    const lastCell=cells[lastCellIndex];

    // Skapa block i f√∂rsta cellen och str√§ck det visuellt via position:absolute inom en "kolumn-overlay"
    // F√∂r enkelhet: vi l√§gger blocket i f√∂rsta cellen och s√§tter h√∂jd = antal slots * cellens h√∂jd minus sm√• marginaler.
    // (I print/kompaktl√§gen funkar detta stabilt eftersom raderna √§r lika h√∂ga.)
    const slotsCovered = (eIdx - sIdx) + 1;

    const block=document.createElement("div");
    block.className="block";
    const bg=colorFor(r);
    block.style.background=bg;

    const akt = r.Aktivitet || "Aktivitet";
    const tStr = (r.Start||"-") + (r.Slut? `‚Äì${r.Slut}` : "");
    const deltagare = shrinkList(r.Deltagare, 3);
    // Coachtext ‚Äì visa bara om fler √§n 1 coach eller om r.Coach inte bara √§r "alla"
    let coachText = (r.Coach||"");
    const isAll=(coachText.trim().toLowerCase()==="alla");
    const coachDisplay = isAll ? "Alla" : shrinkList(coachText,2);

    block.innerHTML = `
      <div class="title">${emojiFor(r)} ${akt}</div>
      <div class="small">üïí ${tStr}</div>
      <div class="small">üë• ${deltagare}</div>
      <div class="small">üßë‚Äçüè´ ${coachDisplay}</div>
    `;

    // S√§tt blockets h√∂jd s√• det t√§cker r√§tt antal slotrader
    // Vi approximera h√∂jd via parent cellens h√∂jd vid render ‚Äì funkar p√• sk√§rm/print d√• raderna √§r j√§mna.
    // Placera blocket i f√∂rsta cellen och justera h√∂jd efter slotsCovered:
    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight || 28; // fallback
      block.style.height = (slotsCovered*cellH - 4) + "px"; // -4 f√∂r 2px topp/botten marginal
    });

    firstCell.appendChild(block);
  });

  document.getElementById("viewTitle").textContent = "Veckoblock ‚Äì " + coach + " (08:00‚Äì16:30)";
}

/* ======= Sjukvy (of√∂r√§ndrad f√∂r nu) ======= */
function setupSickList(data){
  const c=document.getElementById("sickList");c.innerHTML="";
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(co=>{
    const id="sick_"+co.replace(/\s+/g,"_");
    c.insertAdjacentHTML("beforeend",`<label><input type="checkbox" value="${co}" id="${id}"> ${co}</label>`);
  });
}
function getSelectedSick(){return[...document.querySelectorAll("#sickList input:checked")].map(e=>e.value);}
function overlap(aStart,aEnd,bStart,bEnd){return !(aEnd<=bStart||aStart>=bEnd);}
function getThisWeekMonFri(){
  const today=getSEDate(),day=today.getDay(),mon=new Date(today);
  mon.setDate(today.getDate()-((day+6)%7));mon.setHours(0,0,0,0);
  const fri=new Date(mon);fri.setDate(mon.getDate()+4);return{mon,fri};
}
function renderSickSchedule(data,sickCoaches){
  document.getElementById("viewTitle").textContent="ü©∫ Sjukschema";
  const {mon,fri}=getThisWeekMonFri(),sK=dayKey(mon.toISOString()),eK=dayKey(fri.toISOString());
  const weekRows=data.filter(r=>dayKey(r.Datum)>=sK&&dayKey(r.Datum)<=eK);
  const sickRows=weekRows.filter(r=>sickCoaches.some(s=>parseCoaches(r.Coach).includes(s)))
    .sort((a,b)=>(dayKey(a.Datum)===dayKey(b.Datum)?(a.Start||"").localeCompare(b.Start||""):dayKey(a.Datum).localeCompare(dayKey(b.Datum))));
  const allCoaches=[...new Set(weekRows.map(r=>parseCoaches(r.Coach)).flat())];
  const extraForRow=(r)=>{
    const tS=r.Start||"00:00",tE=r.Slut||"23:59",dK=dayKey(r.Datum);
    const avail=allCoaches.filter(c=>!sickCoaches.includes(c)).filter(c=>{
      const cRows=weekRows.filter(x=>parseCoaches(x.Coach).includes(c)&&dayKey(x.Datum)===dK);
      return!cRows.some(x=>overlap(x.Start||"00:00",x.Slut||"23:59",tS,tE));
    });
    return avail.length?`<span class="okpill">Ers√§ttare: ${avail.join(", ")}</span>`:`<span class="pill">Inga ers√§ttare</span>`;
  };
  const grouped=groupByDate(sickRows);let html="";
  Object.keys(grouped).forEach(k=>{
    const rows=grouped[k].map(r=>{
      const cs=parseCoaches(r.Coach),sick=cs.filter(c=>sickCoaches.includes(c)),others=cs.filter(c=>!sickCoaches.includes(c));
      const coachText=[sick.length?`Sjuk: ${sick.join(", ")}`:"",others.length?`√ñvriga: ${others.join(", ")}`:""].filter(Boolean).join(" ‚Ä¢ ");
      return {...r,Coach:coachText};
    });
    html+=sectionHTML(k,rows,extraForRow);
  });
  document.getElementById("schemaContainer").innerHTML=sickRows.length?html:`<p>Inga pass f√∂r valda coacher under denna vecka.</p>`;
}

/* ======= Knappar ======= */
document.getElementById("btnDaily").onclick=()=>{
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("sickPanel").style.display="none";
  renderDaily(DATA);
};
document.getElementById("btnCoach").onclick=()=>{
  document.getElementById("sickPanel").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("btnBlocks").style.display="inline-block";
  document.getElementById("btnCards").style.display="inline-block";
  const v=document.getElementById("coachSelect").value;
  if(v){ renderCoachWeek(DATA,v); }
  else{
    document.getElementById("schemaContainer").innerHTML=`<p>V√§lj en coach i listan.</p>`;
    document.getElementById("schemaContainer").style.display="block";
    document.getElementById("blockContainer").style.display="none";
  }
};
document.getElementById("btnBlocks").onclick=()=>{
  const v=document.getElementById("coachSelect").value;
  if(!v){ alert("V√§lj en coach f√∂rst."); return; }
  renderCoachBlocks(DATA, v);
};
document.getElementById("btnCards").onclick=()=>{
  const v=document.getElementById("coachSelect").value;
  if(!v){ alert("V√§lj en coach f√∂rst."); return; }
  renderCoachWeek(DATA, v);
};
document.getElementById("btnSick").onclick=()=>{
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("btnBlocks").style.display="none";
  document.getElementById("btnCards").style.display="none";
  document.getElementById("sickPanel").style.display="block";
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("schemaContainer").innerHTML=`<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;
};
document.getElementById("btnShowSick").onclick=()=>{
  const s=getSelectedSick();
  if(!s.length){ document.getElementById("sickMsg").textContent="V√§lj minst en coach."; return; }
  document.getElementById("sickMsg").textContent="";
  renderSickSchedule(DATA,s);
};
document.getElementById("btnClearSick").onclick=()=>{
  document.querySelectorAll("#sickList input").forEach(cb=>cb.checked=false);
  document.getElementById("sickMsg").textContent="";
  document.getElementById("schemaContainer").innerHTML=`<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;
};

document.getElementById("btnPrint").onclick=()=>{
  // ENBART f√∂rhandsvisa ‚Äì ingen auto window.print()
  const title = document.getElementById("viewTitle").textContent;
  if(title.startsWith("Coachschema ‚Äì ")){
    const coach = title.replace("Coachschema ‚Äì ","");
    // Om vi inte redan √§r i blockl√§get: v√§xla till block
    if(document.getElementById("blockContainer").getAttribute("aria-hidden")==="true"){
      renderCoachBlocks(DATA, coach);
    }
    // Visa hint ‚Äì sen f√•r anv√§ndaren trycka Ctrl/Cmd+P sj√§lv
    document.getElementById("printHint").style.display="block";
  }else{
    alert("Utskrift √§r optimerad f√∂r coachens *Veckoblock*. V√§lj Coachschema ‚Üí V√§lj coach ‚Üí Veckoblock.");
  }
};

loadData();
setInterval(loadData,15*60*1000);
</script>
</body>
</html>

