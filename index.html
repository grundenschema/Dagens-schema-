/* ===== Ladda data ===== */
let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    document.getElementById("updated").textContent="Senast uppdaterad: "+(json.updated||"‚Äì");
    setupCoachSelect(DATA);
    setupNameSelect(DATA);
    setupSickList(DATA);
    renderDaily(DATA);
  }catch(e){
    document.getElementById("schemaContainer").innerHTML="<p style='color:red'>Kunde inte h√§mta schemat.</p>";
    console.error(e);
  }
}

/* ===== Fyll coach-lista ===== */
function setupCoachSelect(data){
  const s=document.getElementById("coachSelect");
  s.innerHTML=`<option value="">-- V√§lj coach --</option>`;
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });
  s.onchange=()=>{const v=s.value;if(v)renderCoachWeek(DATA,v);};
}

/* ===== Fyll deltagar-lista (fr√•n fungerande deltagarsida) ===== */
function setupNameSelect(data){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  [...new Set(data.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla")
    .sort().forEach(n=>{
      const o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);
    });
}

/* ===== Kortvy gemensamt schema ===== */
function cardHTML(r){
  const b=colorFor(r);
  const t=(r.Start&&r.Slut)?`${r.Start}‚Äì${r.Slut}`:r.Start||r.Slut||"-";
  return `<div class="card" style="--band:${b}">
    <div class="row"><label>üïí Tid:</label><span>${t}</span></div>
    <div class="card-title">${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</div>
    <div class="row"><label>üë• Deltagare:</label><span>${shrinkList(r.Deltagare,2)}</span></div>
    <div class="row"><label>üßë‚Äçüè´ Coach:</label><span>${shrinkList(r.Coach,2)}</span></div>
  </div>`;
}
function groupByDate(rows){
  const g={};rows.forEach(r=>{const k=dayKey(r.Datum);(g[k]=g[k]||[]).push(r);});
  return Object.keys(g).sort().reduce((a,k)=>(a[k]=g[k],a),{});
}
function sectionHTML(k,rows){
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(k));
  return `<div class="day-section"><div class="day-heading">${label}</div><div class="cards">${rows.map(cardHTML).join("")}</div></div>`;
}
function renderDaily(data){
  const today=dayKey(getSEDate().toISOString());
  const rows=data.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("schemaContainer").innerHTML=rows.length?sectionHTML(today,rows):`<p>Inga aktiviteter idag.</p>`;
}

/* ===== Coachschema ===== */
function renderCoachWeek(data,coach){
  const rows=data.filter(r=>parseCoaches(r.Coach).includes(coach)||(r.Coach||"").trim().toLowerCase()==="alla")
    .sort((a,b)=>{
      if(dayKey(a.Datum)===dayKey(b.Datum))return(a.Start||"").localeCompare(b.Start||"");
      return dayKey(a.Datum).localeCompare(dayKey(b.Datum));
    });
  const grouped=groupByDate(rows);
  document.getElementById("viewTitle").textContent="Coachschema ‚Äì "+coach;
  document.getElementById("schemaContainer").innerHTML=Object.keys(grouped).map(k=>sectionHTML(k,grouped[k])).join("")||`<p>Inga aktiviteter f√∂r ${coach}.</p>`;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
}

/* ===== Deltagarschema ===== */
function renderParticipantWeek(data,name){
  const rows=data.filter(r=>{
    const d=(r.Deltagare||"").toLowerCase();
    return d.includes(name.toLowerCase())||d==="alla";
  }).sort((a,b)=>{
    if(dayKey(a.Datum)===dayKey(b.Datum))return(a.Start||"").localeCompare(b.Start||"");
    return dayKey(a.Datum).localeCompare(dayKey(b.Datum));
  });
  const grouped=groupByDate(rows);
  document.getElementById("viewTitle").textContent="Deltagarschema ‚Äì "+name;
  document.getElementById("schemaContainer").innerHTML=Object.keys(grouped).map(k=>sectionHTML(k,grouped[k])).join("")||`<p>Inga aktiviteter f√∂r ${name}.</p>`;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
}

/* ===== Veckoschema (coach + deltagare, samma layout) ===== */
function makeSlots(){const out=[];let t=8*60;while(t<=16*60+30){out.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));t+=30;}return out;}
function renderBlocks(data,filterFunc,title){
  const slots=makeSlots(),days=[...new Set(data.map(r=>dayKey(r.Datum)))].sort();
  const rows=data.filter(filterFunc);
  const head=document.getElementById("blockHeader"),grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("");
  grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children],dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");block.className="block";block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    if(duration<=30){block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""} ‚Äì ${r.Coach||"-"}`;}
    else{block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}<br>${r.Start}‚Äì${r.Slut}<br>${r.Coach||"-"}`;}
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  document.getElementById("viewTitle").textContent=title;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
}

/* ===== Knapphantering ===== */
document.getElementById("btnDaily").onclick=()=>{renderDaily(DATA);};
document.getElementById("btnCoach").onclick=()=>{
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("btnBlocks").style.display="inline-block";
  document.getElementById("btnCards").style.display="inline-block";
  document.getElementById("sickPanel").style.display="none";
  const v=document.getElementById("coachSelect").value;
  if(v)renderCoachWeek(DATA,v);
};
document.getElementById("btnParticipant").onclick=()=>{
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("btnBlocks").style.display="inline-block";
  document.getElementById("btnCards").style.display="inline-block";
  document.getElementById("sickPanel").style.display="none";
  const v=document.getElementById("nameSelect").value;
  if(v)renderParticipantWeek(DATA,v);
};
document.getElementById("btnBlocks").onclick=()=>{
  const coach=document.getElementById("coachSelect").value;
  const name=document.getElementById("nameSelect").value;
  if(coach)renderBlocks(DATA,r=>parseCoaches(r.Coach).includes(coach)||(r.Coach||"").toLowerCase()==="alla","Veckoschema ‚Äì "+coach);
  else if(name)renderBlocks(DATA,r=>{
    const d=(r.Deltagare||"").toLowerCase();
    return d.includes(name.toLowerCase())||d==="alla";
  },"Veckoschema ‚Äì "+name);
  else alert("V√§lj en coach eller deltagare f√∂rst.");
};
document.getElementById("btnCards").onclick=()=>{
  const coach=document.getElementById("coachSelect").value;
  const name=document.getElementById("nameSelect").value;
  if(coach)renderCoachWeek(DATA,coach);
  else if(name)renderParticipantWeek(DATA,name);
  else alert("V√§lj en coach eller deltagare f√∂rst.");
};
document.getElementById("btnPrint").onclick=()=>{window.print();};

/* ===== Init ===== */
loadData();
setInterval(loadData,15*60*1000);
</script>
</body>
</html>

