<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grunden DV – Schema</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #fafafa;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
    }

    header h1 { margin: 0; }
    header img {
      height: 60px;
      position: absolute;
      top: 0;
      right: 0;
    }

    #clock {
      font-family: monospace;
      font-size: 16px;
      margin-bottom: 10px;
    }

    nav {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    button.active {
      background: #1abc9c;
    }

    select {
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th { background: #f2f2f2; }
    td.aktivitet { font-weight: bold; }
    .ended { opacity: 0.6; }

    .day-section {
      margin-top: 25px;
    }

    .day-section h2 {
      background: #f2f2f2;
      padding: 8px;
      border-radius: 6px;
    }

    @media (max-width: 700px) {
      table, th, td { font-size: 0.9rem; }
      header img { height: 40px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Grunden DV – Schema</h1>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <div id="clock"></div>

  <nav>
    <button id="btn-daily" class="active">📅 Dagens schema</button>
    <button id="btn-week">🗓️ Veckoschema</button>
    <select id="coach-filter" style="display:none;">
      <option value="">Välj coach...</option>
    </select>
  </nav>

  <div id="content"></div>

<script>
// --- INSTÄLLNINGAR ---
const BASE_URL = "https://script.google.com/macros/s/AKfycbzT1dSJN9tVLLw_BcIrMBt3Rw0q3mwHWZT-o-phPpaf5PR8PDt-7yuk3yO2gxJGT5to/exec";

const aktivitetFarger = {
  "Måndagsmöte":     {color:"#AED6F1", emoji:"📅"},
  "Gruppmöte":       {color:"#7FB3D5", emoji:"👥"},
  "Lunch":           {color:"#F9E79F", emoji:"🍲"},
  "Frukost":         {color:"#FAD7A0", emoji:"🥐"},
  "Ateljé":          {color:"#F5CBA7", emoji:"🎨"},
  "Musik":           {color:"#D2B4DE", emoji:"🎶"},
  "Pod":             {color:"#A9CCE3", emoji:"🎙️"},
  "Padel":           {color:"#82E0AA", emoji:"🏓"},
  "Lite av varje":   {color:"#FADBD8", emoji:"✨"},
  "Yoga":            {color:"#D5F5E3", emoji:"🧘"},
  "Gym":             {color:"#A3E4D7", emoji:"🏋️‍♂️"},
  "Lunchpromenad":   {color:"#F7DC6F", emoji:"🚶‍♂️🍲"},
  "Kulturpromenad":  {color:"#F8C471", emoji:"🏛️🚶"},
  "Film":            {color:"#E6B0AA", emoji:"🎬"},
  "Behandling":      {color:"#EDBB99", emoji:"💆"},
  "Handla":          {color:"#ABEBC6", emoji:"🛍️"},
  "Gåträning":       {color:"#76D7C4", emoji:"🚶"},
  "Uppstart":        {color:"#F0B27A", emoji:"🚀"},
  "Poesigruppen":    {color:"#F1948A", emoji:"✍️"},
  "Trummor":         {color:"#F1948A", emoji:"🥁"},
  "Rollspel":        {color:"#BB8FCE", emoji:"🐉"},
  "Återkoppling":    {color:"#85C1E9", emoji:"🔄"},
  "Handling":        {color:"#73C6B6", emoji:"🛒"},
  "Medicin":         {color:"#E59866", emoji:"💊"},
  "Föreningsgruppen":{color:"#D6DBDF", emoji:"🤝"},
  "Öppen verkstad":  {color:"#F5B7B1", emoji:"🔧"},
  "Biljard":         {color:"#A9DFBF", emoji:"🎱"},
  "Spelgruppen":     {color:"#F8C471", emoji:"🎲"},
  "Sömnad":          {color:"#F5EEF8", emoji:"🧵"},
  "Filmkunskap":     {color:"#E6B0AA", emoji:"🎬"},
  "Musikquizz":      {color:"#D2B4DE", emoji:"🎶"},
  "Musikdokumentär": {color:"#D2B4DE", emoji:"🎶"}
};

// --- Hjälpfunktioner ---
function getStockholmDate() {
  return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
}

function setActiveButton(mode) {
  btnDaily.classList.toggle("active", mode === "daily");
  btnWeek.classList.toggle("active", mode === "week");
}

// --- Visa dagens schema ---
async function showDaily() {
  setActiveButton("daily");
  coachFilter.style.display = "none";
  content.innerHTML = "<p>Laddar dagens schema...</p>";

  const res = await fetch(`${BASE_URL}?mode=daily&t=${Date.now()}`);
  const json = await res.json();
  const now = getStockholmDate();
  const nowStr = now.toTimeString().slice(0,5);

  let html = `<h2>${json.date}</h2>
              <table>
              <thead><tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr></thead><tbody>`;

  let firstGreen = null;

  json.data.forEach(a => {
    const fargEmoji = aktivitetFarger[a.aktivitet] || {color:"#fff", emoji:""};
    const aktivitetText = `${fargEmoji.emoji ? fargEmoji.emoji+" " : ""}${a.aktivitet}`;
    let status = "";
    if (a.slut <= nowStr) status = "❌";
    else if (a.start <= nowStr && a.slut >= nowStr) status = "🟢";

    const cls = status === "❌" ? "ended" : "";
    html += `<tr class="${cls}" style="background:${fargEmoji.color}">
               <td>${a.start}</td>
               <td>${a.slut}</td>
               <td class="aktivitet">${status} ${aktivitetText}</td>
               <td>${a.deltagare}</td>
               <td>${a.coach}</td>
             </tr>`;
  });

  html += "</tbody></table>";
  content.innerHTML = html;
}

// --- Visa veckoschema ---
async function showWeek(selectedCoach = "") {
  setActiveButton("week");
  coachFilter.style.display = "inline-block";
  content.innerHTML = "<p>Laddar veckoschema...</p>";

  const res = await fetch(`${BASE_URL}?mode=week&t=${Date.now()}`);
  const json = await res.json();

  // lista alla coacher
  const allCoaches = new Set();
  json.days.forEach(d => d.data.forEach(r => {
    r[4].split(",").forEach(c => allCoaches.add(c.trim()));
  }));
  coachFilter.innerHTML = `<option value="">Välj coach...</option>`;
  [...allCoaches].sort().forEach(c => { if (c) coachFilter.innerHTML += `<option value="${c}">${c}</option>`; });
  if (selectedCoach) coachFilter.value = selectedCoach;

  let html = "";
  json.days.forEach(day => {
    const filtered = day.data.filter(r => {
      const coachList = r[4].split(",").map(x => x.trim().toLowerCase());
      return !selectedCoach || coachList.includes(selectedCoach.toLowerCase()) || coachList.includes("alla");
    });
    if (filtered.length === 0) return;
    html += `<div class="day-section"><h2>${day.date}</h2>
             <table><thead><tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr></thead><tbody>`;
    filtered.forEach(r => {
      const fargEmoji = aktivitetFarger[r[2]] || {color:"#fff", emoji:""};
      const aktivitetText = `${fargEmoji.emoji ? fargEmoji.emoji+" " : ""}${r[2]}`;
      html += `<tr style="background:${fargEmoji.color}">
                 <td>${r[0]}</td>
                 <td>${r[1]}</td>
                 <td class="aktivitet">${aktivitetText}</td>
                 <td>${r[3]}</td>
                 <td>${r[4]}</td>
               </tr>`;
    });
    html += "</tbody></table></div>";
  });

  content.innerHTML = html || "<p>Inget schema hittades för vald coach.</p>";
}

// --- Klocka ---
function updateClock() {
  const now = getStockholmDate();
  const options = { weekday:"long", year:"numeric", month:"long", day:"numeric",
                    hour:"2-digit", minute:"2-digit", second:"2-digit",
                    timeZone:"Europe/Stockholm" };
  document.getElementById("clock").textContent =
    new Intl.DateTimeFormat("sv-SE", options).format(now);
}

setInterval(updateClock, 1000);
updateClock();

// --- Händelser ---
const btnDaily = document.getElementById("btn-daily");
const btnWeek = document.getElementById("btn-week");
const coachFilter = document.getElementById("coach-filter");
const content = document.getElementById("content");

btnDaily.addEventListener("click", showDaily);
btnWeek.addEventListener("click", () => showWeek());
coachFilter.addEventListener("change", e => showWeek(e.target.value));

showDaily();
setInterval(showDaily, 30*60*1000);
</script>
</body>
</html>
