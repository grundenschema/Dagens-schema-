<script>
/* ===== Datakälla ===== */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";
const aktivitetFarger={
  "Måndagsmöte":{color:"#AED6F1"},"Gruppmöte":{color:"#7FB3D5"},
  "Lunch":{color:"#F9E79F"},"Frukost":{color:"#FAD7A0"},
  "Ateljé":{color:"#F5CBA7"},"Musik":{color:"#D2B4DE"},
  "Pod":{color:"#A9CCE3"},"Padel":{color:"#82E0AA"},
  "Lite av varje":{color:"#FADBD8"},"Yoga":{color:"#D5F5E3"},
  "Gym":{color:"#A3E4D7"},"Film":{color:"#E6B0AA"},
  "Föreningsgruppen":{color:"#D6DBDF"},"Trummor":{color:"#F1948A"},
  "Återkoppling":{color:"#85C1E9"},"Medicin":{color:"#E59866"},
  "Biljard":{color:"#A9DFBF"},"Spelgruppen":{color:"#F8C471"},
  "Sömnad":{color:"#F5EEF8"},"Filmgruppen":{color:"#E6B0AA"},
  "Musikquizz":{color:"#D2B4DE"},"Musikdokumentär":{color:"#D2B4DE"}
};

/* ===== Hjälpfunktioner ===== */
function getSEDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Stockholm"}));}
function dayKey(str){return String(str).slice(0,10);}
function parseCoaches(coachStr){
  const ignore=["","-",".","ingen","ingen coach","eget arbete","självständigt","utan coach"];
  return (coachStr||"").split(/,|\/|&|\+|;|\||\n| och /i)
    .map(c=>c.trim())
    .filter(c=>c&&!ignore.includes(c.toLowerCase())&&c.toLowerCase()!=="alla");
}
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#fff"}).color;}
function shrinkList(str,max=2){
  if(!str) return "-";
  const arr=String(str).split(/,|\/|;|\||\n| och /i).map(s=>s.trim()).filter(Boolean);
  return arr.length<=max?arr.join(", "):arr.slice(0,max).join(", ")+`, +${arr.length-max} fler`;
}

/* ===== KORTVY (digital visning) ===== */
function cardHTML(r,isOngoing=false,isShort=false){
  const b=colorFor(r);
  const t=(r.Start&&r.Slut)?`${r.Start}–${r.Slut}`:r.Start||r.Slut||"-";
  if(isShort){
    return `
      <div class="card" style="--band:${b};font-size:0.9rem;">
        <div class="row"><label>🕒 Tid:</label><div>${t}</div></div>
        <div class="card-title" style="font-weight:700;">${r.Aktivitet||"Aktivitet"}</div>
        <div class="row"><label>👥:</label><div>${shrinkList(r.Deltagare,4)}</div></div>
      </div>`;
  }
  return `
    <div class="card" style="--band:${b}">
      <div class="row"><label>🕒 Tid:</label><div>${t}</div></div>
      <h4 class="card-title">${r.Aktivitet||"Aktivitet"}</h4>
      <div class="row"><label>👥 Deltagare:</label><div>${shrinkList(r.Deltagare,4)}</div></div>
      <div class="row"><label>🧑‍🏫 Coach:</label><div>${shrinkList(r.Coach,3)}</div></div>
    </div>`;
}

function renderDaily(data){
  const now=getSEDate();
  const today=dayKey(now.toISOString());
  const rows=data.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const ongoing=[],upcoming=[],past=[];
  for(const r of rows){
    const start=r.Start||"00:00",end=r.Slut||"23:59";
    const [sh,sm]=start.split(":").map(Number);
    const [eh,em]=end.split(":").map(Number);
    const durationMin=(eh*60+em)-(sh*60+sm);
    const isShort=durationMin<=60;
    const nowMins=now.getHours()*60+now.getMinutes();
    const startMins=sh*60+sm,endMins=eh*60+em;
    if(nowMins>=startMins&&nowMins<endMins){ongoing.push({...r,isShort});}
    else if(nowMins<startMins){upcoming.push({...r,isShort});}
    else{past.push({...r,isShort});}
  }
  const htmlSection=(title,arr,icon)=>{
    if(!arr.length)return"";
    return `
      <div class="day-section">
        <div class="day-heading">${icon?icon+" ":""}${title}</div>
        <div class="cards">
          ${arr.map(r=>cardHTML(r,false,r.isShort)).join("")}
        </div>
      </div>`;
  };
  const output=
    htmlSection("Pågående aktiviteter",ongoing,"🟢")+
    htmlSection("Kommande aktiviteter",upcoming,"⏳")+
    htmlSection("Tidigare aktiviteter",past,"🕓");
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("schemaContainer").innerHTML=output||"<p>Inga aktiviteter idag.</p>";
}

/* ===== Blockschema (för utskrift) ===== */
const SLOT_START="08:00",SLOT_END="16:30";
function makeSlots(){const out=[];let t=8*60;while(t<=16*60+30){out.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));t+=30;}return out;}
function weekdayIndex(dateStr){const d=new Date(dateStr),wd=d.getDay();return(wd>=1&&wd<=5)?wd:0;}
function timeToRowIndex(time,slots){return slots.indexOf(time)+1;}
function floorSlot(t){const[h,m]=t.split(":").map(Number);return`${String(h).padStart(2,"0")}:${m<30?"00":"30"}`;}

function renderCoachBlocks(data,coach){
  const slots=makeSlots();
  const workDays=new Set(data.filter(r=>parseCoaches(r.Coach).includes(coach)).map(r=>dayKey(r.Datum)));
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach),isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);
    return cs.includes(coach)||(isAll&&workDays.has(dk));
  });
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("blockContainer").setAttribute("aria-hidden","false");
  document.getElementById("printHint").style.display="block";
  document.getElementById("viewTitle").textContent="Veckoblock – "+coach+" (08:00–16:30)";
  const head=document.getElementById("blockHeader"),grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div><div>Mån</div><div>Tis</div><div>Ons</div><div>Tors</div><div>Fre</div>";
  grid.innerHTML="";
  slots.forEach((t,i)=>{
    const zebra=i%2===0?' style="background:#f9f9f9;"':'';
    grid.innerHTML+=`<div class="block-time"${zebra}>${t}</div>`;
    for(let d=0;d<5;d++)grid.innerHTML+=`<div class="block-cell"${zebra}></div>`;
  });
  const cells=[...grid.children];
  rows.forEach(r=>{
    const wd=weekdayIndex(r.Datum);if(!wd)return;
    const start=floorSlot(r.Start||SLOT_START),end=floorSlot(r.Slut||SLOT_END);
    let sIdx=timeToRowIndex(start,slots),eIdx=timeToRowIndex(end,slots)-1;
    if(sIdx<1||eIdx<sIdx)return;
    const durationMin=(parseInt(end.split(":")[0])*60+parseInt(end.split(":")[1]))-(parseInt(start.split(":")[0])*60+parseInt(start.split(":")[1]));
    const isShort=durationMin<=60;
    const firstCellIndex=(sIdx-1)*(1+5)+wd;
    const firstCell=cells[firstCellIndex];
    const slotsCovered=eIdx-sIdx+1;
    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);
    block.style.border="0.5pt solid #aaa";
    block.style.marginBottom="1px";
    const akt=r.Aktivitet||"Aktivitet";
    const deltagare=shrinkList(r.Deltagare,3);
    const coachDisplay=shrinkList(r.Coach,2);
    const textSize=isShort?"0.75rem":"0.85rem";
    const smallCls=isShort?"style='font-size:0.7rem;line-height:1.1;'":"class='small'";
    block.innerHTML=`
      <div class="title" style="font-size:${textSize};font-weight:700;">${akt}</div>
      <div ${smallCls}>👥 ${deltagare}</div>
      ${isShort?"":`<div class="small">🧑‍🏫 ${coachDisplay}</div>`}
    `;
    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight||28;
      block.style.height=(slotsCovered*cellH-3)+"px";
    });
    firstCell.appendChild(block);
  });
}

/* ===== Ladda data och knappar ===== */
let DATA=[];
async function loadData(){
  const res=await fetch(url+"?t="+Date.now());
  const json=await res.json();
  DATA=json.data||[];
  renderDaily(DATA);
}
document.getElementById("btnDaily").onclick=()=>renderDaily(DATA);
document.getElementById("btnBlocks").onclick=()=>{
  const v=document.getElementById("coachSelect").value;
  if(!v){alert("Välj en coach först.");return;}
  renderCoachBlocks(DATA,v);
};
loadData();
</script>

