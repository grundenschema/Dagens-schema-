<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grunden DV – Schema</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    header img {
      height: 60px;
      position: absolute;
      top: 20px;
      right: 20px;
    }
    h1 { margin-bottom: 5px; }
    #clock { font-family: monospace; margin-bottom: 15px; }

    select, button {
      margin: 5px 5px 15px 0;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background-color: #f7f7f7;
      cursor: pointer;
    }
    button:hover { background-color: #e0e0e0; }

    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f2f2f2; }
    .ended { opacity: 0.6; }
    .aktivitet { font-weight: bold; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <h1 id="viewTitle">Dagens gemensamma schema</h1>
  <div id="clock"></div>

  <div>
    <button id="showDaily">Gemensamt schema</button>
    <button id="showWeekly">Coachschema</button>
    <select id="coachSelect" class="hidden"></select>
  </div>

  <div id="schemaContainer">Laddar schema...</div>

  <script>
    // 🔗 Byt till din egen web app-länk
    const url = "https://script.google.com/macros/s/AKfycbxB9ZR9UnDf1rrEmeATZD9y4r5qM4yRySo574CLWYTkXt9-dpS2eOM14T2fpqZg-2x1/exec";

    const aktivitetFarger = {
      "Måndagsmöte": {color:"#AED6F1", emoji:"📅"},
      "Gruppmöte": {color:"#7FB3D5", emoji:"👥"},
      "Lunch": {color:"#F9E79F", emoji:"🍲"},
      "Frukost": {color:"#FAD7A0", emoji:"🥐"},
      "Ateljé": {color:"#F5CBA7", emoji:"🎨"},
      "Musik": {color:"#D2B4DE", emoji:"🎶"},
      "Pod": {color:"#A9CCE3", emoji:"🎙️"},
      "Padel": {color:"#82E0AA", emoji:"🏓"},
      "Lite av varje": {color:"#FADBD8", emoji:"✨"},
      "Yoga": {color:"#D5F5E3", emoji:"🧘"},
      "Gym": {color:"#A3E4D7", emoji:"🏋️‍♂️"},
      "Film": {color:"#E6B0AA", emoji:"🎬"},
      "Föreningsgruppen": {color:"#D6DBDF", emoji:"🤝"},
      "Trummor": {color:"#F1948A", emoji:"🥁"},
      "Återkoppling": {color:"#85C1E9", emoji:"🔄"},
      "Medicin": {color:"#E59866", emoji:"💊"},
      "Biljard": {color:"#A9DFBF", emoji:"🎱"},
      "Spelgruppen": {color:"#F8C471", emoji:"🎲"},
      "Sömnad": {color:"#F5EEF8", emoji:"🧵"},
      "Filmgruppen": {color:"#E6B0AA", emoji:"🎬"},
      "Musikquizz": {color:"#D2B4DE", emoji:"🎶"},
      "Musikdokumentär": {color:"#D2B4DE", emoji:"🎶"}
    };

    function getStockholmDate() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
    }

    function updateClock() {
      const now = getStockholmDate();
      const options = {
        weekday: "long", year: "numeric", month: "long", day: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit", timeZone: "Europe/Stockholm"
      };
      document.getElementById("clock").textContent =
        new Intl.DateTimeFormat("sv-SE", options).format(now);
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loadSchema() {
      const res = await fetch(url + "?t=" + Date.now());
      const json = await res.json();
      const data = json.data;

      renderDaily(data);
      setupWeekly(data);
    }

    function renderDaily(data) {
      document.getElementById("viewTitle").textContent = "Dagens gemensamma schema";
      document.getElementById("coachSelect").classList.add("hidden");

      const todayStr = getStockholmDate().toISOString().split("T")[0];
      const todays = data.filter(r => r.Datum === todayStr);
      const now = getStockholmDate().toTimeString().slice(0,5);

      let html = `<table><thead>
        <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
      </thead><tbody>`;

      todays.forEach(row => {
        const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
        const status = (row.Slut <= now) ? "❌" : (row.Start <= now && row.Slut >= now) ? "🟢" : "";
        html += `<tr style="background:${f.color}" class="${status==='❌'?'ended':''}">
          <td>${row.Start}</td>
          <td>${row.Slut}</td>
          <td class="aktivitet">${status} ${f.emoji||""} ${row.Aktivitet}</td>
          <td>${row.Deltagare}</td>
          <td>${row.Coach}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById("schemaContainer").innerHTML = html;
    }

    function setupWeekly(data) {
      const coaches = [...new Set(data.map(r => r.Coach.split(",")).flat().map(c => c.trim()).filter(c => c && c!=="Alla"))].sort();
      const select = document.getElementById("coachSelect");
      select.innerHTML = "<option value=''>-- Välj coach --</option>" + coaches.map(c => `<option value="${c}">${c}</option>`).join("");
      select.onchange = () => renderWeekly(data, select.value);
    }

    function renderWeekly(data, coach) {
      document.getElementById("viewTitle").textContent = "Coachschema" + (coach ? ` – ${coach}` : "");
      document.getElementById("coachSelect").classList.remove("hidden");

      let filtered = data;
      if (coach) {
        filtered = data.filter(r =>
          r.Coach.split(",").map(c => c.trim()).includes(coach) ||
          r.Coach.trim() === "Alla"
        );
      }

      let html = `<table><thead>
        <tr><th>Datum</th><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
      </thead><tbody>`;

      filtered.forEach(row => {
        const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
        html += `<tr style="background:${f.color}">
          <td>${row.Datum}</td>
          <td>${row.Start}</td>
          <td>${row.Slut}</td>
          <td class="aktivitet">${f.emoji||""} ${row.Aktivitet}</td>
          <td>${row.Deltagare}</td>
          <td>${row.Coach}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById("schemaContainer").innerHTML = html;
    }

    document.getElementById("showDaily").onclick = () => loadSchema();
    document.getElementById("showWeekly").onclick = () => {
      document.getElementById("coachSelect").classList.remove("hidden");
      fetch(url + "?t=" + Date.now())
        .then(r => r.json())
        .then(json => setupWeekly(json.data));
    };

    loadSchema();
  </script>
</body>
</html>
