<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veckans schema</title>
  <style>
    body { 
      font-family: sans-serif; 
      max-width: 1200px;
      margin: 0 auto; 
      padding: 20px; 
      position: relative;
    }
    h1 { margin-bottom: 10px; }
    #clock { font-family: monospace; font-size: 18px; margin-bottom: 15px; }
    header img { 
      height: 60px; 
      position: absolute; 
      top: 20px; 
      right: 20px; 
    }

    .filter-container {
      margin-bottom: 15px;
    }

    .table-container { overflow-x: auto; max-height: 75vh; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f2f2f2; }
    td.aktivitet { font-weight: bold; }

    .ended { opacity: 0.6; }

    @media (max-width: 600px) {
      th:nth-child(1), td:nth-child(1) { display: none; } /* Dölj datum på små skärmar */
    }
  </style>
</head>
<body>
  <header>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <h1 id="schema-title">Veckans schema</h1>
  <div id="clock"></div>

  <div class="filter-container">
    <label for="coachFilter">Visa schema för: </label>
    <select id="coachFilter">
      <option value="alla">Alla</option>
    </select>
  </div>

  <div class="table-container">
    <table id="schema">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Start</th>
          <th>Slut</th>
          <th>Aktivitet</th>
          <th>Deltagare</th>
          <th>Coach</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const aktivitetFarger = {
  "Måndagsmöte":     {color:"#AED6F1", emoji:"📅"},
  "Gruppmöte":       {color:"#7FB3D5", emoji:"👥"},
  "Lunch":           {color:"#F9E79F", emoji:"🍲"},
  "Frukost":         {color:"#FAD7A0", emoji:"🥐"},
  "Ateljé":          {color:"#F5CBA7", emoji:"🎨"},
  "Musik":           {color:"#D2B4DE", emoji:"🎶"},
  "Pod":             {color:"#A9CCE3", emoji:"🎙️"},
  "Padel":           {color:"#82E0AA", emoji:"🏓"},
  "Lite av varje":   {color:"#FADBD8", emoji:"✨"},
  "Yoga":            {color:"#D5F5E3", emoji:"🧘"},
  "Gym":             {color:"#A3E4D7", emoji:"🏋️‍♂️"},
  "Lunchpromenad":   {color:"#F7DC6F", emoji:"🚶‍♂️🍲"},
  "Kulturpromenad":  {color:"#F8C471", emoji:"🏛️🚶"},
  "Film":            {color:"#E6B0AA", emoji:"🎬"},
  "Behandling":      {color:"#EDBB99", emoji:"💆"},
  "Handla":          {color:"#ABEBC6", emoji:"🛍️"},
  "Gåträning":       {color:"#76D7C4", emoji:"🚶"},
  "Uppstart":        {color:"#F0B27A", emoji:"🚀"},
  "Poesigruppen":    {color:"#F1948A", emoji:"✍️"},
  "Trummor":         {color:"#F1948A", emoji:"🥁"},
  "Rollspel":        {color:"#BB8FCE", emoji:"🐉"},
  "Återkoppling":    {color:"#85C1E9", emoji:"🔄"},
  "Handling":        {color:"#73C6B6", emoji:"🛒"},
  "Medicin":         {color:"#E59866", emoji:"💊"},
  "Föreningsgruppen":{color:"#D6DBDF", emoji:"🤝"},
  "Öppen verkstad":  {color:"#F5B7B1", emoji:"🔧"},
  "Biljard":         {color:"#A9DFBF", emoji:"🎱"},
  "Spelgruppen":     {color:"#F8C471", emoji:"🎲"},
  "Sömnad":          {color:"#F5EEF8", emoji:"🧵"},
  "Filmkunskap":     {color:"#E6B0AA", emoji:"🎬"},
  "Musikquizz":      {color:"#D2B4DE", emoji:"🎶"},
  "Musikdokumentär": {color:"#D2B4DE", emoji:"🎶"}
};

function getStockholmDate() {
  return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
}

let allaAktiviteter = [];

async function loadWeekSchema() {
  const baseUrl = "https://script.google.com/macros/s/AKfycbzx8buYbQ37FJnrb-DYNY3Ku_HNe-QRrLkxxgv978Xh1V6lpAtAA1UiHgybDdxtlT4m/exec";
  const today = getStockholmDate();
  const monday = new Date(today);
  monday.setDate(today.getDate() - ((today.getDay() + 6) % 7)); // måndag denna vecka

  let weekData = [];
  for (let i = 0; i < 5; i++) { // måndag–fredag
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    const dateStr = d.toISOString().split("T")[0];

    try {
      const res = await fetch(baseUrl + "?date=" + dateStr + "&t=" + Date.now());
      const json = await res.json();
      json.data.forEach(row => weekData.push({ date: json.date, row }));
    } catch (err) {
      console.warn("Kunde inte hämta dag:", dateStr, err);
    }
  }

  const now = getStockholmDate();
  const nowStr = now.toTimeString().slice(0,5);

  allaAktiviteter = weekData.map(item => {
    const [start, slut, aktivitet, deltagare, coachStr] = item.row;
    let status = "";
    if (slut <= nowStr) status = "❌";
    else if (start <= nowStr && slut >= nowStr && item.date === now.toISOString().split("T")[0]) status = "🟢";

    const coachLista = coachStr
      ? coachStr.split(/,|&| och /i).map(c => c.trim()).filter(Boolean)
      : [];

    return { 
      datum: new Date(item.date).toLocaleDateString("sv-SE", { weekday:"short", day:"numeric", month:"numeric" }),
      start, slut, aktivitet, deltagare, coachStr, coachLista, status 
    };
  });

  const coacher = [...new Set(allaAktiviteter.flatMap(a => a.coachLista))].sort();
  const select = document.getElementById("coachFilter");
  select.innerHTML = '<option value="alla">Alla</option>' +
    coacher.map(c => `<option value="${c}">${c}</option>`).join("");

  renderSchema();
}

function renderSchema() {
  const tbody = document.querySelector("#schema tbody");
  const valdCoach = document.getElementById("coachFilter").value;
  tbody.innerHTML = "";

  let aktiviteter = allaAktiviteter;
  if (valdCoach !== "alla") {
    aktiviteter = aktiviteter.filter(a =>
      a.coachLista.includes(valdCoach) ||
      a.coachStr.toLowerCase().includes("alla")
    );
  }

  const finalList = aktiviteter.sort((a,b) =>
    a.datum.localeCompare(b.datum) || a.start.localeCompare(b.start)
  );

  finalList.forEach(act => {
    const fargEmoji = aktivitetFarger[act.aktivitet] || {color:"#fff", emoji:""};
    const aktivitetText = `${act.status} ${fargEmoji.emoji ? fargEmoji.emoji+" " : ""}${act.aktivitet}`;

    const tr = document.createElement("tr");
    tr.style.background = fargEmoji.color;
    if (act.status === "❌") tr.classList.add("ended");
    tr.innerHTML = `
      <td>${act.datum}</td>
      <td>${act.start}</td>
      <td>${act.slut}</td>
      <td class="aktivitet">${aktivitetText}</td>
      <td>${act.deltagare}</td>
      <td>${act.coachStr}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("coachFilter").addEventListener("change", renderSchema);

function updateClock() {
  const now = getStockholmDate();
  document.getElementById("clock").textContent =
    new Intl.DateTimeFormat("sv-SE", {
      weekday:"long", year:"numeric", month:"long", day:"numeric",
      hour:"2-digit", minute:"2-digit", second:"2-digit",
      timeZone:"Europe/Stockholm"
    }).format(now);
}

setInterval(updateClock, 1000);
updateClock();
loadWeekSchema();
setInterval(loadWeekSchema, 60*60*1000); // uppdatera varje timme
</script>
</body>
</html>

