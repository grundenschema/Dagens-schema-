<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Schema â€“ Deltagare & Coacher</title>
<style>
/* =============================
   ğŸŒ™ MÃ–RK DASHBOARD-STIL
   ============================= */
:root {
  --bg-main: #1e1f25;
  --bg-panel: #2a2c33;
  --bg-card: #32343b;
  --text-main: #e9e9eb;
  --text-muted: #9a9a9a;
  --accent: #3a7afe;
  --border: #3b3d45;
  --radius: 14px;
  --shadow: 0 4px 10px rgba(0,0,0,.25);
  --hover: #3a3c44;
}

/* ===== GLOBAL ===== */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg-main);
  color:var(--text-main);
  margin:0 auto;
  max-width:1800px;
  padding:16px;
}
h1,h2,h3,h4{font-weight:600}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
small{color:var(--text-muted)}

/* ===== HEADER ===== */
header{
  text-align:center;
  margin-bottom:16px;
}
h1{
  font-size:1.6rem;
  letter-spacing:.3px;
}

/* ===== TOOLBAR ===== */
.toolbar{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:10px;
  padding:16px;
  background:var(--bg-panel);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
button,select{
  font-size:1rem;
  padding:10px 16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  transition:all .18s ease;
  color:var(--text-main);
  background:var(--bg-card);
  box-shadow:inset 0 0 0 1px var(--border);
}
button:hover,select:hover{
  background:var(--hover);
  transform:translateY(-1px);
  box-shadow:0 3px 8px rgba(0,0,0,.4);
}
button:active{transform:translateY(0);box-shadow:inset 0 0 0 1px var(--border);}
select{min-width:220px}
button span.icon{margin-right:6px}

/* ===== VIEW TITLE ===== */
#viewTitle{
  text-align:center;
  margin:12px 0;
  color:var(--text-muted);
  font-weight:500;
}

/* ===== CARDS ===== */
.cards{
  display:flex;
  flex-direction:column;
  gap:12px;
  max-width:900px;
  margin:0 auto;
}
.card{
  position:relative;
  background:var(--bg-card);
  border-radius:var(--radius);
  padding:12px 16px;
  box-shadow:var(--shadow);
}
.card::before{
  content:"";
  position:absolute;
  left:0;top:0;bottom:0;
  width:6px;
  background:var(--accent);
  border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 4px;font-size:1.05rem}
.card .row{font-size:.9rem;color:var(--text-muted)}

/* ===== WEEK VIEW ===== */
.week-view{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:18px;
  margin:0 auto;
  padding:10px;
}
.day-col{
  flex:1 1 260px;
  min-width:240px;
  max-width:300px;
  background:var(--bg-panel);
  border-radius:var(--radius);
  padding:12px 14px;
  box-shadow:var(--shadow);
}
.day-col h4{
  text-align:center;
  margin-bottom:10px;
  font-size:1rem;
  color:var(--text-main);
  border-bottom:1px solid var(--border);
  padding-bottom:6px;
}

/* ===== ACTIVITY BLOCKS ===== */
.block{
  background:var(--bg-card);
  color:var(--text-main);
  border-radius:10px;
  padding:8px 10px;
  margin-bottom:10px;
  box-shadow:0 3px 8px rgba(0,0,0,.3);
  transition:background .2s ease,transform .15s ease;
}
.block:hover{
  background:var(--hover);
  transform:translateY(-1px);
}
.block .title{
  font-weight:600;
  color:#fff;
  font-size:.9rem;
}
.block .meta{
  font-size:.8rem;
  color:var(--text-muted);
  margin-top:3px;
}

/* ===== PANELS ===== */
.helper-panels{max-width:1000px;margin:0 auto}
.panel{
  display:none;
  background:var(--bg-panel);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
.panel h2{color:var(--text-main);margin-bottom:12px;}
.list-two-col{
  display:flex;
  gap:30px;
  justify-content:center;
  flex-wrap:wrap;
}
.list-two-col>div{min-width:240px}

/* ===== RESPONSIVE ===== */
@media(max-width:760px){
  body{padding:8px}
  .toolbar{flex-direction:column;align-items:stretch}
  button,select{width:100%;font-size:1.05rem}
  .week-view{flex-direction:column;align-items:center}
}

/* ===== PRINT ===== */
@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,.helper-panels,#schemaContainer{display:none!important;}
  .week-view{
    display:block!important;
    color:#000;
    background:#fff;
  }
  .day-col{
    background:#fff;
    box-shadow:none;
    border:1px solid #ccc;
    margin-bottom:8px;
  }
  .block{
    background:#f9f9f9;
    color:#000;
    box-shadow:none;
  }
  @page{size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <h1>Schema â€“ Deltagare & Coacher</h1>
  <small>Veckoschema med flervy, pÃ¥gÃ¥ende vy och ersÃ¤ttarplanering</small>
</header>

<div class="toolbar">
  <button id="btnParticipant"><span class="icon">ğŸ§â€â™‚ï¸</span>Deltagarschema</button>
  <button id="btnCoach"><span class="icon">ğŸ§‘â€ğŸ«</span>Coachschema</button>
  <select id="nameSelect"><option value="">-- VÃ¤lj deltagare --</option></select>
  <select id="coachSelect" style="display:none"><option value="">-- VÃ¤lj coach --</option></select>
  <button id="btnCards">ğŸ“… Dagens schema</button>
  <button id="btnBlocks">ğŸ“† Veckoschema</button>
  <button id="btnNow">â±ï¸ PÃ¥gÃ¥r just nu</button>
  <button id="btnCompare">ğŸ” JÃ¤mfÃ¶r scheman</button>
  <button id="btnSick">ğŸ©º Hitta ersÃ¤ttare</button>
  <button id="btnPrint" style="display:none">ğŸ–¨ï¸ Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>
<div id="nowContainer"></div>

<div class="helper-panels">
  <div id="comparePanel" class="panel">
    <h2>JÃ¤mfÃ¶r scheman</h2>
    <div class="list-two-col">
      <div><h3>Coacher</h3><div id="coachListCompare"></div></div>
      <div><h3>Deltagare</h3><div id="participantListCompare"></div></div>
    </div>
    <button id="btnShowCompare">Visa valda scheman</button>
  </div>

  <div id="sickPanel" class="panel">
    <h2>Hitta ersÃ¤ttare fÃ¶r sjuk coach</h2>
    <select id="sickCoachSelect"><option value="">-- VÃ¤lj sjuk coach --</option></select>
    <div id="sickResult" style="margin-top:14px;"></div>
  </div>
</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
  "MÃ¥ndagsmÃ¶te":"#AED6F1","GruppmÃ¶te":"#7FB3D5","Lunch":"#F9E79F","Frukost":"#FAD7A0",
  "AteljÃ©":"#F5CBA7","Musik":"#D2B4DE","Pod":"#A9CCE3","Padel":"#82E0AA",
  "Lite av varje":"#FADBD8","Yoga":"#D5F5E3","Gym":"#A3E4D7","Film":"#E6B0AA",
  "FÃ¶reningsgruppen":"#D6DBDF","Trummor":"#F1948A","Ã…terkoppling":"#85C1E9",
  "Medicin":"#E59866","Biljard":"#A9DFBF","Spelgruppen":"#F8C471","SÃ¶mnad":"#F5EEF8",
  "Filmgruppen":"#E6B0AA","Musikquizz":"#D2B4DE","MusikdokumentÃ¤r":"#D2B4DE",
  "Warhammer":"#C39BD3","Utflykt":"#A9CCE3","Uppstart Taket":"#AED6F1"
};
function colorFor(r){return aktivitetFarger[r.Aktivitet]||"#555";}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList();fillCoachList();fillCompareLists();
    document.getElementById("sickCoachSelect").innerHTML='<option value="">-- VÃ¤lj sjuk coach --</option>'+
      [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
      .filter(x=>x&&x.toLowerCase()!=="alla").sort().map(c=>`<option>${c}</option>`).join("");
  }catch(e){console.error(e);}
}
loadData();

/* ---------- LISTOR ---------- */
function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- VÃ¤lj deltagare --</option>';
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
      const o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);
    });
}
function fillCoachList(){
  const s=document.getElementById("coachSelect");
  s.innerHTML='<option value="">-- VÃ¤lj coach --</option>';
  [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
      const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
    });
}
function fillCompareLists(){
  const cList=document.getElementById("coachListCompare");
  const pList=document.getElementById("participantListCompare");
  cList.innerHTML="";pList.innerHTML="";
  [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
      cList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-coach" value="${c}"> ${c}</label><br>`);
    });
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
      pList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-delt" value="${n}"> ${n}</label><br>`);
    });
}

/* ---------- RESET-VIEW ---------- */
function resetView(){
  document.querySelectorAll("#schemaContainer,#nowContainer,#comparePanel,#sickPanel")
    .forEach(el=>{el.style.display="none";});
  document.getElementById("btnPrint").style.display="none";
}

/* ---------- HJÃ„LPFUNKTIONER ---------- */
function applyLunchRule(rows,name,isCoach){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const field=isCoach?"Coach":"Deltagare";
    const isAll=(r[field]||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&(x.Aktivitet||"").toLowerCase().includes("lunch")&&(x[field]||"").toLowerCase().includes(name.toLowerCase()));
      if(specific)return false;
    }
    return true;
  });
}
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
const weekdayNames=["SÃ¶ndag","MÃ¥ndag","Tisdag","Onsdag","Torsdag","Fredag","LÃ¶rdag"];

/* ---------- VISNINGAR ---------- */
function renderCards(name,isCoach){
  resetView();
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(
    DATA.filter(r=>{
      const str=(r[field]||"").toLowerCase();
      return str.includes(name.toLowerCase())||str==="alla";
    }),name,isCoach).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  let html=`<div class='cards'>`;
  if(!rows.length)html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--accent:${colorFor(r)}">
      <h3>${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">ğŸ•’ ${r.Start||""}â€“${r.Slut||""}</div>
      <div class="row">${isCoach?"ğŸ‘¥ Deltagare: "+(r.Deltagare||"-"):"ğŸ§‘â€ğŸ« Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("viewTitle").textContent=`Dagens schema â€“ ${name}`;
}
function renderBlocks(name,isCoach){
  resetView();
  const days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach);
  let html=`<div class='week-view'>`;
  days.forEach(d=>{
    const dayRows=rows.filter(r=>dayKey(r.Datum)===d)
      .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
    const dayName=weekdayNames[new Date(d).getDay()];
    html+=`<div class="day-col"><h4>${dayName}</h4>`;
    if(!dayRows.length){html+=`<p style="color:var(--text-muted)">Inga aktiviteter</p>`;}
    dayRows.forEach(r=>{
      html+=`<div class="block" style="background:${colorFor(r)}">
        <div class="title">${r.Aktivitet||""}</div>
        <div class="meta">ğŸ•’ ${r.Start||""}â€“${r.Slut||""}</div>
        <div class="meta">${isCoach?"ğŸ‘¥ "+(r.Deltagare||"-"):"ğŸ§‘â€ğŸ« "+(r.Coach||"-")}</div>
      </div>`;
    });
    html+=`</div>`;
  });
  html+=`</div>`;
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
  document.getElementById("viewTitle").textContent=`Veckoschema â€“ ${name}`;
}

/* ---------- PÃ…GÃ…R NU ---------- */
document.getElementById("btnNow").onclick=()=>{
  resetView();
  const now=new Date();
  const minsNow=now.getHours()*60+now.getMinutes();
  const today=todayKey();
  const active=DATA.filter(r=>{
    if(dayKey(r.Datum)!==today)return false;
    const[sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const[eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const s=sh*60+sm,e=eh*60+em;
    return minsNow>=s&&minsNow<=e;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const cont=document.getElementById("nowContainer");
  cont.innerHTML=`<h2 style="text-align:center">â±ï¸ PÃ¥gÃ¥r just nu</h2>`;
  if(!active.length)cont.innerHTML+=`<p style="text-align:center">Inga aktiviteter pÃ¥gÃ¥r just nu.</p>`;
  else cont.innerHTML+=`<div class="cards">`+
    active.map(r=>`<div class="card" style="--accent:${colorFor(r)}"><h3>${r.Aktivitet}</h3><div class="row">ğŸ•’ ${r.Start}â€“${r.Slut}</div><div class="row">ğŸ§‘â€ğŸ« ${r.Coach||"-"}</div><div class="row">ğŸ‘¥ ${r.Deltagare||"-"}</div></div>`).join("")+
    `</div>`;
  cont.style.display="block";
  document.getElementById("viewTitle").textContent="PÃ¥gÃ¥r just nu";
};

/* ---------- HITTA ERSÃ„TTARE ---------- */
document.getElementById("btnSick").onclick=()=>{
  resetView();
  document.getElementById("sickPanel").style.display="block";
  document.getElementById("viewTitle").textContent="Hitta ersÃ¤ttare";
};
function overlap(s1,e1,s2,e2){return !(e1<=s2||s1>=e2);}
document.getElementById("sickCoachSelect").onchange=()=>{
  const coach=document.getElementById("sickCoachSelect").value;
  if(!coach)return;
  const allDays=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const otherCoaches=[...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla"&&x!==coach);
  let html="";
  allDays.forEach(d=>{
    const dayRows=DATA.filter(r=>dayKey(r.Datum)===d&&(r.Coach||"").toLowerCase().includes(coach.toLowerCase()));
    if(!dayRows.length)return;
    const dayName=weekdayNames[new Date(d).getDay()];
    html+=`<h3 style="margin-top:16px">${dayName}</h3>`;
    dayRows.forEach(r=>{
      const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
      const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
      const s1=sh*60+sm,e1=eh*60+em;
      const free=otherCoaches.filter(c=>{
        return !DATA.some(o=>{
          if(dayKey(o.Datum)!==d)return false;
          if(!(o.Coach||"").toLowerCase().includes(c.toLowerCase()))return false;
          const[os,om]=(o.Start||"00:00").split(":").map(Number);
          const[oe,om2]=(o.Slut||"00:00").split(":").map(Number);
          const s2=os*60+om,e2=oe*60+om2;
          return overlap(s1,e1,s2,e2);
        });
      });
      html+=`<div class="block" style="background:${colorFor(r)}">
        <div class="title">${r.Aktivitet||""} (${r.Start}â€“${r.Slut})</div>
        <div class="meta">ğŸ‘¥ ${r.Deltagare||"-"}</div>
        <div class="meta">ğŸ’¡ Lediga vikarier: ${free.length?free.join(", "):"â€“ Inga lediga"}</div>
      </div>`;
    });
  });
  document.getElementById("sickResult").innerHTML=html||"<p>Inga pass hittades fÃ¶r den valda coachen.</p>";
};

/* ---------- JÃ„MFÃ–R SCHEMAN ---------- */
document.getElementById("btnCompare").onclick=()=>{
  resetView();
  document.getElementById("comparePanel").style.display="block";
  document.getElementById("viewTitle").textContent="JÃ¤mfÃ¶r scheman";
};
document.getElementById("btnShowCompare").onclick=()=>{
  const selectedNames=[...document.querySelectorAll(".chk-delt:checked"),...document.querySelectorAll(".chk-coach:checked")]
    .map(cb=>({name:cb.value,isCoach:cb.classList.contains("chk-coach")}));
  if(!selectedNames.length){alert("VÃ¤lj minst en person fÃ¶rst.");return;}
  resetView();
  const wrap=document.createElement("div");wrap.className="week-view";
  selectedNames.forEach(sel=>{
    const div=document.createElement("div");div.className="day-col";
    div.innerHTML=`<h4>${sel.isCoach?"Coach: ":"Deltagare: "}${sel.name}</h4>`;
    const field=sel.isCoach?"Coach":"Deltagare";
    const days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
    days.forEach(d=>{
      const rows=applyLunchRule(DATA.filter(r=>{
        const str=(r[field]||"").toLowerCase();
        return (str.includes(sel.name.toLowerCase())||str==="alla")&&dayKey(r.Datum)===d;
      }),sel.name,sel.isCoach);
      if(!rows.length)return;
      const dayName=weekdayNames[new Date(d).getDay()];
      div.innerHTML+=`<h5 style="color:var(--text-muted);margin-top:6px;">${dayName}</h5>`;
      rows.forEach(r=>{
        div.innerHTML+=`<div class="block" style="background:${colorFor(r)}">
          <div class="title">${r.Aktivitet}</div>
          <div class="meta">${r.Start||""}â€“${r.Slut||""}</div>
          <div class="meta">${sel.isCoach?"ğŸ‘¥ "+(r.Deltagare||"-"):"ğŸ§‘â€ğŸ« "+(r.Coach||"-")}</div>
        </div>`;
      });
    });
    wrap.appendChild(div);
  });
  document.getElementById("schemaContainer").innerHTML="";
  document.getElementById("schemaContainer").appendChild(wrap);
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
  document.getElementById("viewTitle").textContent="JÃ¤mfÃ¶r scheman";
};

/* ---------- KNAPPHANTERING ---------- */
document.getElementById("btnParticipant").onclick=()=>{
  resetView();
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
  resetView();
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
  const n=document.getElementById("nameSelect").style.display!=="none"?document.getElementById("nameSelect").value:document.getElementById("coachSelect").value;
  if(n)renderCards(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnBlocks").onclick=()=>{
  const n=document.getElementById("nameSelect").style.display!=="none"?document.getElementById("nameSelect").value:document.getElementById("coachSelect").value;
  if(n)renderBlocks(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnPrint").onclick=()=>{window.print();};
</script>
</body>
</html>
