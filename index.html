<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grunden DV ‚Äì Schema</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background:#fafafa; }
    header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    header img { height:60px; }
    #clock { font-family: monospace; font-size: .9rem; margin-bottom: 4px; }
    #updated { font-size: .8rem; color:#666; margin-bottom: 8px; }
    .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-bottom:12px; }
    button, select { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; font-size:14px; }
    button:hover { background:#eaeaea; }
    #coachSelect { display:none; }
    #sickPanel { display:none; border:1px solid #ddd; background:#fff; border-radius:10px; padding:10px; }
    #sickPanel h3 { margin:0 0 8px 0; font-size:1rem; }
    #sickList { display:flex; flex-wrap:wrap; gap:10px 16px; max-height:200px; overflow:auto; }
    #sickList label { display:flex; align-items:center; gap:6px; white-space:nowrap; }
    #sickMsg { font-size:.85rem; color:#666; margin-top:6px; }

    table { border-collapse: collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#f2f2f2; }
    .aktivitet { font-weight:bold; }
    .ended { opacity:.6; }

    .day-heading { background:#f0f6ff; color:#2c3e50; padding:8px 12px; border-radius:8px; font-size:1.05rem; font-weight:600; margin-top:18px; }

    .pill { display:inline-block; padding:2px 8px; border-radius:10px; font-size:.8rem; background:#eef2ff; color:#334; margin-left:8px; }
    .warn { color:#b36b00; }
    .ok { color:#1a7f37; }

    /* Kortvy p√• mobil */
    @media (max-width: 700px) {
      table, thead, tbody, th, td, tr { display:block; width:100%; }
      thead { display:none; }
      tr { background:#fff; margin:0 auto 12px auto; border:1px solid #ddd; border-radius:12px; padding:10px 12px; box-shadow:0 1px 3px rgba(0,0,0,.1); max-width:95%; }
      td { border:none; padding:6px 0; display:flex; justify-content:space-between; gap:10px; }
      td::before { content: attr(data-label); font-weight:bold; color:#333; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div id="clock"></div>
      <div id="updated">Senast uppdaterad: ‚Äì</div>
    </div>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <div class="toolbar">
    <button id="btnDaily">Gemensamt schema</button>
    <button id="btnCoach">Coachschema</button>
    <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
    <button id="btnSick">Sjukschema</button>
  </div>

  <!-- Enkel panel f√∂r sjukschema-val (utan krusiduller) -->
  <div id="sickPanel">
    <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
    <div id="sickList"></div>
    <div id="sickMsg"></div>
    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnShowSick">Visa sjukschema</button>
      <button id="btnClearSick" title="Rensa val">Rensa</button>
    </div>
  </div>

  <div id="schemaContainer">Laddar schema...</div>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

    const aktivitetFarger = {
      "M√•ndagsm√∂te": {color:"#AED6F1", emoji:"üìÖ"},
      "Gruppm√∂te": {color:"#7FB3D5", emoji:"üë•"},
      "Lunch": {color:"#F9E79F", emoji:"üç≤"},
      "Frukost": {color:"#FAD7A0", emoji:"ü•ê"},
      "Atelj√©": {color:"#F5CBA7", emoji:"üé®"},
      "Musik": {color:"#D2B4DE", emoji:"üé∂"},
      "Pod": {color:"#A9CCE3", emoji:"üéôÔ∏è"},
      "Padel": {color:"#82E0AA", emoji:"üèì"},
      "Lite av varje": {color:"#FADBD8", emoji:"‚ú®"},
      "Yoga": {color:"#D5F5E3", emoji:"üßò"},
      "Gym": {color:"#A3E4D7", emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
      "Film": {color:"#E6B0AA", emoji:"üé¨"},
      "F√∂reningsgruppen": {color:"#D6DBDF", emoji:"ü§ù"},
      "Trummor": {color:"#F1948A", emoji:"ü•Å"},
      "√Öterkoppling": {color:"#85C1E9", emoji:"üîÑ"},
      "Medicin": {color:"#E59866", emoji:"üíä"},
      "Biljard": {color:"#A9DFBF", emoji:"üé±"},
      "Spelgruppen": {color:"#F8C471", emoji:"üé≤"},
      "S√∂mnad": {color:"#F5EEF8", emoji:"üßµ"},
      "Filmgruppen": {color:"#E6B0AA", emoji:"üé¨"},
      "Musikquizz": {color:"#D2B4DE", emoji:"üé∂"},
      "Musikdokument√§r": {color:"#D2B4DE", emoji:"üé∂"}
    };

    function getSEDate() { return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" })); }
    function fmtSE(dt, opts) { return new Intl.DateTimeFormat("sv-SE", opts).format(dt); }

    function updateClock() {
      const now = getSEDate();
      const opts = { weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit", second:"2-digit" };
      document.getElementById("clock").textContent = fmtSE(now, opts);
    }
    setInterval(updateClock, 1000); updateClock();

    let DATA = []; // all rows from API

    async function loadData() {
      const res = await fetch(url + "?t=" + Date.now());
      const json = await res.json();
      DATA = json.data || [];
      document.getElementById("updated").textContent = "Senast uppdaterad: " + (json.updated || "‚Äì");
      setupCoachSelect(DATA);
      setupSickList(DATA);
      renderDaily(DATA);              // startl√§ge
      document.getElementById("coachSelect").style.display = "none";
      document.getElementById("sickPanel").style.display = "none";
    }

    // --------- Hj√§lpare ---------
    function dayKey(str) { return String(str).slice(0,10); } // yyyy-MM-dd
    function countCoaches(coachStr) {
      return (coachStr || "")
        .split(",")
        .map(c => c.trim())
        .filter(c => c && c.toLowerCase() !== "alla").length;
    }
    function parseCoaches(coachStr) {
      return (coachStr || "")
        .split(",")
        .map(c => c.trim())
        .filter(c => c && c.toLowerCase() !== "alla");
    }
    function overlap(aStart, aEnd, bStart, bEnd) {
      return !(aEnd <= bStart || aStart >= bEnd);
    }
    function getNextWeekMonFri() {
      const today = getSEDate();
      const day = today.getDay(); // 0=s√∂n,1=m√•n...
      const nextMon = new Date(today);
      nextMon.setDate(today.getDate() + ((8 - day) % 7));
      nextMon.setHours(0,0,0,0);
      const fri = new Date(nextMon);
      fri.setDate(nextMon.getDate() + 4);
      return { nextMon, fri };
    }

    function groupByDate(rows) {
      const grouped = {};
      rows.forEach(r => {
        const k = dayKey(r.Datum);
        if (!grouped[k]) grouped[k] = [];
        grouped[k].push(r);
      });
      return Object.keys(grouped).sort().reduce((acc,k)=> (acc[k]=grouped[k], acc), {});
    }

    function rowHTML(row, extraRightHTML="") {
      const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
      const cCount = countCoaches(row.Coach);
      const warn = cCount > 2 ? ` <span class="pill warn">‚ö†Ô∏è ${cCount} coacher</span>` : "";
      return `<tr style="background:${f.color}">
        <td data-label="Start">${row.Start||""}</td>
        <td data-label="Slut">${row.Slut||""}</td>
        <td data-label="Aktivitet" class="aktivitet">${f.emoji||""} ${row.Aktivitet||""}${warn}</td>
        <td data-label="Deltagare">${row.Deltagare||""}</td>
        <td data-label="Coach">${row.Coach||""}${extraRightHTML}</td>
      </tr>`;
    }

    // --------- Gemensamt schema (idag) ---------
    function renderDaily(data) {
      const today = dayKey(getSEDate().toISOString());
      const todays = data.filter(r => dayKey(r.Datum) === today).sort((a,b)=> (a.Start||"").localeCompare(b.Start||""));
      let html = `<table><thead>
        <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
      </thead><tbody>`;
      todays.forEach(r => { html += rowHTML(r); });
      if (!todays.length) html += `<tr><td colspan="5">Inga aktiviteter idag.</td></tr>`;
      html += "</tbody></table>";
      document.getElementById("schemaContainer").innerHTML = html;
    }

    // --------- Coachschema ---------
    function setupCoachSelect(data) {
      const select = document.getElementById("coachSelect");
      select.innerHTML = `<option value="">-- V√§lj coach --</option>`;
      const coaches = [...new Set(
        data.map(r => parseCoaches(r.Coach)).flat()
      )].sort();
      coaches.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        select.appendChild(opt);
      });
      select.onchange = () => {
        const v = select.value;
        if (!v) return;
        renderCoachWeek(DATA, v);
      };
    }

    function renderCoachWeek(data, coach) {
      const rows = data.filter(r => {
        const cs = parseCoaches(r.Coach);
        return cs.includes(coach) || (r.Coach||"").trim().toLowerCase()==="alla";
      }).sort((a,b)=> (dayKey(a.Datum)===dayKey(b.Datum) ? (a.Start||"").localeCompare(b.Start||"") : dayKey(a.Datum).localeCompare(dayKey(b.Datum))));

      const grouped = groupByDate(rows);
      let html = "";
      Object.keys(grouped).forEach(dateKey=>{
        const label = new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(dateKey));
        html += `<div class="day-heading">${label.charAt(0).toUpperCase()+label.slice(1)}</div>`;
        html += `<table><thead>
          <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
        </thead><tbody>`;
        grouped[dateKey].forEach(r => { html += rowHTML(r); });
        html += "</tbody></table>";
      });
      if (!rows.length) html = `<p>Inga aktiviteter hittades f√∂r ${coach}.</p>`;
      document.getElementById("schemaContainer").innerHTML = html;
    }

    // --------- Sjukschema (m√•n‚Äìfre kommande vecka) ---------
    function setupSickList(data) {
      const cont = document.getElementById("sickList");
      cont.innerHTML = "";
      const coaches = [...new Set(data.map(r => parseCoaches(r.Coach)).flat())].sort();
      coaches.forEach(c => {
        const id = "sick_" + c.replace(/\s+/g,"_");
        cont.insertAdjacentHTML("beforeend", `<label><input type="checkbox" value="${c}" id="${id}"> ${c}</label>`);
      });
    }

    function getSelectedSick() {
      return [...document.querySelectorAll("#sickList input[type=checkbox]:checked")].map(el => el.value);
    }

    function renderSickSchedule(data, sickCoaches) {
      const { nextMon, fri } = getNextWeekMonFri();
      const startKey = dayKey(nextMon.toISOString());
      const endKey = dayKey(fri.toISOString());

      // Ta bara m√•ndag‚Äìfredag kommande vecka
      const weekRows = data.filter(r => {
        const d = dayKey(r.Datum);
        return d >= startKey && d <= endKey;
      });

      // Pass som ber√∂r sjuka
      const sickRows = weekRows.filter(r => {
        const cs = parseCoaches(r.Coach);
        return sickCoaches.some(s => cs.includes(s));
      }).sort((a,b)=> (dayKey(a.Datum)===dayKey(b.Datum) ? (a.Start||"").localeCompare(b.Start||"") : dayKey(a.Datum).localeCompare(dayKey(b.Datum))));

      // Lediga ers√§ttare f√∂r varje pass
      const allCoaches = [...new Set(weekRows.map(r => parseCoaches(r.Coach)).flat())];
      let html = "";

      const grouped = groupByDate(sickRows);
      Object.keys(grouped).forEach(dateKey=>{
        const label = new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(dateKey));
        html += `<div class="day-heading">${label.charAt(0).toUpperCase()+label.slice(1)}</div>`;
        html += `<table><thead>
          <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
        </thead><tbody>`;

        grouped[dateKey].forEach(r=>{
          const cs = parseCoaches(r.Coach);
          const cCount = countCoaches(r.Coach);
          const warn = cCount > 2 ? ` <span class="pill warn">‚ö†Ô∏è ${cCount} coacher</span>` : "";

          // tider f√∂r √∂verlappningskoll
          const tStart = r.Start || "00:00";
          const tEnd   = r.Slut  || "23:59";

          // lediga = inte sjuk, och har inga √∂verlappande pass den dagen
          const available = allCoaches
            .filter(c => !sickCoaches.includes(c))
            .filter(c => {
              const cRows = weekRows.filter(x => parseCoaches(x.Coach).includes(c) && dayKey(x.Datum) === dateKey);
              return !cRows.some(x => overlap(x.Start||"00:00", x.Slut||"23:59", tStart, tEnd));
            });

          const f = aktivitetFarger[r.Aktivitet] || {color:"#fff", emoji:""};
          const sickHere = cs.filter(c => sickCoaches.includes(c));
          const others = cs.filter(c => !sickCoaches.includes(c));

          const ersHTML = available.length ? ` <span class="pill ok">Ers√§ttare: ${available.join(", ")}</span>` : ` <span class="pill">Inga ers√§ttare funna</span>`;
          const coachCol = [
            sickHere.length ? `Sjuk: ${sickHere.join(", ")}` : "",
            others.length ? `√ñvriga: ${others.join(", ")}` : ""
          ].filter(Boolean).join(" &nbsp;‚Ä¢&nbsp; ");

          html += `<tr style="background:${f.color}">
            <td data-label="Start">${r.Start||""}</td>
            <td data-label="Slut">${r.Slut||""}</td>
            <td data-label="Aktivitet" class="aktivitet">${f.emoji||""} ${r.Aktivitet||""}${warn}</td>
            <td data-label="Deltagare">${r.Deltagare||""}</td>
            <td data-label="Coach">${coachCol}${ersHTML}</td>
          </tr>`;
        });

        html += "</tbody></table>";
      });

      if (!sickRows.length) html = `<p>Inga pass f√∂r valda coacher under m√•n‚Äìfre kommande vecka.</p>`;
      document.getElementById("schemaContainer").innerHTML = html;
    }

    // --------- Handlers ---------
    document.getElementById("btnDaily").onclick = () => {
      document.getElementById("coachSelect").style.display = "none";
      document.getElementById("sickPanel").style.display = "none";
      renderDaily(DATA);
    };

    document.getElementById("btnCoach").onclick = () => {
      document.getElementById("sickPanel").style.display = "none";
      document.getElementById("coachSelect").style.display = "inline-block";
      const v = document.getElementById("coachSelect").value;
      if (v) renderCoachWeek(DATA, v);
      else document.getElementById("schemaContainer").innerHTML = `<p>V√§lj en coach i listan.</p>`;
    };

    document.getElementById("btnSick").onclick = () => {
      document.getElementById("coachSelect").style.display = "none";
      document.getElementById("sickPanel").style.display = "block";
      document.getElementById("schemaContainer").innerHTML = `<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;
    };

    document.getElementById("btnShowSick").onclick = () => {
      const sick = getSelectedSick();
      if (!sick.length) {
        document.getElementById("sickMsg").textContent = "V√§lj minst en coach.";
        return;
      }
      document.getElementById("sickMsg").textContent = "";
      renderSickSchedule(DATA, sick);
    };

    document.getElementById("btnClearSick").onclick = () => {
      document.querySelectorAll("#sickList input[type=checkbox]").forEach(cb => cb.checked = false);
      document.getElementById("sickMsg").textContent = "";
      document.getElementById("schemaContainer").innerHTML = `<p>V√§lj upp till 5 coacher och tryck ‚ÄúVisa sjukschema‚Äù.</p>`;
    };

    // Max 5 val
    document.addEventListener("change", (e)=>{
      if (e.target && e.target.closest("#sickList") && e.target.type === "checkbox") {
        const sel = getSelectedSick();
        if (sel.length > 5) {
          e.target.checked = false;
          document.getElementById("sickMsg").textContent = "Du kan v√§lja h√∂gst 5 coacher.";
        } else {
          document.getElementById("sickMsg").textContent = "";
        }
      }
    });

    // üöÄ Start
    loadData();
    // H√§mta nytt var 15:e minut (men inga val sparas)
    setInterval(loadData, 15*60*1000);
  </script>
</body>
</html>
