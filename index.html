<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Schema v5 ‚Äì Grunden DV</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#ffffff">

<style id="dynamicPageStyle">
@media print { /* @page removed (handled dynamically) */}
</style>

<style>
:root {
  --bg:#f0f4f8;
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 3px 10px rgba(0,0,0,.06);
  --radius:14px;
  --blue:#3b82f6;
  --muted:#555;
  --header-bg:#f5f7fa;
  --chip-bg:#f8fafc;
  --chip-border:#cfd8e3;
  --chip-active:#3b82f6;
  --chip-text:#1f2937;
}

/* Reset & bas */
* { box-sizing:border-box; margin:0; padding:0; }
body {
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1400px;
  margin:0 auto;
  padding:14px;
}

/* Header (loggan = hemknapp) */
header {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  margin-bottom:12px;
  cursor:pointer;
}
header img { height:60px; width:auto; }
#clock { font-weight:600; color:#333; font-size:1.05rem; letter-spacing:.3px; }

/* Tabbar ‚Äì mobil: 2x2, desktop: rad */
.tab-bar {
  display:grid;
  gap:10px;
  margin:8px 0 12px;
}
button.tab {
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  cursor:pointer;
  font-size:1.02rem;
  transition:.15s background,.15s color,.15s border-color;
  box-shadow:var(--shadow);
}
button.tab:hover { background:#eef3fb; }
button.tab.active { background:var(--blue); color:#fff; border-color:var(--blue); }
@media (max-width:700px){ .tab-bar{ grid-template-columns:1fr 1fr; } }
@media (min-width:701px){ .tab-bar{ grid-template-columns:repeat(4,1fr); } }

/* Selects & action-knappar under flikarna */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  align-items:center;
  margin-bottom:10px;
}
select, .btn {
  font-size:1rem;
  padding:10px 16px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
}
.btn:hover { background:#eef3fb; }
.btn.primary { background:#fff; border-color:#cfd8e3; }
.btn.primary.active, .btn.primary:active {
  background:var(--blue);
  color:#fff;
  border-color:var(--blue);
}

/* Cards (p√•g√•r/kommande och dagkort) */
.cards {
  display:flex;
  flex-direction:column;
  gap:10px;
  max-width:1100px;
  margin:0 auto;
}
.card {
  position:relative;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px 14px;
  box-shadow:var(--shadow);
}
.card::before {
  content:"";
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:6px;
  background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);
  border-bottom-left-radius:var(--radius);
}
.card h3 { margin:0 0 6px; font-size:1.05rem; }
.card .row { font-size:.95rem; color:#222; }

.section-title { text-align:center; margin:10px 0 8px; font-weight:800; font-size:1.15rem; }

/* Schema ‚Äì blocklayout */
#blockContainer { display:none; margin-top:8px; }
.block-header {
  display:grid;
  grid-template-columns:80px repeat(5,1fr);
  font-weight:800;
  font-size:.92rem;
  background:var(--header-bg);
  border-radius:10px 10px 0 0;
  text-transform:capitalize;
}
.block-header div { text-align:center; padding:8px 0; }
.block-grid { display:grid; grid-template-columns:80px repeat(5,1fr); background:transparent; }
.block-time { font-size:.86rem; padding:4px 6px; text-align:right; color:#2b2b2b; }
.block-cell { position:relative; min-height:34px; background:transparent; border:none; }

/* =========================
   Block & Assistent-stilar
========================= */
.block {
  position:absolute;
  left:2px;
  right:2px;
  top:2px;
  border-radius:10px;
  padding:6px 8px;
  line-height:1.25;
  font-size:.82rem;
  color:#111;
  box-shadow:var(--shadow);
  border:1px solid rgba(0,0,0,.15);
  word-break:break-word;
  overflow:visible;
  -webkit-print-color-adjust:exact;
  print-color-adjust:exact;
}
.block .title { font-weight:700; }

/* =========================
   J√§mf√∂relse (i assistenten)
========================= */
.compare-wrap {
  display:grid;
  gap:16px;
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
}
.compare-item {
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:8px;
  box-shadow:var(--shadow);
}
.compare-item h3 {
  margin:6px 0 10px;
  text-align:center;
  font-size:1.0rem;
}

/* =========================
   Paneler + chips (assistent)
========================= */
.panel {
  display:none;
  background:#fff;
  border:1px solid #cfd8e3;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:16px;
  margin:14px auto;
  max-width:1200px;
}
.panel h2 { margin:4px 0 10px; font-size:1.2rem; }
.chip-group { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.chip-title { font-weight:700; margin:10px 0 6px; }
.chip {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  background:#fff;
  border:1px solid var(--chip-border);
  color:var(--chip-text);
  border-radius:999px;
  padding:8px 14px;
  cursor:pointer;
  user-select:none;
  transition:background .15s, border-color .15s, color .15s;
  font-size:.95rem;
  font-weight:500;
}
.chip input { display:none; }
.chip.active {
  background:var(--chip-active);
  border-color:var(--chip-active);
  color:#fff;
}

/* =========================
   Visningsytor (en per flik)
========================= */
.view { display:none; }
.view.active { display:block; }
#viewTitle {
  text-align:center;
  margin:10px 0 8px;
  font-weight:800;
}

/* =========================
   Sm√• sk√§rmar ‚Äì st√∂rre klickytor
========================= */
@media (max-width:700px) {
  body { padding:10px; }
  select, .btn { width:100%; }
}

/* =========================
   Utskrift ‚Äì skriv bara ut aktivt schema
========================= */
@media print {
  /* D√∂lj navigering, knappar, flikar och header */
  header, .tab-bar, button.btn, .controls {
    display: none !important;
    visibility: hidden !important;
  }

  /* Visa bara aktiv vy */
  .view {
    display: none !important;
    visibility: hidden !important;
  }
  .view.active {
    display: block !important;
    visibility: visible !important;
  }

  /* Stil f√∂r utskriftsrubrik */
  .print-header {
    display: flex !important;
    flex-direction: column;
    align-items: center;
    text-align: center;
    border-bottom: 1px solid #ccc;
    padding-bottom: 8px;
    margin-bottom: 16px;
  }
  .print-header h2 {
    font-size: 18pt !important;
    font-weight: 800;
    margin: 4px 0;
  }
  .print-header .date {
    font-size: 10pt;
    color: #333;
  }

  /* Beh√•ll f√§rger och layout */
  body {
    background: #fff !important;
    color: #000 !important;
    font-size: 10pt;
    margin: 0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .block, .card, .compare-item {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* Undvik att element delas mellan sidor */
  .card, .compare-item {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* A4 liggande */
  /* @page removed (handled dynamically) */}

/* =========================
   J√§mf√∂relse (i assistenten)
========================= */
.compare-wrap{
  display:grid;
  gap:16px;
  /* Sk√§rm: visa tv√• i rad n√§r det finns plats */
  grid-template-columns: repeat(2, minmax(0, 1fr));
  align-items:start;
}
@media (max-width: 820px){
  .compare-wrap{ grid-template-columns: 1fr; }
}

.compare-item{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:8px;
  box-shadow:var(--shadow);
  /* G√∂r korten visuellt j√§mnstora p√• sk√§rm */
  min-height: 520px;
}

.compare-item h3{
  margin:6px 0 10px;
  text-align:center;
  font-size:1.0rem;
}

/* ===== Utskrift: A4 liggande, max 2 scheman per rad ===== */
@media print{
  .compare-wrap{
    grid-template-columns: 1fr 1fr !important;
    gap: 8mm !important;
  }
  /* varje j√§mf√∂relseschema = "halv A4" (tv√• per rad p√• A4 liggande) */
  .compare-item{
    padding: 6mm !important;
    min-height: auto !important;
    height: 190mm; /* 210mm - (2*10mm sidmarginal) */
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* tajta typografi lite f√∂r att f√• plats */
  .compare-item h3{ font-size: 11pt !important; margin: 0 0 6mm !important; }
  .block-header{ font-size: .86rem !important; }
  .block-time{ font-size: .78rem !important; }
  .block{ font-size: .78rem !important; padding: 5px 6px !important; }
}


/* ===== Coach 30-minuterspass: EN RAD, s√§kert ===== */
.block.coach-half {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.block.coach-half .act { font-weight: 800; }
.block.coach-half .time { opacity: .9; }


/* ===== Fet stil f√∂r aktivitet (alla vyer) ===== */
.act { font-weight: 800; }
.card h3 { font-weight: 800; }


/* ===== Deltagare 30-minuterspass: EN RAD, s√§kert ===== */
.block.part-half {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


/* ===== Utskriftsrubrik ===== */
#print-header {
  display: none;
}

@media print {
  #print-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0;
    font-size: 12px;
  }
  .print-title {
    font-weight: 800;
    font-size: 17px;
  }
  .print-meta {
    font-size: 11px;
    color: #333;
    display: flex;
    gap: 12px;
  }
}


@media print {
  h1, h2, .view-title, .schema-title, .coach-title {
    display: none !important;
  }
}


@media print {
  body { margin-top: 10mm; }
  #main, #content, .container { margin-top: 0 !important; padding-top: 0 !important; }
}


@media print {
  .coach-schema-title,
  .coach-header,
  .view-header,
  .schema-header,
  .topbar,
  .subtitle,
  .print-subtitle {
    display: none !important;
  }
}


@media print {
  .print-subtitle,
  .print-date,
  .subtitle,
  .subheader,
  .schema-subtitle,
  .print-meta {
    display: none !important;
  }
}


@media print {
  #print-header-single {
    font-weight: 800;
    font-size: 17px;
    margin-bottom: 4px;
  }
}


@media print {
  #viewTitle,
  .controls,
  .toggleRow,
  .top-controls,
  .tabs,
  .tabbar,
  .nav,
  .header,
  .subheader {
    display: none !important;
  }
}


@media print {
  #print-header-single {
    font-weight: 800;
    font-size: 26px;
    text-align: center;
    margin-bottom: 6mm; /* space between title and schema */
  }
}


@media print {
  hr, .divider, .top-line {
    display: none !important;
    border: none !important;
  }
}


.start-text,
.intro,
.help-text,
.info-text {
  display: none !important;
}


@media print {
  * {
    box-shadow: none !important;
  }
  body {
    border-top: none !important;
  }
  hr {
    display: none !important;
  }
  header, .header, .topbar, .app-header {
    border: none !important;
    display: none !important;
  }
}


@media print {
  body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    text-rendering: geometricPrecision;
  }
  * {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
}


#print-header-single{display:none;}

/* Print-only elements must not show on screen */
.print-only, #print-date, #print-person, #print-header, #print-meta { display:none !important; }
@media print {
  .print-only, #print-date, #print-person, #print-header, #print-meta { display:inline !important; }
}


/* ===== Print header visibility fix ===== */
#print-header-single { display: none; }
@media print {
  #print-header-single { display: block !important; }
}


/* ===== Print logo (endast utskrift) ===== */
#print-logo { display: none; }
@media print {
  #print-logo {
    display: block !important;
    position: fixed;
    top: 10mm;
    right: 10mm;
    z-index: 9999;
  }
  #print-logo img {
    height: 16mm;   /* justera vid behov */
    width: auto;
  }
  /* Ge rubriken lite luft s√• den inte krockar med loggan */
  #print-header-single { padding-right: 28mm; }
}


/* ===== Print logo (robust, endast utskrift) ===== */
#print-logo { display: none; }
@media print {
  #print-logo {
    display: block !important;
    position: fixed;
    top: 10mm;
    right: 10mm;
    z-index: 9999;
  }
  #print-logo img {
    height: 16mm;   /* justera vid behov */
    width: auto;
  }
  #print-header-single { padding-right: 28mm; }
}


@media print {
  /* Flytta Chromes √∂vre linje visuellt till under rubriken */
  #print-header-single {
    border-top: none !important;
    border-bottom: 2px solid #000;
    padding-bottom: 6mm;
    margin-bottom: 8mm;
  }
}

/* =========================
   Bildst√∂d (Deltagare)
========================= */
.picto-wrap { max-width: 1100px; margin: 0 auto; }
.picto-day {
  background:#fff;
  padding: 14mm 12mm;
  margin: 0 auto 12mm;
  border: 0;
}
.picto-day-title{
  text-align:center;
  font-weight: 900;
  font-size: 22pt;
  margin: 0 0 10mm 0;
}
.picto-item{
  display:grid;
  grid-template-columns: 120px 1fr 220px; /* Tid | Aktivitet | Coach */
  align-items:center;
  gap: 8mm;
  border: 4px solid #000;
  border-radius: 18px;
  padding: 10mm;
  margin: 0 0 8mm 0;
}
.picto-time{ text-align:center; font-weight: 900; }
.picto-time .clock{ font-size: 44px; line-height:1; margin-bottom: 2mm; }
.picto-time .t{ font-size: 28px; line-height:1.05; }

.picto-act{ text-align:center; }
.picto-act .e{ font-size: 64px; line-height:1; margin-bottom: 3mm; }
.picto-act .a{ font-size: 28px; font-weight: 900; line-height:1.1; }

.picto-coach{ text-align:center; }
.picto-coach .lbl{ font-size: 18px; font-weight: 800; margin-bottom: 2mm; letter-spacing:.2px; }
.picto-coach .names{ font-size: 26px; font-weight: 900; line-height:1.08; word-break: break-word; }

/* Print: om bildst√∂d √§r aktivt, k√∂r st√•ende A4 */
@media print{
  /* pictos-print @page removed (handled dynamically) */
/* Endast bildst√∂d ska p√•verka sidbrytningar */
  body.pictos-print #participantPictos .picto-day{
    break-after: page;
    page-break-after: always;
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* Undvik att wrapper eller andra block skapar extra sidor */
  body.pictos-print #participantPictos .picto-wrap{
    break-inside: auto;
    page-break-inside: auto;
  }
}


  body.pictos-print #participantPictos .picto-item{
    grid-template-columns: 95px 1fr 170px !important;
    gap: 6mm !important;
    padding: 7mm !important;
    margin: 0 0 6mm 0 !important;
    border-width: 3px !important;
  }
  body.pictos-print #participantPictos .picto-time .clock{ font-size: 34px !important; }
  body.pictos-print #participantPictos .picto-time .t{ font-size: 26px !important; }
  body.pictos-print #participantPictos .picto-act .e{ font-size: 48px !important; }
  body.pictos-print #participantPictos .picto-act .a{ font-size: 26px !important; }
  body.pictos-print #participantPictos .picto-coach .lbl{ font-size: 15px !important; }
  body.pictos-print #participantPictos .picto-coach .names{ font-size: 20px !important; }
}


@media print {
  /* Bildst√∂d: h√•rd komprimering f√∂r att f√• plats med upp till 8 aktiviteter */
  body.pictos-print #participantPictos .picto-day-title{
    font-size: 18pt !important;
    margin: 0 0 6mm 0 !important;
  }
  body.pictos-print #participantPictos .picto-day{
    padding: 7mm 6mm !important;
    margin: 0 !important;
  }
  body.pictos-print #participantPictos .picto-item{
    grid-template-columns: 85px 1fr 150px !important;
    gap: 4.5mm !important;
    padding: 5.5mm !important;
    margin: 0 0 4.5mm 0 !important;
    border-width: 2.5px !important;
    border-radius: 14px !important;
  }
  body.pictos-print #participantPictos .picto-time .clock{ font-size: 28px !important; margin-bottom: 1.5mm !important; }
  body.pictos-print #participantPictos .picto-time .t{ font-size: 18px !important; }
  body.pictos-print #participantPictos .picto-act .e{ font-size: 40px !important; margin-bottom: 1.5mm !important; }
  body.pictos-print #participantPictos .picto-act .a{ font-size: 18px !important; }
  body.pictos-print #participantPictos .picto-coach .lbl{ font-size: 12px !important; margin-bottom: 1mm !important; }
  body.pictos-print #participantPictos .picto-coach .names{ font-size: 17px !important; line-height: 1.05 !important; }
}


@media print {
  /* Bildst√∂d: skala ner hela ytan s√• upp till 8 rutor f√•r plats */
  body.pictos-print #print-logo { display: none !important; }
  body.pictos-print #print-header-single { margin-bottom: 3mm !important; font-size: 18px !important; }

  

  /* Sidbrytning: en dag per sida, men INGEN tom sista/extra sida */
  body.pictos-print #participantPictos .picto-day{
    break-after: page;
    page-break-after: always;
  }
  body.pictos-print #participantPictos .picto-day:last-child{
    break-after: auto !important;
    page-break-after: auto !important;
  }

  /* Extra s√§kerhet: inga of√∂rklarliga blank-sidor f√∂re f√∂rsta */
  body.pictos-print #participantPictos,
  body.pictos-print #participantPictos .picto-wrap,
  body.pictos-print #participantPictos .picto-day{
    break-before: auto !important;
    page-break-before: auto !important;
  }
}


@media print {
  body.pictos-print #print-header-single {
    display: none !important;
  }
}


@media print {
  body.pictos-print #participantPictos .picto-day-title{
    font-size: 16pt !important;
    margin: 0 0 3.5mm 0 !important;
  }
  body.pictos-print #participantPictos .picto-day{
    padding: 5.8mm 4.5mm !important;
    margin: 0 !important;
  }
  body.pictos-print #participantPictos .picto-item{
    grid-template-columns: 86px 1fr 145px !important;
    gap: 4.6mm !important;
    padding: 5.8mm !important;
    margin: 0 0 3.8mm 0 !important;
    border-width: 2px !important;
    border-radius: 12px !important;
  }
  body.pictos-print #participantPictos .picto-time .clock{ font-size: 26px !important; margin-bottom: 1mm !important; }
  body.pictos-print #participantPictos .picto-time .t{ font-size: 17px !important; }
  body.pictos-print #participantPictos .picto-act .e{ font-size: 40px !important; margin-bottom: 1mm !important; }
  body.pictos-print #participantPictos .picto-act .a{ font-size: 17px !important; }
  body.pictos-print #participantPictos .picto-coach .lbl{ font-size: 10px !important; margin-bottom: .5mm !important; }
  body.pictos-print #participantPictos .picto-coach .names{ font-size: 15px !important; }
}


body.pictos-print #participantPictos .picto-day{
    height: 277mm; /* A4 297mm - ca 20mm marginaler */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    break-after: page;
  }

  body.pictos-print #participantPictos .picto-item{
    flex: 0 0 auto;
    height: 30mm;          /* 8 x 30mm = 240mm */
    margin-bottom: 3mm;   /* 8 x 3mm = 24mm */
    padding: 6mm !important;
    box-sizing: border-box;
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }

  body.pictos-print #participantPictos .picto-item:last-child{
    margin-bottom: 0 !important;
  }

  /* Text f√•r ALDRIG bryta rad */
  body.pictos-print #participantPictos .picto-act .a,
  body.pictos-print #participantPictos .picto-coach .names{
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
}


@media print {
  /* === Bildst√∂d: exakt 8 rutor per sida, j√§mn luft === */
  body.pictos-print{
    --pageH: 277mm;      /* 297mm - ca 20mm marginaler */
    --padTop: 5mm;
    --padBot: 5mm;
    --titleH: 12mm;      /* reserverad h√∂jd f√∂r rubrik */
    --gap: 3mm;          /* mellan rutor */
    --itemH: calc((var(--pageH) - var(--padTop) - var(--padBot) - var(--titleH) - (7 * var(--gap))) / 8);
  }

  body.pictos-print #participantPictos{
    transform: none !important;
    width: 100% !important;
  }

  body.pictos-print #participantPictos .picto-day{
    height: var(--pageH);
    box-sizing: border-box;
    padding: var(--padTop) 0 var(--padBot) 0 !important;
    display: flex;
    flex-direction: column;
    break-after: page;
    page-break-after: always;
  }
  body.pictos-print #participantPictos .picto-day:last-child{
    break-after: auto !important;
    page-break-after: auto !important;
  }

  body.pictos-print #participantPictos .picto-day-title{
    height: var(--titleH);
    line-height: var(--titleH);
    margin: 0 !important;
    padding: 0 0 2mm 0 !important;
    font-size: 16pt !important;
    text-align: center;
    flex: 0 0 auto;
  }

  body.pictos-print #participantPictos .picto-item{
    flex: 0 0 auto;
    height: var(--itemH);
    margin: 0 0 var(--gap) 0 !important;
    padding: 5.5mm !important;
    box-sizing: border-box;
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }
  body.pictos-print #participantPictos .picto-item:last-child{
    margin-bottom: 0 !important;
  }

  /* Text f√•r ALDRIG bryta rad */
  body.pictos-print #participantPictos .picto-act .a,
  body.pictos-print #participantPictos .picto-coach .names{
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }

  /* L√•s line-height s√• emoji/font inte √§ndrar totalh√∂jd */
  body.pictos-print #participantPictos .picto-time,
  body.pictos-print #participantPictos .picto-act,
  body.pictos-print #participantPictos .picto-coach{
    line-height: 1.05 !important;
  }
}


@media print {
  /* Bildst√∂d: ingen topp-rubrik som skjuter ner f√∂rsta sidan */
  body.pictos-print #print-header-single { display: none !important; height: 0 !important; margin: 0 !important; padding: 0 !important; }
  body.pictos-print .print-header { display: none !important; height: 0 !important; margin: 0 !important; padding: 0 !important; }
  body.pictos-print #print-logo { display: none !important; }

  /* Nollst√§ll ev. toppmarginaler p√• containern */
  body.pictos-print #participantPictos { margin-top: 0 !important; padding-top: 0 !important; }
}


}


@media print {
  /* ===== F√∂rsta sidan: ingen extra toppmarginal ===== */
  body.pictos-print {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
  /* Om n√•gon global regel s√§tter body margin-top, neutralisera */
  html, body {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
  /* Nollst√§ll ev. fixed-top som kan reservera h√∂jd */
  body.pictos-print #print-logo,
  body.pictos-print #print-header,
  body.pictos-print #print-meta,
  body.pictos-print #print-date,
  body.pictos-print #print-person {
    display: none !important;
    height: 0 !important;
  }
}


/* =========================
   Mobiloptimering
========================= */
@media (max-width: 720px){
  body{ padding: 10px !important; }
  .view{ padding: 10px !important; }

  #viewTitle{
    font-size: 20px !important;
    margin: 8px 0 10px 0 !important;
  }

  .controls{
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
  }
  .controls select,
  .controls .btn{
    width: 100% !important;
    flex: 1 1 100% !important;
  }

  /* Touchv√§nliga knappar */
  .btn{
    min-height: 44px !important;
    font-size: 16px !important;
    padding: 12px 12px !important;
  }
  select{
    min-height: 44px !important;
    font-size: 16px !important;
    padding: 10px 12px !important;
  }

  /* Kort-vy: b√§ttre l√§sbarhet */
  .card{
    border-radius: 14px !important;
  }
  .card .title{
    font-size: 18px !important;
  }
  .card .meta{
    font-size: 14px !important;
  }

  /* Bildst√∂d p√• sk√§rm: stapla kolumner p√• mobil */
  .picto-wrap{ max-width: 100% !important; }
  .picto-day{ padding: 14px !important; }
  .picto-item{
    grid-template-columns: 1fr !important;
    text-align: center !important;
    gap: 10px !important;
    padding: 14px !important;
  }
  .picto-time{ order: 1; }
  .picto-act{ order: 2; }
  .picto-coach{ order: 3; }
  .picto-time .clock{ font-size: 36px !important; }
  .picto-time .t{ font-size: 18px !important; }
  .picto-act .e{ font-size: 52px !important; }
  .picto-act .a{ font-size: 18px !important; }
  .picto-coach .names{ font-size: 18px !important; }

  }

/* Super-sm√• sk√§rmar */
@media (max-width: 380px){
  #viewTitle{ font-size: 18px !important; }
  .btn, select{ font-size: 15px !important; }
  .picto-act .e{ font-size: 46px !important; }
}


/* =========================
   Mobilfix (st√§dad vy)
========================= */
@media (max-width: 720px){
  /* Ta bort on√∂diga flikar i mobilen */
  #tabAssistant { display:none !important; }
  #assistantView { display:none !important; }

  /* Bildst√∂d-knappen beh√∂vs inte i mobilen */
  #btnParticipantPictos { display:none !important; }

  /* St√∂rre v√§ljare, s√§rskilt coach */
  #coachSelect, #nameSelect{
    font-size: 18px !important;
    padding: 14px 14px !important;
    min-height: 52px !important;
  }

  /* Veckoschema: visa hela veckan genom horisontell scroll */
  #participantWeek, #coachWeek{
    overflow-x:auto !important;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 10px;
  }
  #participantWeek .block-header,
  #participantWeek .block-grid,
  #coachWeek .block-header,
  #coachWeek .block-grid{
    min-width: 820px; /* s√• alla dagar f√•r plats */
  }

  /* G√∂r tidskolumnen lite st√∂rre s√• man ser */
  .block-header{ grid-template-columns: 90px repeat(5, 1fr) !important; }
  .block-grid{ grid-template-columns: 90px repeat(5, 1fr) !important; }
  .block-time{ font-size: 14px !important; }

  /* Mindre r√∂rigt: lite tajtare kort */
  .card h3{ font-size: 18px !important; }
  .card .row{ font-size: 15px !important; }
}




/* Diskret underrubrik */
.subhint{
  margin: 6px 0 10px 0;
  font-size: 15px;
  color: #333;
}






@media print {
  /* Centrera rubrik (namn + datum) vid utskrift av VECKOSCHEMAN (coach + deltagare) */
  body:not(.pictos-print) #print-header-single{
    text-align: center !important;
  }
  body:not(.pictos-print) #print-header-single *{
    text-align: center !important;
  }
}


@media print {
  /* D√∂lj vy-rubriker vid utskrift (ska inte f√∂lja med i print) */
  #participantView #viewTitle,
  #coachView #viewTitle{
    display: none !important;
  }
}


@media print {
  /* Centrera rubrik (namn + datum) p√• VECKOSCHEMA */
  body:not(.pictos-print) #print-header-single{
    display: flex !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center !important;
  }
}



/* =========================
   MOBIL: Dag-f√∂r-dag med swipe (kortvy)
   - Default: idag
   - Swipe: h√∂ger=fram√•t, v√§nster=bak√•t
   - Stopp med "motst√•nd" i kanterna
========================= */
#mobileParticipantDayView, #mobileCoachDayView { display:none; max-width:1100px; margin:0 auto; }
@media (max-width: 720px){
  #mobileParticipantDayView, #mobileCoachDayView { display:block !important; }
  /* Mobil = tittl√§ge: d√∂lj utskriftsknappar och veckovy-knappar */
  #btnParticipantWeek, #btnParticipantPictos, #btnPrintParticipant,
  #btnCoachWeek, #btnPrintCoach,
  #tabAssistant { display:none !important; }

  /* D√∂lj veckogrid p√• mobil */
  #participantWeek, #coachWeek, #compareOutput { display:none !important; }
}

.mobile-day-header{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:12px;
  margin: 8px 0 8px;
}
.mobile-day-title{
  font-weight: 900;
  font-size: 20px;
}
.mobile-day-sub{
  font-size: 13px;
  color: #444;
  white-space: nowrap;
}
.mobile-edge-hint{
  font-size: 12px;
  color: #666;
  text-align: center;
  margin: 6px 0 0;
  min-height: 16px;
}

/* swipe-yta: vi till√•ter vertikal scroll men f√•ngar horisontell */
.mobile-swipe-surface{
  touch-action: pan-y;
  user-select:none;
  will-change: transform;
  transition: transform 120ms ease-out;
}



/* =========================
   UI: D√∂lj "Skriv ut" (globalt)
========================= */
#btnPrintParticipant, #btnPrintCoach, #btnPrintNow, #btnPrintCompare { display:none !important; }



/* Mobil: ta bort "Dagens schema"-knappar (Idag √§r default + swipe) */
@media (max-width: 720px){
  #btnParticipantToday, #btnCoachToday { display:none !important; }
}

/* Mobil: P√•g√•r nu √∂ver Coach/Deltagare */
@media (max-width: 720px){
  .tab-bar{ display:flex; flex-direction:column; gap:8px; align-items:stretch; }
  #tabNow{ width:100%; order:1; }
  #tabCoach, #tabParticipant{ width:49%; }
  .tab-row-mobile{ display:flex; gap:8px; order:2; }
  /* flytta in coach/deltagare i en rad via wrapper */
  #tabAssistant{ display:none !important; }
}

</style>

<!-- =========================
     PRINTFIX (2026-01-05)
     M√•l: Veckoschema = 1 sida (A4 liggande), Bildst√∂d = 1 dag per sida (A4 st√•ende), max 8 rutor
     Detta ligger SIST och vinner med !important.
========================= -->
<style id="printfix">
/* Sk√§rml√§ge p√•verkas inte ‚Äì bara print */
@media print {

  /* Tydliga print-l√§gen */
  body.print-week #participantPictos,
  body.print-week #participantPictos * { display:none !important; visibility:hidden !important; }

  body.print-pictos #participantWeek,
  body.print-pictos #coachWeek,
  body.print-pictos #compareOutput,
  body.print-pictos #participantWeek *,
  body.print-pictos #coachWeek *,
  body.print-pictos #compareOutput * { display:none !important; visibility:hidden !important; }

  /* Nollst√§ll s√•dant som ofta skapar "extra sida" */
  html, body { margin:0 !important; padding:0 !important; }
  body { background:#fff !important; }

  /* ===== VECKOSCHEMA: pressa till exakt 1 sida ===== */
  body.print-week #participantWeek,
  body.print-week #coachWeek,
  body.print-week #compareOutput{
    /* blockera sidbrytning */
    break-inside: avoid !important;
    page-break-inside: avoid !important;
    overflow: hidden !important;

    /* skala ner lite (Firefox/Chrome) */
    transform: scale(0.92) !important;
    transform-origin: top left !important;
    width: 108.7% !important; /* 1/0.92 */
  }

  body.print-week .block-header{ font-size: .80rem !important; }
  body.print-week .block-time{ font-size: .72rem !important; }
  body.print-week .block{ font-size: .72rem !important; padding: 4px 5px !important; }
  body.print-week .compare-wrap{ gap: 6mm !important; }

  /* ===== BILDST√ñD: exakt 1 dag per sida, 8 rutor ===== */
  body.print-pictos #print-logo,
  body.print-pictos #print-header-single{ display:none !important; }

  body.print-pictos #participantPictos{ display:block !important; visibility:visible !important; margin:0 !important; padding:0 !important; }

  body.print-pictos #participantPictos .picto-wrap{ margin:0 !important; padding:0 !important; }

  body.print-pictos #participantPictos .picto-day{
    height: 277mm !important; /* A4 297mm - 20mm marginaler */
    box-sizing: border-box !important;

    /* GRID: rubrik + 8 lika h√∂ga rader */
    display: grid !important;
    grid-template-rows: 14mm repeat(8, 1fr) !important;

    padding: 0 !important;
    margin: 0 !important;
    border: 0 !important;

    break-after: page !important;
    page-break-after: always !important;
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }
  body.print-pictos #participantPictos .picto-day:last-child{
    break-after: auto !important;
    page-break-after: auto !important;
  }

  body.print-pictos #participantPictos .picto-day-title{
    height: 14mm !important;
    line-height: 14mm !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: 16pt !important;
    font-weight: 900 !important;
    text-align: center !important;
  }

  body.print-pictos #participantPictos .picto-item{
    margin: 0 !important;
    border-width: 2px !important;
    border-radius: 12px !important;

    display: grid !important;
    grid-template-columns: 85px 1fr 150px !important;
    align-items: center !important;
    gap: 4mm !important;
    padding: 4.5mm !important;

    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }

  /* Lite mindre typografi s√• 8 alltid f√•r plats */
  body.print-pictos #participantPictos .picto-time .clock{ font-size: 24px !important; }
  body.print-pictos #participantPictos .picto-time .t{ font-size: 16px !important; }
  body.print-pictos #participantPictos .picto-act .e{ font-size: 34px !important; }
  body.print-pictos #participantPictos .picto-act .a{ font-size: 16px !important; font-weight:900 !important; }
  body.print-pictos #participantPictos .picto-coach .lbl{ font-size: 11px !important; }
  body.print-pictos #participantPictos .picto-coach .names{ font-size: 14px !important; font-weight:900 !important; }

  /* Text f√•r inte v√§xa h√∂jden (ingen radbrytning) */
  body.print-pictos #participantPictos .picto-act .a,
  body.print-pictos #participantPictos .picto-coach .names{
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
}

/* Fallback @page om JS inte hinner (browser-bugg) */
@media print { @page { size: A4 landscape; margin: 10mm; } }
body.print-pictos{ }
body.print-week{ }
</style>



<style id="print-logo-override">
@media print{
  /* Flytta Grunden-loggan i veckoutskrift ovanf√∂r strecket och undvik att den ligger p√• linjen */
  #print-logo{
    top: -4mm !important;
    right: 10mm !important;
    z-index: 999999 !important;
    background: #fff !important;
    padding: 1mm 2mm !important;
    border-radius: 2mm !important;
  }
  #print-logo img{
    height: 14mm !important;
    width: auto !important;
    display:block !important;
  }
}
</style>


</head>

<body>

<div id="print-logo" aria-hidden="true">
  <img id="printLogoImg" alt="Grunden DV logotyp">
</div>

<div id="print-header-single"></div>
<header title="Klicka f√∂r start (P√•g√•r nu)">
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png"
       alt="Grunden DV logotyp" id="homeLogo">
  <div id="clock"></div>
  <div id="logoFallback" style="display:none;font-weight:900;font-size:18px;">Grunden DV</div>
</header>


<div id="dataStatus" style="max-width:1100px;margin:0 auto 10px;display:none;
  background:#fff3cd;border:1px solid #ffeeba;color:#856404;
  padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);">
  <div style="font-weight:800;margin-bottom:6px;">‚ö†Ô∏è Kunde inte ladda schema-data</div>
  <div style="font-size:14px;line-height:1.35;margin-bottom:8px;">
    Kontrollera n√§tet. Om du √∂ppnar filen som en lokal fil kan vissa mobiler blockera dataladdning.
  </div>
  <button id="btnRetryData" class="btn">üîÑ F√∂rs√∂k igen</button>
</div>


<!-- Flikar -->
<div class="tab-bar">
  <button id="tabNow" class="tab active">üîî P√•g√•r nu</button>
  <div class="tab-row-mobile">
    <button id="tabCoach" class="tab">üßë‚Äçüè´ Coach</button>
    <button id="tabParticipant" class="tab">üë§ Deltagare</button>
  </div>
  <button id="tabAssistant" class="tab">ü§ñ Assistent</button>
</div>


<!-- DELTAGARE-VY -->
<div id="participantView" class="view">
  <div id="viewTitle">üë§ Deltagarschema</div>

<div class="controls">
    <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
    <button id="btnParticipantToday" class="btn primary">‚òÄÔ∏è Dagens schema</button>
    <button id="btnParticipantWeek" class="btn primary">üìÜ Schema</button>
    <button id="btnParticipantPictos" class="btn primary">üñºÔ∏è Bildst√∂d (vecka)</button>
    <button id="btnPrintParticipant" class="btn">üñ®Ô∏è Skriv ut</button>
  </div>
<div id="participantDay" class="cards print-scope"></div>

  <!-- MOBIL (tittl√§ge): Dag-f√∂r-dag med swipe (kortvy) -->
  <div id="mobileParticipantDayView" class="print-scope">
    <div class="mobile-day-header">
      <div class="mobile-day-title" id="mPTitle">Idag</div>
      <div class="mobile-day-sub" id="mPSub"></div>
    </div>
    <div id="mPSwipe" class="mobile-swipe-surface">
      <div id="mPDayCards" class="cards"></div>
    </div>
    <div class="mobile-edge-hint" id="mPEdgeHint"></div>
  </div>

  <div id="participantWeek" class="print-scope" style="display:none;">
    <div class="block-header" id="pBlockHeader"></div>
    <div class="block-grid" id="pBlockGrid"></div>
  </div>

<div id="participantPictos" class="print-scope" style="display:none;"></div>

</div>

<!-- COACH-VY -->
<div id="coachView" class="view">
  <div id="viewTitle">üßë‚Äçüè´ Coachschema</div>
  <div class="controls">
    <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
    <button id="btnCoachToday" class="btn primary">‚òÄÔ∏è Dagens schema</button>
    <button id="btnCoachWeek" class="btn primary">üìÜ Schema</button>
    <button id="btnPrintCoach" class="btn">üñ®Ô∏è Skriv ut</button>
  </div>
<div id="coachDay" class="cards print-scope"></div>

  <!-- MOBIL (tittl√§ge): Dag-f√∂r-dag med swipe (kortvy) -->
  <div id="mobileCoachDayView" class="print-scope">
    <div class="mobile-day-header">
      <div class="mobile-day-title" id="mCTitle">Idag</div>
      <div class="mobile-day-sub" id="mCSub"></div>
    </div>
    <div id="mCSwipe" class="mobile-swipe-surface">
      <div id="mCDayCards" class="cards"></div>
    </div>
    <div class="mobile-edge-hint" id="mCEdgeHint"></div>
  </div>

  <div id="coachWeek" class="print-scope" style="display:none;">
    <div class="block-header" id="cBlockHeader"></div>
    <div class="block-grid" id="cBlockGrid"></div>
  </div>
</div>

<!-- P√ÖG√ÖR NU-VY -->
<div id="nowView" class="view active">
  <div id="viewTitle">üîî P√•g√•r just nu</div>
  <div id="nowContainer" class="print-scope"></div>
  <div style="text-align:center;margin-top:10px;">
    <button id="btnPrintNow" class="btn">üñ®Ô∏è Skriv ut</button>
  </div>
</div>

<!-- ASSISTENT-VY -->
<div id="assistantView" class="view">
  <div id="viewTitle">ü§ñ Schema-assistenten</div>

  <div id="comparePanel" class="panel">
    <h2>J√§mf√∂r scheman</h2>
    <div class="chip-title">Coacher</div>
    <div id="coachListCompare" class="chip-group"></div>
    <div class="chip-title">Deltagare</div>
    <div id="participantListCompare" class="chip-group"></div>
    <div style="text-align:center; margin-top:12px;">
      <button id="btnShowCompare" class="btn primary">Visa valda scheman</button>
      <button id="btnPrintCompare" class="btn">Skriv ut</button>
    </div>
  </div>

  <div id="compareOutput" class="print-scope" style="display:none;"></div>

  <div id="sickPanel" class="panel">
    <h2>ü©∫ Hitta ers√§ttare</h2>
    <div class="controls">
      <select id="sickCoachSelect"><option value="">-- V√§lj sjuk coach --</option></select>
      <label style="display:inline-flex;gap:8px;align-items:center;">
        <input type="checkbox" id="chkFullWeek" checked> Visa hela veckan
      </label>
    </div>
    <div id="sickResult"></div>
  </div>

  <div class="controls" style="justify-content:center;margin-top:8px;">
    <button id="btnOpenCompare" class="btn primary">√ñppna j√§mf√∂relse</button>
    <button id="btnOpenSick" class="btn primary">ü©∫ √ñppna ers√§ttare</button>
  </div>
</div>

<script>
/* =========================
   DATA & KONFIG
========================= */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

/* Emoji & f√§rg per aktivitet */
const aktivitetFarger = {
  "M√•ndagsm√∂te": { color: "#AED6F1", emoji: "üìÖ" },
  "Gruppm√∂te": { color: "#7FB3D5", emoji: "üë•" },

  "Lunch": { color: "#F9E79F", emoji: "üç≤" },
  "Lunch Mio": { color: "#F9A825", emoji: "üçΩÔ∏è" },
  "Lunch Anders B": { color: "#F9A825", emoji: "üçΩÔ∏è" },

  "Frukost": { color: "#FAD7A0", emoji: "ü•ê" },
  "Morgonrutiner": { color: "#FAD7A0", emoji: "‚òÄÔ∏è" },

  "Atelj√©": { color: "#F5CBA7", emoji: "üé®" },
  "Atelj√©n": { color: "#F5CBA7", emoji: "üé®" },

  "Musik": { color: "#C9C3D6", emoji: "üé∂" },
  "Musik veckom√∂te": { color: "#C9C3D6", emoji: "üé∂" },
  "Musikutbyte": { color: "#C9C3D6", emoji: "üé∂" },
  "Musikproduktion": { color: "#C9C3D6", emoji: "üé∂" },
  "Egen musikproduktion": { color: "#C9C3D6", emoji: "üé∂" },
  "Rep och jam": { color: "#C9C3D6", emoji: "üé∂" },
  "Musikquizz": { color: "#C9C3D6", emoji: "üé∂" },
  "Musikdokument√§r": { color: "#C9C3D6", emoji: "üé∂" },
  "Vocal": { color: "#C9C3D6", emoji: "üé§" },

  "Pod": { color: "#A9CCE3", emoji: "üéôÔ∏è" },
  "Pod sidbenor": { color: "#A9CCE3", emoji: "üéôÔ∏è" },

  "Padel": { color: "#82E0AA", emoji: "üèì" },

  "Lite av varje": { color: "#FADBD8", emoji: "‚ú®" },

  "Yoga": { color: "#D5F5E3", emoji: "üßò" },
  "Behandling": { color: "#D5F5E3", emoji: "üíÜ‚Äç‚ôÄÔ∏è" },
  "Behandlingar": { color: "#D5F5E3", emoji: "üíÜ‚Äç‚ôÄÔ∏è" },

  "Gym": { color: "#A3E4D7", emoji: "üèãÔ∏è‚Äç‚ôÇÔ∏è" },
  "Gym Slottskogens Gym": { color: "#A3E4D7", emoji: "üèãÔ∏è‚Äç‚ôÇÔ∏è" },

  "Film": { color: "#E6B0AA", emoji: "üé¨" },
  "Filmgruppen": { color: "#E6B0AA", emoji: "üé¨" },

  "F√∂reningsgruppen": { color: "#D6DBDF", emoji: "ü§ù" },
  "Autentiskt relaterande": { color: "#FCF3CF", emoji: "üí¨" },

  "Trummor": { color: "#F1948A", emoji: "ü•Å" },

  "√Öterkoppling": { color: "#D6DBDF", emoji: "üîÑ" },

  "Medicin": { color: "#E59866", emoji: "üíä" },

  "Biljard": { color: "#A9DFBF", emoji: "üé±" },

  "Spelgruppen": { color: "#F8C471", emoji: "üé≤" },

  "S√∂mnad": { color: "#F5EEF8", emoji: "üßµ" },

  "Warhammer": { color: "#C39BD3", emoji: "üõ°Ô∏è" },

  "Utflykt": { color: "#ABEBC6", emoji: "üöå" },
  "Promenad": { color: "#ABEBC6", emoji: "üö∂‚Äç‚ôÄÔ∏è" },
  "G√•tr√§ning": { color: "#ABEBC6", emoji: "üö∂‚Äç‚ôÇÔ∏è" },
  "G√•tr√§ning / byte till rullstol": { color: "#ABEBC6", emoji: "üö∂‚Äç‚ôÇÔ∏è" },
  "Toa, promenad": { color: "#ABEBC6", emoji: "üö∂‚Äç‚ôÄÔ∏è" },
  "Lunchpromenad": { color: "#ABEBC6", emoji: "üö∂‚Äç‚ôÄÔ∏èüç≤" },
  "Kulturpromenad": { color: "#ABEBC6", emoji: "üèõÔ∏è" },

  "Lokalv√•rd": { color: "#E5E7E8", emoji: "üßπ" },
  "√ñppen verkstad": { color: "#E5E7E8", emoji: "üß∞" },
  "Handla": { color: "#E5E7E8", emoji: "üõí" },
  "Handling": { color: "#E5E7E8", emoji: "üõí" },

  
  
  "Relax Massagestol": { color: "#FDEDEC", emoji: "üí∫" },

  "Transkribering": { color: "#E8DAEF", emoji: "‚å®Ô∏è" },
  "Transkibering": { color: "#E8DAEF", emoji: "‚å®Ô∏è" },
  "Manusarbete": { color: "#E8DAEF", emoji: "üìù" },
  "Mark- Manusarbete (John)": { color: "#E8DAEF", emoji: "üìù" },
  "Foto": { color: "#E8DAEF", emoji: "üì∏" },

  "Kommunikation": { color: "#D6EAF8", emoji: "üí¨" },

  "Poesigrupp": { color: "#FDEBD0", emoji: "‚úçÔ∏è" },
  "Poesigruppen": { color: "#FDEBD0", emoji: "‚úçÔ∏è" },

  "Samtal": { color: "#FCF3CF", emoji: "üí¨" },
  "Samtal onsdag eller torsdag": { color: "#FCF3CF", emoji: "üí¨" },

  "Avslappning": { color: "#D5F5E3", emoji: "ü™∑" },

  "Ladda stol": { color: "#FAD7A0", emoji: "üîã" },

  "G√•tr√§ning": { color: "#ABEBC6", emoji: "üö∂‚Äç‚ôÇÔ∏è" },
  "Uppstart": { color: "#D6DBDF", emoji: "üöÄ" },
  "Filmkunskap": { color: "#E6B0AA", emoji: "üé•" },
  "Pod Sidbenor": { color: "#A9CCE3", emoji: "üéôÔ∏è" },

  "Foto": { color: "#E8DAEF", emoji: "üì∏" },
  "Samtal": { color: "#FCF3CF", emoji: "üí¨" },


};

/* ===== FUNKTIONER ===== */

function colorFor(r) {
  return (aktivitetFarger[r.Aktivitet] || { color: "#edf2f7" }).color;
}

function emojiFor(r) {
  return (aktivitetFarger[r.Aktivitet] || { emoji: "" }).emoji;
}

function dayKey(str) {
  return String(str).slice(0, 10);
}

function todayKey(){
  const d=new Date(); d.setHours(0,0,0,0);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}



/* =========================
   MOBIL: Dag-f√∂r-dag (kortvy) + swipe
========================= */
function isMobile(){
  return window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
}

function mondayOfWeek(date){
  const d = new Date(date);
  const day = d.getDay(); // 0=Sun..6=Sat
  const diff = (day === 0 ? -6 : 1 - day); // back to Monday
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}

function weekDaysMonFri(baseDate){
  const mon = mondayOfWeek(baseDate);
  const days = [];
  for(let i=0;i<5;i++){
    const x = new Date(mon);
    x.setDate(mon.getDate() + i);
    days.push(x);
  }
  return days;
}

function keyFromDate(d){
  const x=new Date(d); x.setHours(0,0,0,0);
  const y=x.getFullYear();
  const m=String(x.getMonth()+1).padStart(2,"0");
  const day=String(x.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function prettyDay(d){
  const dt = new Date(d);
  const wd = ["s√∂ndag","m√•ndag","tisdag","onsdag","torsdag","fredag","l√∂rdag"][dt.getDay()];
  const date = new Intl.DateTimeFormat("sv-SE",{ day:"numeric", month:"short"}).format(dt);
  return { wd, date };
}

/* Kort-rendering med valt datum (√•teranv√§nd dina kort-stilar) */
function renderCardsGenericForDate(name,isCoach,targetEl,dateKeyStr){
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
  }).filter(r=>dayKey(r.Datum)===dateKeyStr).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  let html=`<div class='cards'>`;
  if(!rows.length) html+="<div class='card' style='--band:#cfd8e3'><div class='row'>Ledig</div></div>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  targetEl.innerHTML=html;
}

/* Swipe-engine med motst√•nd (stopp i kanterna) */
function attachDaySwipe(opts){
  const surface = opts.surface;
  const getIndex = opts.getIndex;
  const setIndex = opts.setIndex;
  const maxIndex = opts.maxIndex; // inclusive
  const onEdge = opts.onEdge || function(){};
  const onChange = opts.onChange || function(){};

  let startX=0, startY=0, dx=0, dy=0, dragging=false, horizontal=false;

  function rubberband(dist){
    // mjuk motst√•ndskurva
    const k = 0.35;
    return dist * k;
  }

  function reset(){
    surface.style.transition = "transform 120ms ease-out";
    surface.style.transform = "translateX(0px)";
    setTimeout(()=>{ surface.style.transition = "transform 120ms ease-out"; }, 0);
  }

  surface.addEventListener("touchstart",(e)=>{
    if(!e.touches || e.touches.length!==1) return;
    dragging=true; horizontal=false;
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    dx=0; dy=0;
    surface.style.transition = "none";
  },{passive:true});

  surface.addEventListener("touchmove",(e)=>{
    if(!dragging || !e.touches || e.touches.length!==1) return;
    dx=e.touches[0].clientX - startX;
    dy=e.touches[0].clientY - startY;

    if(!horizontal){
      if(Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)*1.2){
        horizontal=true;
      }else{
        return;
      }
    }

    const idx = getIndex();
    const atStart = idx<=0;
    const atEnd = idx>=maxIndex;

    let move = dx;

    // Motst√•nd i kanterna
    if((atStart && dx>0) || (atEnd && dx<0)){
      move = rubberband(dx);
      onEdge(atStart ? "start" : "end");
    }else{
      onEdge(null);
    }

    surface.style.transform = `translateX(${move}px)`;
    e.preventDefault();
  },{passive:false});

  surface.addEventListener("touchend",()=>{
    if(!dragging){ reset(); return; }
    dragging=false;

    const idx = getIndex();
    const atStart = idx<=0;
    const atEnd = idx>=maxIndex;

    const threshold = 60; // px

    // dx>0 = svep h√∂ger (tillbaka), dx<0 = svep v√§nster (fram√•t)
    if(horizontal && Math.abs(dx) > threshold){
      if(dx < 0 && !atEnd){
        setIndex(idx+1);
        onChange(getIndex());
      }else if(dx > 0 && !atStart){
        setIndex(idx-1);
        onChange(getIndex());
      }else{
        // stopp
        onEdge(atStart ? "start" : "end");
      }
    }
    reset();
  },{passive:true});
}

/* Init mobilvy f√∂r deltagare */
let mPDays = [];
let mPIndex = 0;

function initMobileParticipant(){
  if(!isMobile()) return;
  const name = document.getElementById("nameSelect")?.value;
  if(!name) return;

  mPDays = weekDaysMonFri(new Date());
  const today = todayKey();
  const todayIdx = mPDays.findIndex(d=>keyFromDate(d)===today);
  mPIndex = (todayIdx>=0)?todayIdx:0;

  const titleEl = document.getElementById("mPTitle");
  const subEl = document.getElementById("mPSub");
  const cardsEl = document.getElementById("mPDayCards");
  const edgeEl = document.getElementById("mPEdgeHint");
  const surface = document.getElementById("mPSwipe");

  function render(){
    const d = mPDays[mPIndex];
    const k = keyFromDate(d);
    const pretty = prettyDay(d);
    titleEl.textContent = (k===today) ? "Idag" : (pretty.wd.charAt(0).toUpperCase()+pretty.wd.slice(1));
    subEl.textContent = pretty.date;
    renderCardsGenericForDate(name,false,cardsEl,k);
  }

  render();

  attachDaySwipe({
    surface,
    getIndex: ()=>mPIndex,
    setIndex: (v)=>{ mPIndex=v; },
    maxIndex: mPDays.length-1,
    onEdge: (where)=>{
      edgeEl.textContent = where ? (where==="start" ? "F√∂rsta dagen i veckan" : "Sista dagen i veckan") : "";
    },
    onChange: ()=>render()
  });
}

/* Init mobilvy f√∂r coach */
let mCDays = [];
let mCIndex = 0;

function initMobileCoach(){
  if(!isMobile()) return;
  const name = document.getElementById("coachSelect")?.value;
  if(!name) return;

  mCDays = weekDaysMonFri(new Date());
  const today = todayKey();
  const todayIdx = mCDays.findIndex(d=>keyFromDate(d)===today);
  mCIndex = (todayIdx>=0)?todayIdx:0;

  const titleEl = document.getElementById("mCTitle");
  const subEl = document.getElementById("mCSub");
  const cardsEl = document.getElementById("mCDayCards");
  const edgeEl = document.getElementById("mCEdgeHint");
  const surface = document.getElementById("mCSwipe");

  function render(){
    const d = mCDays[mCIndex];
    const k = keyFromDate(d);
    const pretty = prettyDay(d);
    titleEl.textContent = (k===today) ? "Idag" : (pretty.wd.charAt(0).toUpperCase()+pretty.wd.slice(1));
    subEl.textContent = pretty.date;
    renderCardsGenericForDate(name,true,cardsEl,k);
  }

  render();

  attachDaySwipe({
    surface,
    getIndex: ()=>mCIndex,
    setIndex: (v)=>{ mCIndex=v; },
    maxIndex: mCDays.length-1,
    onEdge: (where)=>{
      edgeEl.textContent = where ? (where==="start" ? "F√∂rsta dagen i veckan" : "Sista dagen i veckan") : "";
    },
    onChange: ()=>render()
  });
}

/* Re-init n√§r man byter person/coach */
document.getElementById("nameSelect")?.addEventListener("change", ()=>{ 
  if(isMobile()) initMobileParticipant();
});
document.getElementById("coachSelect")?.addEventListener("change", ()=>{ 
  if(isMobile()) initMobileCoach();
});

/* Om sk√§rmstorlek √§ndras (t.ex. rotering) */
window.addEventListener("resize", ()=>{
  if(isMobile()){
    // init om det finns val
    initMobileParticipant();
    initMobileCoach();
  }
});

function weekdayName(d) {
  return ["s√∂ndag","m√•ndag","tisdag","onsdag","torsdag","fredag","l√∂rdag"][d];
}


/* DATA */
let DATA=[];

/* Ladda data + init */
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    const st=document.getElementById("dataStatus"); if(st) st.style.display="none";
    fillLists(); fillCompareLists(); fillSickList();
    renderNow(); // startvy
    // Mobil-init om val redan finns
    if(isMobile()) { initMobileParticipant(); initMobileCoach(); }
  }catch(e){ console.error("Kunde inte h√§mta data:", e);
    const st=document.getElementById("dataStatus"); if(st) st.style.display="block";
  }
}
loadData();

/* Klocka */
function updateClock(){
  const el=document.getElementById("clock");
  if(!el) return;
  const now=new Date();
  el.textContent=now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000); updateClock();


/* Logga-fallback (om bild inte kan laddas) */
const logoImg = document.getElementById("homeLogo");
if(logoImg){
  logoImg.addEventListener("error", ()=>{
    const fb=document.getElementById("logoFallback");
    if(fb) fb.style.display="block";
  });
}


/* =========================
   LISTOR / UTVAL
========================= */
function uniqueTokens(field){
  return [...new Set(DATA.map(r=>(r[field]||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla")
    .sort();
}
function sanitizeName(x){
  const bad=["alla","ingen coach","ingen","eget arbete",".","-","na","n/a","ok√§nt","unknown","(tom)",""];
  return x && !bad.includes(String(x).trim().toLowerCase());
}
function splitNames(str){
  return (str||"").split(/,|\/|;|\n/).map(s=>s.trim()).filter(sanitizeName);
}
function fillLists(){
  const n=document.getElementById("nameSelect");
  const c=document.getElementById("coachSelect");
  if(!n||!c) return;
  n.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  c.innerHTML='<option value="">-- V√§lj coach --</option>';
  uniqueTokens("Deltagare").forEach(v=>n.innerHTML+=`<option>${v}</option>`);
  uniqueTokens("Coach").forEach(v=>c.innerHTML+=`<option>${v}</option>`);
}
function fillCompareLists(){
  const cWrap=document.getElementById("coachListCompare");
  const pWrap=document.getElementById("participantListCompare");
  if(!cWrap||!pWrap) return;
  cWrap.innerHTML=""; pWrap.innerHTML="";
  uniqueTokens("Coach").forEach(c=>{
    const id="c_"+btoa(encodeURIComponent(c)).replace(/=/g,"");
    cWrap.insertAdjacentHTML("beforeend",`
      <label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-coach" value="${c}"><span>${c}</span></label>
    `);
  });
  uniqueTokens("Deltagare").forEach(n=>{
    const id="p_"+btoa(encodeURIComponent(n)).replace(/=/g,"");
    pWrap.insertAdjacentHTML("beforeend",`
      <label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-delt" value="${n}"><span>${n}</span></label>
    `);
  });
  document.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click",()=>{
      const inp=chip.querySelector("input");
      inp.checked=!inp.checked;
      chip.classList.toggle("active",inp.checked);
    });
  });
}
function fillSickList(){
  const s=document.getElementById("sickCoachSelect");
  if(!s) return;
  s.innerHTML='<option value="">-- V√§lj sjuk coach --</option>'+
    uniqueTokens("Coach").map(c=>`<option>${c}</option>`).join("");
}

/* =========================
   VY-HANTERING & TABS
========================= */
function showView(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  if(id==="participantView") document.getElementById("tabParticipant").classList.add("active");
  if(id==="coachView") document.getElementById("tabCoach").classList.add("active");
  if(id==="nowView") document.getElementById("tabNow").classList.add("active");
  if(id==="assistantView") document.getElementById("tabAssistant").classList.add("active");

  // ===== Alternativ 3: Nollst√§ll visningen vid vybyte, men beh√•ll val i listorna =====
  if(id==="participantView"){
    const day = document.getElementById("participantDay");
    const week = document.getElementById("participantWeek");
    const pictos = document.getElementById("participantPictos");

    if(week) week.style.display = "none";
    if(pictos){ pictos.style.display = "none"; pictos.innerHTML = ""; }

    if(day){
      day.style.display = "block";
      day.innerHTML = "";
    }
  }

  if(id==="coachView"){
    const day = document.getElementById("coachDay");
    const week = document.getElementById("coachWeek");

    if(week) week.style.display = "none";

    if(day){
      day.style.display = "block";
      day.innerHTML = "";
    }
  }

  // Mobil: init swipe-vyer om relevant
  if(id==="participantView") initMobileParticipant();
  if(id==="coachView") initMobileCoach();
}




document.getElementById("tabParticipant").onclick=()=>{ showView("participantView"); };
document.getElementById("tabCoach").onclick=()=>{ showView("coachView"); };
document.getElementById("tabNow").onclick=()=>{ showView("nowView"); renderNow(); };
document.getElementById("tabAssistant").onclick=()=>{ showView("assistantView"); };

/* Loggan = hem (p√•g√•r nu) */
document.getElementById("homeLogo").addEventListener("click",()=>{ showView("nowView"); renderNow(); });

/* =========================
   P√ÖG√ÖR NU + KOMMANDE
========================= */
function renderNow(){
  const cont = document.getElementById("nowContainer");
  const today=todayKey();
  const now=new Date();
  const minsNow=now.getHours()*60 + now.getMinutes();
  const all = DATA.filter(r=> dayKey(r.Datum)===today )
    .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  const ongo = all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const s=sh*60+sm, e=eh*60+em;
    return minsNow>=s && minsNow<=e;
  });
  const next = all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const s=sh*60+sm;
    return s>minsNow;
  });

  const label = new Intl.DateTimeFormat("sv-SE",{ weekday:"long", day:"numeric", month:"long"}).format(now);
  const time = now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});

  let html = `<div class="section-title">‚è±Ô∏è ${label} ‚Äì kl. ${time}</div>`;

  html += `<div class="section-title">üîî P√•g√•r nu</div>`;
  if(!ongo.length) html += `<div class="cards"><div class="card" style="--band:#cfd8e3"><div class="row" style="text-align:center">Inga aktiviteter p√•g√•r just nu.</div></div></div>`;
  else{
    html += `<div class="cards">` + ongo.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") + `</div>`;
  }

  html += `<div class="section-title">‚è≠Ô∏è Kommande idag</div>`;
  if(!next.length) html += `<div class="cards"><div class="card" style="--band:#cfd8e3"><div class="row" style="text-align:center">Inget mer planerat idag.</div></div></div>`;
  else{
    html += `<div class="cards">` + next.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") + `</div>`;
  }

  cont.innerHTML = html;
}

/* =========================
   DAGENS (KORT)
========================= */
function renderCardsGeneric(name,isCoach,targetEl){
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
  }).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  let html=`<div class='cards'>`;
  if(!rows.length) html+="<div class='card' style='--band:#cfd8e3'><div class='row'>Inga aktiviteter idag.</div></div>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  targetEl.innerHTML=html;
}

/* =========================
   VECKA (BLOCK, LIGGANDE)
========================= */
function makeSlots(){
  // Visuella tidsrader (30 min). Blockplacering ber√§knas i minuter och kan b√∂rja/sluta n√§r som helst.
  const start=8*60, end=15*60+30, step=30;
  const a=[];
  for(let m=start; m<=end; m+=step){
    const h=Math.floor(m/60), mi=m%60;
    a.push(String(h).padStart(2,"0")+":"+String(mi).padStart(2,"0"));
  }
  return a;
}
function timeToMin(t){
  const m=String(t||"").match(/^\s*(\d{1,2}):(\d{2})\s*$/);
  if(!m) return null;
  const h=+m[1], mi=+m[2];
  if(h<0||h>23||mi<0||mi>59) return null;
  return h*60+mi;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function slotIndexForMin(min, slotMins){
  if(min<=slotMins[0]) return 0;
  for(let i=0;i<slotMins.length-1;i++){
    if(min>=slotMins[i] && min<slotMins[i+1]) return i;
  }
  return slotMins.length-1;
}

function renderBlocksGeneric(name,isCoach,headerEl,gridEl){
  const slots=makeSlots();
  const days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
  });

  headerEl.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
  gridEl.innerHTML="";gridEl.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{gridEl.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...gridEl.children];

  rows.forEach(r=>{
    const d=new Date(r.Datum);
    let wd=d.getDay(); if(wd===0||wd===6) return;
    const col=(wd-1)+1;
    const slotMins = slots.map(timeToMin);
    const sMin = timeToMin(r.Start), eMin = timeToMin(r.Slut);
    if(sMin===null || eMin===null) return;
    const gridStart = slotMins[0];
    const gridEnd = slotMins[slotMins.length-1] + 30; // sista radens slut
    const sCl = clamp(sMin, gridStart, gridEnd);
    const eCl = clamp(eMin, gridStart, gridEnd);
    if(eCl<=sCl) return;
    const baseIdx = slotIndexForMin(sCl, slotMins);
    const firstCellIndex = baseIdx*(1+days.length) + col;
    const firstCell = cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block"; block.style.background=colorFor(r);

    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const duration=(eh*60+em)-(sh*60+sm);

// Coachens veckoschema (INTE j√§mf√∂relse):
// - 30 min: visa starttid + (1 deltagare => deltagare, annars aktivitet). Ingen sluttid.
// - >30 min: visa start‚Äìslut + aktivitet + deltagare (s√• m√•nga som f√•r plats).
const deltagareList = splitNames(r.Deltagare||"");
const deltagareCount = deltagareList.length;

if(duration>30){
  if(isCoach){
    const deltagarRad = (deltagareCount>0) ? deltagareList.join(", ") : "-";
    block.innerHTML=`<div class="title">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      ${emojiFor(r)} <span class="act">${r.Aktivitet||""}</span><br>
      üë• ${deltagarRad}`;
  }else{
    // deltagarvy of√∂r√§ndrad
    block.innerHTML=`<div class="title">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      ${emojiFor(r)} <span class="act">${r.Aktivitet||""}</span><br>
      üßë‚Äçüè´ ${(r.Coach||"-")}`;
  }
}else{
  if(isCoach){
    const label = (deltagareCount===1) ? deltagareList[0] : (r.Aktivitet||"");
    block.classList.add("coach-half");
    const act=(r.Aktivitet||"");
    const one=(deltagareCount===1)?(" ‚Ä¢ "+deltagareList[0]):"";
    block.innerHTML=`<span class="time">‚è±Ô∏è ${r.Start||""}</span> <span class="act">${act}</span>${one}`;
  }else{
    // deltagarvy of√∂r√§ndrad
    block.classList.add("part-half");
      block.innerHTML=`üïí ${r.Start||""} ${emojiFor(r)} <span class="act">${(r.Aktivitet||"")}</span> ‚Äì üßë‚Äçüè´ ${(r.Coach||"-")}`;
  }
}

    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;const topOff=((sCl-slotMins[baseIdx])/30)*cellH;const h=((eCl-sCl)/30)*cellH;block.style.top=(2+topOff)+"px";block.style.height=Math.max(10,h-4)+"px";block.style.zIndex=10;});
    firstCell.appendChild(block);
  });
}

/* =========================
   ASSISTENT ‚Äì J√§mf√∂r
========================= */
document.getElementById("btnOpenCompare").onclick=()=>{
  document.getElementById("comparePanel").style.display="block";
  document.getElementById("sickPanel").style.display="none";
  document.getElementById("compareOutput").style.display="none";
};
document.getElementById("btnOpenSick").onclick=()=>{
  document.getElementById("sickPanel").style.display="block";
  document.getElementById("comparePanel").style.display="none";
  document.getElementById("compareOutput").style.display="none";
};

document.getElementById("btnShowCompare").onclick = () => {
  const selected = [
    ...document.querySelectorAll(".chk-delt:checked"),
    ...document.querySelectorAll(".chk-coach:checked")
  ].map(cb => ({ name: cb.value, isCoach: cb.classList.contains("chk-coach") }));

  if (!selected.length) { alert("V√§lj minst ett namn."); return; }
  if (selected.length > 4) { alert("V√§lj h√∂gst 4 personer f√∂r j√§mf√∂relse."); return; }

  const out=document.getElementById("compareOutput");
  out.innerHTML = ""; // rensa
  const wrap = document.createElement("div");
  wrap.className = "compare-wrap";

  selected.forEach(sel => {
    const item = document.createElement("div");
    item.className = "compare-item";
    const header = document.createElement("h3");
    header.textContent = sel.name;
    item.appendChild(header);
    item.appendChild(renderSingleWeek(sel.name, sel.isCoach, true));
    wrap.appendChild(item);
  });

  out.appendChild(wrap);
  out.style.display="block";
  document.getElementById("comparePanel").style.display="none";
};

function renderSingleWeek(name,isCoach,compact=false){
  const slots=makeSlots(), days=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) || (r[field]||"").trim().toLowerCase()==="alla";
  });

  const container=document.createElement("div");
  container.innerHTML=`<div class="block-header"><div>Tid</div>${days.map(d=>`<div>${d}</div>`).join("")}</div>
  <div class="block-grid" style="grid-template-columns:80px repeat(${days.length},1fr)"></div>`;

  const grid=container.querySelector(".block-grid");
  const timeFont = compact ? ".78rem" : ".86rem";
  grid.previousElementSibling.querySelectorAll('div').forEach(d => d.style.fontSize = compact ? ".86rem" : ".92rem");
  slots.forEach(t=>{
    grid.innerHTML+=`<div class='block-time' style="font-size:${timeFont}">${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");
  });
  const cells=[...grid.children];

  rows.forEach(r=>{
    const wd=new Date(r.Datum).getDay(); if(wd===0||wd===6) return;
    const col=(wd-1)+1;
    const slotMins = slots.map(timeToMin);
    const sMin = timeToMin(r.Start), eMin = timeToMin(r.Slut);
    if(sMin===null || eMin===null) return;
    const gridStart = slotMins[0];
    const gridEnd = slotMins[slotMins.length-1] + 30;
    const sCl = clamp(sMin, gridStart, gridEnd);
    const eCl = clamp(eMin, gridStart, gridEnd);
    if(eCl<=sCl) return;
    const baseIdx = slotIndexForMin(sCl, slotMins);
    const firstCellIndex=baseIdx*(1+days.length)+col, firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block"; block.style.background=colorFor(r);
    block.style.fontSize = compact ? ".78rem" : ".82rem";
    block.style.padding = compact ? "5px 6px" : "6px 8px";

    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const duration=(eh*60+em)-(sh*60+sm);

    if(compact){
      const participants = splitNames(r.Deltagare||"");
      const coaches = splitNames(r.Coach||"");
      const pCnt = participants.length;
      const cCnt = coaches.length;

      // J√ÑMF√ñRELSEVY ‚Äì EN RAD, INGEN EXTRA INFO
      // Deltagarschema:
      //  - 1 deltagare + 1 coach  => visa ENBART coach
      //  - fler deltagare         => visa ENBART aktivitet
      // Coachschema:
      //  - 1 deltagare            => visa ENBART deltagare
      //  - fler deltagare         => visa ENBART aktivitet
      if(!isCoach){
        if(pCnt===1 && cCnt===1){
          block.innerHTML = `<div class="title" style="font-size:1.05em;font-weight:800;text-align:center">${coaches[0]}</div>`;
        }else if(pCnt>1){
          block.innerHTML = `<div class="title" style="font-size:1.05em;font-weight:800;text-align:center">${r.Aktivitet||""}</div>`;
        }else{
          // fallback
          block.innerHTML = `<div class="title" style="font-size:1.05em;font-weight:800;text-align:center">${r.Aktivitet||""}</div>`;
        }
      }else{
        if(pCnt===1){
          block.innerHTML = `<div class="title" style="font-size:1.05em;font-weight:800;text-align:center">${participants[0]}</div>`;
        }else if(pCnt>1){
          block.innerHTML = `<div class="title" style="font-size:1.05em;font-weight:800;text-align:center">${r.Aktivitet||""}</div>`;
        }else{
          block.innerHTML = `<div class="title" style="font-size:1.05em;font-weight:800;text-align:center">${r.Aktivitet||""}</div>`;
        }
      }
    }else{
      if(duration>30){
        block.innerHTML=`<div class="title">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
          ${emojiFor(r)} <span class="act">${r.Aktivitet||""}</span><br>
          ${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
      }else{
        block.innerHTML=`${emojiFor(r)} <span class="act">${r.Aktivitet||""}</span> ‚Äì ${isCoach ? "üë• "+(r.Deltagare||"-") : "üßë‚Äçüè´ "+(r.Coach||"-")}`;
      }
    }

    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||26;const topOff=((sCl-slotMins[baseIdx])/30)*cellH;const h=((eCl-sCl)/30)*cellH;block.style.top=(2+topOff)+"px";block.style.height=Math.max(10,h-4)+"px";block.style.zIndex=10;});
    firstCell.appendChild(block);
  });
  return container;
}

/* =========================
   ERS√ÑTTARE
========================= */
document.getElementById("sickCoachSelect").onchange = renderSick;
document.getElementById("chkFullWeek").onchange = renderSick;

function renderSick(){
  const coach = document.getElementById("sickCoachSelect").value;
  const fullWeek = document.getElementById("chkFullWeek").checked;
  if(!coach){ document.getElementById("sickResult").innerHTML=""; return; }

  const today = new Date();
  const monday = new Date(today);
  const day = monday.getDay();
  const diffToMonday = (day === 0 ? -6 : 1) - day;
  monday.setDate(today.getDate() + diffToMonday);
  const days = [...Array(5)].map((_,i)=>{ const d=new Date(monday); d.setDate(monday.getDate()+i); return d; });

  const passes = DATA.filter(r=>{
    const isSameDay = dayKey(r.Datum)===todayKey();
    const inWeek = days.some(d => dayKey(r.Datum)===d.toISOString().slice(0,10));
    const coachHit = (r.Coach||"").toLowerCase().includes(coach.toLowerCase());
    return coachHit && (fullWeek ? inWeek : isSameDay);
  }).sort((a,b)=> (a.Datum||"").localeCompare(b.Datum||"") || (a.Start||"").localeCompare(b.Start||""));

  const allCoaches = uniqueTokens("Coach");

  let html = "";
  if(!passes.length){
    html = `<p>Inga pass hittades f√∂r ${coach} ${fullWeek?"denna vecka":"idag"}.</p>`;
  } else {
    const byDay = {};
    passes.forEach(p=>{
      const k = dayKey(p.Datum);
      (byDay[k] ||= []).push(p);
    });

    html = `<div class="cards">`;
    Object.keys(byDay).sort().forEach(k=>{
      const dObj=new Date(k);
      html += `<div class="card" style="--band:#cfd8e3">
        <h3>üìÖ ${weekdayName(dObj.getDay())}</h3>
        <div class="row" style="color:#555">Coach: ${coach}</div>
      </div>`;

      byDay[k].forEach(p=>{
        const [psh,psm]=(p.Start||"00:00").split(":").map(Number);
        const [peh,pem]=(p.Slut||"00:00").split(":").map(Number);
        const ps=psh*60+psm, pe=peh*60+pem;

        const free = allCoaches.filter(c=>{
          if(!sanitizeName(c) || c===coach) return false;
          const overlaps = DATA.some(r=>{
            if(dayKey(r.Datum)!==k) return false;
            if(!(r.Coach||"").toLowerCase().includes(c.toLowerCase())) return false;
            const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
            const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
            const s=sh*60+sm, e=eh*60+em;
            return !(e<=ps || s>=pe);
          });
          return !overlaps;
        });

        const e=emojiFor(p), col=colorFor(p);
        html += `<div class="card" style="--band:${col}">
          <h3>${e} ${p.Aktivitet||""} (${p.Start}‚Äì${p.Slut})</h3>
          <div class="row">üßë‚Äçüè´ Sjuk coach: ${coach}</div>
          <div class="row">üë• Deltagare: ${p.Deltagare||"-"}</div>
          <div class="row">‚úÖ Lediga ers√§ttare: ${free.length? free.join(", ") : "Ingen tillg√§nglig"}</div>
        </div>`;
      });
    });
    html += `</div>`;
  }

  document.getElementById("sickResult").innerHTML = html;
}

/* =========================
   KNAPPKOPPLINGAR ‚Äì DELTAGARE/COACH
========================= */
document.getElementById("btnParticipantToday").onclick=()=>{
  const name=document.getElementById("nameSelect").value;
  if(!name){ alert("V√§lj en deltagare."); return; }

  // Visa ENBART bildst√∂d f√∂r IDAG (ingen kort-vy)
  document.getElementById("participantDay").style.display="none";
  document.getElementById("participantWeek").style.display="none";
  document.getElementById("participantPictos").style.display="block";

  renderParticipantPictosToday(name);
};


document.getElementById("btnParticipantWeek").onclick=()=>{
  const name=document.getElementById("nameSelect").value;
  if(!name){ alert("V√§lj en deltagare."); return; }
  // visa vecka, d√∂lj dag
  document.getElementById("participantDay").style.display="none";
  document.getElementById("participantWeek").style.display="block";
  document.getElementById("participantPictos").style.display="none";
  renderBlocksGeneric(name,false,document.getElementById("pBlockHeader"),document.getElementById("pBlockGrid"));
};

document.getElementById("btnCoachToday").onclick=()=>{
  const name=document.getElementById("coachSelect").value;
  if(!name){ alert("V√§lj en coach."); return; }
  document.getElementById("coachWeek").style.display="none";
  document.getElementById("coachDay").style.display="block";
  renderCardsGeneric(name,true,document.getElementById("coachDay"));
};

document.getElementById("btnCoachWeek").onclick=()=>{
  const name=document.getElementById("coachSelect").value;
  if(!name){ alert("V√§lj en coach."); return; }
  document.getElementById("coachDay").style.display="none";
  document.getElementById("coachWeek").style.display="block";
  renderBlocksGeneric(name,true,document.getElementById("cBlockHeader"),document.getElementById("cBlockGrid"));
};

/* =====================================================
   AKTIVERA UTSKRIFTSKNAPPAR
   ===================================================== */
window.addEventListener("load", () => {
  const buttons = {
    btnPrintParticipant: "Deltagarschema",
    btnPrintCoach: "Coachschema",
    btnPrintNow: "P√•g√•r nu",
    btnPrintCompare: "J√§mf√∂relse"
  };

  Object.entries(buttons).forEach(([id, title]) => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("click", () => {
        // F√∂rs√∂k h√§mta namn beroende p√• vy
        let personName = "";
        const activeView = document.querySelector(".view.active");
        if (activeView?.id === "participantView")
          personName = document.getElementById("nameSelect")?.value || "";
        else if (activeView?.id === "coachView")
          personName = document.getElementById("coachSelect")?.value || "";

        printSchema(title, personName);
      });
    }
  });
});


/* =====================================================
   F√ñRBERED UTSKRIFTSRUBRIK
   ===================================================== */
/* =====================================================
   UTF√ñR UTSKRIFT
   ===================================================== */
function getActivePrintName(){
  const activeView = document.querySelector(".view.active");
  if(activeView?.id === "participantView"){
    return document.getElementById("nameSelect")?.value || "";
  }
  if(activeView?.id === "coachView"){
    return document.getElementById("coachSelect")?.value || "";
  }
  // F√∂r "P√•g√•r nu" och "J√§mf√∂relse" finns inget enskilt namn
  return "";
}

function updatePrintHeaderSingleNow(){
  const el = document.getElementById("print-header-single");
  if(!el) return;
  const d = new Date();
  const yy = String(d.getFullYear()).slice(2);
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const dateStr = yy+mm+dd;

  const name = getActivePrintName();
  el.textContent = name ? `Schema ${name} ${dateStr}` : `Schema ${dateStr}`;
}

/* =====================================================
   UTF√ñR UTSKRIFT (ALLTID F√ÑRSKT NAMN)
   ===================================================== */
function printSchema(title, personName) {
  // Alltid f√§rskt namn i rubriken
  updatePrintHeaderSingleNow();

  // ===== PRINT-L√ÑGE: l√•s orientering r√§tt innan dialogen √∂ppnas =====
  (function(){
    const pv = document.getElementById("participantView");
    const pictos = document.getElementById("participantPictos");
    const isPictos = pv && pv.classList.contains("active") && pictos && pictos.style.display !== "none" && pictos.innerHTML.trim() !== "";
    // S√§tt klass tidigt s√• print-CSS kan sl√• igenom
    document.body.classList.toggle("pictos-print", !!isPictos);

    // L√•s @page via dynamicPageStyle direkt (inte bara via beforeprint)
    const styleEl = document.getElementById("dynamicPageStyle");
    if(styleEl){
      styleEl.textContent = isPictos
        ? "@media print { @page { size: A4 portrait; margin: 10mm; } }"
        : "@media print { @page { size: A4 landscape; margin: 10mm; } }";
    }
  })();

  // S√§kerst√§ll att bara EN yta i respektive vy √§r synlig vid utskrift
  const activeView = document.querySelector(".view.active");
  const restore = [];

  function hideIfShown(el){
    if(!el) return;
    const prev = el.style.display;
    restore.push(()=>{ el.style.display = prev; });
    el.style.display = "none";
  }

  if(activeView?.id === "participantView"){
    const day = document.getElementById("participantDay");
    const week = document.getElementById("participantWeek");
    const pictos = document.getElementById("participantPictos");

    // Avg√∂r vad som √§r "valt" just nu
    const dayOn   = day && day.style.display !== "none";
    const weekOn  = week && week.style.display !== "none";
    const picOn   = pictos && pictos.style.display !== "none";

    if(dayOn){ hideIfShown(week); hideIfShown(pictos); }
    else if(weekOn){ hideIfShown(day); hideIfShown(pictos); }
    else if(picOn){ hideIfShown(day); hideIfShown(week); }
  }

  if(activeView?.id === "coachView"){
    const day = document.getElementById("coachDay");
    const week = document.getElementById("coachWeek");

    const dayOn  = day && day.style.display !== "none";
    const weekOn = week && week.style.display !== "none";

    if(dayOn){ hideIfShown(week); }
    else if(weekOn){ hideIfShown(day); }
  }

  // K√∂r utskrift efter att layouten hunnit s√§tta sig
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      window.print();
      // √Öterst√§ll visning efter print-dialogen √∂ppnats
      setTimeout(()=>restore.forEach(fn=>fn()), 500);
    });
  });
}
// ===== Single print header (print-time accurate) =====
(function(){
  function yymmdd(){
    const d = new Date();
    const yy = String(d.getFullYear()).slice(2);
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return yy+mm+dd;
  }
  function currentName(){
    const activeView = document.querySelector(".view.active");
    // Prioritera aktiv vy, s√• coach-utskrift inte r√•kar f√• deltagarnamn
    if(activeView?.id === "coachView"){
      const sel = document.getElementById("coachSelect");
      const txt = (sel && sel.value || "").trim();
      if(txt && !txt.startsWith("--")) return txt;
    }
    if(activeView?.id === "participantView"){
      const sel = document.getElementById("nameSelect");
      const txt = (sel && sel.value || "").trim();
      if(txt && !txt.startsWith("--")) return txt;
    }

    // Fallback: om n√•got √§r valt, anv√§nd det
    const c = (document.getElementById("coachSelect")?.value || "").trim();
    if(c && !c.startsWith("--")) return c;
    const p = (document.getElementById("nameSelect")?.value || "").trim();
    if(p && !p.startsWith("--")) return p;

    return "";
  }
  function setHeader(){
    const el = document.getElementById("print-header-single");
    if(!el) return;
    const name = currentName();
    const dateStr = yymmdd();
    el.textContent = name ? `Schema ${name} ${dateStr}` : `Schema ${dateStr}`;
  }

  window.addEventListener("beforeprint", setHeader);
  // also update when user changes selection
  for(const id of ["nameSelect","coachSelect"]){
    const sel = document.getElementById(id);
    if(sel) sel.addEventListener("change", setHeader);
  }
  // initial
  setHeader();
})();


// ===== Print logo: use already-loaded home logo, fallback to embedded SVG =====
(function(){
  const fallback = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22360%22%20height%3D%22120%22%20viewBox%3D%220%200%20360%20120%22%3E%0A%20%20%3Crect%20x%3D%220%22%20y%3D%220%22%20width%3D%22360%22%20height%3D%22120%22%20rx%3D%2218%22%20fill%3D%22%23111%22/%3E%0A%20%20%3Ctext%20x%3D%2224%22%20y%3D%2272%22%20font-family%3D%22Arial%2C%20Helvetica%2C%20sans-serif%22%20font-size%3D%2256%22%20font-weight%3D%22800%22%20fill%3D%22%23fff%22%3EGrunden%3C/text%3E%0A%20%20%3Ctext%20x%3D%22260%22%20y%3D%2272%22%20font-family%3D%22Arial%2C%20Helvetica%2C%20sans-serif%22%20font-size%3D%2244%22%20font-weight%3D%22800%22%20fill%3D%22%23fff%22%3EDV%3C/text%3E%0A%3C/svg%3E";
  function setLogo(){
    const img = document.getElementById("printLogoImg");
    if(!img) return;
    const home = document.getElementById("homeLogo");
    const src = home ? (home.currentSrc || home.src || "") : "";
    img.onerror = () => { img.onerror = null; img.src = fallback; };
    img.src = src || fallback;
  }
  window.addEventListener("beforeprint", setLogo);
  document.addEventListener("DOMContentLoaded", setLogo);
})();

/* =========================
   BILDST√ñD (Deltagare) ‚Äì VECKA (m√•n‚Äìfre)
   - 1 dag per sida vid utskrift (st√•ende A4)
   - Ingen datumrad (bara veckodag)
   - Max 8 aktiviteter per dag
   - Tom dag = ledig (ingen sida)
========================= */

function mondayOf(dateObj){
  const d = new Date(dateObj);
  const day = d.getDay(); // 0=s√∂n
  const diff = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}
function isoDate(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function weekDatesMonFri(monDate){
  const dates=[];
  for(let i=0;i<5;i++){
    const dd=new Date(monDate);
    dd.setDate(monDate.getDate()+i);
    dates.push(isoDate(dd));
  }
  return dates;
}

function buildPictosWeekData(name){
  // Samma logik som tidigare: v√§lj f√∂rsta vecka (m√•n‚Äìfre) med minst en aktivitet inom 0‚Äì6 veckor fram√•t
  const allRows = DATA
    .filter(r=>{
      const list = splitNames(r["Deltagare"]||"");
      return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) ||
             (r["Deltagare"]||"").trim().toLowerCase()==="alla";
    })
    .filter(r=> sanitizeName(r.Aktivitet||""));

  const startMon = mondayOf(new Date());
  let chosenDates = null;

  for(let w=0; w<7; w++){
    const mon = new Date(startMon);
    mon.setDate(startMon.getDate() + w*7);
    const dates = weekDatesMonFri(mon);
    const hasAny = allRows.some(r => dates.includes(dayKey(r.Datum)));
    if(hasAny){ chosenDates = dates; break; }
  }

  if(!chosenDates) return [];

  const rows = allRows
    .filter(r=> chosenDates.includes(dayKey(r.Datum)))
    .sort((a,b)=> (a.Datum||"").localeCompare(b.Datum||"") || (a.Start||"").localeCompare(b.Start||""));

  const byDate = {};
  rows.forEach(r=>{
    const k = dayKey(r.Datum);
    (byDate[k] ||= []).push(r);
  });

  const daysData = [];
  chosenDates.forEach(dateKeyStr=>{
    const allDayRows = (byDate[dateKeyStr]||[]);
    if(!allDayRows.length) return; // Tom dag = inget blad

    const d = new Date(dateKeyStr);
    const title = `${name} ‚Äì ${weekdayName(d.getDay())}`;

    const items = allDayRows.slice(0,8).map(r=>({
      time: `üïí ${r.Start||""}`,
      emoji: emojiFor(r) || "‚ú®",
      label: r.Aktivitet||"",
      coach: (splitNames(r.Coach||"").join(", ") || (r.Coach||"-") || "-")
    }));

    daysData.push({ title, items });
  });

  return daysData;
}

function renderParticipantPictosWeek(name){
  const out = document.getElementById("participantPictos");
  if(!out) return;

  // Alla rader f√∂r deltagaren
  const allRows = DATA
    .filter(r=>{
      const list = splitNames(r["Deltagare"]||"");
      return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) ||
             (r["Deltagare"]||"").trim().toLowerCase()==="alla";
    })
    .filter(r=> sanitizeName(r.Aktivitet||""));

  // V√§lj f√∂rsta vecka (m√•n‚Äìfre) med minst en aktivitet: denna vecka + upp till 6 veckor fram√•t
  const startMon = mondayOf(new Date());
  let chosenDates = null;

  for(let w=0; w<7; w++){
    const mon = new Date(startMon);
    mon.setDate(startMon.getDate() + w*7);
    const dates = weekDatesMonFri(mon);
    const hasAny = allRows.some(r => dates.includes(dayKey(r.Datum)));
    if(hasAny){ chosenDates = dates; break; }
  }

  if(!chosenDates){
    out.innerHTML = `<div class="cards"><div class="card" style="--band:#cfd8e3"><div class="row">Inget schema m√•n‚Äìfre de n√§rmaste veckorna.</div></div></div>`;
    return;
  }

  // Rader inom vald vecka
  const rows = allRows
    .filter(r=> chosenDates.includes(dayKey(r.Datum)))
    .sort((a,b)=> (a.Datum||"").localeCompare(b.Datum||"") || (a.Start||"").localeCompare(b.Start||""));

  // Grupp per datum
  const byDate = {};
  rows.forEach(r=>{
    const k = dayKey(r.Datum);
    (byDate[k] ||= []).push(r);
  });

  const wrap = document.createElement("div");
  wrap.className = "picto-wrap";

  // 1 dag = 1 sida. Tom dag = inget blad. Max 8 aktiviteter per dag.
  const MAX_PER_DAY = 8;

  chosenDates.forEach(dateKeyStr=>{
    const allDayRows = (byDate[dateKeyStr]||[])
      .filter(r=> sanitizeName(r.Aktivitet||""))
      .sort((a,b)=> (a.Start||"").localeCompare(b.Start||""));

    if(!allDayRows.length) return; // tom dag = ledig, inget blad

    const d = new Date(dateKeyStr);
    const dayRows = allDayRows.slice(0, MAX_PER_DAY);

    const dayDiv = document.createElement("div");
    dayDiv.className = "picto-day";

    const title = document.createElement("div");
    title.className = "picto-day-title";
    title.textContent = `${name} ‚Äì ${weekdayName(d.getDay())}`;
    dayDiv.appendChild(title);

    dayRows.forEach(r=>{
      const item = document.createElement("div");
      item.className = "picto-item";

      const time = document.createElement("div");
      time.className = "picto-time";
      time.innerHTML = `<div class="clock">üïí</div><div class="t">${r.Start||""}</div>`;

      const act = document.createElement("div");
      act.className = "picto-act";
      const e = emojiFor(r) || "‚ú®";
      act.innerHTML = `<div class="e">${e}</div><div class="a">${r.Aktivitet||"Aktivitet"}</div>`;

      const coach = document.createElement("div");
      coach.className = "picto-coach";
      const coachNames = splitNames(r.Coach||"").join(", ") || (r.Coach||"-") || "-";
      coach.innerHTML = `<div class="lbl">Coach</div><div class="names">${coachNames}</div>`;

      item.appendChild(time);
      item.appendChild(act);
      item.appendChild(coach);
      dayDiv.appendChild(item);
    });

    wrap.appendChild(dayDiv);
  });

  out.innerHTML = "";
  out.appendChild(wrap);

  if(!wrap.children.length){
    out.innerHTML = `<div class="cards"><div class="card" style="--band:#cfd8e3"><div class="row">Inget schema m√•n‚Äìfre i vald vecka.</div></div></div>`;
  }
}


function renderParticipantPictosToday(name){
  const outEl = document.getElementById("participantPictos");
  if(!outEl) return;

  const today = todayKey();
  const dayRows = DATA
    .filter(r=>{
      const list = splitNames(r["Deltagare"]||"");
      return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) ||
             (r["Deltagare"]||"").trim().toLowerCase()==="alla";
    })
    .filter(r=> dayKey(r.Datum) === today)
    .filter(r=> sanitizeName(r.Aktivitet||""))
    .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  // Tom dag = ledig, inget bildst√∂d
  if(!dayRows.length){
    outEl.style.display = "none";
    outEl.innerHTML = "";
    return;
  }

  const d = new Date(today);
  const wrap = document.createElement("div");
  wrap.className = "picto-wrap";

  const dayDiv = document.createElement("div");
  dayDiv.className = "picto-day";

  const title = document.createElement("div");
  title.className = "picto-day-title";
  title.textContent = `${name} ‚Äì ${weekdayName(d.getDay())}`;
  dayDiv.appendChild(title);

  // max 8 per dag (som du vill)
  dayRows.slice(0, 8).forEach(r=>{
    const item = document.createElement("div");
    item.className = "picto-item";

    const time = document.createElement("div");
    time.className = "picto-time";
    time.innerHTML = `<div class="clock">üïí</div><div class="t">${r.Start||""}</div>`;

    const act = document.createElement("div");
    act.className = "picto-act";
    const e = emojiFor(r) || "‚ú®";
    act.innerHTML = `<div class="e">${e}</div><div class="a">${r.Aktivitet||"Aktivitet"}</div>`;

    const coach = document.createElement("div");
    coach.className = "picto-coach";
    const coachNames = splitNames(r.Coach||"").join(", ") || (r.Coach||"-") || "-";
    coach.innerHTML = `<div class="lbl">Coach</div><div class="names">${coachNames}</div>`;

    item.appendChild(time);
    item.appendChild(act);
    item.appendChild(coach);
    dayDiv.appendChild(item);
  });

  wrap.appendChild(dayDiv);
  outEl.innerHTML = "";
  outEl.appendChild(wrap);
  outEl.style.display = "block";
}

// Knapp: Bildst√∂d (vecka)
const btnP = document.getElementById("btnParticipantPictos");
if(btnP){
  btnP.addEventListener("click", ()=>{
    const name = document.getElementById("nameSelect").value;
    if(!name){ alert("V√§lj en deltagare."); return; }

    // Bygg bildst√∂dsdata (1 dag = 1 blad, max 8, tom dag = inget blad)
    const daysData = buildPictosWeekData(name);
    if(!daysData.length){
      alert("Inget schema m√•n‚Äìfre de n√§rmaste veckorna.");
      return;
    }

    // G√∂r datan tillg√§nglig f√∂r nya f√∂nstret direkt (b√§st f√∂r Firefox/file://)
    window.__PICTO_DATA__ = daysData;

    // Spara √§ven som fallback
    try{ localStorage.setItem("PICTO_DATA_V1", JSON.stringify(daysData)); }catch(e){}
    try{ localStorage.setItem("PICTO_BACK_URL", location.href); }catch(e){}

    // √ñppna separat print-fil (st√•ende A4) ‚Äì l√∂ser Firefox-l√•sning i liggande
    location.href = "./bildstod_print_v11.html";
  });
}

// N√§r man g√•r till veckoschemat: g√∂m bildst√∂det s√• det inte r√•kar f√∂lja med i utskrift
const btnWeek = document.getElementById("btnParticipantWeek");
if(btnWeek){
  const old = btnWeek.onclick;
  btnWeek.onclick = ()=>{
    const pp = document.getElementById("participantPictos");
    if(pp) pp.style.display="none";
    if(typeof old === "function") return old();
  };
}

/* Print: om Bildst√∂d √§r synligt -> st√•ende A4 */
window.addEventListener("beforeprint", ()=>{
  const pv = document.getElementById("participantView");
  const pictos = document.getElementById("participantPictos");
  if(pv && pv.classList.contains("active") && pictos && pictos.style.display !== "none"){
    document.body.classList.add("pictos-print");
  }else{
    document.body.classList.remove("pictos-print");
  }
});
window.addEventListener("afterprint", ()=>{
  document.body.classList.remove("pictos-print");
});


// ===== Dynamic @page size (portrait for bildst√∂d, landscape otherwise) =====
(function(){
  const styleEl = document.getElementById("dynamicPageStyle");
  function setPage(orientation){
    if(!styleEl) return;
    if(orientation === "portrait"){
      styleEl.textContent = "@media print { @page { size: A4 portrait; margin: 10mm; } }";
    }else{
      styleEl.textContent = "@media print { @page { size: A4 landscape; margin: 10mm; } }";
    }
  }
  window.addEventListener("beforeprint", ()=>{
    const pv = document.getElementById("participantView");
    const pictos = document.getElementById("participantPictos");
    const isPictos = pv && pv.classList.contains("active") && pictos && pictos.style.display !== "none";
    setPage(isPictos ? "portrait" : "landscape");
  });
  // default
  setPage("landscape");
})();


</script>
<script>
  // Minimal PWA: registrera service worker (kr√§ver HTTPS eller localhost)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>


<script id="printfix-js">
/* =========================
   PRINTFIX (2026-01-05)
   - S√§tter tydligt print-l√§ge (week/pictos)
   - S√§tter @page via dynamicPageStyle
========================= */
(function(){
  const styleEl = document.getElementById("dynamicPageStyle");

  function setPage(orientation){
    if(!styleEl) return;
    styleEl.textContent = "@media print { @page { size: A4 " + orientation + "; margin: 10mm; } }";
  }

  function computeMode(){
    const activeView = document.querySelector(".view.active");
    const pictos = document.getElementById("participantPictos");
    const pictosVisible = activeView && activeView.id === "participantView" &&
      pictos && pictos.style.display !== "none" && pictos.innerHTML.trim().length > 0;

    // Bildst√∂d styr endast n√§r bildst√∂d √§r synligt i deltagarvyn
    return pictosVisible ? "pictos" : "week";
  }

  function applyMode(){
    const mode = computeMode();

    document.body.classList.remove("print-week","print-pictos","pictos-print");
    if(mode === "pictos"){
      document.body.classList.add("print-pictos","pictos-print");
      setPage("portrait");
    }else{
      document.body.classList.add("print-week");
      setPage("landscape");
    }
  }

  window.addEventListener("beforeprint", applyMode);
  window.addEventListener("afterprint", ()=>{
    document.body.classList.remove("print-week","print-pictos","pictos-print");
    // tillbaka till standard (landscape) s√• veckoschema k√§nns "normalt"
    setPage("landscape");
  });

  // Om anv√§ndaren v√§xlar vy precis innan print (Chrome kan vara seg)
  document.addEventListener("click", (e)=>{
    const t = e.target;
    if(t && t.id && String(t.id).toLowerCase().includes("print")){
      applyMode();
    }
  }, true);
})();
</script>

</body>
</html>
