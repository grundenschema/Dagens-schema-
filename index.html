<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnBlocks">Veckoblock</button>
  <button id="btnCards">Kortvy</button>
  <button id="btnSick">Sjukschema</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<div id="blockContainer" class="block-wrap" aria-hidden="true">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div id="printHint" style="font-size:.9rem;color:#444;margin-top:6px;text-align:center;">
    F√∂rhandsvisning ‚Äì anv√§nd webbl√§sarens <b>Skriv ut</b> (Ctrl/Cmd + P).
  </div>
</div>

<div id="sickPanel">
  <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
  <div id="sickList"></div>
  <div id="sickMsg" style="font-size:.85rem;color:#666;margin-top:6px;"></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button id="btnShowSick">Visa sjukschema</button>
    <button id="btnClearSick">Rensa</button>
  </div>
</div>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnBlocks">Veckoblock</button>
  <button id="btnCards">Kortvy</button>
  <button id="btnSick">Sjukschema</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<div id="blockContainer" class="block-wrap" aria-hidden="true">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div id="printHint" style="font-size:.9rem;color:#444;margin-top:6px;text-align:center;">
    F√∂rhandsvisning ‚Äì anv√§nd webbl√§sarens <b>Skriv ut</b> (Ctrl/Cmd + P).
  </div>
</div>

<div id="sickPanel">
  <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
  <div id="sickList"></div>
  <div id="sickMsg" style="font-size:.85rem;color:#666;margin-top:6px;"></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button id="btnShowSick">Visa sjukschema</button>
    <button id="btnClearSick">Rensa</button>
  </div>
</div>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>
</header>

<div class="toolbar">
  <button id="btnDaily">Gemensamt schema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
  <button id="btnBlocks">Veckoblock</button>
  <button id="btnCards">Kortvy</button>
  <button id="btnSick">Sjukschema</button>
  <button id="btnPrint">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer">Laddar schema...</div>

<div id="blockContainer" class="block-wrap" aria-hidden="true">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div id="printHint" style="font-size:.9rem;color:#444;margin-top:6px;text-align:center;">
    F√∂rhandsvisning ‚Äì anv√§nd webbl√§sarens <b>Skriv ut</b> (Ctrl/Cmd + P).
  </div>
</div>

<div id="sickPanel">
  <h3>ü©∫ V√§lj sjuka coacher (max 5)</h3>
  <div id="sickList"></div>
  <div id="sickMsg" style="font-size:.85rem;color:#666;margin-top:6px;"></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button id="btnShowSick">Visa sjukschema</button>
    <button id="btnClearSick">Rensa</button>
  </div>
</div>
<script>
/* ===== Datak√§lla ===== */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";
const aktivitetFarger={
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},"Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},"Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},"Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},"Padel":{color:"#82E0AA",emoji:"üèì"},
  "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"},"Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},"Film":{color:"#E6B0AA",emoji:"üé¨"},
  "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"},"Trummor":{color:"#F1948A",emoji:"ü•Å"},
  "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"},"Medicin":{color:"#E59866",emoji:"üíä"},
  "Biljard":{color:"#A9DFBF",emoji:"üé±"},"Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
  "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"},"Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
  "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"},"Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"}
};

/* ===== Klocka ===== */
function getSEDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Stockholm"}));}
function fmtSE(dt,opts){return new Intl.DateTimeFormat("sv-SE",opts).format(dt);}
function updateClock(){
  const now=getSEDate();
  document.getElementById("clock").textContent=
    fmtSE(now,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateClock,1000);updateClock();

/* ===== Hj√§lp ===== */
function dayKey(str){return String(str).slice(0,10);}
function parseCoaches(coachStr){
  const ignore=["","-",".","ingen","ingen coach","eget arbete","sj√§lvst√§ndigt","utan coach"];
  return (coachStr||"").split(/,|\/|&|\+|;|\||\n| och /i)
    .map(c=>c.trim())
    .filter(c=>c&&!ignore.includes(c.toLowerCase())&&c.toLowerCase()!=="alla");
}
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#fff"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function shrinkList(str,max=2){
  if(!str) return "-";
  const arr=String(str).split(/,|\/|;|\||\n| och /i).map(s=>s.trim()).filter(Boolean);
  return arr.length<=max?arr.join(", "):arr.slice(0,max).join(", ")+`, +${arr.length-max} fler`;
}

/* ===== Ladda data ===== */
let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    document.getElementById("updated").textContent="Senast uppdaterad: "+(json.updated||"‚Äì");
    setupCoachSelect(DATA);
    setupSickList(DATA);
    renderDaily(DATA);
  }catch(e){
    document.getElementById("schemaContainer").innerHTML="<p style='color:red'>Kunde inte h√§mta schemat.</p>";
    console.error(e);
  }
}

/* ===== Kortvy: gemensamt & coach ===== */
function cardHTML(r){
  const b=colorFor(r);
  const t=(r.Start&&r.Slut)?`${r.Start}‚Äì${r.Slut}`:r.Start||r.Slut||"-";
  return `<div class="card" style="--band:${b}">
    <div class="row"><label>üïí Tid:</label><div>${t}</div></div>
    <h4 class="card-title">${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h4>
    <div class="row"><label>üë• Deltagare:</label><div>${shrinkList(r.Deltagare,2)}</div></div>
    <div class="row"><label>üßë‚Äçüè´ Coach:</label><div>${shrinkList(r.Coach,2)}</div></div>
  </div>`;
}

function groupByDate(rows){
  const g={};rows.forEach(r=>{const k=dayKey(r.Datum);(g[k]=g[k]||[]).push(r);});
  return Object.keys(g).sort().reduce((a,k)=>(a[k]=g[k],a),{});
}

function sectionHTML(k,rows){
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(k));
  return `<div class="day-section"><div class="day-heading">${label}</div><div class="cards">${rows.map(cardHTML).join("")}</div></div>`;
}

function renderDaily(data){
  const today=dayKey(getSEDate().toISOString());
  const rows=data.filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  document.getElementById("viewTitle").textContent="Gemensamt schema";
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("schemaContainer").innerHTML=rows.length?sectionHTML(today,rows):`<p>Inga aktiviteter idag.</p>`;
}

/* ===== Coachschema (kortvy per coach) ===== */
function setupCoachSelect(data){
  const s=document.getElementById("coachSelect");
  s.innerHTML=`<option value="">-- V√§lj coach --</option>`;
  [...new Set(data.map(r=>parseCoaches(r.Coach)).flat())].sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });
  s.onchange=()=>{const v=s.value;if(v)renderCoachWeek(DATA,v);};
}

/* ===== Blockschema hj√§lpmetoder ===== */
const SLOT_START="08:00", SLOT_END="16:30";
function makeSlots(){
  const out=[];let t=8*60;while(t<=16*60+30){
    out.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));t+=30;
  }return out;
}
function timeToRowIndex(time,slots){return slots.indexOf(time)+1;}
function floorSlot(t){const [h,m]=t.split(":").map(Number);return `${String(h).padStart(2,"0")}:${m<30?"00":"30"}`;}
/* ===== Coachschemavecka (kortvy) ===== */
function renderCoachWeek(data,coach){
  const workDays=new Set(
    data.filter(r=>parseCoaches(r.Coach).includes(coach)).map(r=>dayKey(r.Datum))
  );
  const rows=data.filter(r=>{
    const cs=parseCoaches(r.Coach);
    const isAll=(r.Coach||"").trim().toLowerCase()==="alla";
    const dk=dayKey(r.Datum);

    // üçΩÔ∏è Lunch-trumfar-Alla-regel f√∂r Mio/Anders B
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const isAllRow=isAll || (r.Deltagare||"").trim().toLowerCase()==="alla";
    if(isLunch && isAllRow){
      const overlappingSpecific=data.some(x=>{
        const sameDay=dayKey(x.Datum)===dk;
        const sameTime=(x.Start===r.Start && x.Slut===r.Slut);
        const sameActivity=(x.Aktivitet||"").toLowerCase().includes("lunch");
        const specificForThisCoach=parseCoaches(x.Coach).includes(coach);
        const specificForMioOrAnders=/\bmio\b/i.test(x.Deltagare||"") || /\banders b\b/i.test(x.Deltagare||"");
        const notAll=(x.Coach||"").trim().toLowerCase()!=="alla" && (x.Deltagare||"").trim().toLowerCase()!=="alla";
        return sameDay && sameTime && sameActivity && specificForThisCoach && specificForMioOrAnders && notAll;
      });
      if(overlappingSpecific)return false;
    }

    return cs.includes(coach)||(isAll&&workDays.has(dk));
  }).sort((a,b)=>{
    if(dayKey(a.Datum)===dayKey(b.Datum))return(a.Start||"").localeCompare(b.Start||"");
    return dayKey(a.Datum).localeCompare(dayKey(b.Datum));
  });
  const grouped=groupByDate(rows);
  document.getElementById("viewTitle").textContent="Coachschema ‚Äì "+coach;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("schemaContainer").innerHTML=Object.keys(grouped).map(k=>sectionHTML(k,grouped[k])).join("")||`<p>Inga aktiviteter hittades f√∂r ${coach}.</p>`;
}

/* ===== BLOCKSCHEMA ‚Äì uppdaterad med Mio-regel och dolda lediga dagar ===== */
function renderCoachBlocks(data, coach) {
  const slots = makeSlots();

  // Hitta alla dagar d√§r coachen jobbar (exkludera frukost & lunch)
  const activeDays = [...new Set(
    data
      .filter(r => parseCoaches(r.Coach).includes(coach))
      .filter(r => !/(frukost|lunch)/i.test(r.Aktivitet || ""))
      .map(r => dayKey(r.Datum))
  )].sort();

  if (!activeDays.length) {
    document.getElementById("viewTitle").textContent = `Veckoschema ‚Äì ${coach}`;
    document.getElementById("schemaContainer").style.display = "block";
    document.getElementById("blockContainer").style.display = "none";
    document.getElementById("schemaContainer").innerHTML = `<p>${coach} har inga schemalagda aktiviteter denna vecka.</p>`;
    return;
  }

  const rows = data.filter(r => {
    const cs = parseCoaches(r.Coach);
    const dk = dayKey(r.Datum);
    const isAll = (r.Coach || "").trim().toLowerCase() === "alla";
    const isMeal = /(frukost|lunch)/i.test(r.Aktivitet || "");

    // üçΩÔ∏è Lunch-trumfar-Alla-regel f√∂r Mio/Anders B
    const isLunch = (r.Aktivitet || "").toLowerCase().includes("lunch");
    const isAllRow = isAll || (r.Deltagare || "").trim().toLowerCase() === "alla";
    if (isLunch && isAllRow) {
      const overlappingSpecific = data.some(x => {
        const sameDay = dayKey(x.Datum) === dk;
        const sameTime = (x.Start === r.Start && x.Slut === r.Slut);
        const sameActivity = (x.Aktivitet || "").toLowerCase().includes("lunch");
        const specificForThisCoach = parseCoaches(x.Coach).includes(coach);
        const specificForMioOrAnders =
          /\bmio\b/i.test(x.Deltagare || "") || /\banders b\b/i.test(x.Deltagare || "");
        const notAll =
          (x.Coach || "").trim().toLowerCase() !== "alla" &&
          (x.Deltagare || "").trim().toLowerCase() !== "alla";
        return sameDay && sameTime && sameActivity && specificForThisCoach && specificForMioOrAnders && notAll;
      });
      if (overlappingSpecific) return false;
    }

    if (isMeal) return false;
    return (cs.includes(coach) || isAll) && activeDays.includes(dk);
  });

  // Visa blockschema, d√∂lj kortvy
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "block";
  document.getElementById("blockContainer").setAttribute("aria-hidden", "false");
  document.getElementById("printHint").style.display = "block";
  document.getElementById("viewTitle").textContent = `Veckoschema ‚Äì ${coach}`;

  // Rubriker & grid
  const head = document.getElementById("blockHeader"),
        grid = document.getElementById("blockGrid");
  head.innerHTML = "<div>Tid</div>" + activeDays.map(d =>
    `<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"long"}).format(new Date(d))}</div>`
  ).join("");
  grid.innerHTML = "";
  grid.style.gridTemplateColumns = `80px repeat(${activeDays.length}, 1fr)`;

  slots.forEach(t => {
    grid.innerHTML += `<div class="block-time">${t}</div>`;
    for (let d = 0; d < activeDays.length; d++) grid.innerHTML += `<div class="block-cell"></div>`;
  });

  const cells = [...grid.children];

  rows.forEach(r => {
    const dk = dayKey(r.Datum);
    const dayIndex = activeDays.indexOf(dk);
    if (dayIndex === -1) return;

    const start = floorSlot(r.Start || SLOT_START);
    const end = floorSlot(r.Slut || SLOT_END);
    let sIdx = timeToRowIndex(start, slots);
    let eIdx = timeToRowIndex(end, slots) - 1;
    if (sIdx < 1 || eIdx < sIdx) return;

    const firstCellIndex = (sIdx - 1) * (1 + activeDays.length) + (dayIndex + 1);
    const firstCell = cells[firstCellIndex];
    const slotsCovered = eIdx - sIdx + 1;

    const toMin = t => { const [h,m] = t.split(":").map(Number); return h * 60 + m; };
    const durationMin = toMin(r.Slut || SLOT_END) - toMin(r.Start || SLOT_START);
    const isShort = durationMin <= 30;

    const block = document.createElement("div");
    block.className = "block";
    block.style.background = colorFor(r);
    block.style.fontSize = isShort ? "0.7rem" : "0.85rem";

    const akt = r.Aktivitet || "Aktivitet";
    const deltagare = shrinkList(r.Deltagare, 2);

    if (isShort) {
      block.innerHTML = `<div><b>${akt}</b> ‚Äì ${deltagare}</div>`;
    } else {
      block.innerHTML = `
        <div class="title">${akt}</div>
        <div class="small">üë• ${deltagare}</div>
      `;
    }

    requestAnimationFrame(() => {
      const cellH = firstCell.clientHeight || 28;
      block.style.height = (slotsCovered * cellH - 3) + "px";
    });

    firstCell.appendChild(block);
  });
}

/* ===== Knappar, sjukpanel, initiering ===== */
document.getElementById("btnDaily").onclick=()=>{renderDaily(DATA);};
document.getElementById("btnCoach").onclick=()=>{
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("btnBlocks").style.display="inline-block";
  document.getElementById("btnCards").style.display="inline-block";
  const v=document.getElementById("coachSelect").value;
  if(v){renderCoachWeek(DATA,v);}
};
document.getElementById("btnBlocks").onclick=()=>{
  const v=document.getElementById("coachSelect").value;
  if(!v){alert("V√§lj en coach f√∂rst.");return;}
  renderCoachBlocks(DATA,v);
};
document.getElementById("btnCards").onclick=()=>{
  const v=document.getElementById("coachSelect").value;
  if(!v){alert("V√§lj en coach f√∂rst.");return;}
  renderCoachWeek(DATA,v);
};
document.getElementById("btnPrint").onclick=()=>{window.print();};

/* Init */
loadData();
setInterval(loadData,15*60*1000);
</script>
</body>
</html>
