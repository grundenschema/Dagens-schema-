<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Schema ‚Äì Deltagare & Coacher</title>
<style>
:root{
  --card-bg:#fff; --border:#ddd; --shadow:0 3px 10px rgba(0,0,0,.05);
  --radius:14px; --muted:#666; --band:#9ecbff;
}
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  margin:0 auto; max-width:1800px; padding:12px; background:#fafafa;
}
header{text-align:center;margin-bottom:12px;}
h1{margin:0;font-size:1.35rem}
small{color:var(--muted)}
.toolbar{
  display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;
  margin:10px auto 12px;
}
button,select{
  font-size:1rem;padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#f8f8f8;cursor:pointer;
}
button:hover{background:#eee}
select{min-width:220px}
#viewTitle{ text-align:center; margin:12px 0 8px; }

.cards{display:flex;flex-direction:column;gap:10px;max-width:900px;margin:0 auto}
.card{
  position:relative;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);padding:10px 14px;box-shadow:var(--shadow);
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 4px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

#blockContainer{display:none;margin-top:6px;}
.schema-wrap{ /* anv√§nds f√∂r flervy */
  display:flex;flex-wrap:wrap;gap:16px;justify-content:center;align-items:flex-start;
}
.schema{
  flex:1 1 360px;min-width:320px;max-width:520px;background:var(--card-bg);
  border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:var(--shadow);
}
.schema h3{margin:6px 0;text-align:center}
.block-header{display:grid;grid-template-columns:80px repeat(5,1fr);font-weight:700;font-size:.85rem;background:#eef3ff;border-radius:8px 8px 0 0}
.block-grid{display:grid;grid-template-columns:80px repeat(5,1fr)}
.block-time{background:#fafafa;font-size:.8rem;padding:2px 4px}
.block-cell{position:relative;min-height:26px}
.block{
  position:absolute;left:2px;right:2px;top:2px;border-radius:6px;padding:3px 4px;line-height:1.2;border:1pt solid #666;font-size:.75rem;overflow:hidden;-webkit-print-color-adjust:exact;print-color-adjust:exact;
}
.block .title{font-weight:700}

.helper-panels{max-width:1000px;margin:0 auto}
.panel{
  display:none;background:#fff;border:1px solid #ccc;border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,.1);padding:16px;margin:14px auto;
}
.panel h2{margin:6px 0 12px}

.list-two-col{display:flex;gap:30px;justify-content:center;flex-wrap:wrap}
.list-two-col > div{min-width:240px}

#nowContainer{max-width:900px;margin:10px auto}

@media (max-width:760px){
  body{padding:8px}
  .schema{min-width:100%;max-width:100%}
  .toolbar{flex-direction:column}
  button,select{width:95%;font-size:1.08rem}
}
@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar,.helper-panels,#schemaContainer{display:none!important;}
  #blockContainer{display:block!important;}
  .schema{page-break-inside:avoid;}
  @page{size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header>
  <h1>Schema ‚Äì Deltagare & Coacher</h1>
  <small>Veckoschema med flervy, p√•g√•ende vy och sjuk-ers√§ttare</small>
</header>

<div class="toolbar">
  <button id="btnParticipant">Deltagarschema</button>
  <button id="btnCoach">Coachschema</button>
  <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
  <select id="coachSelect" style="display:none"><option value="">-- V√§lj coach --</option></select>

  <button id="btnCards">Dagens schema</button>
  <
  <button id="btnBlocks">Veckoschema</button>
  <button id="btnNow">‚è±Ô∏è P√•g√•r just nu</button>
  <button id="btnCompare">üîç J√§mf√∂r scheman</button>
  <button id="btnSick">ü©∫ Hitta ers√§ttare</button>
  <button id="btnPrint" style="display:none">üñ®Ô∏è Skriv ut</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>
<div id="nowContainer"></div>

<div id="blockContainer">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
</div>

<div class="helper-panels">
  <div id="comparePanel" class="panel">
    <h2>J√§mf√∂r scheman</h2>
    <div class="list-two-col">
      <div><h3>Coacher</h3><div id="coachListCompare"></div></div>
      <div><h3>Deltagare</h3><div id="participantListCompare"></div></div>
    </div>
    <button id="btnShowCompare">Visa valda scheman</button>
  </div>

  <div id="sickPanel" class="panel">
    <h2>Hitta ers√§ttare</h2>
    <select id="sickCoachSelect"><option value="">-- V√§lj sjuk coach --</option></select>
    <div id="sickResult"></div>
  </div>
</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
  "M√•ndagsm√∂te":"#AED6F1","Gruppm√∂te":"#7FB3D5","Lunch":"#F9E79F","Frukost":"#FAD7A0",
  "Atelj√©":"#F5CBA7","Musik":"#D2B4DE","Pod":"#A9CCE3","Padel":"#82E0AA",
  "Lite av varje":"#FADBD8","Yoga":"#D5F5E3","Gym":"#A3E4D7","Film":"#E6B0AA",
  "F√∂reningsgruppen":"#D6DBDF","Trummor":"#F1948A","√Öterkoppling":"#85C1E9",
  "Medicin":"#E59866","Biljard":"#A9DFBF","Spelgruppen":"#F8C471","S√∂mnad":"#F5EEF8",
  "Filmgruppen":"#E6B0AA","Musikquizz":"#D2B4DE","Musikdokument√§r":"#D2B4DE",
  "Warhammer":"#C39BD3","Utflykt":"#A9CCE3","Uppstart Taket":"#AED6F1"
};

function colorFor(r){return aktivitetFarger[r.Aktivitet]||"#eee";}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList();fillCoachList();fillCompareLists();
    document.getElementById("sickCoachSelect").innerHTML='<option value="">-- V√§lj sjuk coach --</option>'+
      [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
      .filter(x=>x&&x.toLowerCase()!=="alla").sort().map(c=>`<option>${c}</option>`).join("");
  }catch(e){console.error(e);}
}
loadData();

/* === LISTOR === */
function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
    const o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);
  });
}
function fillCoachList(){
  const s=document.getElementById("coachSelect");
  s.innerHTML='<option value="">-- V√§lj coach --</option>';
  [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
  .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
    const o=document.createElement("option");o.value=c;o.textContent=c;s.appendChild(o);
  });
}
function fillCompareLists(){
  const cList=document.getElementById("coachListCompare");
  const pList=document.getElementById("participantListCompare");
  cList.innerHTML="";pList.innerHTML="";
  [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(c=>{
      cList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-coach" value="${c}"> ${c}</label><br>`);
    });
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla").sort().forEach(n=>{
      pList.insertAdjacentHTML("beforeend",`<label><input type="checkbox" class="chk-delt" value="${n}"> ${n}</label><br>`);
    });
}

/* === RENDER FUNKTIONER === */
function applyLunchRule(rows,name,isCoach){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const field=isCoach?"Coach":"Deltagare";
    const isAll=(r[field]||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&(x.Aktivitet||"").toLowerCase().includes("lunch")&&(x[field]||"").toLowerCase().includes(name.toLowerCase()));
      if(specific) return false;
    }
    return true;
  });
}

function renderCards(name,isCoach){
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(
    DATA.filter(r=>{
      const str=(r[field]||"").toLowerCase();
      return str.includes(name.toLowerCase())||str==="alla";
    }),name,isCoach).filter(r=>dayKey(r.Datum)===today).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  let html=`<div class='cards'>`;
  if(!rows.length) html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
      <div class="row">${isCoach?"üë• Deltagare: "+(r.Deltagare||"-"):"üßë‚Äçüè´ Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("btnPrint").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema ‚Äì ${name}`;
}

function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
function renderBlocks(name,isCoach){
  const slots=makeSlots(), days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach);
  const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("");
  grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children], dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");block.className="block";block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    block.innerHTML=`<div class="title">${r.Aktivitet||""}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  document.getElementById("viewTitle").textContent=`Veckoschema ‚Äì ${name}`;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
}

/* === KNAPPAR === */
document.getElementById("btnParticipant").onclick=()=>{
  document.getElementById("coachSelect").style.display="none";
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Deltagarschema";
};
document.getElementById("btnCoach").onclick=()=>{
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Coachschema";
};
document.getElementById("btnCards").onclick=()=>{
  const n=document.getElementById("nameSelect").style.display!=="none"
    ?document.getElementById("nameSelect").value
    :document.getElementById("coachSelect").value;
  if(n)renderCards(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnBlocks").onclick=()=>{
  const n=document.getElementById("nameSelect").style.display!=="none"
    ?document.getElementById("nameSelect").value
    :document.getElementById("coachSelect").value;
  if(n)renderBlocks(n,document.getElementById("coachSelect").style.display!=="none");
};
document.getElementById("btnPrint").onclick=()=>{window.print();};
/* === P√ÖG√ÖR JUST NU === */
document.getElementById("btnNow").onclick = () => {
  const now = new Date();
  const minsNow = now.getHours() * 60 + now.getMinutes();
  const today = todayKey();
  const active = DATA.filter(r => {
    if (dayKey(r.Datum) !== today) return false;
    const [sh, sm] = (r.Start || "00:00").split(":").map(Number);
    const [eh, em] = (r.Slut || "00:00").split(":").map(Number);
    const start = sh * 60 + sm, end = eh * 60 + em;
    return minsNow >= start && minsNow <= end;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const cont = document.getElementById("nowContainer");
  cont.innerHTML = `<h2 style="text-align:center">‚è±Ô∏è P√•g√•r just nu</h2>`;
  if (!active.length) {
    cont.innerHTML += `<p style="text-align:center">Inga aktiviteter p√•g√•r just nu.</p>`;
    return;
  }
  cont.innerHTML += `<div class="cards">` +
    active.map(r => `
      <div class="card" style="--band:${colorFor(r)}">
        <h3>${r.Aktivitet||"Aktivitet"}</h3>
        <div class="row">üïí ${r.Start||""}‚Äì${r.Slut||""}</div>
        <div class="row">üßë‚Äçüè´ Coach: ${r.Coach||"-"}</div>
        <div class="row">üë• Deltagare: ${r.Deltagare||"-"}</div>
      </div>`).join("") +
    `</div>`;
  document.getElementById("viewTitle").textContent = "P√•g√•r just nu";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("btnPrint").style.display = "none";
};


/* === HITTA ERS√ÑTTARE (SJUKSYSTEM) === */
document.getElementById("btnSick").onclick = () => {
  document.getElementById("sickPanel").style.display = "block";
  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("btnPrint").style.display = "none";
  document.getElementById("viewTitle").textContent = "Hitta ers√§ttare (sjuk coach)";
};

document.getElementById("sickCoachSelect").onchange = () => {
  const coach = document.getElementById("sickCoachSelect").value;
  if (!coach) return;
  const today = todayKey();
  const todaysPass = DATA.filter(r =>
    dayKey(r.Datum) === today && (r.Coach||"").toLowerCase().includes(coach.toLowerCase())
  );
  const otherCoaches = [...new Set(DATA.map(r=>(r.Coach||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla" && x!==coach);
  const freeCoaches = otherCoaches.filter(c=>{
    return !DATA.some(r=>{
      if(dayKey(r.Datum)!==today)return false;
      if(!(r.Coach||"").toLowerCase().includes(c.toLowerCase()))return false;
      const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
      const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
      const s=sh*60+sm,e=eh*60+em;
      return todaysPass.some(tp=>{
        const [th,tm]=(tp.Start||"00:00").split(":").map(Number);
        const [xh,xm]=(tp.Slut||"00:00").split(":").map(Number);
        const ts=th*60+tm,te=xh*60+xm;
        return !(e<=ts || s>=te);
      });
    });
  });
  let html = `<h3>${coach}s pass idag</h3>`;
  if (!todaysPass.length) html += `<p>Inga pass idag.</p>`;
  else html += `<ul>` + todaysPass.map(r=>`<li>${r.Aktivitet} (${r.Start}‚Äì${r.Slut})</li>`).join("") + `</ul>`;
  html += `<h3>Tillg√§ngliga coacher</h3>`;
  if (!freeCoaches.length) html += `<p>Inga lediga coacher just nu.</p>`;
  else html += `<ul>` + freeCoaches.map(c=>`<li>${c}</li>`).join("") + `</ul>`;
  document.getElementById("sickResult").innerHTML = html;
};


/* === J√ÑMF√ñR SCHEMAN (FLERVY) === */
document.getElementById("btnCompare").onclick = () => {
  document.getElementById("comparePanel").style.display = "block";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").style.display = "none";
  document.getElementById("blockContainer").style.display = "none";
  document.getElementById("nowContainer").innerHTML = "";
  document.getElementById("btnPrint").style.display = "none";
  document.getElementById("viewTitle").textContent = "J√§mf√∂r scheman";
};

document.getElementById("btnShowCompare").onclick = () => {
  const selectedNames = [
    ...document.querySelectorAll(".chk-delt:checked"),
    ...document.querySelectorAll(".chk-coach:checked")
  ].map(cb => ({
    name: cb.value,
    isCoach: cb.classList.contains("chk-coach")
  }));
  if (!selectedNames.length) {
    alert("V√§lj minst en person f√∂rst.");
    return;
  }
  const wrap = document.createElement("div");
  wrap.className = "schema-wrap";
  selectedNames.forEach(sel => {
    const div = document.createElement("div");
    div.className = "schema";
    div.appendChild(renderSingleWeek(sel.name, sel.isCoach));
    wrap.appendChild(div);
  });
  document.getElementById("comparePanel").style.display = "none";
  document.getElementById("sickPanel").style.display = "none";
  document.getElementById("schemaContainer").innerHTML = "";
  document.getElementById("schemaContainer").appendChild(wrap);
  document.getElementById("schemaContainer").style.display = "block";
  document.getElementById("btnPrint").style.display = "inline-block";
  document.getElementById("viewTitle").textContent = "J√§mf√∂r scheman";
};

function renderSingleWeek(name,isCoach){
  const slots=makeSlots(), days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const str=(r[field]||"").toLowerCase();
    return str.includes(name.toLowerCase())||str==="alla";
  }),name,isCoach);
  const container=document.createElement("div");
  container.innerHTML=`<h3>${isCoach?"Coach: ":"Deltagare: "}${name}</h3>
  <div class="block-header"><div>Tid</div>${days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("")}</div>
  <div class="block-grid"></div>`;
  const grid=container.querySelector(".block-grid");
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{grid.innerHTML+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");});
  const cells=[...grid.children],dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const[h,m]=t.split(":").map(Number);return h*60+m;};
  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    block.innerHTML=`<div class="title">${r.Aktivitet||""}</div>${r.Start||""}‚Äì${r.Slut||""}<br>${isCoach?"üë• "+(r.Deltagare||"-"):"üßë‚Äçüè´ "+(r.Coach||"-")}`;
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });
  return container;
};

</script>
</body>
</html>
