<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grunden DV ‚Äì Schema</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fafafa;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    header img {
      height: 60px;
      margin-top: 5px;
    }

    #clock {
      font-family: monospace;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    #updated {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 10px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }

    select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background-color: #f7f7f7;
      cursor: pointer;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th { background: #f2f2f2; }
    .ended { opacity: 0.6; }
    .aktivitet { font-weight: bold; }

    .day-heading {
      background-color: #f0f6ff;
      color: #2c3e50;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 25px;
    }

    /* üí° Mobilv√§nlig kortvy */
    @media (max-width: 700px) {
      table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
      }

      thead { display: none; }

      tr {
        background: #fff;
        margin: 0 auto 12px auto;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 10px 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        max-width: 95%;
      }

      td {
        border: none;
        padding: 5px 0;
        display: flex;
        justify-content: space-between;
        font-size: 0.95rem;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #333;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div id="clock"></div>
      <div id="updated">Senast uppdaterad: ‚Äì</div>
    </div>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <div class="toolbar">
    <select id="coachSelect">
      <option value="">Gemensamt schema</option>
    </select>
  </div>

  <div id="schemaContainer">Laddar schema...</div>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

    const aktivitetFarger = {
      "M√•ndagsm√∂te": {color:"#AED6F1", emoji:"üìÖ"},
      "Gruppm√∂te": {color:"#7FB3D5", emoji:"üë•"},
      "Lunch": {color:"#F9E79F", emoji:"üç≤"},
      "Frukost": {color:"#FAD7A0", emoji:"ü•ê"},
      "Atelj√©": {color:"#F5CBA7", emoji:"üé®"},
      "Musik": {color:"#D2B4DE", emoji:"üé∂"},
      "Pod": {color:"#A9CCE3", emoji:"üéôÔ∏è"},
      "Padel": {color:"#82E0AA", emoji:"üèì"},
      "Lite av varje": {color:"#FADBD8", emoji:"‚ú®"},
      "Yoga": {color:"#D5F5E3", emoji:"üßò"},
      "Gym": {color:"#A3E4D7", emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
      "Film": {color:"#E6B0AA", emoji:"üé¨"},
      "F√∂reningsgruppen": {color:"#D6DBDF", emoji:"ü§ù"},
      "Trummor": {color:"#F1948A", emoji:"ü•Å"},
      "√Öterkoppling": {color:"#85C1E9", emoji:"üîÑ"},
      "Medicin": {color:"#E59866", emoji:"üíä"},
      "Biljard": {color:"#A9DFBF", emoji:"üé±"},
      "Spelgruppen": {color:"#F8C471", emoji:"üé≤"},
      "S√∂mnad": {color:"#F5EEF8", emoji:"üßµ"},
      "Filmgruppen": {color:"#E6B0AA", emoji:"üé¨"},
      "Musikquizz": {color:"#D2B4DE", emoji:"üé∂"},
      "Musikdokument√§r": {color:"#D2B4DE", emoji:"üé∂"}
    };

    function getStockholmDate() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
    }

    function updateClock() {
      const now = getStockholmDate();
      const opts = { weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit", second:"2-digit" };
      document.getElementById("clock").textContent = new Intl.DateTimeFormat("sv-SE", opts).format(now);
    }
    setInterval(updateClock, 1000);
    updateClock();

    let GLOBAL_DATA = [];

    async function loadSchema() {
      try {
        const res = await fetch(url + "?t=" + Date.now());
        const json = await res.json();
        GLOBAL_DATA = json.data || [];
        document.getElementById("updated").textContent = "Senast uppdaterad: " + (json.updated || "‚Äì");
        setupCoaches(GLOBAL_DATA);
        renderDaily(GLOBAL_DATA);
      } catch {
        document.getElementById("schemaContainer").textContent = "Kunde inte h√§mta schema.";
      }
    }

    function renderDaily(data) {
      const today = getStockholmDate().toISOString().split("T")[0];
      const todays = data.filter(r => String(r.Datum).startsWith(today));
      const now = getStockholmDate().toTimeString().slice(0,5);
      let html = `<table><thead>
        <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
      </thead><tbody>`;

      todays.forEach(row => {
        const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
        const status = (row.Slut <= now) ? "‚ùå" : (row.Start <= now && row.Slut >= now) ? "üü¢" : "";
        html += `<tr style="background:${f.color}" class="${status==='‚ùå'?'ended':''}">
          <td data-label="Start">${row.Start}</td>
          <td data-label="Slut">${row.Slut}</td>
          <td data-label="Aktivitet" class="aktivitet">${status ? status + " " : ""}${f.emoji||""} ${row.Aktivitet}</td>
          <td data-label="Deltagare">${row.Deltagare}</td>
          <td data-label="Coach">${row.Coach}</td>
        </tr>`;
      });

      if (!todays.length) html += `<tr><td colspan="5">Inga aktiviteter idag.</td></tr>`;
      html += "</tbody></table>";
      document.getElementById("schemaContainer").innerHTML = html;
    }

    function setupCoaches(data) {
      const select = document.getElementById("coachSelect");
      const coaches = [...new Set(
        data.map(r => (r.Coach || "").split(",")).flat().map(c => c.trim()).filter(c => c && c!=="Alla")
      )].sort();

      coaches.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });

      select.onchange = () => {
        if (select.value === "") renderDaily(GLOBAL_DATA);
        else renderWeekly(GLOBAL_DATA, select.value);
      };
    }

    function renderWeekly(data, coach) {
      let filtered = data.filter(r => {
        const coachList = (r.Coach || "").split(",").map(c => c.trim());
        return coachList.includes(coach) || (r.Coach || "").trim() === "Alla";
      });

      filtered.sort((a,b)=>{
        const dA=String(a.Datum).slice(0,10), dB=String(b.Datum).slice(0,10);
        if(dA===dB) return (a.Start||"").localeCompare(b.Start||"");
        return dA.localeCompare(dB);
      });

      const grouped = {};
      filtered.forEach(r => {
        const d = String(r.Datum).slice(0,10);
        if(!grouped[d]) grouped[d]=[];
        grouped[d].push(r);
      });

      const fmt = new Intl.DateTimeFormat("sv-SE", {weekday:"long", day:"numeric", month:"long"});
      let html = "";

      Object.keys(grouped).forEach(dateKey=>{
        const dLabel = fmt.format(new Date(dateKey));
        html += `<div class="day-heading">${dLabel.charAt(0).toUpperCase()+dLabel.slice(1)}</div>`;
        html += `<table><thead>
          <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
        </thead><tbody>`;
        grouped[dateKey].forEach(r=>{
          const f=aktivitetFarger[r.Aktivitet]||{color:"#fff",emoji:""};
          html += `<tr style="background:${f.color}">
            <td data-label="Start">${r.Start}</td>
            <td data-label="Slut">${r.Slut}</td>
            <td data-label="Aktivitet" class="aktivitet">${f.emoji||""} ${r.Aktivitet}</td>
            <td data-label="Deltagare">${r.Deltagare}</td>
            <td data-label="Coach">${r.Coach}</td>
          </tr>`;
        });
        html += "</tbody></table>";
      });

      if (!filtered.length) html = `<p>Inga aktiviteter hittades f√∂r ${coach}.</p>`;
      document.getElementById("schemaContainer").innerHTML = html;
    }

    function updateStatusColors(){
      const now=getStockholmDate().toTimeString().slice(0,5);
      document.querySelectorAll("tbody tr").forEach(tr=>{
        const s=tr.children[0]?.textContent?.trim();
        const e=tr.children[1]?.textContent?.trim();
        const cell=tr.querySelector(".aktivitet");
        if(!s||!e||!cell)return;
        let st="";
        if(e<=now)st="‚ùå"; else if(s<=now&&e>=now)st="üü¢";
        cell.textContent=cell.textContent.replace(/^(?:üü¢|‚ùå)\s*/,"");
        if(st)cell.textContent=`${st} ${cell.textContent}`;
        tr.classList.toggle("ended",e<=now);
      });
    }

    loadSchema();
    setInterval(updateStatusColors,60000);
    setInterval(loadSchema,900000);
  </script>
</body>
</html>
