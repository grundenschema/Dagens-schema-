<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schema – Deltagare & Coacher</title>
<style>
:root{
  --bg:#fafafa;
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 3px 10px rgba(0,0,0,.06);
  --radius:14px;
  --muted:#555;
  --band:#9ecbff;
  --header-bg:#f5f7fa;
  --chip-bg:#f8fafc;
  --chip-border:#cfd8e3;
  --chip-active:#3b82f6;
  --chip-text:#1f2937;
}

/* Reset/bas */
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1800px;
  margin:0 auto;
  padding:16px;
}

/* Header */
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  margin-bottom:12px;
}
header img{height:60px;width:auto;}
#clock{font-weight:600;color:#333;font-size:1.1rem;letter-spacing:.5px}

/* Toolbar i logisk ordning */
.toolbar{
  display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;
  margin:12px 0 16px;
}
.toolbar-row{
  display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
}
button,select{
  font-size:1rem;padding:10px 16px;border-radius:12px;border:1px solid #cfd8e3;background:#fff;cursor:pointer;transition:.15s background,.15s transform;
}
button:hover{background:#eef2f7}
button:active{transform:translateY(1px)}
select{min-width:220px;background:#fff}
#viewTitle{text-align:center;margin:10px 0 8px;font-weight:700;}

/* Kort (dagens / nu / kommande / ersättare) */
.cards{
  display:flex;flex-direction:column;gap:10px;max-width:1100px;margin:0 auto;
}
.card{
  position:relative;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow);
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 6px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

/* Veckoschema (liggande) */
#blockContainer{display:none;margin-top:6px;}
.block-header{
  display:grid;grid-template-columns:80px repeat(5,1fr);font-weight:800;font-size:.92rem;background:var(--header-bg);
  border-radius:10px 10px 0 0;text-transform:capitalize;
}
.block-header div{ text-align:center; padding:8px 0; }
.block-grid{ display:grid; grid-template-columns:80px repeat(5,1fr); background:transparent; }
.block-time{ font-size:.86rem; padding:4px 6px; text-align:right; color:#2b2b2b; }
.block-cell{ position:relative; min-height:28px; background:transparent; border:none; }

/* Block i veckoschemat — tunn kant + tydligare separation */
.block{
  position:absolute; left:2px; right:2px; top:2px;
  border-radius:10px; padding:6px 8px; line-height:1.25;
  font-size:.82rem; color:#111; box-shadow:var(--shadow);
  word-break:break-word; overflow:hidden; -webkit-print-color-adjust:exact; print-color-adjust:exact;
  border:1px solid rgba(0,0,0,.15);   /* NYTT: tunn kant runt block */
  background:#fff;                    /* behåll läsbarhet vid ljusa färger */
}
.block .title{font-weight:700}

/* Flervy i jämförelse */
.schema-wrap{ display:flex; flex-wrap:nowrap; gap:16px; align-items:flex-start; overflow-x:auto; padding-bottom:8px; }
.schema{
  min-width:420px; max-width:520px; flex:0 0 auto;
  background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:10px; box-shadow:var(--shadow);
}
.schema h3{margin:6px 0 10px; text-align:center; font-size:1.05rem}

/* Paneler */
.helper-panels{ max-width:1200px; margin:0 auto }
.panel{
  display:none;background:#fff;border:1px solid #cfd8e3;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:16px;margin:14px auto;
}
.panel h2{margin:4px 0 10px;font-size:1.2rem}

/* Jämför – chips */
.chip-group{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.chip-title{ font-weight:700; margin:10px 0 6px; }
.chip{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  background:#fff; border:1px solid var(--chip-border); color:var(--chip-text);
  border-radius:999px; padding:8px 14px; cursor:pointer; user-select:none;
  transition: background .15s, border-color .15s, color .15s;
  font-size:.95rem; font-weight:500;
}
.chip input{display:none;}
.chip.active{ background:var(--chip-active); border-color:var(--chip-active); color:#fff; }

/* Dropdown “Schemaläggning” */
.dropdown{ position:relative; display:inline-block; }
.dropdown-content{
  display:none; position:absolute; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.15);
  border:1px solid #e5e7eb; border-radius:12px; min-width:220px; z-index:10; overflow:hidden;
}
.dropdown-content button{
  width:100%; border:none; text-align:left; background:#fff; border-radius:0; padding:10px 14px;
}
.dropdown-content button:hover{ background:#f5f7fa; }
.dropdown.show .dropdown-content{ display:block; }

/* Utskrift: visa bara aktiv vy */
.print-visible{ display:block !important; }

@media print{
  body{ background:#fff; color:#000; font-size:9pt; margin:0; }
  header, .toolbar, .helper-panels, #nowContainer{ display:none !important; }
  #schemaContainer, #blockContainer{ display:none !important; }
  .print-visible{ display:block !important; }
  .schema{ page-break-inside:avoid; }
  @page{ size:A4 landscape; margin:6mm; }
}

/* Responsiv */
@media (max-width:760px){
  body{padding:8px}
  .toolbar-row{gap:8px}
  button,select{width:95%;font-size:1.05rem}
  .schema{min-width:92vw}
}
</style>
</head>
<body>
<header>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logo">
  <div id="clock"></div>
</header>

<!-- KNAPPAR I LOGISK ORDNING: typ → namn → visning → extra -->
<div class="toolbar">
  <!-- Rad 1: välj schematyp + schemaläggning -->
  <div class="toolbar-row">
    <button id="btnParticipant">Deltagarschema</button>
    <button id="btnCoach">Coachschema</button>
    <div class="dropdown" id="scheduleDropdown">
      <button id="btnSchedule">📅 Schemaläggning ▼</button>
      <div class="dropdown-content">
        <button id="btnCompare">🔍 Jämför scheman</button>
        <button id="btnSick">🩺 Hitta ersättare</button>
      </div>
    </div>
  </div>

  <!-- Rad 2: välj person -->
  <div class="toolbar-row" style="gap:8px;margin-top:2px;">
    <select id="nameSelect"><option value="">-- Välj deltagare --</option></select>
    <select id="coachSelect" style="display:none"><option value="">-- Välj coach --</option></select>
  </div>

  <!-- Rad 3: välj visning -->
  <div class="toolbar-row" style="gap:10px;">
    <button id="btnCards">Dagens schema</button>
    <button id="btnBlocks">Veckoschema</button>
  </div>
</div>

<h2 id="viewTitle"></h2>

<div id="schemaContainer" class="print-scope"></div>
<div id="nowContainer"></div>

<!-- Veckoschema (singel vy) -->
<div id="blockContainer" class="print-scope">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
  <div style="text-align:center;margin-top:10px;">
    <button id="btnPrint" style="display:none;">🖨️ Skriv ut</button>
  </div>
</div>

<!-- Paneler -->
<div class="helper-panels">
  <!-- Jämför -->
  <div id="comparePanel" class="panel">
    <h2>🔍 Jämför scheman</h2>
    <div class="chip-title">Coacher</div>
    <div id="coachListCompare" class="chip-group"></div>
    <div class="chip-title">Deltagare</div>
    <div id="participantListCompare" class="chip-group"></div>
    <div style="text-align:center; margin-top:12px;">
      <button id="btnShowCompare">Visa valda scheman</button>
    </div>
  </div>

  <!-- Ersättare -->
  <div id="sickPanel" class="panel">
    <h2>🩺 Hitta ersättare</h2>
    <select id="sickCoachSelect"><option value="">-- Välj sjuk coach --</option></select>
    <div style="margin-top:8px;">
      <label><input type="checkbox" id="chkFullWeek" checked> Visa hela veckan</label>
    </div>
    <div id="sickResult" style="margin-top:10px;"></div>
  </div>
</div>

<script>
/* =========================
   DATA & KONFIG
========================= */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

/* Emojis + färger (inkl. alias och ☕🔋) */
const aktivitetFarger={
  "Måndagsmöte":{color:"#AED6F1",emoji:"📅"},
  "Gruppmöte":{color:"#7FB3D5",emoji:"👥"},
  "Lunch":{color:"#F9E79F",emoji:"🍲"},
  "Frukost":{color:"#FAD7A0",emoji:"🥐"},
  "Morgonrutiner":{color:"#FAD7A0",emoji:"☀️"},
  "Ateljé":{color:"#F5CBA7",emoji:"🎨"},
  "ateljén":{color:"#F5CBA7",emoji:"🎨"},
  "Ateljén":{color:"#F5CBA7",emoji:"🎨"},
  "Musik":{color:"#D2B4DE",emoji:"🎶"},
  "Pod":{color:"#A9CCE3",emoji:"🎙️"},
  "Padel":{color:"#82E0AA",emoji:"🏓"},
  "Lite av varje":{color:"#FADBD8",emoji:"✨"},
  "lite av varje":{color:"#FADBD8",emoji:"✨"},
  "Yoga":{color:"#D5F5E3",emoji:"🧘"},
  "Gym":{color:"#A3E4D7",emoji:"🏋️‍♂️"},
  "Film":{color:"#E6B0AA",emoji:"🎬"},
  "Föreningsgruppen":{color:"#D6DBDF",emoji:"🤝"},
  "Trummor":{color:"#F1948A",emoji:"🥁"},
  "Återkoppling":{color:"#85C1E9",emoji:"🔄"},
  "Medicin":{color:"#E59866",emoji:"💊"},
  "Biljard":{color:"#A9DFBF",emoji:"🎱"},
  "Spelgruppen":{color:"#F8C471",emoji:"🎲"},
  "Sömnad":{color:"#F5EEF8",emoji:"🧵"},
  "Filmgruppen":{color:"#E6B0AA",emoji:"🎬"},
  "Musikquizz":{color:"#D2B4DE",emoji:"🎶"},
  "Musikdokumentär":{color:"#D2B4DE",emoji:"🎶"},
  "Warhammer":{color:"#C39BD3",emoji:"🛡️"},
  "Utflykt":{color:"#A9CCE3",emoji:"🚌"},
  "Uppstart Taket":{color:"#AED6F1",emoji:"🌤️"},
  "Uppstart":{color:"#AED6F1",emoji:"🌤️"},
  "Gåträning":{color:"#ABEBC6",emoji:"🚶‍♂️"},
  "Promenad":{color:"#ABEBC6",emoji:"🚶‍♀️"},
  "Toa,  promenad":{color:"#ABEBC6",emoji:"🚶‍♀️"},
  "Baka":{color:"#FAD7A0",emoji:"🧁"},
  "Lokalvård":{color:"#E5E7E8",emoji:"🧹"},
  "Öppen verkstad":{color:"#E5E7E8",emoji:"🧰"},
  "Vocal":{color:"#E8DAEF",emoji:"🎤"},
  "Behandling":{color:"#FDEDEC",emoji:"💆‍♀️"},
  "Behandlingar":{color:"#FDEDEC",emoji:"💆‍♀️"},
  "Relax Massagestol":{color:"#FDEDEC",emoji:"💺"},
  "Transkibering":{color:"#E8DAEF",emoji:"⌨️"},
  "Transkribering":{color:"#E8DAEF",emoji:"⌨️"},
  "Pod sidbenor":{color:"#A9CCE3",emoji:"🎙️"},
  "Pod Sidbenor":{color:"#A9CCE3",emoji:"🎙️"},
  "Lunchpromenad":{color:"#ABEBC6",emoji:"🚶‍♀️🍲"},
  "Autentiskt relaterande":{color:"#D6DBDF",emoji:"🤝"},
  "Handla":{color:"#E5E7E8",emoji:"🛒"},
  "Handling":{color:"#E5E7E8",emoji:"🛒"},
  "Foto":{color:"#E8DAEF",emoji:"📸"},
  "Kommunikation":{color:"#D6EAF8",emoji:"💬"},
  "Kulturpromenad":{color:"#ABEBC6",emoji:"🏛️"},
  "Poesigrupp":{color:"#FDEBD0",emoji:"✍️"},
  "Poesigruppen":{color:"#FDEBD0",emoji:"✍️"},
  "Samtal":{color:"#FCF3CF",emoji:"💬"},
  "Samtal onsdag eller torsdag":{color:"#FCF3CF",emoji:"💬"},
  "Manusarbete":{color:"#E8DAEF",emoji:"📝"},
  "Mark- Manusarbete (John)":{color:"#E8DAEF",emoji:"📝"},
  "Gym Slottskogens Gym":{color:"#A3E4D7",emoji:"🏋️‍♂️"},
  "Bakning":{color:"#FAD7A0",emoji:"🧁"},
  "Filmkunskap":{color:"#E6B0AA",emoji:"🎬"},
  "Avslappning":{color:"#D5F5E3",emoji:"🪷"},
  "Fika, Ladda stol":{color:"#FAD7A0",emoji:"☕🔋"},
  "Ladda stol":{color:"#FAD7A0",emoji:"☕🔋"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#edf2f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}
function weekdayName(d){return ["söndag","måndag","tisdag","onsdag","torsdag","fredag","lördag"][d];}

let DATA=[];

/* =========================
   LADDA DATA + “PÅGÅR NU” VID START
========================= */
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList(); fillCoachList(); fillCompareLists(); fillSickList();
    showNowAndNext(); // standardvy: Pågår nu
  }catch(e){ console.error(e); }
}
loadData();

/* =========================
   KLOCKA
========================= */
function updateClock(){
  const el=document.getElementById("clock");
  if(!el) return;
  const now=new Date();
  el.textContent=now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000); updateClock();

/* =========================
   LISTOR (SELECTS + CHIPS)
========================= */
function uniqueTokens(field){
  return [...new Set(DATA.map(r=>(r[field]||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla")
    .sort();
}
function sanitizeName(x){
  const bad=["alla","ingen coach","ingen","eget arbete",".","-","na","n/a","okänt","unknown","(tom)",""];
  return x && !bad.includes(String(x).trim().toLowerCase());
}
function splitNames(str){
  return (str||"").split(/,|\/|;|\n/).map(s=>s.trim()).filter(sanitizeName);
}
function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- Välj deltagare --</option>';
  uniqueTokens("Deltagare").forEach(n=>{
    const o=document.createElement("option"); o.value=n; o.textContent=n; s.appendChild(o);
  });
}
function fillCoachList(){
  const s=document.getElementById("coachSelect");
  s.innerHTML='<option value="">-- Välj coach --</option>';
  uniqueTokens("Coach").forEach(c=>{
    const o=document.createElement("option"); o.value=c; o.textContent=c; s.appendChild(o);
  });
}
function fillCompareLists(){
  const cWrap=document.getElementById("coachListCompare");
  const pWrap=document.getElementById("participantListCompare");
  cWrap.innerHTML=""; pWrap.innerHTML="";
  uniqueTokens("Coach").forEach(c=>{
    const id="c_"+btoa(encodeURIComponent(c)).replace(/=/g,"");
    cWrap.insertAdjacentHTML("beforeend",
      `<label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-coach" value="${c}"><span>${c}</span></label>`
    );
  });
  uniqueTokens("Deltagare").forEach(n=>{
    const id="p_"+btoa(encodeURIComponent(n)).replace(/=/g,"");
    pWrap.insertAdjacentHTML("beforeend",
      `<label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-delt" value="${n}"><span>${n}</span></label>`
    );
  });
  // chip feedback
  document.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click",()=>{
      const inp=chip.querySelector("input");
      inp.checked=!inp.checked;
      chip.classList.toggle("active",inp.checked);
    });
  });
}
function fillSickList(){
  const s=document.getElementById("sickCoachSelect");
  s.innerHTML='<option value="">-- Välj sjuk coach --</option>'+
    uniqueTokens("Coach").map(c=>`<option>${c}</option>`).join("");
}
/* =========================
   GEMENSAM LOGIK
========================= */
function hidePanels(){
  document.getElementById("comparePanel").style.display="none";
  document.getElementById("sickPanel").style.display="none";
}
function applyLunchRule(rows,name,isCoach){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const field=isCoach?"Coach":"Deltagare";
    const isAll=(r[field]||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>
        x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&
        (x.Aktivitet||"").toLowerCase().includes("lunch")&&
        (x[field]||"").toLowerCase().includes(name.toLowerCase())
      );
      if(specific) return false;
    }
    return true;
  });
}

/* =========================
   DAGENS SCHEMA (kortvy)
========================= */
function renderCards(name,isCoach){
  hidePanels();
  const today=todayKey();
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(
    DATA.filter(r=>{
      const list=splitNames(r[field]||"");
      return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) ||
             (r[field]||"").trim().toLowerCase()==="alla";
    }),name,isCoach
  ).filter(r=>dayKey(r.Datum)===today)
   .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  let html=`<div class='cards'>`;
  if(!rows.length) html+="<p>Inga aktiviteter idag.</p>";
  rows.forEach(r=>{
    html+=`<div class="card" style="--band:${colorFor(r)}">
      <h3>${emojiFor(r)} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">🕒 ${r.Start||""}–${r.Slut||""}</div>
      <div class="row">${isCoach?"👥 Deltagare: "+(r.Deltagare||"-"):"🧑‍🏫 Coach: "+(r.Coach||"-")}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("btnPrint").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema – ${name}`;
}

/* =========================
   VECKOSCHEMA (block, liggande)
========================= */
function makeSlots(){
  const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}
  a.push("16:30");return a;
}

function renderBlocks(name,isCoach){
  hidePanels();
  const slots=makeSlots();
  const days=["måndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) ||
           (r[field]||"").trim().toLowerCase()==="alla";
  }),name,isCoach);

  const head=document.getElementById("blockHeader"),
        grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("");
  grid.innerHTML="";
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;

  slots.forEach(t=>{
    grid.innerHTML+=`<div class='block-time'>${t}</div>`+
      days.map(()=>`<div class='block-cell'></div>`).join("");
  });

  const cells=[...grid.children];

  rows.forEach(r=>{
    const d=new Date(r.Datum);
    let wd=d.getDay(); // 0=Sun..6=Sat
    if(wd===0||wd===6) return;
    const col=(wd-1)+1;
    const sIdx=slots.indexOf(r.Start), eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx) return;

    const firstCellIndex=sIdx*(1+days.length)+col;
    const firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);

    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const duration=(eh*60+em)-(sh*60+sm);

    // 🕒 NYT: visa tid först för längre pass
    if(duration>30){
      block.innerHTML=`<div class="title">🕒 ${r.Start||""}–${r.Slut||""}</div>
        ${emojiFor(r)} ${r.Aktivitet||""}<br>
        ${isCoach?"👥 "+(r.Deltagare||"-"):"🧑‍🏫 "+(r.Coach||"-")}`;
    }else{
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}<br>
        ${r.Start||""}–${r.Slut||""}<br>
        ${isCoach?"👥 "+(r.Deltagare||"-"):"🧑‍🏫 "+(r.Coach||"-")}`;
    }

    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight||28;
      block.style.height=(eIdx-sIdx)*cellH+"px";
    });
    firstCell.appendChild(block);
  });

  document.getElementById("viewTitle").textContent=`Veckoschema – ${name}`;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
  document.getElementById("btnPrint").style.display="inline-block";
}
/* =========================
   JÄMFÖR SCHEMAN
========================= */
function renderCompare(){
  hidePanels();
  const chosenCoaches=[...document.querySelectorAll(".chk-coach:checked")].map(c=>c.value);
  const chosenParts=[...document.querySelectorAll(".chk-delt:checked")].map(c=>c.value);
  const allNames=[...chosenCoaches.map(x=>({name:x,isCoach:true})),...chosenParts.map(x=>({name:x,isCoach:false}))];

  if(!allNames.length){alert("Välj minst en person att jämföra!");return;}

  let html="<div class='schema-wrap'>";
  allNames.forEach(p=>{
    html+=`<div class='schema'><h3>${p.isCoach?"🧑‍🏫 ":"🧍‍♀️ "}${p.name}</h3>`;
    html+=makeWeekGrid(p.name,p.isCoach);
    html+="</div>";
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("btnPrint").style.display="inline-block";
  document.getElementById("viewTitle").textContent="Jämförelse";
}

function makeWeekGrid(name,isCoach){
  const slots=makeSlots();
  const days=["måndag","tisdag","onsdag","torsdag","fredag"];
  const field=isCoach?"Coach":"Deltagare";
  const rows=applyLunchRule(DATA.filter(r=>{
    const list=splitNames(r[field]||"");
    return (list.map(x=>x.toLowerCase()).includes(name.toLowerCase())) ||
           (r[field]||"").trim().toLowerCase()==="alla";
  }),name,isCoach);

  let html="<div class='block-header' style='font-size:.9rem'><div>Tid</div>"+days.map(d=>`<div>${d}</div>`).join("")+"</div>";
  html+="<div class='block-grid' style='grid-template-columns:80px repeat(5,1fr)'>";
  slots.forEach(t=>{
    html+=`<div class='block-time'>${t}</div>`+days.map(()=>`<div class='block-cell'></div>`).join("");
  });
  html+="</div>";

  const div=document.createElement("div");div.innerHTML=html;
  const grid=div.querySelector(".block-grid");
  const cells=[...grid.children];

  rows.forEach(r=>{
    const d=new Date(r.Datum);let wd=d.getDay();if(wd===0||wd===6)return;
    const col=(wd-1)+1;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=sIdx*(1+days.length)+col;
    const firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";block.style.background=colorFor(r);

    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const duration=(eh*60+em)-(sh*60+sm);
    if(duration>30){
      block.innerHTML=`<div class="title">🕒 ${r.Start||""}–${r.Slut||""}</div>
        ${emojiFor(r)} ${r.Aktivitet||""}<br>
        ${isCoach?"👥 "+(r.Deltagare||"-"):"🧑‍🏫 "+(r.Coach||"-")}`;
    }else{
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}<br>
        ${r.Start||""}–${r.Slut||""}<br>
        ${isCoach?"👥 "+(r.Deltagare||"-"):"🧑‍🏫 "+(r.Coach||"-")}`;
    }
    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight||28;
      block.style.height=(eIdx-sIdx)*cellH+"px";
    });
    firstCell.appendChild(block);
  });
  return div.innerHTML;
}

/* =========================
   HITTA ERSÄTTARE
========================= */
function renderSick(){
  hidePanels();
  const sel=document.getElementById("sickCoachSelect");
  const name=sel.value;
  if(!name){alert("Välj sjuk coach.");return;}
  const fullWeek=document.getElementById("chkFullWeek").checked;
  const rows=DATA.filter(r=>{
    const list=splitNames(r.Coach||"");
    return list.map(x=>x.toLowerCase()).includes(name.toLowerCase());
  }).filter(r=>{
    if(!fullWeek)return dayKey(r.Datum)===todayKey();return true;
  }).sort((a,b)=>(a.Datum+a.Start).localeCompare(b.Datum+b.Start));

  const allCoaches=uniqueTokens("Coach").filter(c=>c.toLowerCase()!==name.toLowerCase());
  const resultDiv=document.getElementById("sickResult");
  resultDiv.innerHTML="";

  if(!rows.length){resultDiv.innerHTML="<p>Inga pass hittades.</p>";return;}

  rows.forEach(r=>{
    const dateStr=new Date(r.Datum).toLocaleDateString("sv-SE",{weekday:"short",month:"short",day:"numeric"});
    const sameTime=DATA.filter(x=>{
      const sameDay=dayKey(x.Datum)===dayKey(r.Datum);
      if(!sameDay)return false;
      const [sh,sm]=(x.Start||"00:00").split(":").map(Number);
      const [eh,em]=(x.Slut||"00:00").split(":").map(Number);
      const [rsh,rsm]=(r.Start||"00:00").split(":").map(Number);
      const [reh,rem]=(r.Slut||"00:00").split(":").map(Number);
      const startMin=sh*60+sm,endMin=eh*60+em;
      const rStart=rsh*60+rsm,rEnd=reh*60+rem;
      return !(endMin<=rStart||startMin>=rEnd);
    });
    const busy=uniqueTokens("Coach").filter(c=>sameTime.some(x=>splitNames(x.Coach).includes(c)));
    const free=allCoaches.filter(c=>!busy.includes(c));
    resultDiv.innerHTML+=`<div class='card' style='--band:${colorFor(r)}'>
      <h3>${emojiFor(r)} ${r.Aktivitet||""}</h3>
      <div class="row">📅 ${dateStr} 🕒 ${r.Start||""}–${r.Slut||""}</div>
      <div class="row">👥 Deltagare: ${(r.Deltagare||"-")}</div>
      <div class="row">🧑‍🏫 Möjliga ersättare: ${free.join(", ")||"–"}</div>
    </div>`;
  });
}
/* =========================
   “PÅGÅR NU” + KOMMANDE
========================= */
function showNowAndNext(){
  hidePanels();
  const now=new Date();
  const today=dayKey(now);
  const nowMin=now.getHours()*60+now.getMinutes();
  const todayRows=DATA.filter(r=>dayKey(r.Datum)===today);

  const ongoing=todayRows.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const startMin=sh*60+sm,endMin=eh*60+em;
    return nowMin>=startMin && nowMin<endMin;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  const upcoming=todayRows.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const startMin=sh*60+sm;
    return startMin>nowMin;
  }).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));

  let html="<div class='cards'>";
  html+="<h2>⏱️ Pågår nu</h2>";
  if(!ongoing.length) html+="<p>Ingen aktivitet just nu.</p>";
  ongoing.forEach(r=>{
    html+=`<div class='card' style='--band:${colorFor(r)}'>
      <h3>${emojiFor(r)} ${r.Aktivitet||""}</h3>
      <div class="row">🕒 ${r.Start||""}–${r.Slut||""}</div>
      <div class="row">🧑‍🏫 Coach: ${(r.Coach||"-")}</div>
      <div class="row">👥 Deltagare: ${(r.Deltagare||"-")}</div>
    </div>`;
  });
  html+="<h2 style='margin-top:12px'>📅 Kommande idag</h2>";
  if(!upcoming.length) html+="<p>Inga fler aktiviteter idag.</p>";
  upcoming.forEach(r=>{
    html+=`<div class='card' style='--band:${colorFor(r)}'>
      <h3>${emojiFor(r)} ${r.Aktivitet||""}</h3>
      <div class="row">🕒 ${r.Start||""}–${r.Slut||""}</div>
      <div class="row">🧑‍🏫 Coach: ${(r.Coach||"-")}</div>
      <div class="row">👥 Deltagare: ${(r.Deltagare||"-")}</div>
    </div>`;
  });
  html+="</div>";

  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("btnPrint").style.display="none";
  document.getElementById("viewTitle").textContent="Pågår nu";
}
setInterval(showNowAndNext,60000);

/* =========================
   EVENT HANDLERS
========================= */
document.getElementById("btnParticipant").addEventListener("click",()=>{
  document.getElementById("nameSelect").style.display="inline-block";
  document.getElementById("coachSelect").style.display="none";
});
document.getElementById("btnCoach").addEventListener("click",()=>{
  document.getElementById("nameSelect").style.display="none";
  document.getElementById("coachSelect").style.display="inline-block";
});

document.getElementById("btnCards").addEventListener("click",()=>{
  const ns=document.getElementById("nameSelect"),cs=document.getElementById("coachSelect");
  const name=ns.style.display!=="none"?ns.value:cs.value;
  const isCoach=cs.style.display!=="none";
  if(!name){alert("Välj namn först.");return;}
  renderCards(name,isCoach);
});
document.getElementById("btnBlocks").addEventListener("click",()=>{
  const ns=document.getElementById("nameSelect"),cs=document.getElementById("coachSelect");
  const name=ns.style.display!=="none"?ns.value:cs.value;
  const isCoach=cs.style.display!=="none";
  if(!name){alert("Välj namn först.");return;}
  renderBlocks(name,isCoach);
});

document.getElementById("btnCompare").addEventListener("click",()=>{
  hidePanels();
  document.getElementById("comparePanel").style.display="block";
  document.getElementById("sickPanel").style.display="none";
});
document.getElementById("btnSick").addEventListener("click",()=>{
  hidePanels();
  document.getElementById("sickPanel").style.display="block";
});
document.getElementById("btnShowCompare").addEventListener("click",renderCompare);
document.getElementById("sickCoachSelect").addEventListener("change",renderSick);
document.getElementById("chkFullWeek").addEventListener("change",renderSick);

document.getElementById("btnPrint").addEventListener("click",()=>window.print());

document.getElementById("btnSchedule").addEventListener("click",()=>{
  document.getElementById("scheduleDropdown").classList.toggle("show");
});
window.addEventListener("click",e=>{
  if(!e.target.matches("#btnSchedule")) document.getElementById("scheduleDropdown").classList.remove("show");
});
</script>
</body>
</html>
