<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grunden DV ‚Äì Schema</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    header img {
      height: 60px;
      position: absolute;
      top: 20px;
      right: 20px;
    }
    h1 { margin-bottom: 5px; }
    #clock { font-family: monospace; margin-bottom: 8px; }
    #updated { font-size: 12px; color: #666; margin-bottom: 16px; }

    select, button {
      margin: 5px 5px 15px 0;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background-color: #f7f7f7;
      cursor: pointer;
    }
    button:hover { background-color: #e0e0e0; }

    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f2f2f2; }
    .ended { opacity: 0.6; }
    .aktivitet { font-weight: bold; }
    .hidden { display: none; }

    .toolbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .status-dot { font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Logga">
  </header>

  <h1 id="viewTitle">Dagens gemensamma schema</h1>
  <div id="clock"></div>
  <div id="updated">Senast uppdaterad: ‚Äì</div>

  <div class="toolbar">
    <button id="showDaily">Gemensamt schema</button>
    <button id="showWeekly">Coachschema</button>
    <select id="coachSelect" class="hidden"></select>
    <span class="status-dot" title="Uppdaterar status varje minut">üü¢/‚ùå auto</span>
  </div>

  <div id="schemaContainer">Laddar schema...</div>

  <script>
    // üîó Din Google Apps Script-webbapp (deployad adress)
    const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

    // üé® F√§rger och emojis per aktivitet
    const aktivitetFarger = {
      "M√•ndagsm√∂te": {color:"#AED6F1", emoji:"üìÖ"},
      "Gruppm√∂te": {color:"#7FB3D5", emoji:"üë•"},
      "Lunch": {color:"#F9E79F", emoji:"üç≤"},
      "Frukost": {color:"#FAD7A0", emoji:"ü•ê"},
      "Atelj√©": {color:"#F5CBA7", emoji:"üé®"},
      "Musik": {color:"#D2B4DE", emoji:"üé∂"},
      "Pod": {color:"#A9CCE3", emoji:"üéôÔ∏è"},
      "Padel": {color:"#82E0AA", emoji:"üèì"},
      "Lite av varje": {color:"#FADBD8", emoji:"‚ú®"},
      "Yoga": {color:"#D5F5E3", emoji:"üßò"},
      "Gym": {color:"#A3E4D7", emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
      "Film": {color:"#E6B0AA", emoji:"üé¨"},
      "F√∂reningsgruppen": {color:"#D6DBDF", emoji:"ü§ù"},
      "Trummor": {color:"#F1948A", emoji:"ü•Å"},
      "√Öterkoppling": {color:"#85C1E9", emoji:"üîÑ"},
      "Medicin": {color:"#E59866", emoji:"üíä"},
      "Biljard": {color:"#A9DFBF", emoji:"üé±"},
      "Spelgruppen": {color:"#F8C471", emoji:"üé≤"},
      "S√∂mnad": {color:"#F5EEF8", emoji:"üßµ"},
      "Filmgruppen": {color:"#E6B0AA", emoji:"üé¨"},
      "Musikquizz": {color:"#D2B4DE", emoji:"üé∂"},
      "Musikdokument√§r": {color:"#D2B4DE", emoji:"üé∂"}
    };

    // üïê Svensk tid
    function getStockholmDate() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Stockholm" }));
    }

    // üïí Klockan
    function updateClock() {
      const now = getStockholmDate();
      const options = {
        weekday: "long", year: "numeric", month: "long", day: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit", timeZone: "Europe/Stockholm"
      };
      document.getElementById("clock").textContent =
        new Intl.DateTimeFormat("sv-SE", options).format(now);
    }
    setInterval(updateClock, 1000);
    updateClock();

    let GLOBAL_DATA = [];
    let GLOBAL_UPDATED = "";

    // üì¶ H√§mta schema
    async function loadSchema() {
      try {
        const res = await fetch(url + "?t=" + Date.now());
        const json = await res.json();
        GLOBAL_DATA = Array.isArray(json.data) ? json.data : [];
        GLOBAL_UPDATED = json.updated || "";

        document.getElementById("updated").textContent =
          GLOBAL_UPDATED ? "Senast uppdaterad: " + GLOBAL_UPDATED : "Senast uppdaterad: ‚Äì";

        renderDaily(GLOBAL_DATA);
        setupWeekly(GLOBAL_DATA);
      } catch (err) {
        console.error("Fel vid h√§mtning av schema:", err);
        document.getElementById("schemaContainer").textContent =
          "Kunde inte h√§mta schema. Prova att ladda om sidan.";
      }
    }

    // üìÖ Dagens schema
    function renderDaily(data) {
      document.getElementById("viewTitle").textContent = "Dagens gemensamma schema";
      document.getElementById("coachSelect").classList.add("hidden");

      const todayStr = getStockholmDate().toISOString().split("T")[0];
      const todays = data.filter(r => String(r.Datum).startsWith(todayStr));
      const now = getStockholmDate().toTimeString().slice(0,5);

      let html = `<table><thead>
        <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
      </thead><tbody>`;

      todays.forEach(row => {
        const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
        const status = (row.Slut <= now) ? "‚ùå" : (row.Start <= now && row.Slut >= now) ? "üü¢" : "";
        html += `<tr style="background:${f.color}" class="${status==='‚ùå'?'ended':''}">
          <td>${row.Start || ""}</td>
          <td>${row.Slut || ""}</td>
          <td class="aktivitet">${status ? status + " " : ""}${f.emoji||""} ${row.Aktivitet || ""}</td>
          <td>${row.Deltagare || ""}</td>
          <td>${row.Coach || ""}</td>
        </tr>`;
      });

      if (todays.length === 0) {
        html += `<tr><td colspan="5">Inga aktiviteter f√∂r idag.</td></tr>`;
      }

      html += "</tbody></table>";
      document.getElementById("schemaContainer").innerHTML = html;
    }

    // üë• Coachlista
    function setupWeekly(data) {
      const select = document.getElementById("coachSelect");
      const coaches = [...new Set(
        data.map(r => (r.Coach || "").split(",")).flat().map(c => c.trim()).filter(c => c && c !== "Alla")
      )].sort();

      select.innerHTML = "<option value=''>-- V√§lj coach --</option>" +
        coaches.map(c => `<option value="${c}">${c}</option>`).join("");

      select.onchange = () => renderWeekly(data, select.value);
    }

    // üìÜ Veckoschema per coach (grupperat per dag)
    function renderWeekly(data, coach) {
      document.getElementById("viewTitle").textContent =
        "Coachschema" + (coach ? ` ‚Äì ${coach}` : "");
      document.getElementById("coachSelect").classList.remove("hidden");

      let filtered = data;
      if (coach) {
        filtered = data.filter(r => {
          const coachList = (r.Coach || "").split(",").map(c => c.trim());
          return coachList.includes(coach) || (r.Coach || "").trim() === "Alla";
        });
      }

      // Sortera p√• datum + start
      filtered.sort((a, b) => {
        const dA = String(a.Datum).slice(0, 10);
        const dB = String(b.Datum).slice(0, 10);
        if (dA === dB) return (a.Start || "").localeCompare(b.Start || "");
        return dA.localeCompare(dB);
      });

      // Gruppera per dag
      const grouped = {};
      filtered.forEach(row => {
        const dateKey = String(row.Datum).slice(0, 10);
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(row);
      });

      let html = "";
      const formatter = new Intl.DateTimeFormat("sv-SE", {
        weekday: "long", day: "numeric", month: "long"
      });

      Object.keys(grouped).forEach(dateKey => {
        const fDate = formatter.format(new Date(dateKey));
        html += `<h3 style="margin-top:20px;">${fDate.charAt(0).toUpperCase() + fDate.slice(1)}</h3>`;
        html += `<table><thead>
          <tr><th>Start</th><th>Slut</th><th>Aktivitet</th><th>Deltagare</th><th>Coach</th></tr>
        </thead><tbody>`;

        grouped[dateKey].forEach(row => {
          const f = aktivitetFarger[row.Aktivitet] || {color:"#fff", emoji:""};
          html += `<tr style="background:${f.color}">
            <td>${row.Start || ""}</td>
            <td>${row.Slut || ""}</td>
            <td class="aktivitet">${f.emoji||""} ${row.Aktivitet || ""}</td>
            <td>${row.Deltagare || ""}</td>
            <td>${row.Coach || ""}</td>
          </tr>`;
        });

        html += "</tbody></table>";
      });

      if (filtered.length === 0) {
        html = `<p>Inga aktiviteter hittades${coach ? " f√∂r " + coach : ""}.</p>`;
      }

      document.getElementById("schemaContainer").innerHTML = html;
    }

    // üü¢ Uppdatera status lokalt
    function updateStatusColors() {
      const now = getStockholmDate().toTimeString().slice(0,5);
      document.querySelectorAll("tbody tr").forEach(tr => {
        const start = tr.children[0]?.textContent?.trim();
        const end = tr.children[1]?.textContent?.trim();
        const aktivitetCell = tr.querySelector(".aktivitet");
        if (!start || !end || !aktivitetCell) return;

        let status = "";
        if (end <= now) status = "‚ùå";
        else if (start <= now && end >= now) status = "üü¢";

        aktivitetCell.textContent = aktivitetCell.textContent.replace(/^(?:üü¢|‚ùå)\s*/, "");
        if (status) aktivitetCell.textContent = `${status} ${aktivitetCell.textContent}`;
        tr.classList.toggle("ended", end <= now);
      });
    }

    // üîò Knapphantering
    document.getElementById("showDaily").onclick = () => renderDaily(GLOBAL_DATA);
    document.getElementById("showWeekly").onclick = () =>
      renderWeekly(GLOBAL_DATA, document.getElementById("coachSelect").value || "");

    // üöÄ Start
    loadSchema();

    // üîÑ Uppdatera status var minut
    setInterval(updateStatusColors, 60 * 1000);

    // üîÅ H√§mta nytt schema var 15:e minut
    setInterval(loadSchema, 15 * 60 * 1000);
  </script>
</body>
</html>
